<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customizable Progress Bar Timer</title>
    
    <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#000000">
  
    <!-- Google Fonts for different styles --><link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch&family=Electrolyze&family=Jersey+10&family=Jersey+20&family=Jersey+25&family=Orbitron:wght@400;700&family=Press+Start+2P&family=Russo+One&family=Share+Tech&family=Share+Tech+Mono&family=Teko&family=Tomorrow&family=VT323&family=Zen+Dots&display=swap" rel="stylesheet">

    <style>
        /* --- CSS Custom Properties (Variables) --- */
        :root {
            --bar-color: #4CAF50; /* Green */
            --bar-length: 60vw; /* Default length decreased */
            --bar-width: 50px; /* Default width changed */
            --bar-corner-radius: 15px;
            --bar-glow-intensity: 0px;
            --bar-neon-intensity: 0px;
            --bar-gradient-start: #4CAF50;
            --bar-gradient-end: #03A9F4;
            --bar-background: var(--bar-color);
            --border-color: #FFFFFF;
            --border-size: 2px;
            --border-glow-color: #ffffff;
            --border-glow-intensity: 0px;
            --border-neon-intensity: 0px;
            --font-family: 'Inter', system-ui, sans-serif;
            --font-size: 72px;
            --font-color: #FFFFFF;
            --font-outline-color: #000000;
            --font-outline-size: 0px;
            --text-glow-color: #00ffcc; 
            --text-glow-spread: 0px;
            --text-neon-spread: 0px;
            --bg-color: #121212;
            --start-btn-color: #4CAF50;
            --pause-btn-color: #FFC107;
            --repeat-btn-color: #03A9F4;

            /* New variables for UI elements */
            --options-btn-size: 50px;
            --options-btn-animation-speed: 2s; /* Much faster default speed */
            --message-font-size: 1.2rem;
            --message-color: #ccc;
            --message-glow-color: #00ffcc;
            --message-glow-spread: 0px;
            --message-neon-spread: 0px;
            --message-outline-size: 0px;
            --message-outline-color: #000000;
            
            /* New variables for ellipsis animation */
            --ellipsis-pulse-scale: 1.25;
            --ellipsis-wave-opacity: 0.3;

            /* New variables for button styling */
            --btn-padding-y: 10px;
            --btn-padding-x: 22px;
            --btn-font-size: 1rem;
            --btn-font-color: #ffffff;
            --btn-border-size: 0px;
            --btn-border-color: #ffffff;
            --btn-glow-color: #ffffff;
            --btn-glow-intensity: 0px;
            --btn-neon-intensity: 0px;
            --btn-outline-size: 0px;
            --btn-outline-color: #000000;
        }

        /* --- Keyframe Animations --- */
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        @keyframes pulse-icon {
            50% { transform: scale(1.1); }
        }
        @keyframes float-icon {
            50% { transform: translateY(-5px); }
        }
        @keyframes wobble-icon {
            15% { transform: rotate(-5deg); }
            30% { transform: rotate(3deg); }
            45% { transform: rotate(-3deg); }
            60% { transform: rotate(2deg); }
            75% { transform: rotate(-1deg); }
        }
        @keyframes jello-icon {
          11.1% { transform: none; }
          22.2% { transform: skewX(-12.5deg) skewY(-12.5deg); }
          33.3% { transform: skewX(6.25deg) skewY(6.25deg); }
          44.4% { transform: skewX(-3.125deg) skewY(-3.125deg); }
          55.5% { transform: skewX(1.5625deg) skewY(1.5625deg); }
          66.6% { transform: skewX(-0.78125deg) skewY(-0.78125deg); }
          77.7% { transform: skewX(0.390625deg) skewY(0.390625deg); }
          88.8% { transform: skewX(-0.1953125deg) skewY(-0.1953125deg); }
          100% { transform: none; }
        }

        @keyframes pulse-dot {
            0%, 100% {
                transform: scale(1);
                opacity: 0.6;
            }
            50% {
                transform: scale(var(--ellipsis-pulse-scale));
                opacity: 1;
            }
        }
        
        @keyframes wave-dot {
            0%, 60%, 100% {
                opacity: 0; /* Changed for complete disappearance */
            }
            30% {
                opacity: 1;
            }
        }

        /* --- Base and Body Styles --- */
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            font-family: var(--font-family);
            background-color: var(--bg-color);
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            transition: background-color 0.3s ease;
            overflow: hidden;
            color: white;
        }

        body {
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        /* --- Main Timer Wrapper --- */
        .timer-wrapper {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            transition: transform 0.4s ease;
        }

        /* --- Options (Settings) Button --- */
        #options-btn {
            position: absolute;
            width: var(--options-btn-size);
            height: var(--options-btn-size);
            cursor: pointer;
            opacity: 0.6;
            transition: opacity 0.2s, width 0.3s ease, height 0.3s ease, top 0.3s ease, left 0.3s ease;
            z-index: 10;
            bottom: auto; /* Remove bottom positioning in favor of dynamic top */
        }
        
        #icon-animator {
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            border-radius: 50%;
            transition: filter 0.3s ease;
            filter: drop-shadow(0 2px 3px rgba(0,0,0,0.4));
        }

        #options-btn:hover {
            opacity: 1;
        }

        #options-btn:hover #icon-animator[class*="animated-"] {
            animation-play-state: paused;
        }

        #icon-animator.custom-icon svg {
            display: none; /* Hide SVG when custom icon is applied */
        }

        #icon-animator[class*="animated-"] {
            animation-duration: var(--options-btn-animation-speed);
            animation-iteration-count: infinite;
        }
        #icon-animator.animated-spin {
            animation-name: spin;
            animation-timing-function: linear;
        }
        #icon-animator.animated-pulse {
            animation-name: pulse-icon;
            animation-timing-function: ease-in-out;
        }
        #icon-animator.animated-float {
            animation-name: float-icon;
            animation-timing-function: ease-in-out;
        }
        #icon-animator.animated-wobble {
            animation-name: wobble-icon;
            animation-timing-function: linear;
        }
        #icon-animator.animated-jello {
            animation-name: jello-icon;
            transform-origin: center;
            animation-timing-function: ease-in-out;
        }


        #options-btn svg {
            width: 100%;
            height: 100%;
            fill: #FFF;
        }

        /* --- Timer Display & Message --- */
        #timer-display {
            position: relative;
            font-size: var(--font-size);
            color: var(--font-color);
            font-weight: bold;
            bottom: 20px;
            transform: translateY(0);
            z-index: 1;
            text-shadow: 
                calc(-1 * var(--font-outline-size)) calc(-1 * var(--font-outline-size)) 0 var(--font-outline-color),  
                 var(--font-outline-size) calc(-1 * var(--font-outline-size)) 0 var(--font-outline-color),
                calc(-1 * var(--font-outline-size)) var(--font-outline-size) 0 var(--font-outline-color),
                 var(--font-outline-size) var(--font-outline-size) 0 var(--font-outline-color),
                 /* Normal Glow */
                0 0 var(--text-glow-spread) var(--text-glow-color),
                 /* Neon Glow */
                0 0 var(--text-neon-spread) var(--text-glow-color),
                0 0 calc(var(--text-neon-spread) * 2) var(--text-glow-color);
            transition: all 0.3s ease;
            white-space: nowrap;
        }
        
        #timer-message {
            color: var(--message-color);
            font-size: var(--message-font-size);
            margin-top: -20px;
            margin-bottom: 15px;
            text-shadow: 
                 calc(-1 * var(--message-outline-size)) calc(-1 * var(--message-outline-size)) 0 var(--message-outline-color),  
                 var(--message-outline-size) calc(-1 * var(--message-outline-size)) 0 var(--message-outline-color),
                calc(-1 * var(--message-outline-size)) var(--message-outline-size) 0 var(--message-outline-color),
                 var(--message-outline-size) var(--message-outline-size) 0 var(--message-outline-color),
                /* Normal Glow */
                0 0 var(--message-glow-spread) var(--message-glow-color),
                /* Neon Glow */
                0 0 var(--message-neon-spread) var(--message-glow-color),
                0 0 calc(var(--message-neon-spread) * 2) var(--message-glow-color);
            transition: font-size 0.3s ease, color 0.3s ease, text-shadow 0.3s ease;
        }

        /* --- Animated Ellipsis --- */
        .ellipsis {
            display: inline-block;
        }
        .ellipsis-dot {
            display: inline-block;
        }
        .ellipsis.pulse .ellipsis-dot {
            animation: pulse-dot 1.4s infinite;
        }
        .ellipsis.pulse .ellipsis-dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        .ellipsis.pulse .ellipsis-dot:nth-child(3) {
            animation-delay: 0.4s;
        }
        .ellipsis.wave .ellipsis-dot {
            animation: wave-dot 1.4s infinite;
        }
        .ellipsis.wave .ellipsis-dot:nth-child(1) {
            animation-delay: 0s;
        }
        .ellipsis.wave .ellipsis-dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        .ellipsis.wave .ellipsis-dot:nth-child(3) {
            animation-delay: 0.4s;
        }


        /* --- Progress Bar --- */
        #progress-bar-container {
            width: var(--bar-length);
            height: var(--bar-width);
            background-color: #282828; /* Match settings panel */
            border: var(--border-size) solid var(--border-color);
            border-radius: var(--bar-corner-radius);
            overflow: hidden;
            box-shadow: 
                0 0 var(--border-glow-intensity) var(--border-glow-color),
                0 0 var(--border-neon-intensity) var(--border-glow-color),
                0 0 calc(var(--border-neon-intensity) * 2) var(--border-glow-color),
                inset 0 2px 5px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
        }

        #progress-bar {
            width: 0%;
            height: 100%;
            background: var(--bar-background);
            border-radius: var(--bar-corner-radius);
            box-shadow: 
                /* Normal Glow */
                0 0 var(--bar-glow-intensity) var(--bar-color), 
                /* Neon Glow */
                0 0 var(--bar-neon-intensity) var(--bar-color),
                0 0 calc(var(--bar-neon-intensity) * 2) var(--bar-color),
                /* Inset Highlight */
                inset 0 0 10px rgba(255,255,255,0.2);
            transition: width 0.05s linear, background 0.3s ease, box-shadow 0.3s ease;
        }

        /* --- Controls (Buttons) --- */
        #controls {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            justify-content: center; /* Center buttons horizontally */
            align-items: center; /* Vertically center buttons in the container */
            height: 50px; /* Fixed height to prevent layout shifts */
            min-width: 280px; /* Prevents buttons from overlapping on short bars */
        }

        #controls button {
            padding: var(--btn-padding-y) var(--btn-padding-x);
            font-size: var(--btn-font-size);
            border: var(--btn-border-size) solid var(--btn-border-color);
            font-family: inherit;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.1s, box-shadow 0.2s;
            color: var(--btn-font-color);
            font-weight: bold;
            text-shadow: 
                calc(-1 * var(--btn-outline-size)) calc(-1 * var(--btn-outline-size)) 0 var(--btn-outline-color),  
                 var(--btn-outline-size) calc(-1 * var(--btn-outline-size)) 0 var(--btn-outline-color),
                calc(-1 * var(--btn-outline-size)) var(--btn-outline-size) 0 var(--btn-outline-color),
                 var(--btn-outline-size) var(--btn-outline-size) 0 var(--btn-outline-color);
            box-shadow: 
                0 4px 6px rgba(0,0,0,0.2),
                0 0 var(--btn-glow-intensity) var(--btn-glow-color),
                0 0 var(--btn-neon-intensity) var(--btn-glow-color),
                0 0 calc(var(--btn-neon-intensity) * 2) var(--btn-glow-color);
        }

        #controls button:active {
            transform: scale(0.95);
            box-shadow: 0 2px 3px rgba(0,0,0,0.2);
        }

        #start-btn, #resume-btn { background-color: var(--start-btn-color); }
        /* #pause-btn { background-color: var(--pause-btn-color); } */
        #repeat-btn { 
            background-color: var(--repeat-btn-color);
        }

        /* Unify controls layout when timer is active */
        .timer-running #controls,
        .timer-paused #controls {
            display: block;
            position: relative;
            width: var(--bar-length);
        }

        /* Center the Pause button exactly like the Resume button */
        .timer-running #pause-btn {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            transition: transform 0s, box-shadow 0.2s;
        }

        .timer-running #pause-btn:active {
            transform: translateX(-50%) scale(0.95);
            transition: transform 0.1s, box-shadow 0.2s;
        }

        .timer-paused #resume-btn {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            transition: transform 0s, box-shadow 0.2s;
        }
        
        .timer-paused #resume-btn:active {
            transform: translateX(-50%) scale(0.95);
            transition: transform 0.1s, box-shadow 0.2s;
        }

        .timer-paused #repeat-btn {
            position: absolute;
            bottom: 10px;
            right: 0;
        }


        /* --- Options Panel --- */
        #options-panel-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.2); /* Reduced background dimness */
            z-index: 99;
            display: flex;
            justify-content: flex-end; /* Aligns panel to the right */
            align-items: flex-start; /* Aligns panel to the top */
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
            padding: 20px;
            box-sizing: border-box;
        }
        
        #options-panel-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        #options-panel {
            background-color: #282828;
            color: #FFF;
            font-family: 'Inter', system-ui, sans-serif; /* Always use system font here */
            padding: 10px 30px 20px 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 320px; /* Narrower panel */
            max-height: calc(100vh - 40px);
            overflow-y: auto;
            box-shadow: 0 5px 25px rgba(0,0,0,0.5);
            transform: translateX(100%);
            opacity: 0;
            transition: transform 0.4s ease, opacity 0.4s ease;
            display: flex;
            flex-direction: column;
            /* Scrollbar styles for Firefox */
            scrollbar-width: thin;
            scrollbar-color: #666 #282828;
        }
        
        /* Style scrollbar for Webkit browsers (Chrome, Safari) */
        #options-panel::-webkit-scrollbar {
            width: 6px;
        }

        #options-panel::-webkit-scrollbar-track {
            background: #282828;
            border-radius: 10px;
        }

        #options-panel::-webkit-scrollbar-thumb {
            background-color: #666;
            border-radius: 10px;
            border: 1px solid #282828;
        }

        #options-panel-overlay.visible #options-panel {
            transform: translateX(0);
            opacity: 1;
        }

        #options-panel-content {
            flex-grow: 1;
        }

        #options-panel h2 {
            text-align: center;
            margin-bottom: 25px;
            color: #ddd;
        }

        .options-section {
            background-color: rgba(0,0,0,0.2);
            border-radius: 8px;
            margin-bottom: 10px;
            overflow: hidden;
        }
        
        .options-section h3 {
            margin: 0;
            padding: 15px 20px;
            font-size: 1.1rem;
            color: #ccc;
            position: relative;
            border-bottom: 1px solid #282828;
        }

        .options-section.collapsible h3 {
            cursor: pointer;
        }
        
        .options-section.collapsible h3::after {
            content: '+';
            position: absolute;
            right: 20px;
            font-size: 1.5rem;
            font-weight: 300;
            transition: transform 0.3s ease;
        }

        .options-section.collapsible.is-open h3::after {
            transform: rotate(45deg);
        }
        
        .options-content-wrapper {
            display: grid;
            grid-template-rows: 0fr;
            transition: grid-template-rows 0.4s ease;
        }
        .options-section.is-open .options-content-wrapper {
            grid-template-rows: 1fr;
        }

        .options-content {
            overflow: hidden;
            padding: 0 20px;
        }
        
        .options-section.is-open .options-content {
            padding: 20px;
        }

        .duration-control {
            display: grid;
            grid-template-columns: 1.5fr 1fr;
            gap: 5px;
            align-items: center;
        }


        .option-item {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .option-item:last-child {
            margin-bottom: 0;
        }
        
        .option-item.checkbox {
             grid-template-columns: 1fr 20px;
             justify-content: space-between;
        }
        
        .option-item.full-width {
            grid-template-columns: 1fr;
        }

        #options-panel label {
            font-weight: normal;
            font-size: 0.9rem;
            color: #ddd;
        }

        #options-panel input, #options-panel select, #options-panel button {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
            border-radius: 5px;
            border: 1px solid #555;
            background-color: #444;
            color: #FFF;
            font-size: 0.9rem;
        }

        #options-panel input[type="color"] {
            padding: 2px;
            height: 40px;
            cursor: pointer;
        }

        #options-panel input[type="range"] {
            cursor: pointer;
        }
        
        #options-panel input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        #options-panel input[type="file"] {
            padding: 4px;
        }
        #clear-bg-btn, #clear-icon-btn {
             background-color: #666;
             cursor: pointer;
        }
        
        #settings-management-external {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 150px;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.4s 0.2s, visibility 0.4s 0.2s;
        }
        
        body.settings-open #settings-management-external {
            opacity: 1;
            visibility: visible;
        }
        
        #save-settings-btn {
            background-color: #333;
            color: #4CAF50;
            font-weight: bold;
        }
        #reset-settings-btn {
            background-color: #333;
            color: #f44336;
            font-weight: bold;
        }

        /* --- Confirmation Modal --- */
        #confirm-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
            z-index: 102;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        #confirm-modal {
            background: #333;
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 5px 25px rgba(0,0,0,0.4);
        }
        
        #confirm-modal p {
            margin: 0 0 20px 0;
            font-size: 1.1rem;
        }
        
        #confirm-modal-buttons {
            display: flex;
            gap: 15px;
        }
        
        #confirm-yes, #confirm-no {
            padding: 10px 30px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            color: white;
            font-weight: bold;
        }
        
        #confirm-yes { background-color: #f44336; }
        #confirm-no { background-color: #666; }


        /* --- Save Confirmation Message --- */
        #save-confirm {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            z-index: 101;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s, bottom 0.3s;
        }
        #save-confirm.visible {
            opacity: 1;
            visibility: visible;
            bottom: 30px;
        }

        .hidden {
            display: none !important;
        }
        
        .option-group {
            transition: opacity 0.3s ease;
        }
        .option-group.disabled {
            opacity: 0.5;
            pointer-events: none;
        }

        /* --- Responsiveness --- */
        @media (min-width: 800px) {
            body.settings-open .timer-wrapper {
                transform: translateX(-190px); /* Adjusted for narrower panel */
            }
            #settings-management-external {
                left: auto;
                right: calc(320px + 40px + 20px);
                bottom: 20px;
                top: auto;
            }
        }
        
        @media (max-width: 768px) { /* iPad and smaller */
            :root {
                --bar-length: 90vw;
                --font-size: 60px;
            }
             .option-item {
                grid-template-columns: 1fr;
                gap: 8px;
            }
             .option-item.checkbox {
                grid-template-columns: 1fr 20px;
             }
        }

        @media (max-width: 480px) { /* iPhone */
            :root {
                --font-size: 48px;
            }
            #controls {
                flex-direction: column;
                width: 70%;
                gap: 10px;
            }
            #controls button {
                width: 100%;
            }
            #options-panel {
                max-width: 90%;
            }
        }
    </style>
</head>
<body>

    <div class="timer-wrapper">
        <!-- Options Button --><div id="options-btn" title="Settings"><div id="icon-animator"></div></div>

        <!-- Timer Display --><div id="timer-display">
            <span id="main-numbers">0.00%</span>
        </div>
        <div id="timer-message">Your custom message here</div>

        <!-- Progress Bar --><div id="progress-bar-container">
            <div id="progress-bar"></div>
        </div>

        <!-- Controls --><div id="controls">
            <button id="start-btn">Start</button>
            <button id="pause-btn" class="hidden">Pause</button>
            <button id="resume-btn" class="hidden">Resume</button>
            <button id="repeat-btn" class="hidden">Repeat</button>
        </div>
    </div>

    <!-- Options Panel (Hidden by default) --><div id="options-panel-overlay">
        <div id="options-panel">
            <div id="options-panel-content">
                <h2>Customization</h2>
                
                <div class="options-section is-open">
                    <h3>Timer & Sound</h3>
                    <div class="options-content-wrapper">
                        <div class="options-content">
                            <div class="option-item">
                                <label for="duration-input">Duration</label>
                                <div class="duration-control">
                                    <input type="number" id="duration-input" value="20" min="1" step="1">
                                    <select id="duration-unit">
                                        <option value="minutes" selected>M</option>
                                        <option value="hours">H</option>
                                    </select>
                                </div>
                            </div>
                            <div class="option-item"><label for="alarm-sound-select">Alarm</label><select id="alarm-sound-select"><option value="beep">Beep</option><option value="chime">Chime</option><option value="buzz">Buzz</option><option value="none">None</option></select></div>
                        </div>
                    </div>
                </div>

                <div class="options-section collapsible">
                    <h3>Bar</h3>
                    <div class="options-content-wrapper">
                        <div class="options-content">
                            <div class="option-item" id="bar-color-option"><label for="bar-color-input">Color</label><input type="color" id="bar-color-input" value="#4CAF50"></div>
                            <div class="option-item checkbox"><label for="bar-gradient-toggle">Gradient</label><input type="checkbox" id="bar-gradient-toggle"></div>
                            <div class="option-group disabled" id="bar-gradient-options">
                                <div class="option-item"><label for="bar-gradient-start-input">Start</label><input type="color" id="bar-gradient-start-input" value="#4CAF50"></div>
                                <div class="option-item"><label for="bar-gradient-end-input">End</label><input type="color" id="bar-gradient-end-input" value="#03A9F4"></div>
                            </div>
                            <div class="option-item"><label for="bar-length-input">Length</label><input type="range" id="bar-length-input" min="40" max="70" value="60"></div>
                            <div class="option-item"><label for="bar-width-input">Width</label><input type="range" id="bar-width-input" min="15" max="200" value="50"></div>
                            <div class="option-item"><label for="bar-corner-input">Roundness</label><input type="range" id="bar-corner-input" min="0" max="50" value="15"></div>
                            <div class="option-item checkbox"><label for="bar-glow-normal-toggle">Glow</label><input type="checkbox" id="bar-glow-normal-toggle"></div>
                            <div class="option-group" id="bar-glow-normal-options">
                                <div class="option-item"><label for="bar-glow-intensity-input">Intensity</label><input type="range" id="bar-glow-intensity-input" min="0" max="30" value="0"></div>
                            </div>
                            <div class="option-item checkbox"><label for="bar-glow-neon-toggle">Neon</label><input type="checkbox" id="bar-glow-neon-toggle"></div>
                            <div class="option-group" id="bar-glow-neon-options">
                                <div class="option-item"><label for="bar-neon-intensity-input">Intensity</label><input type="range" id="bar-neon-intensity-input" min="0" max="50" value="0"></div>
                            </div>
                            <hr style="border-color: #444; margin: 15px 0;">
                            <label style="margin-bottom: 15px; display: block; text-align: left;">Border</label>
                            <div class="option-item"><label for="border-color-input">Color</label><input type="color" id="border-color-input" value="#FFFFFF"></div>
                            <div class="option-item"><label for="border-size-input">Size</label><input type="range" id="border-size-input" min="0" max="10" value="2"></div>
                            <div class="option-item checkbox"><label for="border-glow-toggle">Glow</label><input type="checkbox" id="border-glow-toggle"></div>
                            <div class="option-group" id="border-glow-options">
                                <div class="option-item"><label for="border-glow-color-input">Color</label><input type="color" id="border-glow-color-input" value="#FFFFFF"></div>
                                <div class="option-item"><label for="border-glow-intensity-input">Intensity</label><input type="range" id="border-glow-intensity-input" min="0" max="30" value="0"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="options-section collapsible">
                    <h3>Text</h3>
                    <div class="options-content-wrapper">
                        <div class="options-content">
                             <div class="option-item"><label for="numbers-position-select">Position</label><select id="numbers-position-select"><option value="above">Above</option><option value="inside">Inside</option></select></div>
                            <hr style="border-color: #444; margin: 15px 0;">
                            <label style="margin-bottom: 15px; display: block; text-align: left;">Percentage</label>
                            <div class="option-item"><label for="font-select">Font</label><select id="font-select"><option value="'Inter', system-ui, sans-serif">System</option><option value="'VT323', monospace">Retro</option><option value="'Press Start 2P', cursive">Pixel</option><option value="'Orbitron', sans-serif">Cyberpunk</option><option value="'Share Tech Mono', monospace">Tech Mono</option><option value="'Jersey 25', sans-serif">Jersey 25</option><option value="'Jersey 20', sans-serif">Jersey 20</option><option value="'Jersey 10', sans-serif">Jersey 10</option><option value="'Share Tech', sans-serif">Share Tech</option><option value="'Teko', sans-serif">Teko</option><option value="'Chakra Petch', sans-serif">Chakra Petch</option><option value="'Russo One', sans-serif">Russo One</option><option value="'Zen Dots', sans-serif">Zen Dots</option><option value="'Electrolyze', sans-serif">Electrolyze</option><option value="'Tomorrow', sans-serif">Tomorrow</option></select></div>
                            <div class="option-item"><label for="font-size-input">Size</label><input type="range" id="font-size-input" min="20" max="120" value="72"></div>
                            <div class="option-item"><label for="font-color-input">Color</label><input type="color" id="font-color-input" value="#FFFFFF"></div>
                            <div class="option-item checkbox"><label for="font-outline-toggle">Outline</label><input type="checkbox" id="font-outline-toggle"></div>
                            <div class="option-group" id="font-outline-options">
                                <div class="option-item"><label for="font-outline-size-input">Size</label><input type="range" id="font-outline-size-input" min="0" max="5" value="0"></div>
                                <div class="option-item"><label for="font-outline-color-input">Color</label><input type="color" id="font-outline-color-input" value="#000000"></div>
                            </div>
                            <div class="option-item checkbox"><label for="text-glow-normal-toggle">Glow</label><input type="checkbox" id="text-glow-normal-toggle"></div>
                             <div class="option-group" id="text-glow-normal-options">
                                <div class="option-item"><label for="text-glow-spread-input">Spread</label><input type="range" id="text-glow-spread-input" min="0" max="30" value="0"></div>
                             </div>
                            <div class="option-item checkbox"><label for="text-glow-neon-toggle">Neon</label><input type="checkbox" id="text-glow-neon-toggle"></div>
                            <div class="option-group" id="text-glow-neon-options">
                                <div class="option-item"><label for="text-neon-spread-input">Spread</label><input type="range" id="text-neon-spread-input" min="0" max="30" value="0"></div>
                            </div>
                             <div class="option-item"><label for="text-glow-color-input">Glow Color</label><input type="color" id="text-glow-color-input" value="#00ffcc"></div>
                            <hr style="border-color: #444; margin: 15px 0;">
                             <label style="margin-bottom: 15px; display: block; text-align: left;">Message</label>
                            <div class="option-item"><label for="message-input">Text</label><input type="text" id="message-input" value="Your custom message here"></div>
                            <div class="option-item"><label for="message-color-input">Color</label><input type="color" id="message-color-input" value="#cccccc"></div>
                            <div class="option-item"><label for="message-font-size-input">Size</label><input type="range" id="message-font-size-input" min="0.5" max="3" value="1.2" step="0.1"></div>
                            <div class="option-item checkbox"><label for="message-outline-toggle">Outline</label><input type="checkbox" id="message-outline-toggle"></div>
                            <div class="option-group" id="message-outline-options">
                                <div class="option-item"><label for="message-outline-size-input">Size</label><input type="range" id="message-outline-size-input" min="0" max="5" value="0"></div>
                                <div class="option-item"><label for="message-outline-color-input">Color</label><input type="color" id="message-outline-color-input" value="#000000"></div>
                            </div>
                            <div class="option-item checkbox"><label for="message-glow-normal-toggle">Glow</label><input type="checkbox" id="message-glow-normal-toggle"></div>
                            <div class="option-group" id="message-glow-normal-options">
                                <div class="option-item"><label for="message-glow-spread-input">Spread</label><input type="range" id="message-glow-spread-input" min="0" max="30" value="0"></div>
                            </div>
                             <div class="option-item checkbox"><label for="message-glow-neon-toggle">Neon</label><input type="checkbox" id="message-glow-neon-toggle"></div>
                            <div class="option-group" id="message-glow-neon-options">
                                <div class="option-item"><label for="message-neon-spread-input">Spread</label><input type="range" id="message-neon-spread-input" min="0" max="30" value="0"></div>
                            </div>
                            <div class="option-item"><label for="message-glow-color-input">Glow Color</label><input type="color" id="message-glow-color-input" value="#00ffcc"></div>
                            <div class="option-item"><label for="ellipsis-animation-select">Ellipsis</label><select id="ellipsis-animation-select"><option value="pulse">Pulse</option><option value="wave">Wave</option><option value="none">None</option></select></div>
                            <div class="option-item"><label for="ellipsis-intensity-input">Intensity</label><input type="range" id="ellipsis-intensity-input" min="0" max="20" value="5"></div>
                        </div>
                    </div>
                </div>
                
                <div class="options-section collapsible">
                    <h3>Icon</h3>
                    <div class="options-content-wrapper">
                        <div class="options-content">
                            <div class="option-item"><label for="icon-preset-select">Preset</label><select id="icon-preset-select"><option value="default">Gear</option><option value="star">Star</option><option value="heart">Heart</option><option value="wrench">Wrench</option><option value="sliders">Sliders</option><option value="ellipsis">Ellipsis</option><option value="info">Info</option><option value="menu" selected>Menu</option></select></div>
                            <div class="option-item"><label for="icon-position-select">Position</label><select id="icon-position-select"><option value="above-center">Above Center</option><option value="above-right" selected>Above Right</option></select></div>
                            <div class="option-item"><label for="icon-size-input">Size</label><input type="range" id="icon-size-input" min="20" max="120" value="50"></div>
                            <div class="option-item checkbox"><label for="icon-animation-toggle">Animate</label><input type="checkbox" id="icon-animation-toggle"></div>
                            <div class="option-item"><label for="icon-animation-style-select">Animation</label><select id="icon-animation-style-select"><option value="spin">Spin</option><option value="pulse">Pulse</option><option value="float">Float</option><option value="wobble">Wobble</option><option value="jello">Jello</option></select></div>
                            <div class="option-item"><label for="icon-animation-speed-input">Speed</label><input type="range" id="icon-animation-speed-input" min="0.5" max="10" value="2" step="0.1"></div>
                            <div class="option-item"><label for="icon-upload-input">Upload</label><input type="file" id="icon-upload-input" accept="image/*"></div>
                            <div class="option-item"><label>Clear</label><button id="clear-icon-btn">Clear Icon</button></div>
                        </div>
                    </div>
                </div>

                 <div class="options-section collapsible">
                    <h3>Background</h3>
                    <div class="options-content-wrapper">
                        <div class="options-content">
                            <div class="option-item"><label for="bg-color-input">Color</label><input type="color" id="bg-color-input" value="#121212"></div>
                            <div class="option-item"><label for="bg-image-upload">Upload</label><input type="file" id="bg-image-upload" accept="image/*"></div>
                            <div class="option-item"><label>Clear</label><button id="clear-bg-btn">Clear Image</button></div>
                        </div>
                    </div>
                </div>
                
                <div class="options-section collapsible">
                    <h3>Buttons</h3>
                    <div class="options-content-wrapper">
                        <div class="options-content">
                            <div class="option-item"><label for="start-btn-color">Start/Resume</label><input type="color" id="start-btn-color" value="#4CAF50"></div>
                            <div class="option-item"><label for="repeat-btn-color">Repeat</label><input type="color" id="repeat-btn-color" value="#03A9F4"></div>
                            <div class="option-item"><label for="btn-font-color-input">Font Color</label><input type="color" id="btn-font-color-input" value="#FFFFFF"></div>
                            <div class="option-item"><label for="btn-padding-y-input">Height</label><input type="range" id="btn-padding-y-input" min="2" max="20" value="10"></div>
                            <div class="option-item"><label for="btn-padding-x-input">Width</label><input type="range" id="btn-padding-x-input" min="5" max="40" value="22"></div>
                            <div class="option-item"><label for="btn-font-size-input">Font Size</label><input type="range" id="btn-font-size-input" min="0.5" max="2" value="1" step="0.1"></div>
                            <div class="option-item checkbox"><label for="btn-outline-toggle">Outline</label><input type="checkbox" id="btn-outline-toggle"></div>
                            <div class="option-group" id="btn-outline-options">
                                <div class="option-item"><label for="btn-outline-size-input">Size</label><input type="range" id="btn-outline-size-input" min="0" max="5" value="0"></div>
                                <div class="option-item"><label for="btn-outline-color-input">Color</label><input type="color" id="btn-outline-color-input" value="#000000"></div>
                            </div>
                            <hr style="border-color: #444; margin: 15px 0;">
                             <label style="margin-bottom: 15px; display: block; text-align: left;">Border</label>
                            <div class="option-item"><label for="btn-border-size-input">Size</label><input type="range" id="btn-border-size-input" min="0" max="10" value="0"></div>
                            <div class="option-item"><label for="btn-border-color-input">Color</label><input type="color" id="btn-border-color-input" value="#FFFFFF"></div>
                             <div class="option-item checkbox"><label for="btn-glow-normal-toggle">Glow</label><input type="checkbox" id="btn-glow-normal-toggle"></div>
                            <div class="option-group" id="btn-glow-normal-options">
                                <div class="option-item"><label for="btn-glow-intensity-input">Intensity</label><input type="range" id="btn-glow-intensity-input" min="0" max="20" value="0"></div>
                            </div>
                            <div class="option-item checkbox"><label for="btn-glow-neon-toggle">Neon</label><input type="checkbox" id="btn-glow-neon-toggle"></div>
                            <div class="option-group" id="btn-glow-neon-options">
                                <div class="option-item"><label for="btn-neon-intensity-input">Intensity</label><input type="range" id="btn-neon-intensity-input" min="0" max="20" value="0"></div>
                            </div>
                             <div class="option-item"><label for="btn-glow-color-input">Glow Color</label><input type="color" id="btn-glow-color-input" value="#FFFFFF"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="settings-management-external">
        <button id="save-settings-btn">Save Settings</button>
        <button id="reset-settings-btn">Reset to Default</button>
    </div>

    <div id="confirm-modal-overlay" class="hidden">
        <div id="confirm-modal">
            <p>Are you sure you want to reset all settings?</p>
            <div id="confirm-modal-buttons">
                <button id="confirm-yes">Yes</button>
                <button id="confirm-no">No</button>
            </div>
        </div>
    </div>
    
    <div id="save-confirm">Settings Saved!</div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM ELEMENT SELECTION ---
            const root = document.documentElement;
            const timerWrapper = document.querySelector('.timer-wrapper');
            const timerDisplay = document.getElementById('timer-display');
            const mainNumbers = document.getElementById('main-numbers');
            const timerMessage = document.getElementById('timer-message');
            const progressBar = document.getElementById('progress-bar');
            const progressBarContainer = document.getElementById('progress-bar-container');

            const startBtn = document.getElementById('start-btn');
            const pauseBtn = document.getElementById('pause-btn');
            const resumeBtn = document.getElementById('resume-btn');
            const repeatBtn = document.getElementById('repeat-btn');
            const optionsBtn = document.getElementById('options-btn');
            const iconAnimator = document.getElementById('icon-animator');
            const optionsPanelOverlay = document.getElementById('options-panel-overlay');
            const saveConfirm = document.getElementById('save-confirm');
            const confirmModalOverlay = document.getElementById('confirm-modal-overlay');
            const confirmYesBtn = document.getElementById('confirm-yes');
            const confirmNoBtn = document.getElementById('confirm-no');


            // Options Panel Inputs
            const allInputs = document.querySelectorAll('#options-panel input, #options-panel select');
            const durationInput = document.getElementById('duration-input');
            const durationUnit = document.getElementById('duration-unit');
            const messageInput = document.getElementById('message-input');
            const messageColorInput = document.getElementById('message-color-input');
            const messageFontSizeInput = document.getElementById('message-font-size-input');
            const messageOutlineToggle = document.getElementById('message-outline-toggle');
            const messageOutlineOptions = document.getElementById('message-outline-options');
            const messageOutlineSizeInput = document.getElementById('message-outline-size-input');
            const messageOutlineColorInput = document.getElementById('message-outline-color-input');
            const messageGlowToggle = document.getElementById('message-glow-normal-toggle');
            const messageGlowOptions = document.getElementById('message-glow-normal-options');
            const messageGlowColorInput = document.getElementById('message-glow-color-input');
            const messageGlowSpreadInput = document.getElementById('message-glow-spread-input');
            const messageNeonToggle = document.getElementById('message-glow-neon-toggle');
            const messageNeonOptions = document.getElementById('message-glow-neon-options');
            const messageNeonSpreadInput = document.getElementById('message-neon-spread-input');
            const ellipsisAnimationSelect = document.getElementById('ellipsis-animation-select');
            const ellipsisIntensityInput = document.getElementById('ellipsis-intensity-input');
            const alarmSoundSelect = document.getElementById('alarm-sound-select');
            const barColorInput = document.getElementById('bar-color-input');
            const barGradientToggle = document.getElementById('bar-gradient-toggle');
            const barGradientOptions = document.getElementById('bar-gradient-options');
            const barGradientStartInput = document.getElementById('bar-gradient-start-input');
            const barGradientEndInput = document.getElementById('bar-gradient-end-input');
            const barLengthInput = document.getElementById('bar-length-input');
            const barWidthInput = document.getElementById('bar-width-input');
            const barCornerInput = document.getElementById('bar-corner-input');
            const barGlowIntensityInput = document.getElementById('bar-glow-intensity-input');
            const barNeonIntensityInput = document.getElementById('bar-neon-intensity-input');
            const barGlowNormalToggle = document.getElementById('bar-glow-normal-toggle');
            const barGlowNeonToggle = document.getElementById('bar-glow-neon-toggle');
            const barGlowNormalOptions = document.getElementById('bar-glow-normal-options');
            const barGlowNeonOptions = document.getElementById('bar-glow-neon-options');
            const borderColorInput = document.getElementById('border-color-input');
            const borderSizeInput = document.getElementById('border-size-input');
            const borderGlowToggle = document.getElementById('border-glow-toggle');
            const borderGlowOptions = document.getElementById('border-glow-options');
            const borderGlowColorInput = document.getElementById('border-glow-color-input');
            const borderGlowIntensityInput = document.getElementById('border-glow-intensity-input');
            const fontSelect = document.getElementById('font-select');
            const fontSizeInput = document.getElementById('font-size-input');
            const fontColorInput = document.getElementById('font-color-input');
            const fontOutlineColorInput = document.getElementById('font-outline-color-input');
            const fontOutlineToggle = document.getElementById('font-outline-toggle');
            const fontOutlineOptions = document.getElementById('font-outline-options');
            const fontOutlineSizeInput = document.getElementById('font-outline-size-input');
            const textGlowColorInput = document.getElementById('text-glow-color-input');
            const textGlowSpreadInput = document.getElementById('text-glow-spread-input');
            const textNeonSpreadInput = document.getElementById('text-neon-spread-input');
            const textGlowNormalToggle = document.getElementById('text-glow-normal-toggle');
            const textGlowNeonToggle = document.getElementById('text-glow-neon-toggle');
            const textGlowNormalOptions = document.getElementById('text-glow-normal-options');
            const textGlowNeonOptions = document.getElementById('text-glow-neon-options');
            const numbersPositionSelect = document.getElementById('numbers-position-select');
            const iconPresetSelect = document.getElementById('icon-preset-select');
            const iconPositionSelect = document.getElementById('icon-position-select');
            const iconAnimationToggle = document.getElementById('icon-animation-toggle');
            const iconAnimationStyleSelect = document.getElementById('icon-animation-style-select');
            const iconAnimationSpeedInput = document.getElementById('icon-animation-speed-input');
            const iconSizeInput = document.getElementById('icon-size-input');
            const iconUploadInput = document.getElementById('icon-upload-input');
            const clearIconBtn = document.getElementById('clear-icon-btn');
            const bgColorInput = document.getElementById('bg-color-input');
            const bgImageUploadInput = document.getElementById('bg-image-upload');
            const clearBgBtn = document.getElementById('clear-bg-btn');
            const startBtnColorInput = document.getElementById('start-btn-color');
            const repeatBtnColorInput = document.getElementById('repeat-btn-color');
            const btnPaddingYInput = document.getElementById('btn-padding-y-input');
            const btnPaddingXInput = document.getElementById('btn-padding-x-input');
            const btnFontSizeInput = document.getElementById('btn-font-size-input');
            const btnFontColorInput = document.getElementById('btn-font-color-input');
            const btnBorderSizeInput = document.getElementById('btn-border-size-input');
            const btnBorderColorInput = document.getElementById('btn-border-color-input');
            const btnOutlineToggle = document.getElementById('btn-outline-toggle');
            const btnOutlineOptions = document.getElementById('btn-outline-options');
            const btnOutlineSizeInput = document.getElementById('btn-outline-size-input');
            const btnOutlineColorInput = document.getElementById('btn-outline-color-input');
            const btnGlowNormalToggle = document.getElementById('btn-glow-normal-toggle');
            const btnGlowNormalOptions = document.getElementById('btn-glow-normal-options');
            const btnGlowIntensityInput = document.getElementById('btn-glow-intensity-input');
            const btnGlowNeonToggle = document.getElementById('btn-glow-neon-toggle');
            const btnGlowNeonOptions = document.getElementById('btn-glow-neon-options');
            const btnNeonIntensityInput = document.getElementById('btn-neon-intensity-input');
            const btnGlowColorInput = document.getElementById('btn-glow-color-input');
            const saveSettingsBtn = document.getElementById('save-settings-btn');
            const resetSettingsBtn = document.getElementById('reset-settings-btn');
            
            // --- STATE & PRESET DATA ---
            let totalDuration, timeRemaining;
            let isRunning = false, isPaused = false;
            let audioContext;
            let wasRunningBeforeSettings = false;

            const presetIcons = {
                default: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M495.9 166.6c3.2 8.7 .5 18.4-6.4 24.6l-43.3 39.4c1.1 8.3 1.7 16.8 1.7 25.4s-.6 17.1-1.7 25.4l43.3 39.4c6.9 6.2 9.6 15.9 6.4 24.6c-4.4 11.9-15.7 20-28.1 20h-86.9c-3.5-10.1-8-19.6-13.3-28.5l-26.4 45.8c-6.2 10.7-18.2 17.2-30.8 17.2s-24.6-6.5-30.8-17.2l-26.4-45.8c-5.3 8.9-10.8 18.4-13.3 28.5H32.4c-12.4 0-23.7-8.1-28.1-20c-3.2-8.7-.5-18.4 6.4-24.6l43.3-39.4C52.6 273.1 52 264.6 52 256s.6-17.1 1.7-25.4L10.4 191.2c-6.9-6.2-9.6-15.9-6.4-24.6C8.4 154.7 19.7 146.6 32.1 146.6h86.9c3.5 10.1 8 19.6 13.3 28.5l26.4-45.8c6.2-10.7 18.2-17.2 30.8-17.2s-24.6 6.5 30.8 17.2l26.4 45.8c5.3-8.9 10.8-18.4 13.3-28.5h86.9c12.4 0 23.7 8.1 28.1 20zM256 336a80 80 0 1 0 0-160 80 80 0 1 0 0 160z"/></svg>',
                star: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><path d="M316.9 18C311.6 7 300.4 0 288.1 0s-23.4 7-28.8 18L195 150.3 51.4 171.5c-12 1.8-22 10.2-25.7 21.7s-.7 24.2 7.9 32.7L137.8 329 113.2 474.7c-2 12 3 24.2 12.9 31.3s23 8 33.8 2.3l128.3-68.5 128.3 68.5c10.8 5.7 23.9 4.9 33.8-2.3s14.9-19.3 12.9-31.3L438.5 329 542.7 225.9c8.6-8.5 11.7-21.2 7.9-32.7s-13.7-19.9-25.7-21.7L381.2 150.3 316.9 18z"/></svg>',
                heart: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M47.6 300.4L228.3 469.1c7.5 7 17.4 10.9 27.7 10.9s20.2-3.9 27.7-10.9L464.4 300.4c30.4-28.3 47.6-68 47.6-109.5v-5.8c0-69.9-50.5-129.5-119.4-141C347 36.5 300.6 51.4 268 84L256 96 244 84c-32.6-32.6-79-47.5-124.6-39.9C50.5 55.6 0 115.2 0 185.1v5.8c0 41.5 17.2 81.2 47.6 109.5z"/></svg>',
                wrench: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M148.4 69.3c-10.2-10.2-23.8-15.6-38.2-15.6s-28 5.4-38.2 15.6L15.6 125.7c-10.2 10.2-15.6 23.8-15.6 38.2s5.4 28 15.6 38.2l99.3 99.3-39.5 39.5-32-32c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l64 64c12.5 12.5 32.8 12.5 45.3 0l32-32 39.5-39.5 99.3 99.3c10.2 10.2 23.8 15.6 38.2 15.6s28-5.4 38.2-15.6l56.4-56.4c10.2-10.2 15.6-23.8 15.6-38.2s-5.4-28-15.6-38.2L329.8 247.4l68-68c10.2-10.2 15.6-23.8 15.6-38.2s-5.4-28-15.6-38.2l-56.4-56.4c-10.2-10.2-23.8-15.6-38.2-15.6s-28 5.4-38.2 15.6l-68 68L148.4 69.3z"/></svg>',
                sliders: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M368 128h-8v-24c0-13.3-10.7-24-24-24s-24 10.7-24 24v24h-8c-13.3 0-24 10.7-24 24s10.7 24 24 24h8v264c0 13.3 10.7 24 24 24s24-10.7 24-24V176h8c13.3 0 24-10.7 24-24s-10.7-24-24-24zm-96 232h-8V24c0-13.3-10.7-24-24-24S216 10.7 216 24v336h-8c-13.3 0-24 10.7-24 24s10.7 24 24 24h64c13.3 0 24-10.7 24-24s-10.7-24-24-24zm-96-64h-8V152c0-13.3-10.7-24-24-24s-24 10.7-24 24v144h-8c-13.3 0-24 10.7-24 24s10.7 24 24 24h64c13.3 0 24-10.7 24-24s-10.7-24-24-24z"/></svg>',
                ellipsis: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M328 256c0 39.8-32.2 72-72 72s-72-32.2-72-72 32.2-72 72-72 72 32.2 72 72zm104-72c-39.8 0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72zm-352 0c-39.8 0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72z"/></svg>',
                info: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M256 512A256 256 0 1 0 256 0a256 256 0 1 0 0 512zM216 336h24V272H216c-13.3 0-24-10.7-24-24s10.7-24 24-24h48c13.3 0 24 10.7 24 24v88h8c13.3 0 24 10.7 24 24s-10.7 24-24 24H216c-13.3 0-24-10.7-24-24s10.7-24 24-24zm40-144a32 32 0 1 1 0-64 32 32 0 1 1 0 64z"/></svg>',
                menu: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M0 96C0 78.3 14.3 64 32 64H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32C14.3 128 0 113.7 0 96zM0 256c0-17.7 14.3-32 32-32H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32c-17.7 0-32-14.3-32-32zM448 416c0 17.7-14.3 32-32 32H32c-17.7 0-32-14.3-32-32s14.3-32 32-32H416c17.7 0 32 14.3 32 32z"/></svg>'
            };

            // --- HELPER FUNCTIONS ---
            const toggleButtons = (showStart, showPause, showResume, showRepeat) => {
                startBtn.classList.toggle('hidden', !showStart);
                pauseBtn.classList.toggle('hidden', !showPause);
                resumeBtn.classList.toggle('hidden', !showResume);
                repeatBtn.classList.toggle('hidden', !showRepeat);
            };

            const updateTimerMessage = (text) => {
                if (text.endsWith('...')) {
                    const mainText = text.slice(0, -3);
                    const animationType = ellipsisAnimationSelect.value;
                    timerMessage.innerHTML = `<span>${mainText}</span><span class="ellipsis ${animationType}"><span class="ellipsis-dot">.</span><span class="ellipsis-dot">.</span><span class="ellipsis-dot">.</span></span>`;
                } else {
                    timerMessage.innerHTML = ''; // Clear previous content
                    timerMessage.textContent = text;
                }
            };

            // --- TIMER LOGIC ---
            const updateDisplay = () => {
                if (!totalDuration) return;
                const elapsedTime = totalDuration - timeRemaining;
                let percentage = (elapsedTime / totalDuration) * 100;
                
                if (percentage < 0) percentage = 0;
                if (percentage > 100) percentage = 100;

                mainNumbers.textContent = `${percentage.toFixed(2)}%`;
                progressBar.style.width = `${percentage}%`;
            };
            
            let lastTick = performance.now();
            const timerLoop = (now) => {
                if (!isRunning || isPaused) return;

                const delta = now - lastTick;
                lastTick = now;
                timeRemaining -= delta;

                if (timeRemaining <= 0) {
                    timeRemaining = 0;
                    isRunning = false;
                    isPaused = false;
                    playAlarm();
                    toggleButtons(false, false, false, true); // show repeat
                }
                
                updateDisplay();

                if (isRunning) {
                   requestAnimationFrame(timerLoop);
                }
            };

            const startTimer = () => {
                if (isRunning) return;
                timerWrapper.classList.remove('timer-paused');
                timerWrapper.classList.add('timer-running');
                if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                isRunning = true;
                isPaused = false;
                lastTick = performance.now();
                requestAnimationFrame(timerLoop);
                toggleButtons(false, false, false, false); 
            };

            const pauseTimer = () => {
                if (!isRunning || isPaused) return;
                isPaused = true;
                timerWrapper.classList.remove('timer-running');
                timerWrapper.classList.add('timer-paused');
                toggleButtons(false, false, true, true); 
                setTimeout(updateUIPositions, 0);
            };

            const resumeTimer = () => {
                if (!isPaused) return;
                isPaused = false;
                timerWrapper.classList.remove('timer-paused');
                timerWrapper.classList.add('timer-running');
                lastTick = performance.now();
                requestAnimationFrame(timerLoop);
                toggleButtons(false, false, false, false);
                setTimeout(updateUIPositions, 0);
            };

            const resetTimer = () => {
                timerWrapper.classList.remove('timer-paused', 'timer-running');
                isRunning = false;
                isPaused = false;
                const unit = durationUnit.value;
                const durationValue = parseFloat(durationInput.value);
                if (unit === 'hours') {
                    totalDuration = durationValue * 60 * 60 * 1000;
                } else { // minutes
                    totalDuration = durationValue * 60 * 1000;
                }
                timeRemaining = totalDuration;
                updateDisplay();
                toggleButtons(true, false, false, false); 
            };

            // --- ALARM SOUND ---
            const playAlarm = () => {
                const sound = alarmSoundSelect.value;
                if (sound === 'none' || !audioContext) return;

                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                gainNode.gain.setValueAtTime(0.5, audioContext.currentTime);

                switch(sound) {
                    case 'beep':
                        oscillator.frequency.setValueAtTime(880, audioContext.currentTime);
                        break;
                    case 'chime':
                        oscillator.type = 'triangle';
                        oscillator.frequency.setValueAtTime(1046.50, audioContext.currentTime); 
                        oscillator.frequency.setValueAtTime(783.99, audioContext.currentTime + 0.2); 
                        break;
                    case 'buzz':
                        oscillator.type = 'sawtooth';
                        oscillator.frequency.setValueAtTime(220, audioContext.currentTime); 
                        break;
                }
                oscillator.start();
                setTimeout(() => oscillator.stop(), 500);
            };

            // --- EVENT LISTENERS ---
            startBtn.addEventListener('click', startTimer);
            pauseBtn.addEventListener('click', pauseTimer);
            resumeBtn.addEventListener('click', resumeTimer);
            repeatBtn.addEventListener('click', () => { resetTimer(); startTimer(); });
            durationInput.addEventListener('change', resetTimer);
            durationUnit.addEventListener('change', resetTimer);

            document.addEventListener('keydown', (e) => {
                if (e.code === 'Space' && e.target.tagName !== 'INPUT' && e.target.tagName !== 'SELECT') {
                    e.preventDefault();
                    if (!isRunning && !isPaused) startTimer();
                    else if (isPaused) resumeTimer();
                    else if (isRunning) pauseTimer();
                }
            });

            document.body.addEventListener('click', (e) => {
                const isClickOnInteractiveUI = e.target.closest('#options-btn') || e.target.closest('#options-panel') || e.target.closest('#settings-management-external') || (e.target.tagName === 'BUTTON' && e.target.closest('#controls'));
                if (isClickOnInteractiveUI) return;

                if (isRunning && !isPaused) pauseTimer();
                else if (isPaused) resumeTimer();
            });

            optionsBtn.addEventListener('click', () => {
                if (isRunning && !isPaused) {
                    wasRunningBeforeSettings = true;
                    pauseTimer();
                }
                optionsPanelOverlay.classList.add('visible');
                document.body.classList.add('settings-open');
            });

            optionsPanelOverlay.addEventListener('click', (e) => {
                if (e.target === optionsPanelOverlay) {
                    if (wasRunningBeforeSettings) {
                        resumeTimer();
                    }
                    wasRunningBeforeSettings = false; // Reset flag
                    optionsPanelOverlay.classList.remove('visible');
                    document.body.classList.remove('settings-open');
                }
            });

            // Collapsible sections
            document.querySelectorAll('.options-section.collapsible h3').forEach(header => {
                header.addEventListener('click', () => {
                    header.parentElement.classList.toggle('is-open');
                });
            });
            
            // --- SETTINGS MANAGEMENT ---
            saveSettingsBtn.addEventListener('click', () => {
                const settings = {};
                allInputs.forEach(input => {
                    // We don't save file inputs
                    if (input.type === 'file') return;
                    
                    if (input.type === 'checkbox') {
                        settings[input.id] = input.checked;
                    } else {
                        settings[input.id] = input.value;
                    }
                });
                localStorage.setItem('progressBarTimerSettings', JSON.stringify(settings));
                
                // Show save confirmation
                saveConfirm.classList.add('visible');
                setTimeout(() => {
                    saveConfirm.classList.remove('visible');
                }, 1500);
            });

            resetSettingsBtn.addEventListener('click', () => {
                confirmModalOverlay.classList.remove('hidden');
            });

            confirmYesBtn.addEventListener('click', () => {
                localStorage.removeItem('progressBarTimerSettings');
                location.reload();
            });
            
            confirmNoBtn.addEventListener('click', () => {
                confirmModalOverlay.classList.add('hidden');
            });


            function loadAndApplySettings() {
                const savedSettings = localStorage.getItem('progressBarTimerSettings');
                if (!savedSettings) return;

                const settings = JSON.parse(savedSettings);

                allInputs.forEach(input => {
                    if (settings[input.id] !== undefined) {
                        if (input.type === 'checkbox') {
                            input.checked = settings[input.id];
                        } else {
                            input.value = settings[input.id];
                        }
                        // Dispatch events to trigger the live update listeners
                        input.dispatchEvent(new Event('input', { bubbles: true }));
                        input.dispatchEvent(new Event('change', { bubbles: true }));
                    }
                });
            }


            // --- LIVE CUSTOMIZATION ---
            const setCssVar = (name, value, unit = '') => root.style.setProperty(name, value + unit);
            
            messageInput.addEventListener('input', (e) => updateTimerMessage(e.target.value));
            ellipsisAnimationSelect.addEventListener('change', () => updateTimerMessage(messageInput.value));
            ellipsisIntensityInput.addEventListener('input', (e) => {
                const intensityValue = parseFloat(e.target.value); // 0-10
                const pulseScale = 1 + (intensityValue / 10) * 0.5; // maps to 1.0 - 1.5
                const waveOpacity = 0.5 - (intensityValue / 10) * 0.4; // maps to 0.5 - 0.1
                setCssVar('--ellipsis-pulse-scale', pulseScale);
                setCssVar('--ellipsis-wave-opacity', waveOpacity);
            });

            messageFontSizeInput.addEventListener('input', (e) => setCssVar('--message-font-size', e.target.value, 'rem'));
            messageColorInput.addEventListener('input', e => setCssVar('--message-color', e.target.value));
            messageGlowColorInput.addEventListener('input', e => setCssVar('--message-glow-color', e.target.value));
            messageOutlineSizeInput.addEventListener('input', e => setCssVar('--message-outline-size', e.target.value, 'px'));
            messageOutlineColorInput.addEventListener('input', e => setCssVar('--message-outline-color', e.target.value));

            barLengthInput.addEventListener('input', (e) => setCssVar('--bar-length', e.target.value, 'vw'));
            barWidthInput.addEventListener('input', (e) => setCssVar('--bar-width', e.target.value, 'px'));
            barCornerInput.addEventListener('input', (e) => setCssVar('--bar-corner-radius', e.target.value, 'px'));
            borderColorInput.addEventListener('input', e => setCssVar('--border-color', e.target.value));
            borderSizeInput.addEventListener('input', e => setCssVar('--border-size', e.target.value, 'px'));
            
            fontSelect.addEventListener('change', (e) => setCssVar('--font-family', e.target.value));
            fontSizeInput.addEventListener('input', (e) => setCssVar('--font-size', e.target.value, 'px'));
            fontColorInput.addEventListener('input', (e) => setCssVar('--font-color', e.target.value));
            fontOutlineColorInput.addEventListener('input', (e) => setCssVar('--font-outline-color', e.target.value));
            textGlowColorInput.addEventListener('input', (e) => setCssVar('--text-glow-color', e.target.value));
            
            iconPresetSelect.addEventListener('change', e => {
                const iconKey = e.target.value;
                if(presetIcons[iconKey]) {
                    iconAnimator.innerHTML = presetIcons[iconKey];
                    iconAnimator.style.backgroundImage = 'none';
                    iconAnimator.classList.remove('custom-icon');
                    iconUploadInput.value = '';
                }
            });

            function applyIconAnimation() {
                iconAnimator.classList.remove('animated-spin', 'animated-pulse', 'animated-float', 'animated-wobble', 'animated-jello');
                if (iconAnimationToggle.checked) {
                    const style = iconAnimationStyleSelect.value;
                    iconAnimator.classList.add(`animated-${style}`);
                }
            }

            iconAnimationToggle.addEventListener('change', applyIconAnimation);
            iconAnimationStyleSelect.addEventListener('change', applyIconAnimation);

            iconAnimationSpeedInput.addEventListener('input', (e) => setCssVar('--options-btn-animation-speed', e.target.value, 's'));
            iconSizeInput.addEventListener('input', (e) => setCssVar('--options-btn-size', e.target.value, 'px'));
            
            iconUploadInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        iconAnimator.style.backgroundImage = `url(${event.target.result})`;
                        iconAnimator.innerHTML = '';
                        iconAnimator.classList.add('custom-icon');

                        let customOption = iconPresetSelect.querySelector('option[value="custom"]');
                        if (!customOption) {
                            customOption = document.createElement('option');
                            customOption.value = 'custom';
                            customOption.textContent = 'Custom (Uploaded)';
                            iconPresetSelect.appendChild(customOption);
                        }
                        iconPresetSelect.value = 'custom';
                    };
                    reader.readAsDataURL(file);
                }
            });
            clearIconBtn.addEventListener('click', () => {
                iconAnimator.innerHTML = presetIcons.menu;
                iconAnimator.style.backgroundImage = 'none';
                iconAnimator.classList.remove('custom-icon');
                iconUploadInput.value = '';
                iconPresetSelect.value = 'menu';
                const customOption = iconPresetSelect.querySelector('option[value="custom"]');
                if (customOption) {
                    customOption.remove();
                }
            });

            const updateUIPositions = () => {
                // Logic for number position
                if (numbersPositionSelect.value === 'inside') {
                    const timerDisplayHeight = timerDisplay.offsetHeight;
                    const messageHeight = timerMessage.offsetHeight;
                    const barHeight = progressBarContainer.offsetHeight;
                    const translation = messageHeight + 15 + (barHeight / 2) - (timerDisplayHeight / 2); // 15 is margin
                    
                    setCssVar('--numbers-position-transform', `translateY(${translation}px)`);
                    setCssVar('--numbers-z-index', '3');
                    setCssVar('--numbers-position-bottom', 'auto');
                } else { 
                    setCssVar('--numbers-position-transform', 'translateY(0)');
                    setCssVar('--numbers-z-index', '1');
                    setCssVar('--numbers-position-bottom', '20px');
                }

                // Logic for icon position (runs after a short delay to allow DOM to update)
                setTimeout(() => {
                    const timerDisplayRect = timerDisplay.getBoundingClientRect();
                    const wrapperRect = timerWrapper.getBoundingClientRect();
                    const iconHeight = optionsBtn.offsetHeight;
                    const desiredGap = 0; // Final tweak to move it down a little more
                    
                    const iconTop = (timerDisplayRect.top - wrapperRect.top) - iconHeight - desiredGap;
                    optionsBtn.style.top = `${iconTop}px`;

                    if (iconPositionSelect.value === 'above-right') {
                        optionsBtn.style.left = `calc(50% + ${parseFloat(barLengthInput.value)/2}vw)`;
                        optionsBtn.style.transform = 'translateX(-100%)';
                    } else { // 'above-center'
                        optionsBtn.style.left = '50%';
                        optionsBtn.style.transform = 'translateX(-50%)';
                    }
                }, 50);
            };

            [numbersPositionSelect, fontSizeInput, barWidthInput, fontSelect, messageFontSizeInput, iconSizeInput, iconPositionSelect, barLengthInput].forEach(el => {
                el.addEventListener('input', updateUIPositions);
            });
            
            bgColorInput.addEventListener('input', (e) => {
                 document.body.style.backgroundImage = 'none'; 
                 setCssVar('--bg-color', e.target.value);
            });
            bgImageUploadInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => document.body.style.backgroundImage = `url(${event.target.result})`;
                    reader.readAsDataURL(file);
                }
            });
            clearBgBtn.addEventListener('click', () => {
                document.body.style.backgroundImage = 'none';
                bgImageUploadInput.value = '';
            });
            
            startBtnColorInput.addEventListener('input', (e) => setCssVar('--start-btn-color', e.target.value));
            repeatBtnColorInput.addEventListener('input', (e) => setCssVar('--repeat-btn-color', e.target.value));
            
            btnPaddingYInput.addEventListener('input', e => setCssVar('--btn-padding-y', e.target.value, 'px'));
            btnPaddingXInput.addEventListener('input', e => setCssVar('--btn-padding-x', e.target.value, 'px'));
            btnFontSizeInput.addEventListener('input', e => setCssVar('--btn-font-size', e.target.value, 'rem'));
            btnBorderColorInput.addEventListener('input', e => setCssVar('--btn-border-color', e.target.value));
            btnFontColorInput.addEventListener('input', e => setCssVar('--btn-font-color', e.target.value));
            btnOutlineSizeInput.addEventListener('input', e => setCssVar('--btn-outline-size', e.target.value, 'px'));
            btnOutlineColorInput.addEventListener('input', e => setCssVar('--btn-outline-color', e.target.value));
            
             // --- GLOW TOGGLE LOGIC ---
            function setupGlowToggle(toggle, group, intensityInput, cssVar) {
                if(!toggle || !group || !intensityInput) return; // Prevent error if element is missing
                function updateState() {
                    const isEnabled = toggle.checked;
                    group.classList.toggle('disabled', !isEnabled);
                    if (!isEnabled) {
                        setCssVar(cssVar, '0px'); // Turn off glow
                    } else {
                        setCssVar(cssVar, `${intensityInput.value}px`); // Restore glow from slider
                    }
                }

                toggle.addEventListener('change', updateState);
                intensityInput.addEventListener('input', (e) => {
                    if (toggle.checked) {
                        setCssVar(cssVar, `${e.target.value}px`);
                    }
                });

                // Initial state on load
                updateState();
            }
            
            function setupMutuallyExclusiveGlows(normalToggle, normalGroup, normalIntensity, normalVar, neonToggle, neonGroup, neonIntensity, neonVar) {
                if(!normalToggle || !neonToggle) return; // Prevent errors
                function updateState(changedToggle) {
                    if (changedToggle === 'normal' && normalToggle.checked) {
                        neonToggle.checked = false;
                    } else if (changedToggle === 'neon' && neonToggle.checked) {
                        normalToggle.checked = false;
                    }
                    
                    const normalEnabled = normalToggle.checked;
                    const neonEnabled = neonToggle.checked;

                    normalGroup.classList.toggle('disabled', !normalEnabled);
                    neonGroup.classList.toggle('disabled', !neonEnabled);

                    setCssVar(normalVar, normalEnabled ? `${normalIntensity.value}px` : '0px');
                    setCssVar(neonVar, neonEnabled ? `${neonIntensity.value}px` : '0px');
                }

                normalToggle.addEventListener('change', () => updateState('normal'));
                neonToggle.addEventListener('change', () => updateState('neon'));
                
                normalIntensity.addEventListener('input', () => updateState());
                neonIntensity.addEventListener('input', () => updateState());
                
                updateState(); // Initial call
            }
            
             function setupGradientToggle(toggle, colorInput, gradientGroup, startInput, endInput, cssVar) {
                if(!toggle) return;
                const colorOption = document.getElementById('bar-color-option');
                function updateState() {
                    const isGradient = toggle.checked;
                    gradientGroup.classList.toggle('disabled', !isGradient);
                    if(colorOption) colorOption.classList.toggle('disabled', isGradient);

                    if (isGradient) {
                        setCssVar(cssVar, `linear-gradient(90deg, ${startInput.value}, ${endInput.value})`);
                    } else {
                        setCssVar(cssVar, colorInput.value);
                    }
                }
                toggle.addEventListener('change', updateState);
                colorInput.addEventListener('input', updateState);
                startInput.addEventListener('input', updateState);
                endInput.addEventListener('input', updateState);
                updateState();
            }

            setupGradientToggle(barGradientToggle, barColorInput, barGradientOptions, barGradientStartInput, barGradientEndInput, '--bar-background');
            setupMutuallyExclusiveGlows(barGlowNormalToggle, barGlowNormalOptions, barGlowIntensityInput, '--bar-glow-intensity', barGlowNeonToggle, barGlowNeonOptions, barNeonIntensityInput, '--bar-neon-intensity');
            setupMutuallyExclusiveGlows(textGlowNormalToggle, textGlowNormalOptions, textGlowSpreadInput, '--text-glow-spread', textGlowNeonToggle, textGlowNeonOptions, textNeonSpreadInput, '--text-neon-spread');
            setupMutuallyExclusiveGlows(messageGlowToggle, messageGlowOptions, messageGlowSpreadInput, '--message-glow-spread', messageNeonToggle, messageNeonOptions, messageNeonSpreadInput, '--message-neon-spread');
            setupGlowToggle(borderGlowToggle, borderGlowOptions, borderGlowIntensityInput, '--border-glow-intensity');
            setupGlowToggle(fontOutlineToggle, fontOutlineOptions, fontOutlineSizeInput, '--font-outline-size');
            setupGlowToggle(messageOutlineToggle, messageOutlineOptions, messageOutlineSizeInput, '--message-outline-size');
            setupGlowToggle(btnOutlineToggle, btnOutlineOptions, btnOutlineSizeInput, '--btn-outline-size');
            setupMutuallyExclusiveGlows(btnGlowNormalToggle, btnGlowNormalOptions, btnGlowIntensityInput, '--btn-glow-intensity', btnGlowNeonToggle, btnGlowNeonOptions, btnNeonIntensityInput, '--btn-neon-intensity');
            borderGlowColorInput.addEventListener('input', e => setCssVar('--border-glow-color', e.target.value));

            window.addEventListener('resize', () => {
                updateDisplay();
                updateUIPositions();
            });

            // --- INITIALIZATION ---
            iconAnimator.innerHTML = presetIcons.menu; // Load default icon into the correct container
            resetTimer(); 
            updateTimerMessage(messageInput.value);
            loadAndApplySettings();
            // Final UI position update after loading settings
            updateUIPositions();
            if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("service-worker.js")
    .then(() => console.log("Service Worker registered successfully"))
    .catch(err => console.error("Service Worker registration failed:", err));
        };
    </script>
</body>
</html>






