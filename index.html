<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no, viewport-fit=cover">
    <title>Customizable Progress Bar Timer</title>
    
    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Timer">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#1a1a1a">
    <meta name="msapplication-navbutton-color" content="#1a1a1a">
    <meta name="apple-touch-fullscreen" content="yes">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <!-- Google Fonts for different styles --><link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch&family=Electrolyze&family=Jersey+10&family=Jersey+20&family=Jersey+25&family=Orbitron:wght@400;700&family=Press+Start+2P&family=Russo+One&family=Share+Tech&family=Share+Tech+Mono&family=Teko&family=Tomorrow&family=VT323&family=Zen+Dots&display=swap" rel="stylesheet">

    <style>
        /* --- Font Preloading --- */
        .font-preloader {
            font-family: 'Inter', system-ui, sans-serif;
            font-family: 'VT323', monospace;
            font-family: 'Press Start 2P', cursive;
            font-family: 'Share Tech Mono', monospace;
            font-family: 'Jersey 25', sans-serif;
            font-family: 'Jersey 20', sans-serif;
            font-family: 'Jersey 10', sans-serif;
            font-family: 'Share Tech', sans-serif;
            font-family: 'Electrolyze', sans-serif;
            position: absolute;
            left: -9999px;
            opacity: 0;
            pointer-events: none;
        }

        /* --- Pixel Font Size Adjustment --- */
        #timer-display[style*="Press Start 2P"] {
            font-size: calc(var(--font-size) * 0.7) !important;
        }
        
        #timer-message[style*="Press Start 2P"] {
            font-size: calc(var(--message-font-size) * 0.7) !important;
        }

        /* --- iPhone 14 Vertical Mode Settings Icon Position --- */
        @media screen and (max-width: 430px) and (max-height: 932px) and (orientation: portrait) {
            #options-btn {
                right: 20px !important;
                left: auto !important;
            }
        }

        /* --- Start Button Width for All Screens --- */
        #start-btn {
            padding: 10px 32px !important;
        }

        /* --- iPhone 14 & 13 Vertical Mode Start Button Size --- */
        @media screen and (max-width: 430px) and (orientation: portrait) {
            #start-btn {
                padding: 10px 12px !important;
                font-size: 1rem !important;
            }
        }

        /* --- CSS Custom Properties (Variables) --- */
        :root {
            --bar-color: #4CAF50; /* Green */
            --bar-length: 60vw; /* Decreased default length */
            --bar-width: 50px; /* Default width changed */
            --bar-corner-radius: 0px;
            --bar-glow-intensity: 0px;
            --bar-neon-intensity: 0px;
            --bar-gradient-start: #4CAF50;
            --bar-gradient-end: #03A9F4;
            --bar-background: var(--bar-color);
            --border-color: #FFFFFF;
            --border-size: 2px;
            --border-glow-color: #ffffff;
            --border-glow-intensity: 0px;
            --border-neon-intensity: 0px;
            --font-family: 'Inter', system-ui, sans-serif;
            --font-size: 72px;
            --font-color: #FFFFFF;
            --font-outline-color: #000000;
            --font-outline-size: 0px;
            --text-glow-color: #00ffcc; 
            --text-glow-spread: 0px;
            --text-neon-spread: 0px;
            --bg-color: #121212;
            --start-btn-color: #4CAF50;
            --pause-btn-color: #FFC107;
            --repeat-btn-color: #03A9F4;
            --end-btn-color: #f44336;

            /* New variables for UI elements */
            --options-btn-size: 50px;
            --options-btn-animation-speed: 2s; /* Much faster default speed */
            --message-font-size: 1.2rem;
            --message-color: #ccc;
            --message-glow-color: #00ffcc;
            --message-glow-spread: 0px;
            --message-neon-spread: 0px;
            --message-outline-size: 0px;
            --message-outline-color: #000000;
            
            /* New variables for ellipsis animation */
            --ellipsis-pulse-scale: 1.25;
            --ellipsis-wave-opacity: 0.3;

            /* New variables for button styling */
            --btn-padding-y: 10px;
            --btn-padding-x: 22px;
            --btn-font-size: 1rem;
            --btn-font-color: #ffffff;
            --btn-border-size: 0px;
            --btn-border-color: #ffffff;
            --btn-glow-color: #ffffff;
            --btn-glow-intensity: 0px;
            --btn-neon-intensity: 0px;
            --btn-outline-size: 0px;
            --btn-outline-color: #000000;
            /* Layout anchoring gaps (preserve current visual spacing) */
            --gap-message-to-bar: 15px;
            --gap-display-to-message: 20px;
            --gap-controls-to-bar: 20px;
            /* Viewport half for vertical anchoring */
            --viewport-half: 50vh;
            /* Interface opacity (affects only main timer UI) */
            --ui-opacity: 1;
        }

        /* --- Keyframe Animations --- */
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        @-webkit-keyframes spin {
            from { -webkit-transform: rotate(0deg); }
            to { -webkit-transform: rotate(360deg); }
        }
        @keyframes pulse-icon {
            50% { transform: scale(1.1); }
        }
        @-webkit-keyframes pulse-icon {
            50% { -webkit-transform: scale(1.1); }
        }
        @keyframes float-icon {
            50% { transform: translateY(-5px); }
        }
        @-webkit-keyframes float-icon {
            50% { -webkit-transform: translateY(-5px); }
        }
        @keyframes wobble-icon {
            15% { transform: rotate(-5deg); }
            30% { transform: rotate(3deg); }
            45% { transform: rotate(-3deg); }
            60% { transform: rotate(2deg); }
            75% { transform: rotate(-1deg); }
        }
        @-webkit-keyframes wobble-icon {
            15% { -webkit-transform: rotate(-5deg); }
            30% { -webkit-transform: rotate(3deg); }
            45% { -webkit-transform: rotate(-3deg); }
            60% { -webkit-transform: rotate(2deg); }
            75% { -webkit-transform: rotate(-1deg); }
        }
        @keyframes jello-icon {
          11.1% { transform: none; }
          22.2% { transform: skewX(-12.5deg) skewY(-12.5deg); }
          33.3% { transform: skewX(6.25deg) skewY(6.25deg); }
          44.4% { transform: skewX(-3.125deg) skewY(-3.125deg); }
          55.5% { transform: skewX(1.5625deg) skewY(1.5625deg); }
          66.6% { transform: skewX(-0.78125deg) skewY(-0.78125deg); }
          77.7% { transform: skewX(0.390625deg) skewY(0.390625deg); }
          88.8% { transform: skewX(-0.1953125deg) skewY(-0.1953125deg); }
          100% { transform: none; }
        }
        @-webkit-keyframes jello-icon {
          11.1% { -webkit-transform: none; }
          22.2% { -webkit-transform: skewX(-12.5deg) skewY(-12.5deg); }
          33.3% { -webkit-transform: skewX(6.25deg) skewY(6.25deg); }
          44.4% { -webkit-transform: skewX(-3.125deg) skewY(-3.125deg); }
          55.5% { -webkit-transform: skewX(1.5625deg) skewY(1.5625deg); }
          66.6% { -webkit-transform: skewX(-0.78125deg) skewY(-0.78125deg); }
          77.7% { -webkit-transform: skewX(0.390625deg) skewY(0.390625deg); }
          88.8% { -webkit-transform: skewX(-0.1953125deg) skewY(-0.1953125deg); }
          100% { -webkit-transform: none; }
        }

        @keyframes pulse-dot {
            0%, 100% {
                transform: scale(1);
                opacity: 0.6;
            }
            50% {
                transform: scale(var(--ellipsis-pulse-scale));
                opacity: 1;
            }
        }
        @-webkit-keyframes pulse-dot {
            0%, 100% {
                -webkit-transform: scale(1);
                opacity: 0.6;
            }
            50% {
                -webkit-transform: scale(var(--ellipsis-pulse-scale));
                opacity: 1;
            }
        }
        
        @keyframes wave-dot {
            0%, 60%, 100% {
                opacity: 0; /* Changed for complete disappearance */
            }
            30% {
                opacity: 1;
            }
        }
        @-webkit-keyframes wave-dot {
            0%, 60%, 100% {
                opacity: 0;
            }
            30% {
                opacity: 1;
            }
        }

        /* --- Base and Body Styles --- */
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            font-family: var(--font-family);
            background-color: var(--bg-color);
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            transition: background-color 0.3s ease;
            overflow: hidden;
            color: white;
        }

        body {
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        /* --- Main Timer Wrapper --- */
        .timer-wrapper {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            height: 100vh;
            transition: transform 0.3s ease;
            opacity: var(--ui-opacity);
        }

        /* --- Options (Settings) Button --- */
        #options-btn {
            position: absolute;
            width: var(--options-btn-size);
            height: var(--options-btn-size);
            cursor: pointer;
            opacity: 0.6;
            transition: opacity 0.3s ease, width 0.3s ease, height 0.3s ease, left 0.3s ease, transform 0.3s ease;
            z-index: 10;
            bottom: auto;
            /* Start in above-right position immediately */
            left: calc(50% + var(--bar-length)/2);
            transform: translateX(-100%);
            top: calc(var(--viewport-half) - var(--bar-width)/2 - var(--options-btn-size) - 140px);
        }
        
        #icon-animator {
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            border-radius: 50%;
            transition: filter 0.3s ease;
            filter: drop-shadow(0 2px 3px rgba(0,0,0,0.4));
        }

        #options-btn:hover {
            opacity: 1;
        }

        #options-btn:hover #icon-animator[class*="animated-"] {
            animation-play-state: paused;
        }

        #icon-animator.custom-icon svg {
            display: none; /* Hide SVG when custom icon is applied */
        }

        #icon-animator[class*="animated-"] {
            animation-duration: var(--options-btn-animation-speed);
            animation-iteration-count: infinite;
        }
        #icon-animator.animated-spin {
            -webkit-animation-name: spin;
            animation-name: spin;
            animation-timing-function: linear;
        }
        #icon-animator.animated-pulse {
            -webkit-animation-name: pulse-icon;
            animation-name: pulse-icon;
            animation-timing-function: ease-in-out;
        }
        #icon-animator.animated-float {
            -webkit-animation-name: float-icon;
            animation-name: float-icon;
            animation-timing-function: ease-in-out;
        }
        #icon-animator.animated-wobble {
            -webkit-animation-name: wobble-icon;
            animation-name: wobble-icon;
            animation-timing-function: linear;
        }
        #icon-animator.animated-jello {
            -webkit-animation-name: jello-icon;
            animation-name: jello-icon;
            transform-origin: center;
            animation-timing-function: ease-in-out;
        }


        #options-btn svg {
            width: 100%;
            height: 100%;
            fill: #FFF;
        }

        /* --- Timer Display & Message --- */
        #timer-display {
            position: absolute;
            font-size: var(--font-size);
            color: var(--font-color);
            font-weight: bold;
            left: 50%;
            top: calc(50% - var(--bar-width)/2 - var(--gap-message-to-bar) - var(--gap-display-to-message));
            transform: translate(-50%, -100%) translateZ(0);
            z-index: 3;
            text-shadow: 
                calc(-1 * var(--font-outline-size)) calc(-1 * var(--font-outline-size)) 0 var(--font-outline-color),  
                 var(--font-outline-size) calc(-1 * var(--font-outline-size)) 0 var(--font-outline-color),
                calc(-1 * var(--font-outline-size)) var(--font-outline-size) 0 var(--font-outline-color),
                 var(--font-outline-size) var(--font-outline-size) 0 var(--font-outline-color),
                 /* Normal Glow */
                0 0 var(--text-glow-spread) var(--text-glow-color),
                 /* Neon Glow */
                0 0 var(--text-neon-spread) var(--text-glow-color),
                0 0 calc(var(--text-neon-spread) * 2) var(--text-glow-color);
            transition: font-size 0.3s ease, color 0.3s ease, text-shadow 0.3s ease, font-family 0.4s ease, opacity 0.2s ease;
            white-space: nowrap;
            will-change: transform;
            backface-visibility: hidden;
            font-variant-numeric: tabular-nums;
            letter-spacing: 0.05em;
            width: max-content;
            min-width: 200px;
            text-align: center;
            margin: 0 auto;
        }
        
        #timer-message {
            color: var(--message-color);
            font-size: var(--message-font-size);
            margin: 0;
            text-shadow: 
                 calc(-1 * var(--message-outline-size)) calc(-1 * var(--message-outline-size)) 0 var(--message-outline-color),  
                 var(--message-outline-size) calc(-1 * var(--message-outline-size)) 0 var(--message-outline-color),
                calc(-1 * var(--message-outline-size)) var(--message-outline-size) 0 var(--message-outline-color),
                 var(--message-outline-size) var(--message-outline-size) 0 var(--message-outline-color),
                /* Normal Glow */
                0 0 var(--message-glow-spread) var(--message-glow-color),
                /* Neon Glow */
                0 0 var(--message-neon-spread) var(--message-glow-color),
                0 0 calc(var(--message-neon-spread) * 2) var(--message-glow-color);
            transition: font-size 0.3s ease, color 0.3s ease, text-shadow 0.3s ease, font-family 0.4s ease, opacity 0.2s ease;
            will-change: transform;
            position: absolute;
            left: 50%;
            top: calc(50% - var(--bar-width)/2 - var(--gap-message-to-bar));
            transform: translate(-50%, -100%) translateZ(0);
            backface-visibility: hidden;
            font-variant-numeric: tabular-nums;
            letter-spacing: 0.02em;
            width: max-content;
            text-align: center;
            margin-left: auto;
            margin-right: auto;
            z-index: 3;
        }

        /* --- Animated Ellipsis --- */
        .ellipsis {
            display: inline-block;
        }
        .ellipsis-dot {
            display: inline-block;
        }
        .ellipsis.pulse .ellipsis-dot {
            -webkit-animation: pulse-dot 1.4s infinite;
            animation: pulse-dot 1.4s infinite;
        }
        .ellipsis.pulse .ellipsis-dot:nth-child(2) {
            -webkit-animation-delay: 0.2s;
            animation-delay: 0.2s;
        }
        .ellipsis.pulse .ellipsis-dot:nth-child(3) {
            -webkit-animation-delay: 0.4s;
            animation-delay: 0.4s;
        }
        .ellipsis.wave .ellipsis-dot {
            -webkit-animation: wave-dot 1.4s infinite;
            animation: wave-dot 1.4s infinite;
        }
        .ellipsis.wave .ellipsis-dot:nth-child(1) {
            -webkit-animation-delay: 0s;
            animation-delay: 0s;
        }
        .ellipsis.wave .ellipsis-dot:nth-child(2) {
            -webkit-animation-delay: 0.2s;
            animation-delay: 0.2s;
        }
        .ellipsis.wave .ellipsis-dot:nth-child(3) {
            -webkit-animation-delay: 0.4s;
            animation-delay: 0.4s;
        }


        /* --- Progress Bar --- */
        #progress-bar-container {
            width: var(--bar-length);
            height: var(--bar-width);
            background-color: #282828; /* Match settings panel */
            border: var(--border-size) solid var(--border-color);
            border-radius: var(--bar-corner-radius);
            overflow: hidden;
            box-shadow: 
                0 0 var(--border-glow-intensity) var(--border-glow-color),
                0 0 var(--border-neon-intensity) var(--border-glow-color),
                0 0 calc(var(--border-neon-intensity) * 2) var(--border-glow-color),
                inset 0 2px 5px rgba(0,0,0,0.3);
            transition: all 0.3s ease, width 0.3s ease;
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            z-index: 2;
        }

        #progress-bar {
            width: 0%;
            height: 100%;
            background: var(--bar-background);
            border-radius: var(--bar-corner-radius);
            box-shadow: 
                /* Normal Glow */
                0 0 var(--bar-glow-intensity) var(--bar-color), 
                /* Neon Glow */
                0 0 var(--bar-neon-intensity) var(--bar-color),
                0 0 calc(var(--bar-neon-intensity) * 2) var(--bar-color),
                /* Inset Highlight */
                inset 0 0 10px rgba(255,255,255,0.2);
            transition: width 0.3s ease, background 0.3s ease, box-shadow 0.3s ease;
            will-change: width;
            transform: translateZ(0);
        }

        /* --- Controls (Buttons) --- */
        #controls {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            justify-content: center; /* Center buttons horizontally */
            align-items: center; /* Vertically center buttons in the container */
            height: 50px; /* Fixed height to prevent layout shifts */
            min-width: 280px; /* Prevents buttons from overlapping on short bars */
            position: absolute;
            left: 50%;
            top: calc(50% + var(--bar-width)/2 + var(--gap-controls-to-bar));
            transform: translateX(-50%);
            width: var(--bar-length);
            z-index: 4;
        }

        #controls button {
            padding: var(--btn-padding-y) var(--btn-padding-x);
            font-size: var(--btn-font-size);
            border: none;
            font-family: inherit;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s ease, left 0.3s ease;
            color: var(--btn-font-color);
            font-weight: 400;
            box-shadow: none;
        }

        #controls button:active {
            transform: scale(0.98);
            box-shadow: none;
        }

        #start-btn, #resume-btn { background-color: var(--start-btn-color); }
        /* #pause-btn { background-color: var(--pause-btn-color); } */
        #repeat-btn { 
            background-color: var(--repeat-btn-color);
        }
        #end-btn { 
            background-color: var(--end-btn-color);
        }

        /* Unify controls layout when timer is active */
        .timer-running #controls,
        .timer-paused #controls {
            display: block;
            width: var(--bar-length);
            transition: width 0.3s ease;
        }

        /* Center the Pause button exactly like the Resume button */
        .timer-running #pause-btn {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            transition: transform 0s, box-shadow 0.2s;
        }

        .timer-running #pause-btn:active {
            transform: translateX(-50%) scale(0.95);
            transition: transform 0.1s, box-shadow 0.2s;
        }

        .timer-paused #resume-btn {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            transition: transform 0s, box-shadow 0.2s;
        }
        
        .timer-paused #resume-btn:active {
            transform: translateX(-50%) scale(0.95);
            transition: transform 0.1s, box-shadow 0.2s;
        }

        .timer-paused #repeat-btn {
            position: absolute;
            bottom: 10px;
            right: 0;
            transition: left 0.3s ease, transform 0.3s ease, box-shadow 0.3s ease;
        }

        .timer-paused #end-btn {
            position: absolute;
            bottom: 10px;
            left: 0;
            transition: left 0.3s ease, transform 0.3s ease, box-shadow 0.3s ease;
        }

        /* Particle Effects Canvas */
        #particles-canvas {
            position: fixed;
            top: calc(0px - env(safe-area-inset-top));
            left: calc(0px - env(safe-area-inset-left));
            width: calc(100vw + env(safe-area-inset-left) + env(safe-area-inset-right));
            height: calc(100vh + env(safe-area-inset-top) + env(safe-area-inset-bottom));
            pointer-events: none;
            z-index: 1;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        #particles-canvas.active {
            opacity: 1;
        }

        /* --- Options Panel --- */
        #options-panel-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.2); /* Reduced background dimness */
            z-index: 99;
            display: flex;
            justify-content: flex-end; /* Aligns panel to the right */
            align-items: flex-start; /* Aligns panel to the top */
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
            padding: 20px;
            box-sizing: border-box;
        }
        
        #options-panel-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        #options-panel {
            background-color: #282828;
            color: #FFF;
            font-family: 'Inter', system-ui, sans-serif; /* Always use system font here */
            padding: 8px 15px 12px 15px;
            border-radius: 12px;
            width: 90%;
            max-width: 240px; /* Smaller panel */
            max-height: calc(100vh - 40px);
            overflow-y: auto;
            box-shadow: 0 5px 25px rgba(0,0,0,0.5);
            transform: translateX(100%);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
            display: flex;
            flex-direction: column;
            /* Scrollbar styles for Firefox */
            scrollbar-width: thin;
            scrollbar-color: #666 #282828;
        }
        
        /* Style scrollbar for Webkit browsers (Chrome, Safari) */
        #options-panel::-webkit-scrollbar {
            width: 6px;
        }

        #options-panel::-webkit-scrollbar-track {
            background: #282828;
            border-radius: 10px;
        }

        #options-panel::-webkit-scrollbar-thumb {
            background-color: #666;
            border-radius: 10px;
            border: 1px solid #282828;
        }

        #options-panel-overlay.visible #options-panel {
            transform: translateX(0);
            opacity: 1;
        }

        #close-panel-btn {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 2rem;
            color: #E57373;
            cursor: pointer;
            transition: color 0.2s;
            line-height: 1;
            z-index: 10;
        }

        #close-panel-btn:hover {
            color: #f44336;
        }

        #options-panel-content {
            flex-grow: 1;
        }

        #options-panel h2 {
            text-align: center;
            margin-bottom: 10px;
            color: #ddd;
        }

        .options-section {
            background-color: rgba(0,0,0,0.2);
            border-radius: 8px;
            margin-bottom: 8px;
            overflow: hidden;
        }
        
        .options-section h3 {
            margin: 0;
            padding: 10px 15px;
            font-size: 0.85rem;
            color: #ccc;
            position: relative;
            border-bottom: 1px solid #282828;
            text-align: center;
        }

        .options-section.collapsible h3 {
            cursor: pointer;
        }
        
        .options-section.collapsible h3::after {
            content: '+';
            position: absolute;
            right: 20px;
            font-size: 1.5rem;
            font-weight: 300;
            transition: transform 0.3s ease;
        }

        .options-section.collapsible.is-open h3::after {
            transform: rotate(45deg);
        }
        
        .options-content-wrapper {
            display: grid;
            grid-template-rows: 0fr;
            transition: grid-template-rows 0.3s ease;
        }
        .options-section.is-open .options-content-wrapper {
            grid-template-rows: 1fr;
        }

        .options-content {
            overflow: hidden;
            padding: 0 12px;
        }
        
        .options-section.is-open .options-content {
            padding: 12px;
        }

        .duration-control {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }

        .duration-control input {
            width: 75px;
            text-align: center;
        }

        .endtime-control {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .endtime-control select {
            flex-grow: 1;
        }

        .duration-control select {
            width: 75px;
        }


        .option-item {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .option-item:last-child {
            margin-bottom: 0;
        }
        
        .option-item.checkbox {
             grid-template-columns: 1fr auto;
             gap: 10px;
             justify-content: space-between;
        }
        
        .option-item.full-width {
            grid-template-columns: 1fr;
        }

        #options-panel label {
            font-weight: normal;
            font-size: 0.9rem;
            color: #ddd;
        }

        .section-title {
            font-weight: 500;
            font-size: 0.85rem;
            color: #bbb;
            margin-bottom: 12px;
            display: block;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            opacity: 0.8;
        }

        #options-panel input, #options-panel select, #options-panel button {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
            border-radius: 5px;
            border: 1px solid #555;
            background-color: #444;
            color: #FFF;
            font-size: 0.9rem;
        }

        #options-panel input[type="color"] {
            padding: 2px;
            height: 40px;
            cursor: pointer;
        }

        #options-panel input[type="range"] {
            cursor: pointer;
        }
        
        #options-panel input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        #options-panel input[type="file"] {
            padding: 4px;
        }

        /* --- Modern Sliders --- */
        #options-panel input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 6px;
            border-radius: 0px;
            background: #444;
            outline: none;
            transition: background 0.3s ease;
            margin: 0;
            padding: 0;
        }

        #options-panel input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 0px;
            background: #f44336;
            cursor: pointer;
            border: 2px solid #fff;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
            margin-top: -7px;
        }

        #options-panel input[type="range"]::-webkit-slider-thumb:hover {
            background: #e53935;
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
        }

        #options-panel input[type="range"]::-webkit-slider-thumb:active {
            background: #d32f2f;
            transform: scale(1.05);
        }

        #options-panel input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 0px;
            background: #f44336;
            cursor: pointer;
            border: 2px solid #fff;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
        }

        #options-panel input[type="range"]::-moz-range-thumb:hover {
            background: #e53935;
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
        }

        #options-panel input[type="range"]::-webkit-slider-track {
            -webkit-appearance: none;
            appearance: none;
            height: 6px;
            border-radius: 0px;
            background: #444;
            border: none;
        }

        #options-panel input[type="range"]::-moz-range-progress {
            height: 6px;
            border-radius: 0px;
            background: #f44336;
        }
        #clear-bg-btn, #clear-icon-btn {
             background-color: #666;
             cursor: pointer;
        }
        
        #settings-management-external {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 150px;
            opacity: 0;
            visibility: hidden;
            transform: translateX(100%);
            transition: transform 0.4s ease, opacity 0.4s ease, visibility 0.4s;
        }
        
        body.settings-open #settings-management-external {
            opacity: 1;
            visibility: visible;
            transform: translateX(0);
        }
        
        #settings-management-external button {
            border: none;
            border-radius: 12px;
            padding: 12px;
            cursor: pointer;
        }

        #save-settings-btn {
            background-color: #333;
            color: #4CAF50;
            font-weight: bold;
        }
        #reset-settings-btn {
            background-color: #333;
            color: #f44336;
            font-weight: bold;
        }

        /* --- Confirmation Modal --- */
        #confirm-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
            z-index: 102;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        #confirm-modal {
            background: #333;
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 5px 25px rgba(0,0,0,0.4);
        }
        
        #confirm-modal p {
            margin: 0 0 20px 0;
            font-size: 1.1rem;
        }
        
        #confirm-modal-buttons {
            display: flex;
            gap: 15px;
        }
        
        #confirm-yes, #confirm-no {
            padding: 10px 30px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            color: white;
            font-weight: bold;
        }
        
        #confirm-yes { background-color: #f44336; }
        #confirm-no { background-color: #666; }


        /* --- Save Confirmation Message --- */
        #save-confirm {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            z-index: 101;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s, bottom 0.3s;
        }
        #save-confirm.visible {
            opacity: 1;
            visibility: visible;
            bottom: 30px;
        }

        .hidden {
            display: none !important;
        }
        
        .option-group {
            transition: opacity 0.3s ease;
        }
        .option-group.disabled {
            opacity: 0.5;
            pointer-events: none;
        }

        /* Particle Effects Canvas */
        #particles-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        #particles-canvas.active {
            opacity: 1;
        }

        /* --- Horizontal Screen Positioning --- */
        @media (orientation: landscape) and (min-width: 800px) {
            #settings-management-external {
                right: calc(240px + 60px); /* More distance on horizontal screens */
                bottom: 20px;
            }
        }

        /* --- Responsiveness --- */
        @media (min-width: 800px) {
            body.settings-open .timer-wrapper {
                transform: translateX(-190px); /* Adjusted for narrower panel */
            }
            #settings-management-external {
                left: auto;
                right: calc(240px + 70px); /* More distance from panel */
                bottom: 20px;
                top: auto;
            }
        }
        
        @media (max-width: 768px) { /* iPad and smaller */
            :root {
                --bar-length: 90vw;
                --font-size: 60px;
            }
             .option-item {
                grid-template-columns: 1fr;
                gap: 8px;
            }
             .option-item.checkbox {
                grid-template-columns: 1fr 20px;
             }
        }

        @media (max-width: 480px) { /* iPhone */
            :root {
                --font-size: 44px; /* Slightly smaller font for phones */
                --bar-length: 95vw; /* Much longer bar on iPhone vertical */
                --options-btn-size: 35px; /* Smaller icon on iPhone */
            }
            #controls {
                flex-direction: column;
                width: 70%;
                gap: 10px;
            }
            #controls button {
                width: 100%;
            }
            #options-panel {
                max-width: 85%;
                max-width: 200px; /* Even smaller on iPhone */
                padding: 6px 10px 8px 10px; /* Reduced padding */
            }
            
            /* Make Repeat and End buttons bigger on mobile */
            .timer-paused #repeat-btn,
            .timer-paused #end-btn {
                padding: 10px 16px;
                font-size: 0.95rem;
                min-width: auto;
                width: auto;
            }
            
            /* Make Resume button bigger only when it's the only visible button */
            .timer-paused #resume-btn {
                padding: 10px 16px;
                font-size: 0.95rem;
                min-width: auto;
                width: auto;
            }
        }

        /* iOS Safe Area Support for PWA */
        @supports (padding: max(0px)) {
            body {
                padding-top: max(env(safe-area-inset-top), 0px);
                padding-bottom: max(env(safe-area-inset-bottom), 0px);
                padding-left: max(env(safe-area-inset-left), 0px);
                padding-right: max(env(safe-area-inset-right), 0px);
            }
        }

        /* Accurate vertical centering across browsers (set viewport half variable) */
        @supports (height: 100dvh) {
            :root { --viewport-half: 50dvh; }
        }
        @supports (height: 100svh) {
            :root { --viewport-half: 50svh; }
        }

        /* iPhone landscape-only layout adjustment */
        @supports (-webkit-touch-callout: none) {
            @media screen and (orientation: landscape) and (max-height: 480px) {
                .timer-wrapper {
                    transform: translateY(12px);
                }
                #options-btn {
                    top: calc(var(--viewport-half) - var(--bar-width)/2 - var(--options-btn-size) - 140px + 40px);
                }
            }
        }

        /* Fullscreen mode adjustments */
        @media (display-mode: standalone) {
            body {
                background-color: var(--bg-color);
            }
            
            /* Hide any potential scrollbars in standalone mode */
            html, body {
                overflow: hidden;
                height: 100vh;
                height: -webkit-fill-available;
            }
            
            .timer-wrapper {
                height: 100vh;
                height: -webkit-fill-available;
            }
        }

        /* iOS specific adjustments */
        @media screen and (-webkit-min-device-pixel-ratio: 2) {
            /* Retina display adjustments */
            .timer-wrapper {
                -webkit-touch-callout: none;
                -webkit-user-select: none;
                user-select: none;
                -webkit-tap-highlight-color: transparent;
            }
        }
    </style>
</head>
<body>
    <!-- Font Preloader -->
    <div class="font-preloader">Font Preloader</div>

    <div class="timer-wrapper">
        <!-- Options Button --><div id="options-btn" title="Settings"><div id="icon-animator"></div></div>

        <!-- Timer Display --><div id="timer-display">
            <span id="main-numbers">0.00%</span>
        </div>
        <div id="timer-message">Your custom message here</div>

        <!-- Progress Bar --><div id="progress-bar-container">
            <div id="progress-bar"></div>
        </div>

        <!-- Controls --><div id="controls">
            <button id="start-btn">Start</button>
            <button id="pause-btn" class="hidden">Pause</button>
            <button id="resume-btn" class="hidden">Resume</button>
            <button id="repeat-btn" class="hidden">Repeat</button>
            <button id="end-btn" class="hidden">End</button>
        </div>
    </div>

    <!-- Options Panel (Hidden by default) --><div id="options-panel-overlay">
        <div id="options-panel">
            <div id="close-panel-btn">&times;</div>
            <div id="options-panel-content">
                <h2>Customization</h2>
                
                <div class="options-section is-open">
                    <h3>Timer & Sound</h3>
                    <div class="options-content-wrapper">
                        <div class="options-content">
                            <div class="option-item">
                                <label for="timer-mode-select">Mode</label>
                                <select id="timer-mode-select">
                                    <option value="duration" selected>Duration</option>
                                    <option value="endTime">End Time</option>
                                </select>
                            </div>
                            <div id="duration-settings">
                                <div class="option-item full-width">
                                    <label>Duration</label>
                                    <div class="duration-control">
                                        <label for="duration-hours">H:</label>
                                        <input type="number" id="duration-hours" min="0" max="24" value="0" inputmode="numeric" pattern="[0-9]*">
                                        <label for="duration-minutes">M:</label>
                                        <input type="number" id="duration-minutes" min="0" max="59" value="20" inputmode="numeric" pattern="[0-9]*">
                                    </div>
                                 </div>
                            </div>
                            <div id="endtime-settings" class="hidden">
                                <div class="option-item full-width">
                                    <label>End Time</label>
                                    <div class="endtime-control">
                                        <select id="end-time-hour"></select>
                                        <span>:</span>
                                        <select id="end-time-minute"></select>
                                        <select id="end-time-ampm">
                                            <option>AM</option>
                                            <option>PM</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <hr style="border-color: #444; margin: 15px 0;">
                            <div class="option-item"><label for="alarm-sound-select">Alarm</label><select id="alarm-sound-select"><option value="beep">Beep</option><option value="chime">Chime</option><option value="buzz">Buzz</option><option value="none">None</option></select></div>
                        </div>
                    </div>
                </div>

                <div class="options-section collapsible">
                    <h3>Background</h3>
                    <div class="options-content-wrapper">
                        <div class="options-content">
                            <div class="option-item"><label for="bg-color-input">Color</label><input type="color" id="bg-color-input" value="#121212"></div>
                            <div class="option-item"><label for="bg-image-upload">Upload</label><input type="file" id="bg-image-upload-hidden" accept="image/*" style="display: none;"><button id="bg-image-upload" style="width: 100%; padding: 8px; background-color: #666; color: white; border: none; border-radius: 5px; cursor: pointer;">Choose file</button></div>
                            <div class="option-item"><label>Clear</label><button id="clear-bg-btn">Clear Image</button></div>
                            <hr style="border-color: #444; margin: 15px 0;">
                            <label class="section-title">Particles</label>
                            <div class="option-item checkbox"><label for="particles-toggle">Enable Particles</label><input type="checkbox" id="particles-toggle"></div>
                            <div class="option-group disabled" id="particles-options">
                                <div class="option-item"><label for="particle-density-input">Density</label><input type="range" id="particle-density-input" min="1" max="20" value="5"></div>
                                <div class="option-item"><label for="particle-speed-input">Speed</label><input type="range" id="particle-speed-input" min="0.5" max="6" value="1" step="0.1"></div>
                                <div class="option-item"><label for="particle-size-input">Size</label><input type="range" id="particle-size-input" min="1" max="6" value="1"></div>
                                <div class="option-item"><label for="particle-twinkle-input">Twinkle</label><input type="range" id="particle-twinkle-input" min="0" max="100" value="0"></div>
                                <div class="option-item"><label for="particle-color-input">Color</label><input type="color" id="particle-color-input" value="#00BFFF"></div>
                                <div class="option-item"><label for="particle-multi-color-1-input">Color 1</label><input type="color" id="particle-multi-color-1-input" value="#00BFFF"></div>
                                <div class="option-item"><label for="particle-multi-color-2-input">Color 2</label><input type="color" id="particle-multi-color-2-input" value="#FF6B6B"></div>
                                <div class="option-item"><label for="particle-multi-color-3-input">Color 3</label><input type="color" id="particle-multi-color-3-input" value="#4ECDC4"></div>
                                <div class="option-item"><label for="particle-multi-color-4-input">Color 4</label><input type="color" id="particle-multi-color-4-input" value="#45B7D1"></div>
                                <div class="option-item"><label for="particle-color-style-select">Color Style</label><select id="particle-color-style-select"><option value="solid">Solid</option><option value="multiple">Multiple Color</option><option value="rainbow">Rainbow</option><option value="random">Random</option></select></div>
                                <div class="option-item"><label for="particle-direction-select">Direction</label><select id="particle-direction-select"><option value="up">Up</option><option value="down">Down</option><option value="left">Left</option><option value="right">Right</option><option value="bounce">Bounce</option><option value="random">Random</option></select></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="options-section collapsible">
                    <h3>Progress Bar</h3>
                    <div class="options-content-wrapper">
                        <div class="options-content">
                            <div class="option-item"><label for="bar-length-input">Length</label><input type="range" id="bar-length-input" min="40" max="90" value="60"></div>
                            <div class="option-item"><label for="bar-width-input">Width</label><input type="range" id="bar-width-input" min="15" max="200" value="50"></div>
                            <div class="option-item"><label for="bar-corner-input">Roundness</label><input type="range" id="bar-corner-input" min="0" max="50" value="0"></div>
                            <hr style="border-color: #444; margin: 15px 0;">
                            <label class="section-title">Color</label>
                            <div class="option-item" id="bar-color-option"><label for="bar-color-input">Color</label><input type="color" id="bar-color-input" value="#4CAF50"></div>
                            <div class="option-item checkbox"><label for="bar-gradient-toggle">Gradient</label><input type="checkbox" id="bar-gradient-toggle"></div>
                            <div class="option-group disabled" id="bar-gradient-options">
                                <div class="option-item"><label for="bar-gradient-start-input">Start</label><input type="color" id="bar-gradient-start-input" value="#4CAF50"></div>
                                <div class="option-item"><label for="bar-gradient-end-input">End</label><input type="color" id="bar-gradient-end-input" value="#03A9F4"></div>
                            </div>
                            <hr style="border-color: #444; margin: 15px 0;">
                            <label class="section-title">Effects</label>
                            <div class="option-item checkbox"><label for="bar-glow-normal-toggle">Glow</label><input type="checkbox" id="bar-glow-normal-toggle"></div>
                            <div class="option-group" id="bar-glow-normal-options">
                                <div class="option-item"><label for="bar-glow-intensity-input">Intensity</label><input type="range" id="bar-glow-intensity-input" min="0" max="30" value="0"></div>
                            </div>
                            <div class="option-item checkbox"><label for="bar-glow-neon-toggle">Neon</label><input type="checkbox" id="bar-glow-neon-toggle"></div>
                            <div class="option-group" id="bar-glow-neon-options">
                                <div class="option-item"><label for="bar-neon-intensity-input">Intensity</label><input type="range" id="bar-neon-intensity-input" min="0" max="50" value="0"></div>
                            </div>
                            <hr style="border-color: #444; margin: 15px 0;">
                            <label class="section-title">Border</label>
                            <div class="option-item"><label for="border-color-input">Color</label><input type="color" id="border-color-input" value="#FFFFFF"></div>
                            <div class="option-item"><label for="border-size-input">Size</label><input type="range" id="border-size-input" min="0" max="10" value="2"></div>
                            <div class="option-item checkbox"><label for="border-glow-toggle">Glow</label><input type="checkbox" id="border-glow-toggle"></div>
                            <div class="option-group" id="border-glow-options">
                                <div class="option-item"><label for="border-glow-color-input">Color</label><input type="color" id="border-glow-color-input" value="#FFFFFF"></div>
                                <div class="option-item"><label for="border-glow-intensity-input">Intensity</label><input type="range" id="border-glow-intensity-input" min="0" max="30" value="0"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="options-section collapsible">
                    <h3>Percentage Text</h3>
                    <div class="options-content-wrapper">
                        <div class="options-content">
                            <div class="option-item"><label for="font-select">Font</label><select id="font-select"><option value="'Inter', system-ui, sans-serif">System</option><option value="'VT323', monospace">Retro</option><option value="'Press Start 2P', cursive">Pixel</option><option value="'Share Tech Mono', monospace">Tech Mono</option><option value="'Jersey 25', sans-serif">Jersey 25</option><option value="'Jersey 20', sans-serif">Jersey 20</option><option value="'Jersey 10', sans-serif">Jersey 10</option><option value="'Share Tech', sans-serif">Share Tech</option><option value="'Electrolyze', sans-serif">Electrolyze</option></select></div>
                            <div class="option-item"><label for="font-size-input">Size</label><input type="range" id="font-size-input" min="20" max="120" value="72"></div>
                            <div class="option-item"><label for="font-color-input">Color</label><input type="color" id="font-color-input" value="#FFFFFF"></div>
                            <hr style="border-color: #444; margin: 15px 0;">
                            <label class="section-title">Outline</label>
                            <div class="option-item checkbox"><label for="font-outline-toggle">Outline</label><input type="checkbox" id="font-outline-toggle"></div>
                            <div class="option-group" id="font-outline-options">
                                <div class="option-item"><label for="font-outline-size-input">Size</label><input type="range" id="font-outline-size-input" min="0" max="5" value="0"></div>
                                <div class="option-item"><label for="font-outline-color-input">Color</label><input type="color" id="font-outline-color-input" value="#000000"></div>
                            </div>
                            <hr style="border-color: #444; margin: 15px 0;">
                            <label class="section-title">Effects</label>
                            <div class="option-item checkbox"><label for="text-glow-normal-toggle">Glow</label><input type="checkbox" id="text-glow-normal-toggle"></div>
                             <div class="option-group" id="text-glow-normal-options">
                                <div class="option-item"><label for="text-glow-spread-input">Spread</label><input type="range" id="text-glow-spread-input" min="0" max="30" value="0"></div>
                             </div>
                            <div class="option-item checkbox"><label for="text-glow-neon-toggle">Neon</label><input type="checkbox" id="text-glow-neon-toggle"></div>
                            <div class="option-group" id="text-glow-neon-options">
                                <div class="option-item"><label for="text-neon-spread-input">Spread</label><input type="range" id="text-neon-spread-input" min="0" max="30" value="0"></div>
                            </div>
                             <div class="option-item"><label for="text-glow-color-input">Glow Color</label><input type="color" id="text-glow-color-input" value="#00ffcc"></div>
                        </div>
                    </div>
                </div>

                <div class="options-section collapsible">
                    <h3>Custom Message</h3>
                    <div class="options-content-wrapper">
                        <div class="options-content">
                            <div class="option-item checkbox"><label for="message-toggle">Show Message</label><input type="checkbox" id="message-toggle" checked></div>
                            <div class="option-group" id="message-options">
                            <div class="option-item"><label for="message-input">Text</label><input type="text" id="message-input" placeholder="Your custom message here"></div>
                            <div class="option-item"><label for="message-color-input">Color</label><input type="color" id="message-color-input" value="#cccccc"></div>
                            <div class="option-item"><label for="message-font-size-input">Size</label><input type="range" id="message-font-size-input" min="0.5" max="3" value="1.2" step="0.1"></div>
                            <hr style="border-color: #444; margin: 15px 0;">
                            <label class="section-title">Outline</label>
                            <div class="option-item checkbox"><label for="message-outline-toggle">Outline</label><input type="checkbox" id="message-outline-toggle"></div>
                            <div class="option-group" id="message-outline-options">
                                <div class="option-item"><label for="message-outline-size-input">Size</label><input type="range" id="message-outline-size-input" min="0" max="5" value="0"></div>
                                <div class="option-item"><label for="message-outline-color-input">Color</label><input type="color" id="message-outline-color-input" value="#000000"></div>
                            </div>
                            <hr style="border-color: #444; margin: 15px 0;">
                            <label class="section-title">Effects</label>
                            <div class="option-item checkbox"><label for="message-glow-normal-toggle">Glow</label><input type="checkbox" id="message-glow-normal-toggle"></div>
                            <div class="option-group" id="message-glow-normal-options">
                                <div class="option-item"><label for="message-glow-spread-input">Spread</label><input type="range" id="message-glow-spread-input" min="0" max="50" value="0"></div>
                            </div>
                             <div class="option-item checkbox"><label for="message-glow-neon-toggle">Neon</label><input type="checkbox" id="message-glow-neon-toggle"></div>
                            <div class="option-group" id="message-glow-neon-options">
                                <div class="option-item"><label for="message-neon-spread-input">Spread</label><input type="range" id="message-neon-spread-input" min="0" max="50" value="0"></div>
                            </div>
                            <div class="option-item"><label for="message-glow-color-input">Glow Color</label><input type="color" id="message-glow-color-input" value="#00ffcc"></div>
                            <hr style="border-color: #444; margin: 15px 0;">
                            <label class="section-title">Animation</label>
                            <div class="option-item"><label for="ellipsis-animation-select">Ellipsis</label><select id="ellipsis-animation-select"><option value="pulse">Pulse</option><option value="wave">Wave</option><option value="none">None</option></select></div>
                            <div class="option-item"><label for="ellipsis-intensity-input">Intensity</label><input type="range" id="ellipsis-intensity-input" min="0" max="20" value="5"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="options-section collapsible">
                    <h3>Icon</h3>
                    <div class="options-content-wrapper">
                        <div class="options-content">
                            <div class="option-item"><label for="icon-preset-select">Preset</label><select id="icon-preset-select"><option value="default">Gear</option><option value="star">Star</option><option value="heart">Heart</option><option value="wrench">Wrench</option><option value="sliders">Sliders</option><option value="ellipsis">Ellipsis</option><option value="info">Info</option><option value="menu" selected>Menu</option></select></div>
                            <div class="option-item"><label for="icon-size-input">Size</label><input type="range" id="icon-size-input" min="20" max="120" value="50"></div>
                            <div class="option-item"><label for="icon-color-input">Color</label><input type="color" id="icon-color-input" value="#FFFFFF"></div>
                            <hr style="border-color: #444; margin: 15px 0;">
                            <label class="section-title">Animation</label>
                            <div class="option-item checkbox"><label for="icon-animation-toggle">Animate</label><input type="checkbox" id="icon-animation-toggle"></div>
                            <div class="option-item"><label for="icon-animation-style-select">Style</label><select id="icon-animation-style-select"><option value="spin">Spin</option><option value="pulse">Pulse</option><option value="float">Float</option><option value="wobble">Wobble</option><option value="jello">Jello</option></select></div>
                            <div class="option-item"><label for="icon-animation-speed-input">Speed</label><input type="range" id="icon-animation-speed-input" min="0.5" max="10" value="2" step="0.1"></div>
                            <hr style="border-color: #444; margin: 15px 0;">
                            <label class="section-title">Custom</label>
                            <div class="option-item"><label for="icon-upload-input">Upload</label><input type="file" id="icon-upload-input" accept="image/*"></div>
                            <div class="option-item"><label>Clear</label><button id="clear-icon-btn">Clear Icon</button></div>
                        </div>
                    </div>
                </div>
                
                <div class="options-section collapsible">
                    <h3>Buttons</h3>
                    <div class="options-content-wrapper">
                        <div class="options-content">
                            <div class="option-item"><label for="start-btn-color">Start/Resume</label><input type="color" id="start-btn-color" value="#4CAF50"></div>
                            <div class="option-item"><label for="repeat-btn-color">Repeat</label><input type="color" id="repeat-btn-color" value="#03A9F4"></div>
                            <div class="option-item"><label for="btn-font-color-input">Font Color</label><input type="color" id="btn-font-color-input" value="#FFFFFF"></div>
                            <hr style="border-color: #444; margin: 15px 0;">
                            <label class="section-title">Size</label>
                            <div class="option-item"><label for="btn-padding-y-input">Height</label><input type="range" id="btn-padding-y-input" min="2" max="20" value="10"></div>
                            <div class="option-item"><label for="btn-padding-x-input">Width</label><input type="range" id="btn-padding-x-input" min="5" max="40" value="22"></div>
                            <div class="option-item"><label for="btn-font-size-input">Font Size</label><input type="range" id="btn-font-size-input" min="0.5" max="2" value="1" step="0.1"></div>
                            <hr style="border-color: #444; margin: 15px 0;">
                            <label style="margin-bottom: 15px; display: block; text-align: left;">Outline</label>
                            <div class="option-item checkbox"><label for="btn-outline-toggle">Outline</label><input type="checkbox" id="btn-outline-toggle"></div>
                            <div class="option-group" id="btn-outline-options">
                                <div class="option-item"><label for="btn-outline-size-input">Size</label><input type="range" id="btn-outline-size-input" min="0" max="5" value="0"></div>
                                <div class="option-item"><label for="btn-outline-color-input">Color</label><input type="color" id="btn-outline-color-input" value="#000000"></div>
                            </div>
                            <hr style="border-color: #444; margin: 15px 0;">
                             <label style="margin-bottom: 15px; display: block; text-align: left;">Border</label>
                            <div class="option-item"><label for="btn-border-size-input">Size</label><input type="range" id="btn-border-size-input" min="0" max="10" value="0"></div>
                            <div class="option-item"><label for="btn-border-color-input">Color</label><input type="color" id="btn-border-color-input" value="#FFFFFF"></div>
                            <hr style="border-color: #444; margin: 15px 0;">
                            <label class="section-title">Effects</label>
                             <div class="option-item checkbox"><label for="btn-glow-normal-toggle">Glow</label><input type="checkbox" id="btn-glow-normal-toggle"></div>
                            <div class="option-group" id="btn-glow-normal-options">
                                <div class="option-item"><label for="btn-glow-intensity-input">Intensity</label><input type="range" id="btn-glow-intensity-input" min="0" max="20" value="0"></div>
                            </div>
                            <div class="option-item checkbox"><label for="btn-glow-neon-toggle">Neon</label><input type="checkbox" id="btn-glow-neon-toggle"></div>
                            <div class="option-group" id="btn-glow-neon-options">
                                <div class="option-item"><label for="btn-neon-intensity-input">Intensity</label><input type="range" id="btn-neon-intensity-input" min="0" max="20" value="0"></div>
                            </div>
                             <div class="option-item"><label for="btn-glow-color-input">Glow Color</label><input type="color" id="btn-glow-color-input" value="#FFFFFF"></div>
                        </div>
                    </div>
                </div>

                <div class="options-section collapsible">
                    <h3>Interface</h3>
                    <div class="options-content-wrapper">
                        <div class="options-content">
                            <div class="option-item"><label for="ui-opacity-input">Opacity</label><input type="range" id="ui-opacity-input" min="20" max="100" value="100"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Particle Effects Canvas -->
    <canvas id="particles-canvas"></canvas>
    
    <div id="settings-management-external">
        <button id="save-settings-btn">Save Settings</button>
        <button id="reset-settings-btn">Reset to Default</button>
    </div>

    <div id="confirm-modal-overlay" class="hidden">
        <div id="confirm-modal">
            <p>Are you sure you want to reset all settings?</p>
            <div id="confirm-modal-buttons">
                <button id="confirm-yes">Yes</button>
                <button id="confirm-no">No</button>
            </div>
        </div>
    </div>
    
    <div id="save-confirm">Settings Saved!</div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM ELEMENT SELECTION ---
            const root = document.documentElement;
            const timerWrapper = document.querySelector('.timer-wrapper');
            const timerDisplay = document.getElementById('timer-display');
            const mainNumbers = document.getElementById('main-numbers');
            const timerMessage = document.getElementById('timer-message');
            const progressBar = document.getElementById('progress-bar');
            const progressBarContainer = document.getElementById('progress-bar-container');

            const startBtn = document.getElementById('start-btn');
            const pauseBtn = document.getElementById('pause-btn');
            const resumeBtn = document.getElementById('resume-btn');
            const repeatBtn = document.getElementById('repeat-btn');
            const endBtn = document.getElementById('end-btn');
            const optionsBtn = document.getElementById('options-btn');
            const iconAnimator = document.getElementById('icon-animator');
            const optionsPanelOverlay = document.getElementById('options-panel-overlay');
            const closePanelBtn = document.getElementById('close-panel-btn');
            const saveConfirm = document.getElementById('save-confirm');
            const confirmModalOverlay = document.getElementById('confirm-modal-overlay');
            const confirmYesBtn = document.getElementById('confirm-yes');
            const confirmNoBtn = document.getElementById('confirm-no');


            // Options Panel Inputs
            const allInputs = document.querySelectorAll('#options-panel input, #options-panel select');
            const timerModeSelect = document.getElementById('timer-mode-select');
            const durationSettings = document.getElementById('duration-settings');
            const durationHoursInput = document.getElementById('duration-hours');
            const durationMinutesInput = document.getElementById('duration-minutes');
            const endtimeSettings = document.getElementById('endtime-settings');
            const endTimeHourInput = document.getElementById('end-time-hour');
            const endTimeMinuteInput = document.getElementById('end-time-minute');
            const endTimeAmPmInput = document.getElementById('end-time-ampm');
            const messageToggle = document.getElementById('message-toggle');
            const messageOptions = document.getElementById('message-options');
            const messageInput = document.getElementById('message-input');
            const messageColorInput = document.getElementById('message-color-input');
            const messageFontSizeInput = document.getElementById('message-font-size-input');
            const messageOutlineToggle = document.getElementById('message-outline-toggle');
            const messageOutlineOptions = document.getElementById('message-outline-options');
            const messageOutlineSizeInput = document.getElementById('message-outline-size-input');
            const messageOutlineColorInput = document.getElementById('message-outline-color-input');
            const messageGlowToggle = document.getElementById('message-glow-normal-toggle');
            const messageGlowOptions = document.getElementById('message-glow-normal-options');
            const messageGlowColorInput = document.getElementById('message-glow-color-input');
            const messageGlowSpreadInput = document.getElementById('message-glow-spread-input');
            const messageNeonToggle = document.getElementById('message-glow-neon-toggle');
            const messageNeonOptions = document.getElementById('message-glow-neon-options');
            const messageNeonSpreadInput = document.getElementById('message-neon-spread-input');
            const ellipsisAnimationSelect = document.getElementById('ellipsis-animation-select');
            const ellipsisIntensityInput = document.getElementById('ellipsis-intensity-input');
            const alarmSoundSelect = document.getElementById('alarm-sound-select');
            const barColorInput = document.getElementById('bar-color-input');
            const barGradientToggle = document.getElementById('bar-gradient-toggle');
            const barGradientOptions = document.getElementById('bar-gradient-options');
            const barGradientStartInput = document.getElementById('bar-gradient-start-input');
            const barGradientEndInput = document.getElementById('bar-gradient-end-input');
            const barLengthInput = document.getElementById('bar-length-input');
            const barWidthInput = document.getElementById('bar-width-input');
            const barCornerInput = document.getElementById('bar-corner-input');
            const barGlowIntensityInput = document.getElementById('bar-glow-intensity-input');
            const barNeonIntensityInput = document.getElementById('bar-neon-intensity-input');
            const barGlowNormalToggle = document.getElementById('bar-glow-normal-toggle');
            const barGlowNeonToggle = document.getElementById('bar-glow-neon-toggle');
            const barGlowNormalOptions = document.getElementById('bar-glow-normal-options');
            const barGlowNeonOptions = document.getElementById('bar-glow-neon-options');
            const borderColorInput = document.getElementById('border-color-input');
            const borderSizeInput = document.getElementById('border-size-input');
            const borderGlowToggle = document.getElementById('border-glow-toggle');
            const borderGlowOptions = document.getElementById('border-glow-options');
            const borderGlowColorInput = document.getElementById('border-glow-color-input');
            const borderGlowIntensityInput = document.getElementById('border-glow-intensity-input');
            const fontSelect = document.getElementById('font-select');
            const fontSizeInput = document.getElementById('font-size-input');
            const fontColorInput = document.getElementById('font-color-input');
            const fontOutlineColorInput = document.getElementById('font-outline-color-input');
            const fontOutlineToggle = document.getElementById('font-outline-toggle');
            const fontOutlineOptions = document.getElementById('font-outline-options');
            const fontOutlineSizeInput = document.getElementById('font-outline-size-input');
            const textGlowColorInput = document.getElementById('text-glow-color-input');
            const textGlowSpreadInput = document.getElementById('text-glow-spread-input');
            const textNeonSpreadInput = document.getElementById('text-neon-spread-input');
            const textGlowNormalToggle = document.getElementById('text-glow-normal-toggle');
            const textGlowNeonToggle = document.getElementById('text-glow-neon-toggle');
            const textGlowNormalOptions = document.getElementById('text-glow-normal-options');
            const textGlowNeonOptions = document.getElementById('text-glow-neon-options');
            const iconPresetSelect = document.getElementById('icon-preset-select');
            const iconAnimationToggle = document.getElementById('icon-animation-toggle');
            const iconAnimationStyleSelect = document.getElementById('icon-animation-style-select');
            const iconAnimationSpeedInput = document.getElementById('icon-animation-speed-input');
            const iconSizeInput = document.getElementById('icon-size-input');
            const iconColorInput = document.getElementById('icon-color-input');
            const iconUploadInput = document.getElementById('icon-upload-input');
            const clearIconBtn = document.getElementById('clear-icon-btn');
            const bgColorInput = document.getElementById('bg-color-input');
            const bgImageUploadInput = document.getElementById('bg-image-upload-hidden');
            const bgImageUploadBtn = document.getElementById('bg-image-upload');
            const clearBgBtn = document.getElementById('clear-bg-btn');
            const particlesToggle = document.getElementById('particles-toggle');
            const particlesOptions = document.getElementById('particles-options');
            const particleDensityInput = document.getElementById('particle-density-input');
            const particleSpeedInput = document.getElementById('particle-speed-input');
            const particleSizeInput = document.getElementById('particle-size-input');
            const particleTwinkleInput = document.getElementById('particle-twinkle-input');
            const particleColorInput = document.getElementById('particle-color-input');
            const particleMultiColor1Input = document.getElementById('particle-multi-color-1-input');
            const particleMultiColor2Input = document.getElementById('particle-multi-color-2-input');
            const particleMultiColor3Input = document.getElementById('particle-multi-color-3-input');
            const particleMultiColor4Input = document.getElementById('particle-multi-color-4-input');
            const particleColorStyleSelect = document.getElementById('particle-color-style-select');
            const particleDirectionSelect = document.getElementById('particle-direction-select');
            const startBtnColorInput = document.getElementById('start-btn-color');
            const repeatBtnColorInput = document.getElementById('repeat-btn-color');
            const btnPaddingYInput = document.getElementById('btn-padding-y-input');
            const btnPaddingXInput = document.getElementById('btn-padding-x-input');
            const btnFontSizeInput = document.getElementById('btn-font-size-input');
            const btnFontColorInput = document.getElementById('btn-font-color-input');
            const btnBorderSizeInput = document.getElementById('btn-border-size-input');
            const btnBorderColorInput = document.getElementById('btn-border-color-input');
            const btnOutlineToggle = document.getElementById('btn-outline-toggle');
            const btnOutlineOptions = document.getElementById('btn-outline-options');
            const btnOutlineSizeInput = document.getElementById('btn-outline-size-input');
            const btnOutlineColorInput = document.getElementById('btn-outline-color-input');
            const btnGlowNormalToggle = document.getElementById('btn-glow-normal-toggle');
            const btnGlowNormalOptions = document.getElementById('btn-glow-normal-options');
            const btnGlowIntensityInput = document.getElementById('btn-glow-intensity-input');
            const btnGlowNeonToggle = document.getElementById('btn-glow-neon-toggle');
            const btnGlowNeonOptions = document.getElementById('btn-glow-neon-options');
            const btnNeonIntensityInput = document.getElementById('btn-neon-intensity-input');
            const btnGlowColorInput = document.getElementById('btn-glow-color-input');
            const uiOpacityInput = document.getElementById('ui-opacity-input');
            const saveSettingsBtn = document.getElementById('save-settings-btn');
            const resetSettingsBtn = document.getElementById('reset-settings-btn');
            
            // --- STATE & PRESET DATA ---
            let totalDuration, timeRemaining, startTime, targetEndTime;
            let isRunning = false, isPaused = false;
            let audioContext;
            let timerLoopId; // To hold the requestAnimationFrame ID

            const presetIcons = {
                default: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M495.9 166.6c3.2 8.7 .5 18.4-6.4 24.6l-43.3 39.4c1.1 8.3 1.7 16.8 1.7 25.4s-.6 17.1-1.7 25.4l43.3 39.4c6.9 6.2 9.6 15.9 6.4 24.6c-4.4 11.9-15.7 20-28.1 20h-86.9c-3.5-10.1-8-19.6-13.3-28.5l-26.4 45.8c-6.2 10.7-18.2 17.2-30.8 17.2s-24.6-6.5-30.8-17.2l-26.4-45.8c-5.3 8.9-10.8 18.4-13.3 28.5H32.4c-12.4 0-23.7-8.1-28.1-20c-3.2-8.7-.5-18.4 6.4-24.6l43.3-39.4C52.6 273.1 52 264.6 52 256s.6-17.1 1.7-25.4L10.4 191.2c-6.9-6.2-9.6-15.9-6.4-24.6C8.4 154.7 19.7 146.6 32.1 146.6h86.9c3.5 10.1 8 19.6 13.3 28.5l26.4-45.8c6.2-10.7 18.2-17.2 30.8-17.2s-24.6 6.5 30.8 17.2l26.4 45.8c5.3-8.9 10.8-18.4 13.3-28.5h86.9c12.4 0 23.7 8.1 28.1 20zM256 336a80 80 0 1 0 0-160 80 80 0 1 0 0 160z"/></svg>',
                star: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><path fill="currentColor" d="M316.9 18C311.6 7 300.4 0 288.1 0s-23.4 7-28.8 18L195 150.3 51.4 171.5c-12 1.8-22 10.2-25.7 21.7s-.7 24.2 7.9 32.7L137.8 329 113.2 474.7c-2 12 3 24.2 12.9 31.3s23 8 33.8 2.3l128.3-68.5 128.3 68.5c10.8 5.7 23.9 4.9 33.8-2.3s14.9-19.3 12.9-31.3L438.5 329 542.7 225.9c8.6-8.5 11.7-21.2 7.9-32.7s-13.7-19.9-25.7-21.7L381.2 150.3 316.9 18z"/></svg>',
                heart: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M47.6 300.4L228.3 469.1c7.5 7 17.4 10.9 27.7 10.9s20.2-3.9 27.7-10.9L464.4 300.4c30.4-28.3 47.6-68 47.6-109.5v-5.8c0-69.9-50.5-129.5-119.4-141C347 36.5 300.6 51.4 268 84L256 96 244 84c-32.6-32.6-79-47.5-124.6-39.9C50.5 55.6 0 115.2 0 185.1v5.8c0 41.5 17.2 81.2 47.6 109.5z"/></svg>',
                wrench: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M148.4 69.3c-10.2-10.2-23.8-15.6-38.2-15.6s-28 5.4-38.2 15.6L15.6 125.7c-10.2 10.2-15.6 23.8-15.6 38.2s5.4 28 15.6 38.2l99.3 99.3-39.5 39.5-32-32c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l64 64c12.5 12.5 32.8 12.5 45.3 0l32-32 39.5-39.5 99.3 99.3c10.2 10.2 23.8 15.6 38.2 15.6s28-5.4 38.2-15.6l56.4-56.4c-10.2-10.2-15.6-23.8-15.6-38.2s-5.4-28-15.6-38.2L329.8 247.4l68-68c10.2-10.2 15.6-23.8 15.6-38.2s-5.4-28-15.6-38.2l-56.4-56.4c-10.2-10.2-23.8-15.6-38.2-15.6s-28 5.4-38.2 15.6l-68 68L148.4 69.3z"/></svg>',
                sliders: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M368 128h-8v-24c0-13.3-10.7-24-24-24s-24 10.7-24 24v24h-8c-13.3 0-24 10.7-24 24s10.7 24 24 24h8v264c0 13.3 10.7 24 24 24s24-10.7 24-24V176h8c13.3 0 24-10.7 24-24s-10.7-24-24-24zm-96 232h-8V24c0-13.3-10.7-24-24-24S216 10.7 216 24v336h-8c-13.3 0-24 10.7-24 24s10.7 24 24 24h64c13.3 0 24-10.7 24-24s-10.7-24-24-24zm-96-64h-8V152c0-13.3-10.7-24-24-24s-24 10.7-24 24v144h-8c-13.3 0-24 10.7-24 24s10.7 24 24 24h64c13.3 0 24-10.7 24-24s-10.7-24-24-24z"/></svg>',
                ellipsis: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M328 256c0 39.8-32.2 72-72 72s-72-32.2-72-72 32.2-72 72-72 72 32.2 72 72zm104-72c-39.8 0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72zm-352 0c-39.8 0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72z"/></svg>',
                info: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M256 512A256 256 0 1 0 256 0a256 256 0 1 0 0 512zM216 336h24V272H216c-13.3 0-24-10.7-24-24s10.7-24 24-24h48c13.3 0 24 10.7 24 24v88h8c13.3 0 24 10.7 24 24s-10.7 24-24 24H216c-13.3 0-24-10.7-24-24s10.7-24 24-24zm40-144a32 32 0 1 1 0-64 32 32 0 1 1 0 64z"/></svg>',
                menu: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M0 96C0 78.3 14.3 64 32 64H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32C14.3 128 0 113.7 0 96zM0 256c0-17.7 14.3-32 32-32H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32c-17.7 0-32-14.3-32-32zM448 416c0 17.7-14.3 32-32 32H32c-17.7 0-32-14.3-32-32s14.3-32 32-32H416c17.7 0 32 14.3 32 32z"/></svg>'
            };

            // --- HELPER FUNCTIONS ---
            const vibrateDevice = () => {
                if ('vibrate' in navigator) {
                    // Strong but brief vibration pattern: short-strong-short
                    navigator.vibrate([200, 50, 300]);
                }
            };
            
            const toggleButtons = (showStart, showPause, showResume, showRepeat, showEnd) => {
                startBtn.classList.toggle('hidden', !showStart);
                pauseBtn.classList.toggle('hidden', !showPause);
                resumeBtn.classList.toggle('hidden', !showResume);
                repeatBtn.classList.toggle('hidden', !showRepeat);
                endBtn.classList.toggle('hidden', !showEnd);
            };

            // --- TIMER LOGIC ---
            const updateDisplay = (percentage) => {
                if (percentage < 0) percentage = 0;
                if (percentage > 100) percentage = 100;

                mainNumbers.textContent = `${percentage.toFixed(2)}%`;
                progressBar.style.width = `${percentage}%`;
            };
            
            let lastTick = performance.now();
            const durationLoop = (now) => {
                if (!isRunning || isPaused) return;

                const delta = now - lastTick;
                lastTick = now;
                timeRemaining -= delta;

                if (timeRemaining <= 0) {
                    timeRemaining = 0;
                    isRunning = false;
                    timerWrapper.classList.add('timer-paused');
                    playAlarm();
                    vibrateDevice();
                    toggleButtons(false, false, false, true, false); // show repeat
                }
                
                const elapsedTime = totalDuration - timeRemaining;
                const percentage = (elapsedTime / totalDuration) * 100;
                updateDisplay(percentage);

                if (isRunning) {
                   timerLoopId = requestAnimationFrame(durationLoop);
                }
            };

            const endTimeLoop = () => {
                if (!isRunning) return;

                const now = Date.now();
                const elapsedTime = now - startTime;
                let percentage = (elapsedTime / totalDuration) * 100;

                if (now >= targetEndTime) {
                    percentage = 100;
                    isRunning = false;
                    timerWrapper.classList.add('timer-paused');
                    playAlarm();
                    vibrateDevice();
                    toggleButtons(false, false, false, true, false);
                }
                
                updateDisplay(percentage);

                if (isRunning) {
                    timerLoopId = requestAnimationFrame(endTimeLoop);
                }
            };

            const startTimer = () => {
                if (isRunning) return;
                
                timerWrapper.classList.remove('timer-paused');
                timerWrapper.classList.add('timer-running');
                if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                isRunning = true;
                isPaused = false;

                const mode = timerModeSelect.value;
                if (mode === 'duration') {
                    lastTick = performance.now();
                    timerLoopId = requestAnimationFrame(durationLoop);
                    toggleButtons(false, false, false, false, false); 
                } else { // endTime
                    startTime = Date.now();
                    // totalDuration and targetEndTime are set in resetTimer
                    timerLoopId = requestAnimationFrame(endTimeLoop);
                    toggleButtons(false, false, false, false, false); // No pause in endTime mode
                }
            };

            const stopTimer = () => {
                isRunning = false;
                if (timerLoopId) {
                    cancelAnimationFrame(timerLoopId);
                }
            }

            const pauseTimer = () => {
                if (!isRunning || isPaused) return;
                isPaused = true;
                timerWrapper.classList.remove('timer-running');
                timerWrapper.classList.add('timer-paused');
                toggleButtons(false, false, true, true, true); 
                setTimeout(updateUIPositions, 0);
            };

            const resumeTimer = () => {
                if (!isPaused) return;
                isPaused = false;
                timerWrapper.classList.remove('timer-paused');
                timerWrapper.classList.add('timer-running');
                lastTick = performance.now();
                timerLoopId = requestAnimationFrame(durationLoop);
                toggleButtons(false, false, false, false, false);
                setTimeout(updateUIPositions, 0);
            };

            const resetTimer = () => {
                stopTimer();
                timerWrapper.classList.remove('timer-paused', 'timer-running');
                
                const mode = timerModeSelect.value;
                if (mode === 'duration') {
                    const hours = parseInt(durationHoursInput.value) || 0;
                    const minutes = parseInt(durationMinutesInput.value) || 0;
                    totalDuration = (hours * 3600 + minutes * 60) * 1000;
                    timeRemaining = totalDuration;
                } else { // endTime
                    const hour12 = parseInt(endTimeHourInput.value);
                    const minute = parseInt(endTimeMinuteInput.value);
                    const isPM = endTimeAmPmInput.value === 'PM';

                    let hour24 = hour12;
                    if (isPM && hour12 < 12) {
                        hour24 += 12; // 1pm becomes 13, etc.
                    } else if (!isPM && hour12 === 12) {
                        hour24 = 0; // 12am becomes 0
                    }
                    
                    const now = new Date();
                    const targetDate = new Date();
                    targetDate.setHours(hour24, minute, 0, 0);

                    if (targetDate < now) { // If time has passed for today, set for tomorrow
                        targetDate.setDate(targetDate.getDate() + 1);
                    }
                    
                    targetEndTime = targetDate.getTime();
                    const currentTime = Date.now();
                    totalDuration = targetEndTime - currentTime;
                    timeRemaining = totalDuration;
                }
                
                updateDisplay(0);
                toggleButtons(true, false, false, false, false); 
            };

            // --- ALARM SOUND ---
            const playAlarm = () => {
                const sound = alarmSoundSelect.value;
                if (sound === 'none' || !audioContext) return;

                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                gainNode.gain.setValueAtTime(0.5, audioContext.currentTime);

                switch(sound) {
                    case 'beep':
                        oscillator.frequency.setValueAtTime(880, audioContext.currentTime);
                        break;
                    case 'chime':
                        oscillator.type = 'triangle';
                        oscillator.frequency.setValueAtTime(1046.50, audioContext.currentTime); 
                        oscillator.frequency.setValueAtTime(783.99, audioContext.currentTime + 0.2); 
                        break;
                    case 'buzz':
                        oscillator.type = 'sawtooth';
                        oscillator.frequency.setValueAtTime(220, audioContext.currentTime); 
                        break;
                }
                oscillator.start();
                setTimeout(() => oscillator.stop(), 500);
            };

            // --- EVENT LISTENERS ---
            startBtn.addEventListener('click', startTimer);
            pauseBtn.addEventListener('click', pauseTimer);
            resumeBtn.addEventListener('click', resumeTimer);
            repeatBtn.addEventListener('click', () => { 
                // Disable transition temporarily for instant reset
                progressBar.style.transition = 'none';
                resetTimer(); 
                
                // Re-enable transition after a brief delay
                setTimeout(() => {
                    progressBar.style.transition = 'width 0.3s ease, background 0.3s ease, box-shadow 0.3s ease';
                }, 50);
                
                startTimer(); 
            });
            
            const endTimer = () => {
                stopTimer();
                timerWrapper.classList.remove('timer-paused', 'timer-running');
                
                // Disable transition temporarily for instant fill
                progressBar.style.transition = 'none';
                updateDisplay(100); // Instantly fill the bar
                
                // Re-enable transition after a brief delay
                setTimeout(() => {
                    progressBar.style.transition = 'width 0.3s ease, background 0.3s ease, box-shadow 0.3s ease';
                }, 50);
                
                playAlarm();
                vibrateDevice();
                toggleButtons(false, false, false, true, false); // Show only repeat button
            };
            
            endBtn.addEventListener('click', endTimer);
            
            timerModeSelect.addEventListener('change', () => {
                const isDurationMode = timerModeSelect.value === 'duration';
                durationSettings.classList.toggle('hidden', !isDurationMode);
                endtimeSettings.classList.toggle('hidden', isDurationMode);
                resetTimer();
            });

            const enforceMinMax = (e) => {
                const min = parseInt(e.target.min);
                const max = parseInt(e.target.max);
                let value = parseInt(e.target.value);
                if (isNaN(value)) value = min;
                if (value < min) e.target.value = min;
                if (value > max) e.target.value = max;
            };

            durationHoursInput.addEventListener('input', (e) => { e.target.value = e.target.value.replace(/[^0-9]/g, ''); });
            durationHoursInput.addEventListener('change', resetTimer);
            durationHoursInput.addEventListener('blur', enforceMinMax); // Correct value when user leaves the box
            durationMinutesInput.addEventListener('input', (e) => { e.target.value = e.target.value.replace(/[^0-9]/g, ''); });
            durationMinutesInput.addEventListener('change', resetTimer);
            durationMinutesInput.addEventListener('blur', enforceMinMax); // Correct value when user leaves the box
            
            endTimeHourInput.addEventListener('change', resetTimer);
            endTimeMinuteInput.addEventListener('change', resetTimer);
            endTimeAmPmInput.addEventListener('change', resetTimer);


            document.addEventListener('keydown', (e) => {
                if (e.code === 'Space' && e.target.tagName !== 'INPUT' && e.target.tagName !== 'SELECT') {
                    e.preventDefault();
                    if (!repeatBtn.classList.contains('hidden') && endBtn.classList.contains('hidden')) {
                        // When only Repeat button is visible, trigger it first
                        repeatBtn.click();
                    }
                    else if (!isRunning && !isPaused) startTimer();
                    else if (isPaused) resumeTimer();
                    else if (isRunning) pauseTimer();
                }
            });

            document.body.addEventListener('click', (e) => {
                const isClickOnInteractiveUI = e.target.closest('#options-btn') || e.target.closest('#options-panel') || e.target.closest('#options-panel-overlay') || e.target.closest('#settings-management-external') || (e.target.tagName === 'BUTTON' && e.target.closest('#controls'));
                if (isClickOnInteractiveUI) return;

                // When only Repeat button is visible, trigger it
                if (!repeatBtn.classList.contains('hidden') && endBtn.classList.contains('hidden')) {
                    repeatBtn.click();
                }
                // Normal timer controls
                else if (isRunning && !isPaused) pauseTimer();
                else if (isPaused) resumeTimer();
                else if (!isRunning && !isPaused) startTimer(); // Click anywhere to start
            });

            const openOptionsPanel = () => {
                optionsPanelOverlay.classList.add('visible');
                document.body.classList.add('settings-open');
            };

            const closeOptionsPanel = () => {
                optionsPanelOverlay.classList.remove('visible');
                document.body.classList.remove('settings-open');
                
                // Collapse all sections except Timer & Sound when closing panel
                const allSections = document.querySelectorAll('.options-section');
                allSections.forEach(section => {
                    // Keep Timer & Sound section open (it has "Timer & Sound" in the h3)
                    const sectionTitle = section.querySelector('h3');
                    if (sectionTitle && sectionTitle.textContent.includes('Timer & Sound')) {
                        section.classList.add('is-open');
                    } else {
                        section.classList.remove('is-open');
                    }
                });
            };

            optionsBtn.addEventListener('click', openOptionsPanel);
            closePanelBtn.addEventListener('click', closeOptionsPanel);

            optionsPanelOverlay.addEventListener('click', (e) => {
                if (e.target === optionsPanelOverlay) {
                    closeOptionsPanel();
                }
            });

            // Collapsible sections
            document.querySelectorAll('.options-section.collapsible h3').forEach(header => {
                header.addEventListener('click', () => {
                    header.parentElement.classList.toggle('is-open');
                });
            });
            
            // --- SETTINGS MANAGEMENT ---
            saveSettingsBtn.addEventListener('click', () => {
                const settings = {};
                allInputs.forEach(input => {
                    // We don't save file inputs
                    if (input.type === 'file') return;
                    
                    if (input.type === 'checkbox') {
                        settings[input.id] = input.checked;
                    } else {
                        settings[input.id] = input.value;
                    }
                });
                localStorage.setItem('progressBarTimerSettings', JSON.stringify(settings));
                
                // Show save confirmation
                saveConfirm.classList.add('visible');
                setTimeout(() => {
                    saveConfirm.classList.remove('visible');
                }, 1500);
            });

            resetSettingsBtn.addEventListener('click', () => {
                confirmModalOverlay.classList.remove('hidden');
            });

            confirmYesBtn.addEventListener('click', () => {
                localStorage.removeItem('progressBarTimerSettings');
                location.reload();
            });
            
            confirmNoBtn.addEventListener('click', () => {
                confirmModalOverlay.classList.add('hidden');
            });


            function loadAndApplySettings() {
                const savedSettings = localStorage.getItem('progressBarTimerSettings');
                if (!savedSettings) return;

                const settings = JSON.parse(savedSettings);

                allInputs.forEach(input => {
                    if (settings[input.id] !== undefined) {
                        if (input.type === 'checkbox') {
                            input.checked = settings[input.id];
                        } else {
                            input.value = settings[input.id];
                        }
                        // Dispatch events to trigger the live update listeners
                        input.dispatchEvent(new Event('input', { bubbles: true }));
                        input.dispatchEvent(new Event('change', { bubbles: true }));
                    }
                });

                // Ensure interface opacity CSS var is applied if saved (in case no listener fired yet)
                if (settings['ui-opacity-input'] !== undefined) {
                    const value = Math.max(20, Math.min(100, parseInt(settings['ui-opacity-input'], 10)));
                    setCssVar('--ui-opacity', value / 100);
                }
            }


            // --- LIVE CUSTOMIZATION ---
            const setCssVar = (name, value, unit = '') => root.style.setProperty(name, value + unit);
            
            messageInput.addEventListener('input', (e) => updateTimerMessage(e.target.value));
            ellipsisAnimationSelect.addEventListener('change', () => updateTimerMessage(messageInput.value));
            ellipsisIntensityInput.addEventListener('input', (e) => {
                const intensityValue = parseFloat(e.target.value); // 0-10
                const pulseScale = 1 + (intensityValue / 10) * 0.5; // maps to 1.0 - 1.5
                const waveOpacity = 0.5 - (intensityValue / 10) * 0.4; // maps to 0.5 - 0.1
                setCssVar('--ellipsis-pulse-scale', pulseScale);
                setCssVar('--ellipsis-wave-opacity', waveOpacity);
            });


            messageFontSizeInput.addEventListener('input', (e) => setCssVar('--message-font-size', e.target.value, 'rem'));
            messageColorInput.addEventListener('input', e => setCssVar('--message-color', e.target.value));
            messageGlowColorInput.addEventListener('input', e => setCssVar('--message-glow-color', e.target.value));
            messageOutlineSizeInput.addEventListener('input', e => setCssVar('--message-outline-size', e.target.value, 'px'));
            messageOutlineColorInput.addEventListener('input', e => setCssVar('--message-outline-color', e.target.value));

            barLengthInput.addEventListener('input', (e) => setCssVar('--bar-length', e.target.value, 'vw'));
            barWidthInput.addEventListener('input', (e) => setCssVar('--bar-width', e.target.value, 'px'));
            barCornerInput.addEventListener('input', (e) => setCssVar('--bar-corner-radius', e.target.value, 'px'));
            borderColorInput.addEventListener('input', e => setCssVar('--border-color', e.target.value));
            borderSizeInput.addEventListener('input', e => setCssVar('--border-size', e.target.value, 'px'));
            
            fontSelect.addEventListener('change', (e) => {
                // Add smooth fade effect during font change
                const timerDisplay = document.getElementById('timer-display');
                const timerMessage = document.getElementById('timer-message');
                
                // Fade out slightly
                timerDisplay.style.opacity = '0.7';
                timerMessage.style.opacity = '0.7';
                
                // Change font after brief delay
                setTimeout(() => {
                    setCssVar('--font-family', e.target.value);
                    
                    // Fade back in
                    setTimeout(() => {
                        timerDisplay.style.opacity = '1';
                        timerMessage.style.opacity = '1';
                    }, 50);
                }, 100);
            });
            fontSizeInput.addEventListener('input', (e) => setCssVar('--font-size', e.target.value, 'px'));
            fontColorInput.addEventListener('input', (e) => setCssVar('--font-color', e.target.value));
            fontOutlineColorInput.addEventListener('input', (e) => setCssVar('--font-outline-color', e.target.value));
            textGlowColorInput.addEventListener('input', (e) => setCssVar('--text-glow-color', e.target.value));
            
            iconPresetSelect.addEventListener('change', e => {
                const iconKey = e.target.value;
                if(presetIcons[iconKey]) {
                    iconAnimator.innerHTML = presetIcons[iconKey];
                    iconAnimator.style.backgroundImage = 'none';
                    iconAnimator.classList.remove('custom-icon');
                    iconUploadInput.value = '';
                    // Apply the selected color to preset icons
                    iconAnimator.style.color = iconColorInput.value;
                }
            });

            function applyIconAnimation() {
                iconAnimator.classList.remove('animated-spin', 'animated-pulse', 'animated-float', 'animated-wobble', 'animated-jello');
                if (iconAnimationToggle.checked) {
                    const style = iconAnimationStyleSelect.value;
                    iconAnimator.classList.add(`animated-${style}`);
                }
            }

            iconAnimationToggle.addEventListener('change', applyIconAnimation);
            iconAnimationStyleSelect.addEventListener('change', applyIconAnimation);

            iconAnimationSpeedInput.addEventListener('input', (e) => setCssVar('--options-btn-animation-speed', e.target.value, 's'));
            iconSizeInput.addEventListener('input', (e) => setCssVar('--options-btn-size', e.target.value, 'px'));
            iconColorInput.addEventListener('input', (e) => {
                if (!iconAnimator.classList.contains('custom-icon')) {
                    iconAnimator.style.color = e.target.value;
                }
            });
            
            iconUploadInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        iconAnimator.style.backgroundImage = `url(${event.target.result})`;
                        iconAnimator.innerHTML = '';
                        iconAnimator.classList.add('custom-icon');

                        let customOption = iconPresetSelect.querySelector('option[value="custom"]');
                        if (!customOption) {
                            customOption = document.createElement('option');
                            customOption.value = 'custom';
                            customOption.textContent = 'Custom (Uploaded)';
                            iconPresetSelect.appendChild(customOption);
                        }
                        iconPresetSelect.value = 'custom';
                    };
                    reader.readAsDataURL(file);
                }
            });
            clearIconBtn.addEventListener('click', () => {
                iconAnimator.innerHTML = presetIcons.menu;
                iconAnimator.style.backgroundImage = 'none';
                iconAnimator.classList.remove('custom-icon');
                iconUploadInput.value = '';
                iconPresetSelect.value = 'menu';
                // Reset to default color
                iconAnimator.style.color = iconColorInput.value;
                const customOption = iconPresetSelect.querySelector('option[value="custom"]');
                if (customOption) {
                    customOption.remove();
                }
            });

            const updateUIPositions = () => {
                // Icon positioning removed - icon stays in CSS position
                // Function kept for other UI updates if needed
            };

            [fontSizeInput, barWidthInput, fontSelect, messageFontSizeInput, iconSizeInput, barLengthInput].forEach(el => {
                el.addEventListener('input', updateUIPositions);
            });
            
            bgColorInput.addEventListener('input', (e) => {
                 document.body.style.backgroundImage = 'none'; 
                 setCssVar('--bg-color', e.target.value);
            });
            bgImageUploadBtn.addEventListener('click', () => {
                bgImageUploadInput.click();
            });
            
            bgImageUploadInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => document.body.style.backgroundImage = `url(${event.target.result})`;
                    reader.readAsDataURL(file);
                }
            });
            clearBgBtn.addEventListener('click', () => {
                document.body.style.backgroundImage = 'none';
                bgImageUploadInput.value = '';
            });
            
            // --- PARTICLE SYSTEM ---
            const canvas = document.getElementById('particles-canvas');
            const ctx = canvas.getContext('2d');
            let particles = [];
            let animationId;
            
            const resizeCanvas = () => {
                // Match canvas to its rendered CSS box (covers safe areas)
                const rect = canvas.getBoundingClientRect();
                const dpr = window.devicePixelRatio || 1;
                canvas.width = Math.round(rect.width * dpr);
                canvas.height = Math.round(rect.height * dpr);
                ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
            };
            
            // Initialize canvas size
            resizeCanvas();
            
            const createParticle = () => {
                const speed = parseFloat(particleSpeedInput.value);
                const size = parseFloat(particleSizeInput.value);
                const direction = particleDirectionSelect.value;
                const colorStyle = particleColorStyleSelect.value;
                const baseColor = particleColorInput.value;
                const multiColor1 = particleMultiColor1Input.value;
                const multiColor2 = particleMultiColor2Input.value;
                const multiColor3 = particleMultiColor3Input.value;
                const multiColor4 = particleMultiColor4Input.value;
                
                // Generate color based on style
                let color = baseColor;
                if (colorStyle === 'rainbow') {
                    const hue = Math.random() * 360;
                    color = `hsl(${hue}, 100%, 70%)`;
                } else if (colorStyle === 'random') {
                    color = `hsl(${Math.random() * 360}, ${50 + Math.random() * 50}%, ${50 + Math.random() * 30}%)`;
                } else if (colorStyle === 'multiple') {
                    const colors = [multiColor1, multiColor2, multiColor3, multiColor4];
                    color = colors[Math.floor(Math.random() * colors.length)];
                }
                
                // Set initial position and velocity based on direction
                let x, y, vx, vy;
                
                switch (direction) {
                    case 'up':
                        x = Math.random() * canvas.width;
                        y = canvas.height + 10;
                        vx = (Math.random() - 0.5) * speed * 0.2;
                        vy = -speed * (1.5 + Math.random() * 0.5);
                        break;
                    case 'down':
                        x = Math.random() * canvas.width;
                        y = -10;
                        vx = (Math.random() - 0.5) * speed * 0.2;
                        vy = speed * (1.5 + Math.random() * 0.5);
                        break;
                    case 'left':
                        x = canvas.width + 10;
                        y = Math.random() * canvas.height;
                        vx = -speed * (1.5 + Math.random() * 0.5);
                        vy = (Math.random() - 0.5) * speed * 0.2;
                        break;
                    case 'right':
                        x = -10;
                        y = Math.random() * canvas.height;
                        vx = speed * (1.5 + Math.random() * 0.5);
                        vy = (Math.random() - 0.5) * speed * 0.2;
                        break;
                    case 'bounce':
                        x = Math.random() * canvas.width;
                        y = Math.random() * canvas.height;
                        vx = (Math.random() - 0.5) * speed * 2;
                        vy = (Math.random() - 0.5) * speed * 2;
                        break;
                    case 'random':
                        x = Math.random() * canvas.width;
                        y = Math.random() * canvas.height;
                        vx = (Math.random() - 0.5) * speed * 2;
                        vy = (Math.random() - 0.5) * speed * 2;
                        break;
                }
                
                return {
                    x: x,
                    y: y,
                    vx: vx,
                    vy: vy,
                    size: size,
                    color: color,
                    baseColor: baseColor,
                    multiColor1: multiColor1,
                    multiColor2: multiColor2,
                    multiColor3: multiColor3,
                    multiColor4: multiColor4,
                    colorStyle: colorStyle,
                    opacity: 0.8 + Math.random() * 0.2,
                    rotation: Math.random() * Math.PI * 2,
                    rotationSpeed: (Math.random() - 0.5) * 0.1,
                    twinklePhase: Math.random() * Math.PI * 2,
                    twinkleSpeed: parseFloat(particleTwinkleInput.value) > 0 ? (0.1 + (parseFloat(particleTwinkleInput.value) / 100) * 0.2) : 0, // Custom twinkle speed
                    direction: direction
                };
            };
            
            // Cache expensive calculations
            let twinkleIntensity = 0;
            let twinkleIntensityUpdated = false;
            let twinkleSpeedBase = 0;
            
            const drawParticle = (particle) => {
                // Cache twinkle intensity calculation (only update when input changes)
                if (!twinkleIntensityUpdated) {
                    twinkleIntensity = parseFloat(particleTwinkleInput.value) / 100; // 0..1
                    // Non-linear mapping: very slow at low values, much faster at high values
                    // Map to per-frame phase increment (used below)
                    twinkleSpeedBase = twinkleIntensity === 0 ? 0 : (0.001 + Math.pow(twinkleIntensity, 2.2) * 0.05);
                    twinkleIntensityUpdated = true;
                }
                
                ctx.save();
                ctx.translate(particle.x, particle.y);
                
                // Only rotate if rotation is significant
                if (Math.abs(particle.rotation) > 0.01) {
                    ctx.rotate(particle.rotation);
                }
                
                // Optimized twinkling effect
                const twinkleEffect = twinkleIntensity > 0 ? Math.sin(particle.twinklePhase) : 1;
                const currentOpacity = particle.opacity * (twinkleIntensity > 0 ? (0.3 + 0.7 * twinkleEffect) : 1);
                
                ctx.globalAlpha = currentOpacity;
                
                // Optimized shadow settings
                ctx.shadowColor = particle.color;
                ctx.shadowBlur = twinkleIntensity > 0 ? (15 + twinkleEffect * 10) : 15;
                ctx.shadowOffsetX = 0;
                ctx.shadowOffsetY = 0;
                
                // Set fill style
                ctx.fillStyle = particle.color;
                
                // Draw main particle (optimized rectangle)
                const halfSize = particle.size * 0.5;
                ctx.fillRect(-halfSize, -halfSize, particle.size, particle.size);
                
                // Draw inner core (only if size is large enough)
                if (particle.size > 2) {
                    ctx.shadowBlur = 0;
                    ctx.fillStyle = '#FFFFFF';
                    const quarterSize = particle.size * 0.25;
                    ctx.fillRect(-quarterSize, -quarterSize, halfSize, halfSize);
                }
                
                ctx.restore();
            };
            
            const animate = () => {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // Cache canvas dimensions for better performance
                const canvasWidth = canvas.width;
                const canvasHeight = canvas.height;
                const canvasCenterX = canvasWidth * 0.5;
                const canvasCenterY = canvasHeight * 0.5;
                
                particles.forEach(particle => {
                    // Update particle position
                    particle.x += particle.vx;
                    particle.y += particle.vy;
                    
                    particle.rotation += particle.rotationSpeed;
                    // Advance twinkle phase using non-linear base speed plus small per-particle variance
                    particle.twinklePhase += (twinkleSpeedBase + particle.twinkleSpeed * 0.01);
                    
                    // Optimized color updates (reduce Math.random calls)
                    if (particle.colorStyle === 'rainbow') {
                        const hue = (particle.twinklePhase * 50) % 360;
                        particle.color = `hsl(${hue}, 100%, 70%)`;
                    } else if (particle.colorStyle === 'random' && Math.random() < 0.005) { // Reduced frequency
                        particle.color = `hsl(${Math.random() * 360}, ${50 + Math.random() * 50}%, ${50 + Math.random() * 30}%)`;
                    }
                    
                    // Optimized screen wrapping using cached dimensions
                    const direction = particle.direction;
                    const margin = 10;
                    
                    switch (direction) {
                        case 'up':
                            if (particle.x < -margin) particle.x = canvasWidth + margin;
                            if (particle.x > canvasWidth + margin) particle.x = -margin;
                            if (particle.y < -margin) {
                                particle.y = canvasHeight + margin;
                                particle.x = Math.random() * canvasWidth;
                            }
                            break;
                        case 'down':
                            if (particle.x < -margin) particle.x = canvasWidth + margin;
                            if (particle.x > canvasWidth + margin) particle.x = -margin;
                            if (particle.y > canvasHeight + margin) {
                                particle.y = -margin;
                                particle.x = Math.random() * canvasWidth;
                            }
                            break;
                        case 'left':
                            if (particle.y < -margin) particle.y = canvasHeight + margin;
                            if (particle.y > canvasHeight + margin) particle.y = -margin;
                            if (particle.x < -margin) {
                                particle.x = canvasWidth + margin;
                                particle.y = Math.random() * canvasHeight;
                            }
                            break;
                        case 'right':
                            if (particle.y < -margin) particle.y = canvasHeight + margin;
                            if (particle.y > canvasHeight + margin) particle.y = -margin;
                            if (particle.x > canvasWidth + margin) {
                                particle.x = -margin;
                                particle.y = Math.random() * canvasHeight;
                            }
                            break;
                        case 'bounce':
                            // Optimized bounce with cached dimensions
                            if (particle.x < 0 || particle.x > canvasWidth) {
                                particle.vx = -particle.vx;
                                particle.x = Math.max(0, Math.min(canvasWidth, particle.x));
                            }
                            if (particle.y < 0 || particle.y > canvasHeight) {
                                particle.vy = -particle.vy;
                                particle.y = Math.max(0, Math.min(canvasHeight, particle.y));
                            }
                            break;
                        case 'random':
                            if (particle.x < -margin) particle.x = canvasWidth + margin;
                            if (particle.x > canvasWidth + margin) particle.x = -margin;
                            if (particle.y < -margin) particle.y = canvasHeight + margin;
                            if (particle.y > canvasHeight + margin) particle.y = -margin;
                            break;
                    }
                    
                    drawParticle(particle);
                });
                
                animationId = requestAnimationFrame(animate);
            };
            
            const updateParticles = () => {
                const density = parseInt(particleDensityInput.value);
                const targetCount = density * 100; // x2 density scaling
                
                // Clear existing particles if density is 0
                if (targetCount === 0) {
                    particles = [];
                    return;
                }
                
                // Adjust particle count more efficiently
                if (particles.length < targetCount) {
                    // Spawn all remaining particles immediately for simultaneous appearance
                    const needed = targetCount - particles.length;
                    const newParticles = new Array(needed).fill(0).map(() => createParticle());
                    particles.push(...newParticles);
                } else if (particles.length > targetCount) {
                    // Remove excess particles
                    particles.splice(targetCount);
                }
                
                // Update existing particles
                particles.forEach(particle => {
                    const speed = parseFloat(particleSpeedInput.value);
                    const size = parseFloat(particleSizeInput.value);
                    const direction = particleDirectionSelect.value;
                    const colorStyle = particleColorStyleSelect.value;
                    const baseColor = particleColorInput.value;
                    const multiColor1 = particleMultiColor1Input.value;
                    const multiColor2 = particleMultiColor2Input.value;
                    const multiColor3 = particleMultiColor3Input.value;
                    const multiColor4 = particleMultiColor4Input.value;
                    
                    // Update properties
                    particle.size = size;
                    particle.direction = direction;
                    particle.colorStyle = colorStyle;
                    particle.baseColor = baseColor;
                    particle.multiColor1 = multiColor1;
                    particle.multiColor2 = multiColor2;
                    particle.multiColor3 = multiColor3;
                    particle.multiColor4 = multiColor4;
                    particle.twinkleSpeed = parseFloat(particleTwinkleInput.value) > 0 ? (0.1 + (parseFloat(particleTwinkleInput.value) / 100) * 0.2) : 0;
                    
                    // Update color based on style
                    if (colorStyle === 'rainbow') {
                        const hue = Math.random() * 360;
                        particle.color = `hsl(${hue}, 100%, 70%)`;
                    } else if (colorStyle === 'random') {
                        particle.color = `hsl(${Math.random() * 360}, ${50 + Math.random() * 50}%, ${50 + Math.random() * 30}%)`;
                    } else if (colorStyle === 'multiple') {
                        const colors = [multiColor1, multiColor2, multiColor3, multiColor4];
                        particle.color = colors[Math.floor(Math.random() * colors.length)];
                    } else {
                        particle.color = baseColor;
                    }
                    
                    // Update velocity based on direction
                    switch (direction) {
                        case 'up':
                            particle.vx = (Math.random() - 0.5) * speed * 0.2;
                            particle.vy = -speed * (1.5 + Math.random() * 0.5);
                            break;
                        case 'down':
                            particle.vx = (Math.random() - 0.5) * speed * 0.2;
                            particle.vy = speed * (1.5 + Math.random() * 0.5);
                            break;
                        case 'left':
                            particle.vx = -speed * (1.5 + Math.random() * 0.5);
                            particle.vy = (Math.random() - 0.5) * speed * 0.2;
                            break;
                        case 'right':
                            particle.vx = speed * (1.5 + Math.random() * 0.5);
                            particle.vy = (Math.random() - 0.5) * speed * 0.2;
                            break;
                        case 'bounce':
                            particle.vx = (Math.random() - 0.5) * speed * 2;
                            particle.vy = (Math.random() - 0.5) * speed * 2;
                            break;
                        case 'orbit':
                            particle.vx = Math.cos(particle.orbitAngle) * speed * 0.5;
                            particle.vy = Math.sin(particle.orbitAngle) * speed * 0.5;
                            break;
                        case 'random':
                            particle.vx = (Math.random() - 0.5) * speed * 2;
                            particle.vy = (Math.random() - 0.5) * speed * 2;
                            break;
                    }
                });
            };
            
            // Event listeners for particles
            particlesToggle.addEventListener('change', (e) => {
                particlesOptions.classList.toggle('disabled', !e.target.checked);
                canvas.classList.toggle('active', e.target.checked);
                
                if (e.target.checked) {
                    resizeCanvas();
                    updateParticles();
                    animate();
                } else {
                    cancelAnimationFrame(animationId);
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    particles = []; // Clear particles array when disabled
                }
            });
            
            [particleDensityInput, particleSpeedInput, particleSizeInput, particleTwinkleInput, particleColorInput, particleMultiColor1Input, particleMultiColor2Input, particleMultiColor3Input, particleMultiColor4Input, particleColorStyleSelect, particleDirectionSelect].forEach(input => {
                input.addEventListener('input', () => {
                    // Reset twinkle intensity cache when twinkle input changes
                    if (input === particleTwinkleInput) {
                        twinkleIntensityUpdated = false;
                    }
                    updateParticles();
                });
                input.addEventListener('change', () => {
                    // Reset twinkle intensity cache when twinkle input changes
                    if (input === particleTwinkleInput) {
                        twinkleIntensityUpdated = false;
                    }
                    updateParticles();
                });
            });
            
            // Show/hide color inputs based on color style selection
            particleColorStyleSelect.addEventListener('change', () => {
                const colorItem = particleColorInput.closest('.option-item');
                const multiColor1Item = particleMultiColor1Input.closest('.option-item');
                const multiColor2Item = particleMultiColor2Input.closest('.option-item');
                const multiColor3Item = particleMultiColor3Input.closest('.option-item');
                const multiColor4Item = particleMultiColor4Input.closest('.option-item');
                
                if (particleColorStyleSelect.value === 'multiple') {
                    colorItem.style.display = 'none';
                    multiColor1Item.style.display = 'flex';
                    multiColor2Item.style.display = 'flex';
                    multiColor3Item.style.display = 'flex';
                    multiColor4Item.style.display = 'flex';
                } else {
                    colorItem.style.display = 'flex';
                    multiColor1Item.style.display = 'none';
                    multiColor2Item.style.display = 'none';
                    multiColor3Item.style.display = 'none';
                    multiColor4Item.style.display = 'none';
                }
                updateParticles();
            });
            
            // Initialize color input visibility
            const colorItem = particleColorInput.closest('.option-item');
            const multiColor1Item = particleMultiColor1Input.closest('.option-item');
            const multiColor2Item = particleMultiColor2Input.closest('.option-item');
            const multiColor3Item = particleMultiColor3Input.closest('.option-item');
            const multiColor4Item = particleMultiColor4Input.closest('.option-item');
            
            if (particleColorStyleSelect.value === 'multiple') {
                colorItem.style.display = 'none';
                multiColor1Item.style.display = 'flex';
                multiColor2Item.style.display = 'flex';
                multiColor3Item.style.display = 'flex';
                multiColor4Item.style.display = 'flex';
            } else {
                colorItem.style.display = 'flex';
                multiColor1Item.style.display = 'none';
                multiColor2Item.style.display = 'none';
                multiColor3Item.style.display = 'none';
                multiColor4Item.style.display = 'none';
            }
            
            window.addEventListener('resize', () => {
                if (particlesToggle.checked) {
                    resizeCanvas();
                }
            });
            
            startBtnColorInput.addEventListener('input', (e) => setCssVar('--start-btn-color', e.target.value));
            repeatBtnColorInput.addEventListener('input', (e) => setCssVar('--repeat-btn-color', e.target.value));
            
            btnPaddingYInput.addEventListener('input', e => setCssVar('--btn-padding-y', e.target.value, 'px'));
            btnPaddingXInput.addEventListener('input', e => setCssVar('--btn-padding-x', e.target.value, 'px'));
            btnFontSizeInput.addEventListener('input', e => setCssVar('--btn-font-size', e.target.value, 'rem'));
            btnBorderColorInput.addEventListener('input', e => setCssVar('--btn-border-color', e.target.value));
            btnFontColorInput.addEventListener('input', e => setCssVar('--btn-font-color', e.target.value));
            btnOutlineSizeInput.addEventListener('input', e => setCssVar('--btn-outline-size', e.target.value, 'px'));
            btnOutlineColorInput.addEventListener('input', e => setCssVar('--btn-outline-color', e.target.value));
            uiOpacityInput.addEventListener('input', (e) => {
                // Map 20..100 to 0.2..1.0
                const value = Math.max(20, Math.min(100, parseInt(e.target.value, 10)));
                setCssVar('--ui-opacity', value / 100);
            });
            
             // --- GLOW TOGGLE LOGIC ---
            function setupGlowToggle(toggle, group, intensityInput, cssVar) {
                if(!toggle || !group || !intensityInput) return; // Prevent error if element is missing
                function updateState() {
                    const isEnabled = toggle.checked;
                    group.classList.toggle('disabled', !isEnabled);
                    if (!isEnabled) {
                        setCssVar(cssVar, '0px'); // Turn off glow
                    } else {
                        setCssVar(cssVar, `${intensityInput.value}px`); // Restore glow from slider
                    }
                }

                toggle.addEventListener('change', updateState);
                intensityInput.addEventListener('input', (e) => {
                    if (toggle.checked) {
                        setCssVar(cssVar, `${e.target.value}px`);
                    }
                });

                // Initial state on load
                updateState();
            }
            
            function setupMutuallyExclusiveGlows(normalToggle, normalGroup, normalIntensity, normalVar, neonToggle, neonGroup, neonIntensity, neonVar) {
                if(!normalToggle || !neonToggle) return; // Prevent errors
                function updateState(changedToggle) {
                    if (changedToggle === 'normal' && normalToggle.checked) {
                        neonToggle.checked = false;
                    } else if (changedToggle === 'neon' && neonToggle.checked) {
                        normalToggle.checked = false;
                    }
                    
                    const normalEnabled = normalToggle.checked;
                    const neonEnabled = neonToggle.checked;

                    normalGroup.classList.toggle('disabled', !normalEnabled);
                    neonGroup.classList.toggle('disabled', !neonEnabled);

                    setCssVar(normalVar, normalEnabled ? `${normalIntensity.value}px` : '0px');
                    setCssVar(neonVar, neonEnabled ? `${neonIntensity.value}px` : '0px');
                }

                normalToggle.addEventListener('change', () => updateState('normal'));
                neonToggle.addEventListener('change', () => updateState('neon'));
                
                normalIntensity.addEventListener('input', () => updateState());
                neonIntensity.addEventListener('input', () => updateState());
                
                updateState(); // Initial call
            }
            
             function setupGradientToggle(toggle, colorInput, gradientGroup, startInput, endInput, cssVar) {
                if(!toggle) return;
                const colorOption = document.getElementById('bar-color-option');
                function updateState() {
                    const isGradient = toggle.checked;
                    gradientGroup.classList.toggle('disabled', !isGradient);
                    if(colorOption) colorOption.classList.toggle('disabled', isGradient);

                    if (isGradient) {
                        setCssVar(cssVar, `linear-gradient(90deg, ${startInput.value}, ${endInput.value})`);
                        setCssVar('--bar-color', endInput.value); // Match glow to end color
                    } else {
                        setCssVar(cssVar, colorInput.value);
                        setCssVar('--bar-color', colorInput.value); // Match glow to solid color
                    }
                }
                toggle.addEventListener('change', updateState);
                colorInput.addEventListener('input', updateState);
                startInput.addEventListener('input', updateState);
                endInput.addEventListener('input', updateState);
                updateState();
            }

            setupGradientToggle(barGradientToggle, barColorInput, barGradientOptions, barGradientStartInput, barGradientEndInput, '--bar-background');
            setupMutuallyExclusiveGlows(barGlowNormalToggle, barGlowNormalOptions, barGlowIntensityInput, '--bar-glow-intensity', barGlowNeonToggle, barGlowNeonOptions, barNeonIntensityInput, '--bar-neon-intensity');
            setupMutuallyExclusiveGlows(textGlowNormalToggle, textGlowNormalOptions, textGlowSpreadInput, '--text-glow-spread', textGlowNeonToggle, textGlowNeonOptions, textNeonSpreadInput, '--text-neon-spread');
            setupMutuallyExclusiveGlows(messageGlowToggle, messageGlowOptions, messageGlowSpreadInput, '--message-glow-spread', messageNeonToggle, messageNeonOptions, messageNeonSpreadInput, '--message-neon-spread');
            setupGlowToggle(borderGlowToggle, borderGlowOptions, borderGlowIntensityInput, '--border-glow-intensity');
            setupGlowToggle(fontOutlineToggle, fontOutlineOptions, fontOutlineSizeInput, '--font-outline-size');
            setupGlowToggle(messageOutlineToggle, messageOutlineOptions, messageOutlineSizeInput, '--message-outline-size');
            setupGlowToggle(btnOutlineToggle, btnOutlineOptions, btnOutlineSizeInput, '--btn-outline-size');
            setupMutuallyExclusiveGlows(btnGlowNormalToggle, btnGlowNormalOptions, btnGlowIntensityInput, '--btn-glow-intensity', btnGlowNeonToggle, btnGlowNeonOptions, btnNeonIntensityInput, '--btn-neon-intensity');
            borderGlowColorInput.addEventListener('input', e => setCssVar('--border-glow-color', e.target.value));

            // Message toggle functionality
            function setupMessageToggle(toggle, optionsGroup) {
                if(!toggle || !optionsGroup) return;
                function updateState() {
                    const isEnabled = toggle.checked;
                    optionsGroup.classList.toggle('disabled', !isEnabled);
                    timerMessage.style.display = isEnabled ? 'block' : 'none';
                }
                toggle.addEventListener('change', updateState);
                updateState(); // Initial call
            }
            setupMessageToggle(messageToggle, messageOptions);

            // Update timer message function
            const updateTimerMessage = (text) => {
                let displayText = text.trim();
                if (!displayText) {
                    displayText = "Your custom message here";
                }

                if (displayText.endsWith('...')) {
                    const mainText = displayText.slice(0, -3);
                    const animationType = ellipsisAnimationSelect.value;
                    timerMessage.innerHTML = `<span>${mainText}</span><span class="ellipsis ${animationType}"><span class="ellipsis-dot">.</span><span class="ellipsis-dot">.</span><span class="ellipsis-dot">.</span></span>`;
                } else {
                    timerMessage.innerHTML = ''; // Clear previous content
                    timerMessage.textContent = displayText;
                }
            };

            window.addEventListener('resize', () => {
                let percentage = 0;
                if (totalDuration > 0) {
                    const mode = timerModeSelect.value;
                    if (mode === 'duration') {
                        const elapsedTime = totalDuration - timeRemaining;
                        percentage = (elapsedTime / totalDuration) * 100;
                    } else { // endTime
                        const now = Date.now();
                        if (now >= targetEndTime) {
                            percentage = 100;
                        } else if (!startTime || now < startTime) {
                            percentage = 0;
                        } else {
                            const elapsedTime = now - startTime;
                            percentage = (elapsedTime / totalDuration) * 100;
                        }
                    }
                }
                updateDisplay(percentage);
                updateUIPositions();
            });

            // --- INITIALIZATION ---
            // Populate End Time dropdowns
            for (let i = 1; i <= 12; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i;
                endTimeHourInput.appendChild(option);
            }
            for (let i = 0; i <= 59; i++) {
                const option = document.createElement('option');
                const value = i.toString().padStart(2, '0');
                option.value = value;
                option.textContent = value;
                endTimeMinuteInput.appendChild(option);
            }

            iconAnimator.innerHTML = presetIcons.menu; // Load default icon into the correct container
            iconAnimator.style.color = iconColorInput.value; // Apply initial color
            resetTimer(); 
            updateTimerMessage(messageInput.value);
            loadAndApplySettings();
            // Final UI position update after loading settings
            updateUIPositions();
        });
    </script>
    
    <!-- PWA Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then((registration) => {
                        console.log('SW registered: ', registration);
                    })
                    .catch((registrationError) => {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }
    </script>
</body>
</html>

































