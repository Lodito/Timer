<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no, viewport-fit=cover">
    <title>Customizable Progress Bar Timer</title>
    
      <!-- Google Material Symbols -->
      <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    
    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Timer">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#1a1a1a">
    <meta name="msapplication-navbutton-color" content="#1a1a1a">
    <meta name="apple-touch-fullscreen" content="yes">
    <!-- iPad specific PWA settings -->
    <meta name="format-detection" content="telephone=no">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <!-- Google Fonts for different styles --><link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch&family=Electrolyze&family=Jersey+10&family=Jersey+20&family=Jersey+25&family=Orbitron:wght@400;700&family=Press+Start+2P&family=Russo+One&family=Share+Tech&family=Share+Tech+Mono&family=Teko&family=Tomorrow&family=VT323&family=Zen+Dots&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,500,0,0" />
    
    <style>
        /* --- Font Preloading --- */
        .font-preloader {
            font-family: 'Inter', system-ui, sans-serif;
            font-family: 'VT323', monospace;
            font-family: 'Press Start 2P', cursive;
            font-family: 'Share Tech Mono', monospace;
            font-family: 'Jersey 25', sans-serif;
            font-family: 'Jersey 20', sans-serif;
            font-family: 'Jersey 10', sans-serif;
            font-family: 'Share Tech', sans-serif;
            font-family: 'Electrolyze', sans-serif;
            position: absolute;
            left: -9999px;
            opacity: 0;
            pointer-events: none;
        }

        /* --- Pixel Font Size Adjustment --- */
        #timer-display[style*="Press Start 2P"] {
            font-size: calc(var(--font-size) * 0.7) !important;
        }
        
        #timer-message[style*="Press Start 2P"] {
            font-size: calc(var(--message-font-size) * 0.7) !important;
        }

        /* --- Small Screen Settings Icon Position --- */
        @media screen and (max-width: 430px) and (max-height: 932px) and (orientation: portrait) {
            #options-btn {
                right: 20px !important;
                left: auto !important;
            }
        }
        
        /* --- Move icon down on very small screens --- */
        @media screen and (max-width: 360px) {
            #options-btn {
                top: calc(var(--viewport-half) - var(--bar-width)/2 - var(--options-btn-size) - 80px) !important;
            }
        }
        
        @media screen and (max-height: 600px) {
            #options-btn {
                top: calc(var(--viewport-half) - var(--bar-width)/2 - var(--options-btn-size) - 80px) !important;
            }
        }

        /* --- Start Button Width for All Screens --- */
        #start-btn {
            padding: 10px 32px !important;
        }

        /* --- iPhone 14 & 13 Vertical Mode Start Button Size --- */
        @media screen and (max-width: 430px) and (orientation: portrait) {
            #start-btn {
                padding: 10px 12px !important;
                font-size: 1rem !important;
            }
        }

        /* --- Prevent Text Selection --- */
        * {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
        }
        
        /* --- CSS Custom Properties (Variables) --- */
        :root {
            --bar-color: #4CAF50; /* Green */
            --bar-length: 60vw; /* Decreased default length */
            --bar-width: 50px; /* Default width changed */
            --bar-corner-radius: 8px;
            --bar-padding: 0px;
            --bar-neon-intensity: 0px;
            --bar-gradient-start: #4CAF50;
            --bar-gradient-end: #03A9F4;
            --bar-background: var(--bar-color);
            --border-color: #FFFFFF;
            --border-size: 2px;
            --border-neon-intensity: 0px;
            --border-neon-color: #ffffff;
            --border-neon-match-color: true;
            --font-family: 'Inter', system-ui, sans-serif;
            --font-size: 72px;
            --font-color: #FFFFFF;
            --font-outline-color: #000000;
            --font-outline-size: 0px;
            --text-neon-spread: 0px;
            --text-neon-color: #FFFFFF;
            --text-neon-match-color: true;
            --bg-color: #121212;
            --start-btn-color: #009933;
            --pause-btn-color: #FFC107;
            --repeat-btn-color: #006699;
            --end-btn-color: #CC3333;

            /* New variables for UI elements */
            --options-btn-size: 50px;
            --options-btn-animation-speed: 2s; /* Moderate default speed */
            --icon-neon-intensity: 5px;
            --icon-neon-color: #ffffff;
            --icon-neon-match-color: true;
            --icon-outline-color: #000000;
            --message-font-size: 1.2rem;
            --message-color: #ccc;
            --message-neon-spread: 0px;
            --message-neon-color: #cccccc;
            --message-neon-match-color: true;
            --message-outline-size: 0px;
            --message-outline-color: #000000;
            
            /* New variables for ellipsis animation */
            --ellipsis-pulse-scale: 1.25;
            --ellipsis-wave-opacity: 0.3;

            /* New variables for button styling */
            --btn-padding-y: 10px;
            --btn-padding-x: 22px;
            --btn-font-size: 1rem;
            --btn-border-size: 0px;
            --btn-border-color: #ffffff;
            --btn-neon-intensity: 0px;
            --btn-neon-color: #ffffff;
            --btn-neon-match-color: true;
            --btn-outline-size: 0px;
            --btn-outline-color: #000000;
            /* Layout anchoring gaps (preserve current visual spacing) */
            --gap-message-to-bar: 15px;
            --gap-display-to-message: 20px;
            --gap-controls-to-bar: 20px;
            /* Viewport half for vertical anchoring */
            --viewport-half: 50vh;
            /* Interface opacity (affects only main timer UI) */
            --ui-opacity: 1;
        }

        /* --- Keyframe Animations --- */
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        @-webkit-keyframes spin {
            from { -webkit-transform: rotate(0deg); }
            to { -webkit-transform: rotate(360deg); }
        }
        @keyframes pulse-icon {
            50% { transform: scale(1.1); }
        }
        @-webkit-keyframes pulse-icon {
            50% { -webkit-transform: scale(1.1); }
        }
        @keyframes float-icon {
            50% { transform: translateY(-5px); }
        }
        @-webkit-keyframes float-icon {
            50% { -webkit-transform: translateY(-5px); }
        }
        @keyframes wobble-icon {
            15% { transform: rotate(-5deg); }
            30% { transform: rotate(3deg); }
            45% { transform: rotate(-3deg); }
            60% { transform: rotate(2deg); }
            75% { transform: rotate(-1deg); }
        }
        @keyframes multicolor-icon {
            0% { color: #ff0000; }
            16.66% { color: #ff8000; }
            33.33% { color: #ffff00; }
            50% { color: #00ff00; }
            66.66% { color: #0080ff; }
            83.33% { color: #8000ff; }
            100% { color: #ff0000; }
        }
        @keyframes rainbow-icon {
            0% { color: #ff0000; }
            14.28% { color: #ff7f00; }
            28.57% { color: #ffff00; }
            42.85% { color: #00ff00; }
            57.14% { color: #0000ff; }
            71.42% { color: #4b0082; }
            85.71% { color: #9400d3; }
            100% { color: #ff0000; }
        }



        @-webkit-keyframes wobble-icon {
          15% { -webkit-transform: rotate(-5deg); }
          30% { -webkit-transform: rotate(3deg); }
          45% { -webkit-transform: rotate(-3deg); }
          60% { -webkit-transform: rotate(2deg); }
          75% { -webkit-transform: rotate(-1deg); }
        }

        @keyframes pulse-dot {
            0%, 100% {
                transform: scale(1);
                opacity: 0.6;
            }
            50% {
                transform: scale(var(--ellipsis-pulse-scale));
                opacity: 1;
            }
        }
        @-webkit-keyframes pulse-dot {
            0%, 100% {
                -webkit-transform: scale(1);
                opacity: 0.6;
            }
            50% {
                -webkit-transform: scale(var(--ellipsis-pulse-scale));
                opacity: 1;
            }
        }
        
        @keyframes wave-dot {
            0%, 60%, 100% {
                opacity: 0; /* Changed for complete disappearance */
            }
            30% {
                opacity: 1;
            }
        }
        @-webkit-keyframes wave-dot {
            0%, 60%, 100% {
                opacity: 0;
            }
            30% {
                opacity: 1;
            }
        }

        /* --- Base and Body Styles --- */
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            font-family: var(--font-family);
            background-color: var(--bg-color);
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            transition: background-color 0.3s ease;
            overflow: hidden;
            max-width: 100vw;
            max-height: 100vh;
            overflow: hidden;
            color: white;
        }

        body {
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        /* --- Main Timer Wrapper --- */
        .timer-wrapper {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            height: 100vh;
            transition: transform 0.3s ease;
            opacity: var(--ui-opacity);
        }

        /* --- Options (Settings) Button --- */
        #options-btn {
            position: absolute;
            width: var(--options-btn-size);
            height: var(--options-btn-size);
            cursor: pointer;
            opacity: 1;
            background: transparent;
            transition: opacity 0.3s ease, width 0.3s ease, height 0.3s ease, left 0.3s ease, top 0.3s ease, transform 0.3s ease;
            z-index: 10;
            bottom: auto;
            /* Start in above-right position immediately */
            left: calc(50% + var(--bar-length)/2);
            transform: translateX(-100%);
            top: calc(var(--viewport-half) - var(--bar-width)/2 - var(--options-btn-size) - 140px);
        }
        
        /* Ensure icon stays visible and below customization panel */
        body.settings-open #options-btn {
            z-index: 100;
            opacity: 1;
            pointer-events: auto;
        }
        
        /* Remove any background and glow effects from icon when panel is open */
        body.settings-open #options-btn {
            filter: none !important;
        }
        
        #icon-animator {
            width: 100%;
            height: 100%;
            background: none;
            background-size: cover;
            background-position: center;
            border-radius: 50%;
            transition: filter 0.3s ease, transform 0.3s ease;
            filter: drop-shadow(0 2px 3px rgba(0,0,0,0.4));
        }

        #options-btn:hover {
            opacity: 1;
            transform: translateX(-100%) translateY(-1px);
            filter: drop-shadow(0 2px 3px rgba(0,0,0,0.4)) drop-shadow(0 0 15px rgba(204, 204, 204, 0.8)) drop-shadow(0 0 25px rgba(204, 204, 204, 0.6));
        }
        
        #options-btn:hover svg {
            fill: #FFFFFF;
        }

        #options-btn:hover #icon-animator[class*="animated-"] {
            animation-play-state: paused;
        }

        #icon-animator.custom-icon svg {
            display: none; /* Hide SVG when custom icon is applied */
        }

        #icon-animator[class*="animated-"] {
            animation-duration: var(--options-btn-animation-speed);
            animation-iteration-count: infinite;
        }
        #icon-animator.animated-spin {
            -webkit-animation-name: spin;
            animation-name: spin;
            animation-timing-function: linear;
        }
        #icon-animator.animated-pulse {
            -webkit-animation-name: pulse-icon;
            animation-name: pulse-icon;
            animation-timing-function: ease-in-out;
            animation-duration: calc(var(--options-btn-animation-speed) / 2);
        }
        #icon-animator.animated-float {
            -webkit-animation-name: float-icon;
            animation-name: float-icon;
            animation-timing-function: ease-in-out;
        }
        #icon-animator.animated-wobble {
            -webkit-animation-name: wobble-icon;
            animation-name: wobble-icon;
            animation-timing-function: linear;
        }

        /* Icon Color Style Effects */
        #icon-animator.multicolor {
            animation-name: multicolor-icon;
            animation-duration: 3s;
            animation-iteration-count: infinite;
            animation-timing-function: linear;
        }
        #icon-animator.rainbow {
            animation-name: rainbow-icon;
            animation-duration: 2s;
            animation-iteration-count: infinite;
            animation-timing-function: linear;
        }

        /* Icon Neon Effect - Only when outline is NOT active */
        #icon-animator.neon:not(.outline) {
            filter: drop-shadow(0 0 calc(var(--icon-neon-intensity) * 0.3) var(--icon-neon-color)) drop-shadow(0 0 calc(var(--icon-neon-intensity) * 0.6) var(--icon-neon-color)) drop-shadow(0 0 calc(var(--icon-neon-intensity) * 0.9) var(--icon-neon-color));
        }

        /* Icon Outline Effect - Only when neon is NOT active */
        #icon-animator.outline:not(.neon) {
            filter: 
                drop-shadow(-1px 0 0 var(--icon-outline-color))
                drop-shadow(1px 0 0 var(--icon-outline-color))
                drop-shadow(0 -1px 0 var(--icon-outline-color))
                drop-shadow(0 1px 0 var(--icon-outline-color));
        }

        /* Combined Neon + Outline Effect - Optimized */
        #icon-animator.neon.outline {
            filter: 
                drop-shadow(-1px 0 0 var(--icon-outline-color))
                drop-shadow(1px 0 0 var(--icon-outline-color))
                drop-shadow(0 -1px 0 var(--icon-outline-color))
                drop-shadow(0 1px 0 var(--icon-outline-color))
                drop-shadow(0 0 calc(var(--icon-neon-intensity) * 0.4) var(--icon-neon-color))
                drop-shadow(0 0 calc(var(--icon-neon-intensity) * 0.7) var(--icon-neon-color));
        }



        #options-btn svg {
            width: 100%;
            height: 100%;
            fill: #666666;
        }

        /* Zero Button for Wheel Pickers */
        .zero-btn {
            padding: var(--btn-padding-y) 16px;
            font-size: var(--btn-font-size);
            border: var(--btn-border-size) solid var(--btn-border-color);
            font-family: inherit;
            border-radius: 4px;
            cursor: pointer;
            color: #ffffff;
            font-weight: 400;
            background: linear-gradient(135deg, #555, #333);
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.45), 0 0 0 1px rgba(255,255,255,0.12) inset;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: auto;
            width: auto;
        }

        .zero-btn::before {
            content: "";
            position: absolute;
            inset: 0;
            background: radial-gradient(ellipse at 30% 30%, rgba(255,255,255,0.18), rgba(0,0,0,0.25));
            pointer-events: none;
            border-radius: inherit;
        }

        .zero-btn:hover {
            background: linear-gradient(135deg, #666, #444);
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.5), 0 0 0 1px rgba(255,255,255,0.15) inset;
        }

        .zero-btn:active {
            transform: translateY(0) scale(0.98);
            box-shadow: 0 2px 8px rgba(0,0,0,0.4), 0 0 0 1px rgba(255,255,255,0.1) inset;
        }

        .reset-section {
            display: flex;
            justify-content: center;
            margin: 8px 0;
        }

        /* When reset button is at the top after Duration label */
        .option-item.full-width > .reset-section {
            margin: 4px 0 12px 0;
        }

        /* Make reset button compact in customization panel only */
        #options-panel .option-item.full-width > .reset-section .zero-btn {
            max-width: 180px;
            padding: 10px;
        }
        
        /* Make reset button wider in Set Timer popup */
        #timer-popup-content .option-item.full-width > .reset-section .zero-btn {
            min-width: 150px;
            padding: 10px 24px;
        }

        /* Quick Set-Time icon (shows when paused) */
        #quick-settime-btn {
            position: absolute;
            top: calc(50% - var(--bar-width)/2 - 60px);
            left: calc(50% + var(--bar-length)/2 - 42px);
            width: 42px;
            height: 42px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: radial-gradient(ellipse at 30% 30%, rgba(255,255,255,0.18), rgba(0,0,0,0.25));
            color: #e6e6e6;
            box-shadow: 0 4px 12px rgba(0,0,0,0.45), 0 0 0 1px rgba(255,255,255,0.12) inset;
            cursor: pointer;
            opacity: 0;
            transform: scale(0.9);
            transition: opacity 0.2s ease, transform 0.2s ease, left 0.3s ease;
            pointer-events: none;
            z-index: 5;
            font-size: 18px;
            font-weight: bold;
        }
        #quick-settime-btn .material-symbols-outlined {
            font-size: 24px;
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }
        #quick-settime-btn:hover { 
            transform: scale(0.98); 
            background: radial-gradient(ellipse at 30% 30%, rgba(255,255,255,0.25), rgba(0,0,0,0.2));
        }
        .timer-paused #quick-settime-btn { 
            opacity: 1 !important; 
            pointer-events: auto; 
            transform: scale(1); 
        }
        @media screen and (max-width: 480px) {
            #quick-settime-btn { 
                top: calc(50% - var(--bar-width)/2 - 14px); 
                left: calc(50% + var(--bar-length)/2 - 32px); 
                width: 32px; 
                height: 32px; 
                font-size: 16px;
            }
            #quick-settime-btn .material-symbols-outlined {
                font-size: 20px;
            }
        }

        /* Apply the same glossy overlay, shadow and hover animation to all buttons */
        #controls button,
        .custom-start-button,
        .timer-popup-buttons button {
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.45), 0 0 0 1px rgba(255,255,255,0.12) inset;
            transition: transform 0.2s ease, box-shadow 0.2s ease, filter 0.2s ease;
        }
        #controls button::before,
        .custom-start-button::before,
        .timer-popup-buttons button::before {
            content: "";
            position: absolute;
            inset: 0;
            background: radial-gradient(ellipse at 30% 30%, rgba(255,255,255,0.18), rgba(0,0,0,0.25));
            pointer-events: none;
            border-radius: inherit;
        }
        #controls button:hover,
        .custom-start-button:hover,
        .timer-popup-buttons button:hover {
            transform: translateY(-1px) scale(1.02);
            box-shadow: 0 6px 16px rgba(0,0,0,0.5), 0 0 0 1px rgba(255,255,255,0.16) inset;
            filter: brightness(1.03);
        }
        #controls button:active,
        .custom-start-button:active,
        .timer-popup-buttons button:active {
            transform: translateY(0) scale(0.98);
        }
        /* --- Timer Content Container --- */
        #timer-content-container {
            position: absolute;
            left: 50%;
            top: calc(50% - var(--bar-width)/2 - var(--gap-message-to-bar));
            transform: translate(-50%, -100%) translateZ(0);
            z-index: 3;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: calc(var(--gap-display-to-message) * 0.6);
            width: max-content;
            max-width: 90vw;
        }

        /* --- Timer Display & Message --- */
        #timer-display {
            font-size: var(--font-size);
            color: var(--font-color);
            font-weight: bold;
            text-shadow: 
                calc(-1 * var(--font-outline-size)) calc(-1 * var(--font-outline-size)) 0 var(--font-outline-color),  
                 var(--font-outline-size) calc(-1 * var(--font-outline-size)) 0 var(--font-outline-color),
                calc(-1 * var(--font-outline-size)) var(--font-outline-size) 0 var(--font-outline-color),
                 var(--font-outline-size) var(--font-outline-size) 0 var(--font-outline-color),
                 /* Neon Glow */
                0 0 var(--text-neon-spread) var(--text-neon-color),
                0 0 calc(var(--text-neon-spread) * 2) var(--text-neon-color);
            transition: font-size 0.3s ease, color 0.3s ease, text-shadow 0.3s ease, font-family 0.4s ease, opacity 0.2s ease, top 0.3s ease, transform 0.3s ease;
            white-space: nowrap;
            will-change: transform;
            backface-visibility: hidden;
            font-variant-numeric: tabular-nums;
            letter-spacing: 0.05em;
            width: max-content;
            min-width: 200px;
            text-align: center;
            margin: 0 auto;
        }
        #timer-message {
            color: var(--message-color);
            font-size: var(--message-font-size);
            margin: 0;
            text-shadow: 
                 calc(-1 * var(--message-outline-size)) calc(-1 * var(--message-outline-size)) 0 var(--message-outline-color),  
                 var(--message-outline-size) calc(-1 * var(--message-outline-size)) 0 var(--message-outline-color),
                calc(-1 * var(--message-outline-size)) var(--message-outline-size) 0 var(--message-outline-color),
                 var(--message-outline-size) var(--message-outline-size) 0 var(--message-outline-color),
                /* Neon Glow */
                0 0 var(--message-neon-spread) var(--message-neon-color),
                0 0 calc(var(--message-neon-spread) * 2) var(--message-neon-color);
            transition: font-size 0.3s ease, color 0.3s ease, text-shadow 0.3s ease, font-family 0.4s ease, opacity 0.2s ease, transform 0.3s ease;
            will-change: transform;
            backface-visibility: hidden;
            font-variant-numeric: tabular-nums;
            letter-spacing: 0.02em;
            width: max-content;
            text-align: center;
            margin-left: auto;
            margin-right: auto;
            z-index: 3;
        }

        #countdown-display {
            color: #ff0000;
            font-size: calc(var(--font-size) * 1.2);
            font-weight: bold;
            margin: 0;
            text-shadow: 
                0 0 3px rgba(255, 0, 0, 0.3),
                0 0 6px rgba(255, 0, 0, 0.2),
                0 0 9px rgba(255, 0, 0, 0.1),
                /* Strong white outline */
                -2px -2px 0 #ffffff,
                2px -2px 0 #ffffff,
                -2px 2px 0 #ffffff,
                2px 2px 0 #ffffff;
            transition: opacity 0.2s ease;
            will-change: transform, opacity;
            position: absolute;
            left: 50%;
            top: calc(var(--viewport-half) - var(--bar-width)/2 - var(--options-btn-size) - 140px);
            transform: translate(-50%, -50%) translateZ(0);
            backface-visibility: hidden;
            font-variant-numeric: tabular-nums;
            letter-spacing: 0.1em;
            width: max-content;
            text-align: center;
            margin-left: auto;
            margin-right: auto;
            z-index: 10;
            opacity: 1;
        }

        #countdown-display.hidden {
            display: none;
        }

        #countdown-number {
            display: inline-block;
        }


        /* Disable interactions during countdown */
        body.countdown-active {
            pointer-events: none;
        }
        
        body.countdown-active #countdown-display {
            pointer-events: auto;
        }

        /* Disable timer bar when popup is open */
        body.timer-popup-open #progress-bar-container {
            opacity: 0.6;
            cursor: not-allowed;
            pointer-events: none;
        }

        /* Responsive positioning for countdown to match settings icon */
        @media screen and (max-width: 360px) {
            #countdown-display {
                top: calc(var(--viewport-half) - var(--bar-width)/2 - var(--options-btn-size) - 80px) !important;
            }
        }
        
        @media screen and (max-height: 600px) {
            #countdown-display {
                top: calc(var(--viewport-half) - var(--bar-width)/2 - var(--options-btn-size) - 80px) !important;
            }
        }

        @supports (-webkit-touch-callout: none) {
            @media screen and (orientation: landscape) and (max-height: 480px) {
                #countdown-display {
                    top: calc(var(--viewport-half) - var(--bar-width)/2 - var(--options-btn-size) - 140px + 40px);
                }
            }
        }
        .ellipsis-dot {
            display: inline-block;
        }
        .ellipsis.pulse .ellipsis-dot {
            -webkit-animation: pulse-dot 1.4s infinite;
            animation: pulse-dot 1.4s infinite;
        }
        .ellipsis.pulse .ellipsis-dot:nth-child(2) {
            -webkit-animation-delay: 0.2s;
            animation-delay: 0.2s;
        }
        .ellipsis.pulse .ellipsis-dot:nth-child(3) {
            -webkit-animation-delay: 0.4s;
            animation-delay: 0.4s;
        }
        .ellipsis.wave .ellipsis-dot {
            -webkit-animation: wave-dot 1.4s infinite;
            animation: wave-dot 1.4s infinite;
        }
        .ellipsis.wave .ellipsis-dot:nth-child(1) {
            -webkit-animation-delay: 0s;
            animation-delay: 0s;
        }
        .ellipsis.wave .ellipsis-dot:nth-child(2) {
            -webkit-animation-delay: 0.2s;
            animation-delay: 0.2s;
        }
        .ellipsis.wave .ellipsis-dot:nth-child(3) {
            -webkit-animation-delay: 0.4s;
            animation-delay: 0.4s;
        }


        /* --- Progress Bar --- */
        #progress-bar-container {
            width: var(--bar-length);
            height: var(--bar-width);
            background-color: #282828; /* Match settings panel */
            border: var(--border-size) solid var(--border-color);
            border-radius: var(--bar-corner-radius);
            overflow: hidden;
            box-shadow: 
                0 0 var(--border-neon-intensity) var(--border-neon-color),
                0 0 calc(var(--border-neon-intensity) * 2) var(--border-neon-color),
                inset 0 2px 5px rgba(0,0,0,0.3);
            transition: all 0.3s ease, width 0.3s ease;
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            z-index: 2;
            padding: var(--bar-padding);
            box-sizing: border-box;
        }
        #progress-bar {
            width: 0%;
            height: 100%;
            background: var(--bar-background);
            border-radius: calc(var(--bar-corner-radius) - var(--bar-padding));
            box-shadow: 
                /* Neon Glow */
                0 0 var(--bar-neon-intensity) var(--bar-color),
                0 0 calc(var(--bar-neon-intensity) * 2) var(--bar-color),
                /* Inset Highlight */
                inset 0 0 10px rgba(255,255,255,0.2);
            transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1), background 0.3s ease, box-shadow 0.3s ease;
            will-change: width;
            transform: translateZ(0);
            position: relative;
            overflow: hidden;
        }

        /* Aurora Effect */
        #controls {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            justify-content: center; /* Center buttons horizontally */
            align-items: center; /* Vertically center buttons in the container */
            height: 50px; /* Fixed height to prevent layout shifts */
            min-width: 280px; /* Prevents buttons from overlapping on short bars */
            position: absolute;
            left: 50%;
            top: calc(50% + var(--bar-width)/2 + var(--gap-controls-to-bar));
            transform: translateX(-50%);
            width: var(--bar-length);
            z-index: 4;
            transition: top 0.3s ease, width 0.3s ease;
        }

        #controls button {
            padding: var(--btn-padding-y) var(--btn-padding-x);
            font-size: var(--btn-font-size);
            border: var(--btn-border-size) solid var(--btn-border-color);
            font-family: inherit;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s ease, left 0.3s ease, box-shadow 0.3s ease, text-shadow 0.3s ease, transform 0.3s ease;
            color: #ffffff;
            font-weight: 400;
        }

        #controls button.outline-enabled {
            text-shadow: 
                -1px -1px 0 #000000,  
                 1px -1px 0 #000000,
                -1px  1px 0 #000000,
                 1px  1px 0 #000000;
        }

        #controls button:active {
            transform: scale(0.98);
            box-shadow: none;
        }

        #set-time-btn {
            background-color: #444444;
            transition: all 0.3s ease;
            box-shadow: 
                0 2px 8px rgba(0, 0, 0, 0.3),
                0 0 10px rgba(68, 68, 68, 0.3);
        }

        #set-time-btn:hover {
            background-color: #555555;
            transform: translateY(-1px);
            box-shadow: 
                0 4px 12px rgba(51, 51, 51, 0.4),
                0 0 20px rgba(85, 85, 85, 0.6),
                0 0 30px rgba(85, 85, 85, 0.4);
        }

        #start-btn, #resume-btn { 
            background-color: var(--start-btn-color);
            box-shadow: 
                0 0 var(--btn-neon-intensity) var(--btn-neon-color),
                0 0 calc(var(--btn-neon-intensity) * 2) var(--btn-neon-color);
            transition: all 0.3s ease, opacity 0.2s ease, transform 0.2s ease;
            opacity: 1;
            transform: scale(1);
        }
        
        #start-btn.hidden, #resume-btn.hidden {
            opacity: 0;
            transform: scale(0.9);
            pointer-events: none;
        }

        #start-btn:hover:not(.hidden), #resume-btn:hover:not(.hidden) {
            background: linear-gradient(135deg, var(--start-btn-color) 0%, color-mix(in srgb, var(--start-btn-color) 70%, black) 100%);
            transform: translateY(-1px);
            box-shadow: 
                0 0 calc(var(--btn-neon-intensity) * 1.5) var(--btn-neon-color),
                0 0 calc(var(--btn-neon-intensity) * 3) var(--btn-neon-color),
                0 4px 12px rgba(0, 153, 51, 0.4);
        }
        #pause-btn { 
            background-color: var(--pause-btn-color);
            box-shadow: 
                0 0 var(--btn-neon-intensity) var(--btn-neon-color),
                0 0 calc(var(--btn-neon-intensity) * 2) var(--btn-neon-color);
            transition: all 0.3s ease, opacity 0.2s ease, transform 0.2s ease;
            opacity: 1;
            transform: scale(1);
        }
        
        #pause-btn.hidden {
            opacity: 0;
            transform: scale(0.9);
            pointer-events: none;
        }
        
        #pause-btn:hover:not(.hidden) {
            background: linear-gradient(135deg, var(--pause-btn-color) 0%, color-mix(in srgb, var(--pause-btn-color) 70%, black) 100%);
            transform: translateX(-50%) translateY(-1px);
            box-shadow: 
                0 0 calc(var(--btn-neon-intensity) * 1.5) var(--btn-neon-color),
                0 0 calc(var(--btn-neon-intensity) * 3) var(--btn-neon-color),
                0 4px 12px rgba(255, 165, 0, 0.4);
        }
        #repeat-btn { 
            background-color: var(--repeat-btn-color);
            box-shadow: 
                0 0 var(--btn-neon-intensity) var(--btn-neon-color),
                0 0 calc(var(--btn-neon-intensity) * 2) var(--btn-neon-color);
            transition: transform 0.1s, box-shadow 0.2s, opacity 0.2s ease, transform 0.2s ease;
            opacity: 1;
            transform: scale(1);
        }
        
        #repeat-btn.hidden {
            opacity: 0;
            transform: scale(0.9);
            pointer-events: none;
        }

        #repeat-btn:hover:not(.hidden) {
            background-color: var(--repeat-btn-color);
            transform: translateY(-1px);
            box-shadow: 
                0 0 calc(var(--btn-neon-intensity) * 1.5) var(--btn-neon-color),
                0 0 calc(var(--btn-neon-intensity) * 3) var(--btn-neon-color),
                0 4px 12px rgba(0, 102, 153, 0.4);
        }
        #end-btn { 
            background-color: var(--end-btn-color);
            box-shadow: 
                0 0 var(--btn-neon-intensity) var(--btn-neon-color),
                0 0 calc(var(--btn-neon-intensity) * 2) var(--btn-neon-color);
            transition: all 0.3s ease, opacity 0.2s ease, transform 0.2s ease;
            opacity: 1;
            transform: scale(1);
        }
        
        #end-btn.hidden {
            opacity: 0;
            transform: scale(0.9);
            pointer-events: none;
        }

        #end-btn:hover:not(.hidden) {
            background: linear-gradient(135deg, var(--end-btn-color) 0%, color-mix(in srgb, var(--end-btn-color) 70%, black) 100%);
            transform: translateY(-1px);
            box-shadow: 
                0 0 calc(var(--btn-neon-intensity) * 1.5) var(--btn-neon-color),
                0 0 calc(var(--btn-neon-intensity) * 3) var(--btn-neon-color),
                0 4px 12px rgba(204, 51, 51, 0.4);
        }

        /* Unify controls layout when timer is active */
        .timer-running #controls,
        .timer-paused #controls {
            display: block;
            width: var(--bar-length);
            transition: width 0.3s ease;
        }

        /* Center the Pause button exactly like the Resume button */
        .timer-running #pause-btn {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            transition: transform 0s, box-shadow 0.2s;
        }

        .timer-running #pause-btn:active {
            transform: translateX(-50%) scale(0.95);
            transition: transform 0.1s, box-shadow 0.2s;
        }

        .timer-paused #resume-btn {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            transition: all 0.3s ease;
        }
        
        .timer-paused #resume-btn:hover:not(.hidden) {
            background-color: var(--start-btn-color);
            transform: translateX(-50%) translateY(-1px);
            box-shadow: 
                0 0 calc(var(--btn-neon-intensity) * 1.5) var(--btn-neon-color),
                0 0 calc(var(--btn-neon-intensity) * 3) var(--btn-neon-color),
                0 4px 12px rgba(0, 153, 51, 0.4);
        }
        
        .timer-paused #resume-btn:active {
            transform: translateX(-50%) scale(0.95);
            transition: transform 0.1s, box-shadow 0.2s;
        }

        .timer-paused #repeat-btn {
            position: absolute;
            bottom: 10px;
            right: 0;
            transition: transform 0.1s, box-shadow 0.2s;
        }

        /* Center repeat button when it's the only visible button */
        .only-repeat-visible #repeat-btn {
            position: absolute !important;
            bottom: 10px !important;
            left: 50% !important;
            transform: translateX(-50%) !important;
            right: auto !important;
            transition: none !important;
        }

        .only-repeat-visible #repeat-btn:active {
            transform: translateX(-50%) scale(0.95) !important;
        }

        /* Disable transition when moving back to normal position */
        .no-transition #repeat-btn {
            transition: none !important;
        }
        .timer-paused #end-btn {
            position: absolute;
            bottom: 10px;
            left: 0;
            transition: left 0.3s ease, transform 0.3s ease, box-shadow 0.3s ease;
        }

        /* Particle Effects Canvas */
        #particles-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            pointer-events: none;
            z-index: 1;
            opacity: 0;
            transition: opacity 0.3s ease;
            /* Exact viewport coverage with no overflow */
            max-width: 100vw;
            max-height: 100vh;
            overflow: hidden;
            box-sizing: border-box;
            /* Prevent any scrolling or overflow */
            margin: 0;
            padding: 0;
            border: none;
        }

        #particles-canvas.active {
            opacity: 1;
        }

        /* --- Options Panel --- */
        #options-panel-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.2); /* Reduced background dimness */
            z-index: 101;
            display: flex;
            justify-content: flex-end; /* Aligns panel to the right */
            align-items: flex-start; /* Aligns panel to the top */
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
            padding: 0 0 20px 20px; /* Remove top and right padding to eliminate gaps */
            box-sizing: border-box;
        }
        
        #options-panel-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        #options-panel {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            color: #FFF;
            font-family: 'Inter', system-ui, sans-serif;
            padding: 16px 20px 20px 20px;
            border-radius: 16px;
            width: 90%;
            max-width: 300px;
            max-height: calc(100vh - 40px); /* Increased height to fill more space */
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0,0,0,0.6), 0 0 0 1px rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transform: translateX(100%);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
            position: relative; /* For close button positioning */
            /* Scrollbar styles for Firefox */
            scrollbar-width: thin;
            scrollbar-color: #666 #282828;
        }
        
        /* Style scrollbar for Webkit browsers (Chrome, Safari) */
        #options-panel::-webkit-scrollbar {
            width: 6px;
        }

        #options-panel::-webkit-scrollbar-track {
            background: #282828;
            border-radius: 10px;
        }

        #options-panel::-webkit-scrollbar-thumb {
            background-color: #666;
            border-radius: 10px;
            border: 1px solid #282828;
        }

        #options-panel-overlay.visible #options-panel {
            transform: translateX(0);
            opacity: 1;
        }

        #close-panel-btn {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 2rem;
            color: #E57373;
            cursor: pointer;
            transition: color 0.2s;
            line-height: 1;
            z-index: 10;
        }

        #close-panel-btn:hover {
            color: #f44336;
        }

        #options-panel h2 {
            text-align: center;
            margin-bottom: 10px;
            color: #ddd;
        }

        .options-section {
            background: linear-gradient(135deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.02) 100%);
            border-radius: 12px;
            margin-bottom: 10px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }
        
        .options-section h3 {
            margin: 0;
            padding: 8px 12px;
            font-size: 0.8rem;
            font-weight: 600;
            color: #fff;
            position: relative;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
        }

        .options-section.collapsible h3 {
            cursor: pointer;
        }
        
        /* Timer section header is not clickable */
        .timer-sound-section h3 {
            cursor: default;
        }
        
        .options-section.collapsible h3::after {
            content: '+';
            position: absolute;
            right: 20px;
            font-size: 1.5rem;
            font-weight: 300;
            transition: transform 0.3s ease;
        }
        
        /* Timer section has no collapse arrow */
        .timer-sound-section h3::after {
            display: none;
        }

        .options-section.collapsible.is-open h3::after {
            transform: rotate(45deg);
        }
        
        .options-content-wrapper {
            display: grid;
            grid-template-rows: 0fr;
            transition: grid-template-rows 0.3s ease;
        }
        .options-section.is-open .options-content-wrapper {
            grid-template-rows: 1fr;
        }
        
        /* Timer section is always open */
        .timer-sound-section .options-content-wrapper {
            grid-template-rows: 1fr;
        }

        .options-content {
            overflow: hidden;
            padding: 0 12px;
        }
        
        .options-section.is-open .options-content {
            padding: 12px;
        }

        /* Make Timer & Sound section more compact */
        .timer-sound-section .options-content {
            padding: 8px !important;
        }
        
        .timer-sound-section .option-item {
            margin-bottom: 6px;
        }
        
        .timer-sound-section .duration-control {
            gap: 6px;
        }
        
        .timer-sound-section h3 {
            padding: 6px 12px !important;
        }

        .duration-control {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 6px;
        }

        /* Customization tab duration control - new layout */
        #options-panel .duration-control {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 20px; /* spacing between wheels and countdown section */
        }
        #options-panel .duration-control .top-row {
            display: flex;
            justify-content: flex-start; /* align pickers to the left */
            align-items: flex-start;
            gap: 8px;
            width: 100%;
            margin-top: -10px;
            margin-left: -5px; /* Move wheel pickers more to the left */
        }
        
        /* Time separator (colon) between wheel pickers in customization panel */
        #options-panel .duration-control .time-separator {
            font-size: 32px;
            font-weight: 700;
            color: #ffffff;
            align-self: center;
            margin: 0 -2px;
            margin-top: 15px;
            line-height: 1;
        }
        
        /* Label inside wheel picker at the top for customization panel */
        #options-panel .wheel-picker .wheel-label {
            position: absolute;
            top: 4px;
            left: 0;
            right: 0;
            text-align: center;
            font-size: 9px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.7);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            z-index: 3;
            pointer-events: none;
        }
        
        /* Hide the external label for customization panel wheel pickers only */
        #options-panel .duration-control .input-group > label {
            display: none;
        }
        
        /* Show countdown label in start section */
        .start-section .input-group > label {
            display: block !important;
        }

        #options-panel .duration-control .bottom-row {
            display: flex;
            justify-content: center; /* align with top-row */
            align-items: center;
            gap: 8px; /* tighter */
            width: 100%;
        }

        .start-section {
            display: flex;
            flex-direction: row;
            align-items: flex-end;
            justify-content: flex-start;
            gap: 10px;
            margin-left: 0;
        }
        
        .bottom-controls {
            display: flex;
            flex-direction: row;
            align-items: flex-end;
            justify-content: flex-start;
            gap: 12px;
            margin-top: 8px;
        }
        
        .start-section .input-group {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            margin-left: 0px;
        }
        
        .start-section .input-group label {
            margin-bottom: 3px !important;
            font-size: 12px !important;
            font-weight: 600 !important;
            text-transform: uppercase !important;
            letter-spacing: 0.3px !important;
            line-height: 1 !important;
        }
        
        #custom-start-delay {
            padding: 10px 12px;
            font-size: 1.1rem;
            width: 100px !important;
            box-sizing: border-box;
        }

        .start-section .reset-section {
            margin-top: 0;
            margin-bottom: 4px;
        }

        .custom-start-button {
            background: linear-gradient(135deg, #555, #333);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            min-width: 100px;
        }
        
        .custom-start-button.has-time {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
        }

        .custom-start-button:hover {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
        }
        
        .custom-start-button.has-time:hover {
            background: linear-gradient(135deg, #45a049 0%, #3d8b40 100%);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.5);
        }

        .custom-start-button:active {
            transform: translateY(0) scale(0.98);
            box-shadow: 0 2px 6px rgba(76, 175, 80, 0.3);
        }
        .custom-start-button:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* iOS-style wheel picker */
        .wheel-picker {
            width: 70px;
            height: 140px;
            overflow: hidden;
            border-radius: 12px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.15);
            position: relative;
            z-index: 1;
            backdrop-filter: blur(10px);
            box-shadow: 
                inset 0 1px 0 rgba(255, 255, 255, 0.1),
                0 2px 8px rgba(0, 0, 0, 0.2);
            /* Scale down visually while preserving layout box for alignment/spacing */
            --wheel-scale: 1.0;
            transform: scale(var(--wheel-scale));
            transform-origin: center center;
        }

        .wheel-container {
            display: flex;
            flex-direction: column;
            transition: transform 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            transform: translateY(0);
            padding: 50px 0;
        }
        .wheel-item {
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.6);
            cursor: pointer;
            user-select: none;
            transition: all 0.2s ease;
            position: relative;
            text-align: center;
            width: 100%;
            line-height: 40px;
            padding: 0;
            transform-origin: center center;
            will-change: transform, opacity;
        }

        .wheel-item:hover {
            color: rgba(255, 255, 255, 0.8);
            background: rgba(255, 255, 255, 0.05);
        }
        .wheel-item.selected {
            color: #fff;
            font-weight: 700;
            font-size: 24px;
            background: rgba(255, 255, 255, 0.1);
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
        }

        /* Selection indicator with gradient fade */
        .wheel-picker::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 50px;
            background: linear-gradient(to bottom, rgba(0, 0, 0, 0.4), transparent);
            pointer-events: none;
            z-index: 2;
        }

        .wheel-picker::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 50px;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.4), transparent);
            pointer-events: none;
            z-index: 2;
        }
        /* Center selection highlight */
        .wheel-picker .selection-highlight {
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 40px;
            border-top: 2px solid rgba(255, 255, 255, 0.4);
            border-bottom: 2px solid rgba(255, 255, 255, 0.4);
            transform: translateY(-50%);
            pointer-events: none;
            z-index: 1;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }

        #options-panel .duration-control .input-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            flex: 0 0 auto;
            min-width: 54px; /* pull columns closer */
            /* Counter-scale wrapper so alignment boxes remain unchanged */
            transform: scale(calc(1 / var(--wheel-scale, 1)));
            transform-origin: center top;
        }

        #options-panel .duration-control .input-group label {
            font-size: 12px;
            font-weight: 600;
            color: white;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            position: relative;
            z-index: 1;
        }


        /* Hide native spinner controls */
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input[type="number"] {
            -moz-appearance: textfield;
            appearance: textfield;
        }

        /* Custom spinner styling */
        .custom-spinner {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
        }

        .spinner-btn {
            width: 24px;
            height: 20px;
            border: none;
            background: #f0f0f0;
            color: #333;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            user-select: none;
        }

        .spinner-btn:hover {
            background: #e0e0e0;
            transform: scale(1.05);
        }

        .spinner-btn:active {
            background: #d0d0d0;
            transform: scale(0.95);
        }

        #options-panel .duration-control input {
            width: 60px;
            text-align: center;
            font-size: 14px;
            font-weight: 600;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .duration-control input {
            width: 60px;
            text-align: center;
            font-size: 14px;
            font-weight: 600;
        }

        .endtime-control {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .endtime-control select {
            flex-grow: 1;
        }

        .duration-control select {
            width: 75px;
        }


        .option-item {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            align-items: center;
            margin-bottom: 12px;
            padding: 4px 8px;
            border-radius: 6px;
            transition: background 0.2s ease;
        }
        
        .option-item:hover {
            background: transparent;
        }
        
        .option-item:last-child {
            margin-bottom: 0;
        }
        
        .option-item.checkbox {
             grid-template-columns: 1fr auto;
             gap: 10px;
             justify-content: space-between;
        }
        
        .option-item.full-width {
            grid-template-columns: 1fr;
        }

        #options-panel label {
            font-weight: 500;
            font-size: 0.75rem;
            color: #e0e0e0;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .section-title {
            font-weight: 500;
            font-size: 0.85rem;
            color: #bbb;
            margin-bottom: 12px;
            display: block;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            opacity: 0.8;
        }

        #options-panel input, #options-panel select, #options-panel button {
            width: 100%;
            padding: 6px 8px;
            box-sizing: border-box;
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: linear-gradient(135deg, #3a3a3a 0%, #2a2a2a 100%);
            color: #FFF;
            font-size: 0.8rem;
            transition: all 0.2s ease;
        }
        
        #options-panel input:focus, #options-panel select:focus, #options-panel button:focus {
            border-color: rgba(255, 255, 255, 0.4);
            background: linear-gradient(135deg, #4a4a4a 0%, #3a3a3a 100%);
            outline: none;
            box-shadow: 0 0 8px rgba(255, 255, 255, 0.1);
        }

        #options-panel input[type="color"] {
            padding: 2px;
            height: 40px;
            cursor: pointer;
        }

        #options-panel input[type="range"] {
            cursor: pointer;
        }
        
        #options-panel input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        #options-panel input[type="file"] {
            padding: 4px;
        }

        /* --- Modern Sliders --- */
        #options-panel input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 6px;
            border-radius: 0px;
            background: #444;
            outline: none;
            transition: background 0.3s ease;
            margin: 0;
            padding: 0;
        }

        #options-panel input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 0px;
            background: #f44336;
            cursor: pointer;
            border: 2px solid #fff;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
            margin-top: -7px;
        }

        #options-panel input[type="range"]::-webkit-slider-thumb:hover {
            background: #e53935;
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
        }

        #options-panel input[type="range"]::-webkit-slider-thumb:active {
            background: #d32f2f;
            transform: scale(1.05);
        }

        #options-panel input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 0px;
            background: #f44336;
            cursor: pointer;
            border: 2px solid #fff;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
        }
        #options-panel input[type="range"]::-moz-range-thumb:hover {
            background: #e53935;
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
        }

        #options-panel input[type="range"]::-webkit-slider-track {
            -webkit-appearance: none;
            appearance: none;
            height: 6px;
            border-radius: 0px;
            background: #444;
            border: none;
        }

        #options-panel input[type="range"]::-moz-range-progress {
            height: 6px;
            border-radius: 0px;
            background: #f44336;
        }
        #clear-bg-btn, #clear-icon-btn {
             background-color: #666;
             cursor: pointer;
        }
        
        #settings-management-external {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 102;
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 150px;
            opacity: 0;
            visibility: hidden;
            transform: translateX(100%);
            transition: transform 0.4s ease, opacity 0.4s ease, visibility 0.4s;
        }
        
        body.settings-open #settings-management-external {
            opacity: 1;
            visibility: visible;
            transform: translateX(0);
        }
        
        #settings-management-external button {
            border: none;
            border-radius: 12px;
            padding: 12px;
            cursor: pointer;
        }

        #save-settings-btn {
            background-color: #333;
            color: #4CAF50;
            font-weight: bold;
        }
        #reset-settings-btn {
            background-color: #333;
            color: #f44336;
            font-weight: bold;
        }

        /* --- Confirmation Modal --- */
        #confirm-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
            z-index: 102;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        #confirm-modal {
            background: #333;
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 5px 25px rgba(0,0,0,0.4);
        }
        #confirm-modal p {
            margin: 0 0 20px 0;
            font-size: 1.1rem;
        }
        
        #confirm-modal-buttons {
            display: flex;
            gap: 15px;
        }
        
        #confirm-yes, #confirm-no {
            padding: 10px 30px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            color: white;
            font-weight: bold;
        }
        
        #confirm-yes { background-color: #f44336; }
        #confirm-no { background-color: #666; }


        /* --- Save Confirmation Message --- */
        #save-confirm {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            z-index: 101;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s, bottom 0.3s;
        }
        #save-confirm.visible {
            opacity: 1;
            visibility: visible;
            bottom: 30px;
        }

        .hidden {
            display: none !important;
        }
        
        .option-group {
            transition: opacity 0.3s ease;
        }
        .option-group.disabled {
            opacity: 0.5;
            pointer-events: none;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out, padding 0.3s ease-out;
            padding-top: 0;
            padding-bottom: 0;
        }

        .option-group:not(.disabled) {
            max-height: 1000px;
            opacity: 1;
            transition: max-height 0.3s ease-in, opacity 0.3s ease-in, padding 0.3s ease-in;
            padding-top: 8px;
            padding-bottom: 8px;
        }

        /* Smooth animations for option items within groups */
        .option-group .option-item {
            transition: transform 0.2s ease-out, opacity 0.2s ease-out;
            transform: translateY(0);
        }

        .option-group.disabled .option-item {
            transform: translateY(-10px);
            opacity: 0;
        }

        /* Particle Effects Canvas */
        #particles-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        #particles-canvas.active {
            opacity: 1;
        }

        /* --- Horizontal Screen Positioning --- */
        @media (orientation: landscape) and (min-width: 800px) {
            #settings-management-external {
                right: calc(240px + 60px); /* More distance on horizontal screens */
                bottom: 20px;
            }
        }

        /* --- Responsiveness --- */
        @media (min-width: 800px) {
            body.settings-open .timer-wrapper {
                transform: translateX(-190px); /* Adjusted for narrower panel */
            }
            #settings-management-external {
                left: auto;
                right: calc(240px + 120px); /* More distance from panel to avoid overlap */
                bottom: 20px;
                top: auto;
            }
        }
        
        @media (max-width: 768px) { /* iPad and smaller */
            :root {
                --bar-length: 90vw;
                --font-size: 60px;
            }
             .option-item {
                grid-template-columns: 1fr;
                gap: 8px;
            }
             .option-item.checkbox {
                grid-template-columns: 1fr 20px;
             }
        }

        @media (max-width: 480px) { /* iPhone */
            :root {
                --font-size: 44px; /* Slightly smaller font for phones */
                --bar-length: 95vw; /* Much longer bar on iPhone vertical */
                --options-btn-size: 35px; /* Smaller icon on iPhone */
            }
            #controls {
                flex-direction: column;
                width: 70%;
                gap: 10px;
            }
            #controls button {
                width: 100%;
            }
            #options-panel {
                max-width: 85%;
                max-width: 220px; /* Even smaller on iPhone */
                padding: 6px 10px 8px 10px; /* Reduced padding */
                max-height: calc(100vh - 100px); /* Adjust height for mobile */
            }
            
            /* Adjust overlay positioning for mobile */
            #options-panel-overlay {
                padding: 0 0 20px 20px; /* Remove top and right padding on mobile too */
            }
            
            /* Make Repeat and End buttons bigger on mobile */
            .timer-paused #repeat-btn,
            .timer-paused #end-btn {
                padding: 10px 16px;
                font-size: 0.95rem;
                min-width: auto;
                width: auto;
            }
            
            /* Make Resume button bigger only when it's the only visible button */
            .timer-paused #resume-btn {
                padding: 10px 16px;
                font-size: 0.95rem;
                min-width: auto;
                width: auto;
            }
        }
        /* iOS Safe Area Support for PWA */
        @supports (padding: max(0px)) {
            body {
                padding-top: max(env(safe-area-inset-top), 0px);
                padding-bottom: max(env(safe-area-inset-bottom), 0px);
                padding-left: max(env(safe-area-inset-left), 0px);
                padding-right: max(env(safe-area-inset-right), 0px);
            }
        }

        /* iPad PWA fullscreen support */
        @media screen and (min-width: 768px) {
            body {
                padding-top: 0 !important;
                padding-bottom: 0 !important;
            }
            .timer-wrapper {
                height: 100vh !important;
                height: 100dvh !important;
            }
        }

        /* Accurate vertical centering across browsers (set viewport half variable) */
        @supports (height: 100dvh) {
            :root { --viewport-half: 50dvh; }
        }
        @supports (height: 100svh) {
            :root { --viewport-half: 50svh; }
        }

        /* iPhone landscape-only layout adjustment */
        @supports (-webkit-touch-callout: none) {
            @media screen and (orientation: landscape) and (max-height: 480px) {
                .timer-wrapper {
                    transform: translateY(12px);
                }
                #options-btn {
                    top: calc(var(--viewport-half) - var(--bar-width)/2 - var(--options-btn-size) - 140px + 40px);
                }
            }
        }
        /* Fullscreen mode adjustments */
        @media (display-mode: standalone) {
            body {
                background-color: var(--bg-color);
            }
            
            /* Hide any potential scrollbars in standalone mode */
            html, body {
                overflow: hidden;
                height: 100vh;
                height: -webkit-fill-available;
            }
            
            .timer-wrapper {
                height: 100vh;
                height: -webkit-fill-available;
            }
        }

        /* iOS specific adjustments */
        @media screen and (-webkit-min-device-pixel-ratio: 2) {
            /* Retina display adjustments */
            .timer-wrapper {
                -webkit-touch-callout: none;
                -webkit-user-select: none;
                user-select: none;
                -webkit-tap-highlight-color: transparent;
            }
        }

        /* Unclickable color inputs when match color is enabled */
        input[type="color"].unclickable {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Ensure checkboxes are always clickable */
        input[type="checkbox"] {
            position: relative;
            z-index: 10;
            pointer-events: auto !important;
        }
        /* Disabled checkboxes when neon is off */
        input[type="checkbox"].disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none !important;
        }

        /* Timer Settings Popup Styles */
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .popup-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        .timer-popup {
            background: linear-gradient(135deg, #2a2a2a 0%, #1e1e1e 100%);
            border-radius: 16px;
            padding: 0;
            max-width: 350px;
            width: 85%;
            max-height: none; /* allow natural height; we scale to fit */
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.6), 0 0 0 1px rgba(255, 255, 255, 0.1);
            transform: scale(calc(var(--popup-scale, 1) * 0.9));
            transition: transform 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .popup-overlay.visible .timer-popup {
            transform: scale(var(--popup-scale, 1));
        }

        #timer-popup-content {
            padding: 12px 14px 12px 14px;
            max-width: 100%;
            overflow: hidden;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        #timer-popup-content h2 {
            color: #ffffff;
            margin: 0 0 8px 0;
            text-align: center;
            font-size: 1.1rem;
            font-weight: 600;
            letter-spacing: 0.5px;
            flex-shrink: 0;
        }

        .timer-popup-section {
            margin-bottom: 8px;
            flex-shrink: 0;
        }

        .timer-popup-section .option-item {
            margin-bottom: 6px;
        }

        .timer-popup-section .option-item label {
            color: #e0e0e0;
            display: block;
            margin-bottom: 2px;
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .timer-popup-section select,
        .timer-popup-section input {
            width: 100%;
            padding: 6px 8px;
            background: linear-gradient(135deg, #3a3a3a 0%, #2a2a2a 100%);
            color: #ffffff;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            font-size: 0.8rem;
            transition: all 0.3s ease;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        /* Auto-width, centered selects for Mode and Countdown in popup */
        #popup-timer-mode-select,
        #popup-start-delay {
            width: auto !important; /* allow shrink-to-fit */
            max-width: calc(100vw - 96px); /* stay compact on very small screens */
            display: inline-block;
            margin: 0 auto;
            text-align: center;
            text-align-last: center; /* center selected text */
            white-space: nowrap; /* prevent wrapping */
        }

        /* Keep their option-item centered with the label */
        #timer-popup-content .option-item:has(#popup-timer-mode-select),
        #timer-popup-content .option-item:has(#popup-start-delay) {
            text-align: center;
        }

        .timer-popup-section select:focus,
        .timer-popup-section input:focus {
            outline: none;
            border-color: #009933;
            box-shadow: 0 0 0 2px rgba(0, 153, 51, 0.2), inset 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .timer-popup-section .duration-control,
        .timer-popup-section .endtime-control {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-top: 4px;
            flex-wrap: wrap;
        }

        .timer-popup-section .duration-control {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
        }

        .timer-popup-section .duration-control .input-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            /* Counter-scale wrapper so popup alignment boxes remain unchanged */
            transform: scale(calc(1 / var(--wheel-scale, 1)));
            transform-origin: center top;
        }

        .timer-popup-section .duration-control .input-group label {
            font-size: 11px;
            font-weight: 600;
            color: white;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            position: relative;
            z-index: 1;
        }
        
        /* Time separator (colon) between wheel pickers in popup */
        .timer-popup-section .duration-control .time-separator {
            font-size: 32px;
            font-weight: 700;
            color: #ffffff;
            align-self: center;
            margin: 0 -2px;
            margin-top: 15px;
            line-height: 1;
        }
        
        /* Label inside wheel picker at the top for popup */
        .timer-popup-section .wheel-picker .wheel-label {
            position: absolute;
            top: 4px;
            left: 0;
            right: 0;
            text-align: center;
            font-size: 9px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.7);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            z-index: 3;
            pointer-events: none;
        }
        
        /* Hide the external label for popup wheel pickers */
        .timer-popup-section .duration-control .input-group > label {
            display: none;
        }

        .timer-popup-section .duration-control input {
            width: 50px;
            text-align: center;
            font-weight: 600;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        /* Smaller spinner buttons for popup */
        .timer-popup-section .spinner-btn {
            width: 20px;
            height: 16px;
            font-size: 10px;
        }

        

        .timer-popup-section .endtime-control select {
            width: 90px;
        }

        .timer-popup-buttons {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            flex-shrink: 0;
        }

        .timer-popup-buttons button {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 60px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        #popup-start-btn {
            background: linear-gradient(135deg, #009933 0%, #007a2a 100%);
            color: white;
        }

        #popup-start-btn:hover {
            background: linear-gradient(135deg, #00aa44 0%, #008833 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 153, 51, 0.4);
        }

        #popup-start-btn:disabled {
            background: linear-gradient(135deg, #555 0%, #444 100%);
            cursor: not-allowed;
            opacity: 0.6;
            transform: none;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        #popup-cancel-btn {
            background: linear-gradient(135deg, #CC3333 0%, #aa2222 100%);
            color: white;
        }

        #popup-cancel-btn:hover {
            background: linear-gradient(135deg, #dd4444 0%, #bb3333 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(204, 51, 51, 0.4);
        }

        /* Prevent body scroll when popup is open */
        body.popup-open {
            overflow: hidden;
        }

        /* --- RESPONSIVE POPUP DESIGN --- */
        
        /* Extremely vertical screens - ultra compact */
        @media screen and (max-height: 500px) {
            .timer-popup {
                max-height: 98vh;
                max-width: 280px;
            }
            
            #timer-popup-content {
                padding: 6px 10px 6px 10px;
            }
            
            #timer-popup-content h2 {
                font-size: 0.9rem;
                margin-bottom: 4px;
            }
            
            .timer-popup-section {
                margin-bottom: 4px;
            }
            
            .timer-popup-section .option-item {
                margin-bottom: 3px;
            }
            
            .timer-popup-section .option-item label {
                font-size: 0.65rem;
                margin-bottom: 1px;
            }
            
            .timer-popup-section select,
            .timer-popup-section input {
                padding: 3px 5px;
                font-size: 0.7rem;
            }
            
            .timer-popup-buttons {
                margin-top: 4px;
                padding-top: 4px;
                gap: 4px;
            }
            
            .timer-popup-buttons button {
                padding: 4px 8px;
                font-size: 0.7rem;
                min-width: 45px;
            }
        }

        /* Very vertical screens - prevent scrolling */
        @media screen and (max-height: 600px) {
            .timer-popup {
                max-height: 95vh;
                max-width: 300px;
            }
            
            #timer-popup-content {
                padding: 8px 12px 8px 12px;
            }
            
            #timer-popup-content h2 {
                font-size: 1rem;
                margin-bottom: 6px;
            }
            
            .timer-popup-section {
                margin-bottom: 6px;
            }
            
            .timer-popup-section .option-item {
                margin-bottom: 4px;
            }
            
            .timer-popup-section .option-item label {
                font-size: 0.7rem;
                margin-bottom: 2px;
            }
            
            .timer-popup-section select,
            .timer-popup-section input {
                padding: 4px 6px;
                font-size: 0.75rem;
            }
            
            .timer-popup-buttons {
                margin-top: 6px;
                padding-top: 6px;
                gap: 6px;
            }
            
            .timer-popup-buttons button {
                padding: 6px 10px;
                font-size: 0.75rem;
                min-width: 50px;
            }
        }
        
        /* Mobile phones (portrait) */
        @media screen and (max-width: 480px) {
            .timer-popup {
                max-width: 95%;
                width: 95%;
                max-height: 85vh;
                border-radius: 12px;
            }
            
            #timer-popup-content {
                padding: 20px 16px 16px 16px;
            }
            
            #timer-popup-content h2 {
                font-size: 1.2rem;
                margin-bottom: 14px;
            }
            
            .timer-popup-section {
                margin-bottom: 14px;
            }
            
            .timer-popup-section .option-item {
                margin-bottom: 10px;
            }
            
            .timer-popup-section .option-item label {
                font-size: 0.8rem;
                margin-bottom: 5px;
            }
            
            .timer-popup-section select,
            .timer-popup-section input {
                padding: 8px 10px;
                font-size: 0.85rem;
            }
            
            .timer-popup-section .duration-control input {
                width: 45px;
            }
            
            .timer-popup-section .endtime-control select {
                width: 85px;
            }
            
            .timer-popup-buttons {
                gap: 10px;
                margin-top: 16px;
                padding-top: 14px;
            }
            
            .timer-popup-buttons button {
                padding: 10px 16px;
                font-size: 0.85rem;
                min-width: 70px;
            }
        }
        
        /* Mobile phones (landscape) */
        @media screen and (max-height: 500px) and (orientation: landscape) {
            .timer-popup {
                max-width: 90%;
                width: 90%;
                max-height: 95vh;
                border-radius: 10px;
                overflow-x: hidden;
            }
            
            #timer-popup-content {
                padding: 16px 14px 12px 14px;
                max-width: 100%;
                overflow-x: hidden;
            }

            /* Tighter inputs to prevent horizontal overflow */
            .timer-popup-section .duration-control input { width: 42px; }
            .timer-popup-section .endtime-control select { width: 80px; }
        }
        
        /* Tablets */
        @media screen and (min-width: 481px) and (max-width: 768px) {
            .timer-popup {
                max-width: 400px;
                width: 80%;
                max-height: 75vh;
            }
            
            #timer-popup-content {
                padding: 22px 18px 18px 18px;
            }
            
            #timer-popup-content h2 {
                font-size: 1.25rem;
                margin-bottom: 15px;
            }
            
            .timer-popup-section .option-item label {
                font-size: 0.82rem;
            }
            
            .timer-popup-section select,
            .timer-popup-section input {
                padding: 9px 11px;
                font-size: 0.88rem;
            }
        }
        /* Large screens */
        @media screen and (min-width: 1200px) {
            .timer-popup {
                max-width: 380px;
                width: 75%;
            }
            
            #timer-popup-content {
                padding: 26px 22px 22px 22px;
            }
            
            #timer-popup-content h2 {
                font-size: 1.35rem;
                margin-bottom: 18px;
            }
            
            .timer-popup-section {
                margin-bottom: 18px;
            }
            
            .timer-popup-section .option-item {
                margin-bottom: 14px;
            }
            
            .timer-popup-section .option-item label {
                font-size: 0.87rem;
                margin-bottom: 7px;
            }
            
            .timer-popup-section select,
            .timer-popup-section input {
                padding: 11px 13px;
                font-size: 0.92rem;
            }
            
            .timer-popup-buttons {
                gap: 14px;
                margin-top: 22px;
                padding-top: 18px;
            }
            
            .timer-popup-buttons button {
                padding: 13px 22px;
                font-size: 0.92rem;
                min-width: 85px;
            }
        }
    </style>

    <meta name="theme-color" content="#000000">
    <style>
    /* === Fullscreen Visual Fix for iPad/iOS === */
    html, body {
        background-color: #000 !important;
    }
    body {
        padding-top: env(safe-area-inset-top);
        padding-bottom: env(safe-area-inset-bottom);
        padding-left: env(safe-area-inset-left);
        padding-right: env(safe-area-inset-right);
    }
    body::before, body::after {
        content: "";
        position: fixed;
        left: 0;
        width: 100%;
        background: #000;
        z-index: 999;
        pointer-events: none;
    }
    body::before {
        top: 0;
        height: env(safe-area-inset-top);
    }
    body::after {
        bottom: 0;
        height: env(safe-area-inset-bottom);
    }
    .timer-wrapper {
        padding-top: env(safe-area-inset-top);
        padding-bottom: env(safe-area-inset-bottom);
        min-height: 100vh;
        height: 100dvh;
    }
    @media (display-mode: standalone) {
        html, body {
            background-color: #000 !important;
            overflow: hidden;
            height: 100vh;
            height: -webkit-fill-available;
        }
    }
    </style>

</head>
<body>
    <!-- Font Preloader -->
    <div class="font-preloader">Font Preloader</div>

    <!-- Audio elements for countdown sounds -->
    <audio id="countdown-beep" preload="auto"></audio>
    <audio id="countdown-final" preload="auto"></audio>

    

    <div class="timer-wrapper">
        <!-- Options Button --><div id="options-btn" title="Settings"><div id="icon-animator"></div></div>

        <!-- Timer Display & Message Container -->
        <div id="timer-content-container">
            <div id="timer-display">
            <span id="main-numbers">0.00%</span>
        </div>
        <div id="timer-message">Your custom message here</div>
        </div>
        <div id="countdown-display" class="hidden"><span id="countdown-number">3</span></div>

        <!-- Progress Bar --><div id="progress-bar-container">
            <div id="progress-bar"></div>
        </div>
        <!-- Quick Set Time Button (follows bar) -->
        <div id="quick-settime-btn" aria-label="Set time" title="Set time">
            <span class="material-symbols-outlined">alarm_add</span>
        </div>

        <!-- Controls --><div id="controls">
            <button id="set-time-btn">Set the time</button>
            <button id="pause-btn" class="hidden">Pause</button>
            <button id="resume-btn" class="hidden">Resume</button>
            <button id="repeat-btn" class="hidden">Repeat</button>
            <button id="end-btn" class="hidden">End</button>
        </div>
    </div>

    <!-- Options Panel (Hidden by default) --><div id="options-panel-overlay">
        <div id="options-panel">
            <div id="close-panel-btn">&times;</div>
            <div id="options-panel-content">
                <h2>Customization</h2>
                
                <div class="options-section timer-sound-section">
                    <h3>Timer</h3>
                    <div class="options-content-wrapper">
                        <div class="options-content">
                            <div class="option-item">
                                <label for="timer-mode-select">Mode</label>
                                <select id="timer-mode-select">
                                    <option value="duration" selected>Duration</option>
                                    <option value="endTime">End Time</option>
                                </select>
                            </div>
                            <div id="duration-settings">
                                <div class="option-item full-width">
                                    <label>Duration</label>
                                    <div class="reset-section">
                                        <button class="zero-btn" id="duration-reset-btn">Reset</button>
                                    </div>
                                    <div class="duration-control">
                                        <div class="top-row">
                                            <div class="input-group">
                                                <label for="duration-hours">Hrs</label>
                                        <div class="wheel-picker" id="hours-wheel">
                                            <div class="wheel-label">HRS</div>
                                            <div class="selection-highlight"></div>
                                            <div class="wheel-container">
                                                        <div class="wheel-item" data-value="0">00</div>
                                                        <div class="wheel-item" data-value="1">01</div>
                                                        <div class="wheel-item" data-value="2">02</div>
                                                        <div class="wheel-item" data-value="3">03</div>
                                                        <div class="wheel-item" data-value="4">04</div>
                                                        <div class="wheel-item" data-value="5">05</div>
                                                        <div class="wheel-item" data-value="6">06</div>
                                                        <div class="wheel-item" data-value="7">07</div>
                                                        <div class="wheel-item" data-value="8">08</div>
                                                        <div class="wheel-item" data-value="9">09</div>
                                                        <div class="wheel-item" data-value="10">10</div>
                                                        <div class="wheel-item" data-value="11">11</div>
                                                        <div class="wheel-item" data-value="12">12</div>
                                                        <div class="wheel-item" data-value="13">13</div>
                                                        <div class="wheel-item" data-value="14">14</div>
                                                        <div class="wheel-item" data-value="15">15</div>
                                                        <div class="wheel-item" data-value="16">16</div>
                                                        <div class="wheel-item" data-value="17">17</div>
                                                        <div class="wheel-item" data-value="18">18</div>
                                                        <div class="wheel-item" data-value="19">19</div>
                                                        <div class="wheel-item" data-value="20">20</div>
                                                        <div class="wheel-item" data-value="21">21</div>
                                                        <div class="wheel-item" data-value="22">22</div>
                                                        <div class="wheel-item" data-value="23">23</div>
                                                        <div class="wheel-item" data-value="24">24</div>
                                                    </div>
                                                </div>
                                                <input type="hidden" id="duration-hours" value="0">
                                            </div>
                                            <span class="time-separator">:</span>
                                            <div class="input-group">
                                                <label for="duration-minutes">Min</label>
                                        <div class="wheel-picker" id="minutes-wheel">
                                            <div class="wheel-label">MIN</div>
                                            <div class="selection-highlight"></div>
                                            <div class="wheel-container">
                                                        <div class="wheel-item" data-value="0">00</div>
                                                        <div class="wheel-item" data-value="1">01</div>
                                                        <div class="wheel-item" data-value="2">02</div>
                                                        <div class="wheel-item" data-value="3">03</div>
                                                        <div class="wheel-item" data-value="4">04</div>
                                                        <div class="wheel-item" data-value="5">05</div>
                                                        <div class="wheel-item" data-value="6">06</div>
                                                        <div class="wheel-item" data-value="7">07</div>
                                                        <div class="wheel-item" data-value="8">08</div>
                                                        <div class="wheel-item" data-value="9">09</div>
                                                        <div class="wheel-item" data-value="10">10</div>
                                                        <div class="wheel-item" data-value="11">11</div>
                                                        <div class="wheel-item" data-value="12">12</div>
                                                        <div class="wheel-item" data-value="13">13</div>
                                                        <div class="wheel-item" data-value="14">14</div>
                                                        <div class="wheel-item" data-value="15">15</div>
                                                        <div class="wheel-item" data-value="16">16</div>
                                                        <div class="wheel-item" data-value="17">17</div>
                                                        <div class="wheel-item" data-value="18">18</div>
                                                        <div class="wheel-item" data-value="19">19</div>
                                                        <div class="wheel-item" data-value="20">20</div>
                                                        <div class="wheel-item" data-value="21">21</div>
                                                        <div class="wheel-item" data-value="22">22</div>
                                                        <div class="wheel-item" data-value="23">23</div>
                                                        <div class="wheel-item" data-value="24">24</div>
                                                        <div class="wheel-item" data-value="25">25</div>
                                                        <div class="wheel-item" data-value="26">26</div>
                                                        <div class="wheel-item" data-value="27">27</div>
                                                        <div class="wheel-item" data-value="28">28</div>
                                                        <div class="wheel-item" data-value="29">29</div>
                                                        <div class="wheel-item" data-value="30">30</div>
                                                        <div class="wheel-item" data-value="31">31</div>
                                                        <div class="wheel-item" data-value="32">32</div>
                                                        <div class="wheel-item" data-value="33">33</div>
                                                        <div class="wheel-item" data-value="34">34</div>
                                                        <div class="wheel-item" data-value="35">35</div>
                                                        <div class="wheel-item" data-value="36">36</div>
                                                        <div class="wheel-item" data-value="37">37</div>
                                                        <div class="wheel-item" data-value="38">38</div>
                                                        <div class="wheel-item" data-value="39">39</div>
                                                        <div class="wheel-item" data-value="40">40</div>
                                                        <div class="wheel-item" data-value="41">41</div>
                                                        <div class="wheel-item" data-value="42">42</div>
                                                        <div class="wheel-item" data-value="43">43</div>
                                                        <div class="wheel-item" data-value="44">44</div>
                                                        <div class="wheel-item" data-value="45">45</div>
                                                        <div class="wheel-item" data-value="46">46</div>
                                                        <div class="wheel-item" data-value="47">47</div>
                                                        <div class="wheel-item" data-value="48">48</div>
                                                        <div class="wheel-item" data-value="49">49</div>
                                                        <div class="wheel-item" data-value="50">50</div>
                                                        <div class="wheel-item" data-value="51">51</div>
                                                        <div class="wheel-item" data-value="52">52</div>
                                                        <div class="wheel-item" data-value="53">53</div>
                                                        <div class="wheel-item" data-value="54">54</div>
                                                        <div class="wheel-item" data-value="55">55</div>
                                                        <div class="wheel-item" data-value="56">56</div>
                                                        <div class="wheel-item" data-value="57">57</div>
                                                        <div class="wheel-item" data-value="58">58</div>
                                                        <div class="wheel-item" data-value="59">59</div>
                                                    </div>
                                                </div>
                                                <input type="hidden" id="duration-minutes" value="0">
                                            </div>
                                            <span class="time-separator">:</span>
                                            <div class="input-group">
                                                <label for="duration-seconds">Sec</label>
                                        <div class="wheel-picker" id="seconds-wheel">
                                            <div class="wheel-label">SEC</div>
                                            <div class="selection-highlight"></div>
                                            <div class="wheel-container">
                                                        <div class="wheel-item" data-value="0">00</div>
                                                        <div class="wheel-item" data-value="1">01</div>
                                                        <div class="wheel-item" data-value="2">02</div>
                                                        <div class="wheel-item" data-value="3">03</div>
                                                        <div class="wheel-item" data-value="4">04</div>
                                                        <div class="wheel-item" data-value="5">05</div>
                                                        <div class="wheel-item" data-value="6">06</div>
                                                        <div class="wheel-item" data-value="7">07</div>
                                                        <div class="wheel-item" data-value="8">08</div>
                                                        <div class="wheel-item" data-value="9">09</div>
                                                        <div class="wheel-item" data-value="10">10</div>
                                                        <div class="wheel-item" data-value="11">11</div>
                                                        <div class="wheel-item" data-value="12">12</div>
                                                        <div class="wheel-item" data-value="13">13</div>
                                                        <div class="wheel-item" data-value="14">14</div>
                                                        <div class="wheel-item" data-value="15">15</div>
                                                        <div class="wheel-item" data-value="16">16</div>
                                                        <div class="wheel-item" data-value="17">17</div>
                                                        <div class="wheel-item" data-value="18">18</div>
                                                        <div class="wheel-item" data-value="19">19</div>
                                                        <div class="wheel-item" data-value="20">20</div>
                                                        <div class="wheel-item" data-value="21">21</div>
                                                        <div class="wheel-item" data-value="22">22</div>
                                                        <div class="wheel-item" data-value="23">23</div>
                                                        <div class="wheel-item" data-value="24">24</div>
                                                        <div class="wheel-item" data-value="25">25</div>
                                                        <div class="wheel-item" data-value="26">26</div>
                                                        <div class="wheel-item" data-value="27">27</div>
                                                        <div class="wheel-item" data-value="28">28</div>
                                                        <div class="wheel-item" data-value="29">29</div>
                                                        <div class="wheel-item" data-value="30">30</div>
                                                        <div class="wheel-item" data-value="31">31</div>
                                                        <div class="wheel-item" data-value="32">32</div>
                                                        <div class="wheel-item" data-value="33">33</div>
                                                        <div class="wheel-item" data-value="34">34</div>
                                                        <div class="wheel-item" data-value="35">35</div>
                                                        <div class="wheel-item" data-value="36">36</div>
                                                        <div class="wheel-item" data-value="37">37</div>
                                                        <div class="wheel-item" data-value="38">38</div>
                                                        <div class="wheel-item" data-value="39">39</div>
                                                        <div class="wheel-item" data-value="40">40</div>
                                                        <div class="wheel-item" data-value="41">41</div>
                                                        <div class="wheel-item" data-value="42">42</div>
                                                        <div class="wheel-item" data-value="43">43</div>
                                                        <div class="wheel-item" data-value="44">44</div>
                                                        <div class="wheel-item" data-value="45">45</div>
                                                        <div class="wheel-item" data-value="46">46</div>
                                                        <div class="wheel-item" data-value="47">47</div>
                                                        <div class="wheel-item" data-value="48">48</div>
                                                        <div class="wheel-item" data-value="49">49</div>
                                                        <div class="wheel-item" data-value="50">50</div>
                                                        <div class="wheel-item" data-value="51">51</div>
                                                        <div class="wheel-item" data-value="52">52</div>
                                                        <div class="wheel-item" data-value="53">53</div>
                                                        <div class="wheel-item" data-value="54">54</div>
                                                        <div class="wheel-item" data-value="55">55</div>
                                                        <div class="wheel-item" data-value="56">56</div>
                                                        <div class="wheel-item" data-value="57">57</div>
                                                        <div class="wheel-item" data-value="58">58</div>
                                                        <div class="wheel-item" data-value="59">59</div>
                                                    </div>
                                                </div>
                                                <input type="hidden" id="duration-seconds" value="0">
                                            </div>
                                            </div>
                                            <div class="bottom-controls">
                                                <div class="input-group">
                                                    <label for="custom-start-delay">Countdown</label>
                                                    <select id="custom-start-delay">
                                                        <option value="0">0 sec</option>
                                                        <option value="3">3 sec</option>
                                                        <option value="5">5 sec</option>
                                                        <option value="10">10 sec</option>
                                                        <option value="15">15 sec</option>
                                                    </select>
                                                </div>
                                                <button type="button" id="custom-start-btn" class="custom-start-button">START</button>
                                            </div>
                                        </div>
                                    </div>
                                 </div>
                            </div>
                            <div id="endtime-settings" class="hidden">
                                <div class="option-item full-width">
                                    <label>End Time</label>
                                    <div class="endtime-control">
                                        <select id="end-time-hour"></select>
                                        <span>:</span>
                                        <select id="end-time-minute"></select>
                                        <select id="end-time-ampm">
                                            <option>AM</option>
                                            <option>PM</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="options-section collapsible">
                    <h3>Sounds</h3>
                    <div class="options-content-wrapper">
                        <div class="options-content">
                            <div class="option-item">
                                <label for="alarm-sound-select">Alarm Sound</label>
                                <select id="alarm-sound-select">
                                    <option value="none">None</option>
                                    <option value="0">Classic Beep</option>
                                    <option value="1">Two-Tone Alarm</option>
                                    <option value="2">Rising Tone</option>
                                    <option value="3">Chime</option>
                                    <option value="4">Electronic Pattern</option>
                                </select>
                            </div>
                            <div class="option-item">
                                <label for="countdown-sound-select">Countdown Sound</label>
                                <select id="countdown-sound-select">
                                    <option value="none">None</option>
                                    <option value="beep">Beep</option>
                                    <option value="tick">Tick</option>
                                    <option value="chime">Chime</option>
                                    <option value="digital">Digital</option>
                                </select>
                            </div>
                            <div class="option-item">
                                <label for="ui-sound-select">UI Click Sound</label>
                                <select id="ui-sound-select">
                                    <option value="none" selected>None</option>
                                    <option value="click">Click</option>
                                    <option value="tap">Tap</option>
                                    <option value="beep">Beep</option>
                                    <option value="chime">Chime</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="options-section collapsible">
                    <h3>Background</h3>
                    <div class="options-content-wrapper">
                        <div class="options-content">
                            <div class="option-item"><label for="bg-color-input">Color</label><input type="color" id="bg-color-input" value="#121212"></div>
                            <div class="option-item"><label for="bg-image-upload">Upload</label><input type="file" id="bg-image-upload-hidden" accept="image/*" style="display: none;"><button id="bg-image-upload" style="width: 100%; padding: 8px; background-color: #666; color: white; border: none; border-radius: 5px; cursor: pointer;">Choose file</button></div>
                            <div class="option-item"><label>Clear</label><button id="clear-bg-btn">Clear Image</button></div>
                            <hr style="border-color: #444; margin: 15px 0;">
                            <label class="section-title">Particles</label>
                            <div class="option-item checkbox"><label for="particles-toggle">Enable Particles</label><input type="checkbox" id="particles-toggle"></div>
                            <div class="option-group disabled" id="particles-options">
                                <div class="option-item"><label for="particle-density-input">Density</label><input type="range" id="particle-density-input" min="1" max="20" value="8"></div>
                                <div class="option-item"><label for="particle-speed-input">Speed</label><input type="range" id="particle-speed-input" min="0.3" max="6" value="1" step="0.1"></div>
                                <div class="option-item"><label for="particle-size-input">Size</label><input type="range" id="particle-size-input" min="1" max="12" value="6"></div>
                                <div class="option-item"><label for="particle-twinkle-input">Twinkle</label><input type="range" id="particle-twinkle-input" min="0" max="100" value="0"></div>
                                <div class="option-item"><label for="particle-color-input">Color</label><input type="color" id="particle-color-input" value="#00BFFF"></div>
                                <div class="option-item"><label for="particle-multi-color-1-input">Color 1</label><input type="color" id="particle-multi-color-1-input" value="#00BFFF"></div>
                                <div class="option-item"><label for="particle-multi-color-2-input">Color 2</label><input type="color" id="particle-multi-color-2-input" value="#FF6B6B"></div>
                                <div class="option-item"><label for="particle-multi-color-3-input">Color 3</label><input type="color" id="particle-multi-color-3-input" value="#4ECDC4"></div>
                                <div class="option-item"><label for="particle-multi-color-4-input">Color 4</label><input type="color" id="particle-multi-color-4-input" value="#45B7D1"></div>
                                <div class="option-item"><label for="particle-color-style-select">Color Style</label><select id="particle-color-style-select"><option value="solid">Solid</option><option value="multiple">Multiple Color</option><option value="rainbow">Rainbow</option><option value="random">Random</option></select></div>
                                <div class="option-item"><label for="particle-shape-select">Shape</label><select id="particle-shape-select"><option value="square">Square</option><option value="circle">Circle</option><option value="ring">Ring</option><option value="triangle">Triangle</option><option value="triangle-outline">Triangle Outline</option><option value="horizontal-line">Horizontal Line</option><option value="vertical-line">Vertical Line</option><option value="diagonal-line">Diagonal Line</option><option value="single-pixel">Single Pixel</option><option value="star">⭐ Star</option><option value="heart">❤️ Heart</option><option value="diamond">💎 Diamond</option><option value="cross">➕ Cross</option><option value="hexagon">⬡ Hexagon</option><option value="pentagon">⬟ Pentagon</option><option value="sparkle">✨ Sparkle</option><option value="smoke">💨 Smoke</option><option value="lightning">⚡ Lightning</option><option value="pulse">💓 Pulse</option></select></div>
                                <div class="option-item"><label for="particle-direction-select">Movement Patterns</label><select id="particle-direction-select"><option value="up">Up</option><option value="down">Down</option><option value="left">Left</option><option value="right">Right</option><option value="bounce">Bounce</option><option value="random">Random</option><option value="static">Static</option><option value="space">Outward</option></select></div>
                                <div class="option-item"><label for="particle-effects-select">Advanced Effects</label><select id="particle-effects-select"><option value="none">None</option><option value="connections">🔗 Particle Connections</option></select></div>
                            </div>
                            <hr style="border-color: #444; margin: 15px 0;">
                            
                        </div>
                    </div>
                </div>

                <div class="options-section collapsible">
                    <h3>Progress Bar</h3>
                    <div class="options-content-wrapper">
                        <div class="options-content">
                            <div class="option-item"><label for="bar-length-input">Length</label><input type="range" id="bar-length-input" min="40" max="90" value="60"></div>
                            <div class="option-item"><label for="bar-width-input">Width</label><input type="range" id="bar-width-input" min="15" max="200" value="50"></div>
                            <div class="option-item"><label for="bar-corner-input">Roundness</label><input type="range" id="bar-corner-input" min="0" max="50" value="0"></div>
                            <div class="option-item"><label for="bar-padding-input">Padding</label><input type="range" id="bar-padding-input" min="0" max="10" value="0"></div>
                            <hr style="border-color: #444; margin: 15px 0;">
                            <label class="section-title">Color</label>
                            <div class="option-item" id="bar-color-option"><label for="bar-color-input">Color</label><input type="color" id="bar-color-input" value="#4CAF50"></div>
                            <div class="option-item checkbox"><label for="bar-gradient-toggle">Gradient</label><input type="checkbox" id="bar-gradient-toggle"></div>
                            <div class="option-group disabled" id="bar-gradient-options">
                                <div class="option-item"><label for="bar-gradient-start-input">Start</label><input type="color" id="bar-gradient-start-input" value="#4CAF50"></div>
                                <div class="option-item"><label for="bar-gradient-end-input">End</label><input type="color" id="bar-gradient-end-input" value="#03A9F4"></div>
                            </div>
                            <hr style="border-color: #444; margin: 15px 0;">
                            <label class="section-title">Effects</label>
                            <div class="option-item checkbox"><label for="bar-glow-neon-toggle">Neon</label><input type="checkbox" id="bar-glow-neon-toggle"></div>
                            <div class="option-group" id="bar-glow-neon-options">
                                <div class="option-item"><label for="bar-neon-intensity-input">Intensity</label><input type="range" id="bar-neon-intensity-input" min="0" max="50" value="0"></div>
                            </div>
                            <hr style="border-color: #444; margin: 15px 0;">
                            <label class="section-title">Border</label>
                            <div class="option-item"><label for="border-color-input">Color</label><input type="color" id="border-color-input" value="#FFFFFF"></div>
                            <div class="option-item"><label for="border-size-input">Size</label><input type="range" id="border-size-input" min="0" max="10" value="2"></div>
                            <div class="option-item checkbox"><label for="border-neon-toggle">Neon</label><input type="checkbox" id="border-neon-toggle"></div>
                            <div class="option-group" id="border-neon-options">
                                <div class="option-item"><label for="border-neon-intensity-input">Intensity</label><input type="range" id="border-neon-intensity-input" min="0" max="30" value="0"></div>
                                <div class="option-item checkbox"><label for="border-neon-match-color-toggle">Match Border Color</label><input type="checkbox" id="border-neon-match-color-toggle" checked></div>
                                <div class="option-item"><label for="border-neon-color-input">Color</label><input type="color" id="border-neon-color-input" value="#ffffff"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="options-section collapsible">
                    <h3>Percentage Text</h3>
                    <div class="options-content-wrapper">
                        <div class="options-content">
                            <div class="option-item"><label for="font-select">Font</label><select id="font-select"><option value="'Inter', system-ui, sans-serif">System</option><option value="'VT323', monospace">Retro</option><option value="'Press Start 2P', cursive">Pixel</option><option value="'Share Tech Mono', monospace">Tech Mono</option><option value="'Jersey 25', sans-serif">Jersey 25</option><option value="'Jersey 20', sans-serif">Jersey 20</option><option value="'Jersey 10', sans-serif">Jersey 10</option><option value="'Share Tech', sans-serif">Share Tech</option><option value="'Electrolyze', sans-serif">Electrolyze</option></select></div>
                            <div class="option-item"><label for="font-size-input">Size</label><input type="range" id="font-size-input" min="20" max="120" value="72"></div>
                            <div class="option-item"><label for="font-color-input">Color</label><input type="color" id="font-color-input" value="#FFFFFF"></div>
                            <hr style="border-color: #444; margin: 15px 0;">
                            <label class="section-title">Outline</label>
                            <div class="option-item checkbox"><label for="font-outline-toggle">Outline</label><input type="checkbox" id="font-outline-toggle"></div>
                            <div class="option-group" id="font-outline-options">
                                <div class="option-item"><label for="font-outline-color-input">Color</label><input type="color" id="font-outline-color-input" value="#000000"></div>
                            </div>
                            <hr style="border-color: #444; margin: 15px 0;">
                            <label class="section-title">Effects</label>
                            <div class="option-item checkbox"><label for="text-glow-neon-toggle">Neon</label><input type="checkbox" id="text-glow-neon-toggle"></div>
                            <div class="option-group" id="text-glow-neon-options">
                                <div class="option-item"><label for="text-neon-spread-input">Spread</label><input type="range" id="text-neon-spread-input" min="0" max="30" value="0"></div>
                                <div class="option-item checkbox"><label for="text-neon-match-color-toggle">Match Font Color</label><input type="checkbox" id="text-neon-match-color-toggle" checked></div>
                                <div class="option-item"><label for="text-neon-color-input">Color</label><input type="color" id="text-neon-color-input" value="#FFFFFF"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="options-section collapsible">
                    <h3>Custom Message</h3>
                    <div class="options-content-wrapper">
                        <div class="options-content">
                            <div class="option-item checkbox"><label for="message-toggle">Show Message</label><input type="checkbox" id="message-toggle" checked></div>
                            <div class="option-group" id="message-options">
                            <div class="option-item"><label for="message-input">Text</label><input type="text" id="message-input" placeholder="Your custom message here"></div>
                            <div class="option-item"><label for="message-color-input">Color</label><input type="color" id="message-color-input" value="#cccccc"></div>
                            <div class="option-item"><label for="message-font-size-input">Size</label><input type="range" id="message-font-size-input" min="0.5" max="3" value="1.2" step="0.1"></div>
                            <hr style="border-color: #444; margin: 15px 0;">
                            <label class="section-title">Outline</label>
                            <div class="option-item checkbox"><label for="message-outline-toggle">Outline</label><input type="checkbox" id="message-outline-toggle"></div>
                            <div class="option-group" id="message-outline-options">
                                <div class="option-item"><label for="message-outline-color-input">Color</label><input type="color" id="message-outline-color-input" value="#000000"></div>
                            </div>
                            <hr style="border-color: #444; margin: 15px 0;">
                            <label class="section-title">Effects</label>
                             <div class="option-item checkbox"><label for="message-glow-neon-toggle">Neon</label><input type="checkbox" id="message-glow-neon-toggle"></div>
                            <div class="option-group" id="message-glow-neon-options">
                                <div class="option-item"><label for="message-neon-spread-input">Spread</label><input type="range" id="message-neon-spread-input" min="0" max="50" value="0"></div>
                                <div class="option-item checkbox"><label for="message-neon-match-color-toggle">Match Message Color</label><input type="checkbox" id="message-neon-match-color-toggle" checked></div>
                                <div class="option-item"><label for="message-neon-color-input">Color</label><input type="color" id="message-neon-color-input" value="#cccccc"></div>
                            </div>
                            <hr style="border-color: #444; margin: 15px 0;">
                            <label class="section-title">Animation</label>
                            <div class="option-item"><label for="ellipsis-animation-select">Ellipsis</label><select id="ellipsis-animation-select"><option value="pulse">Pulse</option><option value="wave">Wave</option><option value="none">None</option></select></div>
                            <div class="option-item"><label for="ellipsis-intensity-input">Intensity</label><input type="range" id="ellipsis-intensity-input" min="0" max="20" value="5"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="options-section collapsible">
                    <h3>Icon</h3>
                    <div class="options-content-wrapper">
                        <div class="options-content">
                            <div class="option-item"><label for="icon-preset-select">Preset</label><select id="icon-preset-select"><option value="default">Gear</option><option value="star">Star</option><option value="heart">Heart</option><option value="wrench">Wrench</option><option value="sliders">Sliders</option><option value="ellipsis">Ellipsis</option><option value="info">Info</option><option value="menu" selected>Menu</option></select></div>
                            <div class="option-item"><label for="icon-size-input">Size</label><input type="range" id="icon-size-input" min="20" max="120" value="50"></div>
                             <div class="option-item"><label for="icon-color-input">Color</label><input type="color" id="icon-color-input" value="#999999"></div>
                            <div class="option-item"><label for="icon-color-style-select">Color Style</label><select id="icon-color-style-select"><option value="solid">Solid</option><option value="multicolor">Multicolor</option><option value="rainbow">Rainbow</option></select></div>
                            <div class="option-item"><label for="icon-opacity-input">Opacity</label><input type="range" id="icon-opacity-input" min="20" max="100" value="100"></div>
                            <div class="option-item checkbox"><label for="icon-outline-toggle">Outline</label><input type="checkbox" id="icon-outline-toggle"></div>
                            <div class="option-group" id="icon-outline-options">
                                <div class="option-item"><label for="icon-outline-color-input">Color</label><input type="color" id="icon-outline-color-input" value="#000000"></div>
                            </div>
                            <div class="option-item checkbox"><label for="icon-neon-toggle">Neon</label><input type="checkbox" id="icon-neon-toggle"></div>
                            <div class="option-group" id="icon-neon-options">
                                <div class="option-item"><label for="icon-neon-intensity-input">Intensity</label><input type="range" id="icon-neon-intensity-input" min="0" max="30" value="0"></div>
                                <div class="option-item checkbox"><label for="icon-neon-match-color-toggle">Match Icon Color</label><input type="checkbox" id="icon-neon-match-color-toggle" checked></div>
                                <div class="option-item"><label for="icon-neon-color-input">Color</label><input type="color" id="icon-neon-color-input" value="#ffffff"></div>
                            </div>
                            <hr style="border-color: #444; margin: 15px 0;">
                            <label class="section-title">Animation</label>
                            <div class="option-item checkbox"><label for="icon-animation-toggle">Animate</label><input type="checkbox" id="icon-animation-toggle"></div>
                            <div class="option-item"><label for="icon-animation-style-select">Style</label><select id="icon-animation-style-select"><option value="spin">Spin</option><option value="pulse">Pulse</option><option value="float">Float</option><option value="wobble">Wobble</option></select></div>
                            <div class="option-item"><label for="icon-animation-speed-input">Speed</label><input type="range" id="icon-animation-speed-input" min="1" max="5" value="2" step="0.1"></div>
                            <hr style="border-color: #444; margin: 15px 0;">
                            <label class="section-title">Custom</label>
                            <div class="option-item"><label for="icon-upload-input">Upload</label><input type="file" id="icon-upload-input" accept="image/*"></div>
                            <div class="option-item"><label>Clear</label><button id="clear-icon-btn">Clear Icon</button></div>
                        </div>
                    </div>
                </div>
                
                <div class="options-section collapsible">
                    <h3>Buttons</h3>
                    <div class="options-content-wrapper">
                        <div class="options-content">
                            <div class="option-item"><label for="start-btn-color">Start/Resume</label><input type="color" id="start-btn-color" value="#4CAF50"></div>
                            <div class="option-item"><label for="repeat-btn-color">Repeat</label><input type="color" id="repeat-btn-color" value="#03A9F4"></div>
                            <div class="option-item"><label for="end-btn-color">End</label><input type="color" id="end-btn-color" value="#f44336"></div>
                            <hr style="border-color: #444; margin: 15px 0;">
                            <label class="section-title">Size</label>
                            <div class="option-item"><label for="btn-padding-y-input">Height</label><input type="range" id="btn-padding-y-input" min="2" max="20" value="10"></div>
                            <div class="option-item"><label for="btn-padding-x-input">Width</label><input type="range" id="btn-padding-x-input" min="5" max="40" value="22"></div>
                            <div class="option-item"><label for="btn-font-size-input">Font Size</label><input type="range" id="btn-font-size-input" min="0.5" max="2" value="1" step="0.1"></div>
                            <hr style="border-color: #444; margin: 15px 0;">
                            <label style="margin-bottom: 15px; display: block; text-align: left;">Outline</label>
                            <div class="option-item checkbox"><label for="btn-outline-toggle">Outline</label><input type="checkbox" id="btn-outline-toggle"></div>
                            <hr style="border-color: #444; margin: 15px 0;">
                             <label style="margin-bottom: 15px; display: block; text-align: left;">Border</label>
                            <div class="option-item"><label for="btn-border-size-input">Size</label><input type="range" id="btn-border-size-input" min="0" max="10" value="0"></div>
                            <div class="option-item"><label for="btn-border-color-input">Color</label><input type="color" id="btn-border-color-input" value="#FFFFFF"></div>
                            <hr style="border-color: #444; margin: 15px 0;">
                            <label class="section-title">Effects</label>
                            <div class="option-item checkbox"><label for="btn-glow-neon-toggle">Neon</label><input type="checkbox" id="btn-glow-neon-toggle"></div>
                            <div class="option-group" id="btn-glow-neon-options">
                                <div class="option-item"><label for="btn-neon-intensity-input">Intensity</label><input type="range" id="btn-neon-intensity-input" min="0" max="20" value="0"></div>
                                <div class="option-item checkbox"><label for="btn-neon-match-color-toggle">Match Button Color</label><input type="checkbox" id="btn-neon-match-color-toggle" checked></div>
                                <div class="option-item"><label for="btn-neon-color-input">Color</label><input type="color" id="btn-neon-color-input" value="#ffffff"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="options-section collapsible">
                    <h3>Interface</h3>
                    <div class="options-content-wrapper">
                        <div class="options-content">
                            <div class="option-item"><label for="ui-opacity-input">Opacity</label><input type="range" id="ui-opacity-input" min="20" max="100" value="100"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Particle Effects Canvas -->
    <canvas id="particles-canvas"></canvas>
    
    <div id="settings-management-external">
        <button id="save-settings-btn">Save Settings</button>
        <button id="reset-settings-btn">Reset to Default</button>
    </div>

    <div id="confirm-modal-overlay" class="hidden">
        <div id="confirm-modal">
            <p>Are you sure you want to reset all settings?</p>
            <div id="confirm-modal-buttons">
                <button id="confirm-yes">Yes</button>
                <button id="confirm-no">No</button>
            </div>
        </div>
    </div>
    <div id="save-confirm">Settings Saved!</div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- FEATURE DETECTION & BROWSER COMPATIBILITY ---
            const features = {
                canvas: !!document.createElement('canvas').getContext,
                webAudio: !!(window.AudioContext || window.webkitAudioContext),
                requestAnimationFrame: !!window.requestAnimationFrame,
                localStorage: !!window.localStorage,
                vibration: !!navigator.vibrate,
                devicePixelRatio: !!window.devicePixelRatio
            };
            
            // Fallback for missing features
            if (!features.requestAnimationFrame) {
                window.requestAnimationFrame = (callback) => {
                    return setTimeout(callback, 16); // ~60fps fallback
                };
                window.cancelAnimationFrame = (id) => {
                    clearTimeout(id);
                };
            }
            
            if (!features.localStorage) {
                // Simple localStorage fallback using sessionStorage
                window.localStorage = {
                    getItem: (key) => sessionStorage.getItem(key),
                    setItem: (key, value) => sessionStorage.setItem(key, value),
                    removeItem: (key) => sessionStorage.removeItem(key)
                };
            }
            
            if (!features.vibration) {
                navigator.vibrate = () => {}; // No-op fallback
            }
            
            if (!features.devicePixelRatio) {
                window.devicePixelRatio = 1;
            }
            
            // Show warning for critical missing features
            if (!features.canvas) {
                const warning = document.createElement('div');
                warning.style.cssText = 'position:fixed;top:0;left:0;right:0;background:#ff6b6b;color:white;padding:10px;text-align:center;z-index:10000;';
                warning.textContent = 'Your browser does not support Canvas. Particle effects will be disabled.';
                document.body.appendChild(warning);
            }
            
            if (!features.webAudio) {
                const warning = document.createElement('div');
                warning.style.cssText = 'position:fixed;top:40px;left:0;right:0;background:#ffa500;color:white;padding:10px;text-align:center;z-index:10000;';
                warning.textContent = 'Your browser does not support Web Audio API. Sound alerts will be disabled.';
                document.body.appendChild(warning);
            }
            // --- DOM ELEMENT SELECTION ---
            const root = document.documentElement;
            const timerWrapper = document.querySelector('.timer-wrapper');
            const timerContentContainer = document.getElementById('timer-content-container');
            const timerDisplay = document.getElementById('timer-display');
            const mainNumbers = document.getElementById('main-numbers');
            const timerMessage = document.getElementById('timer-message');
            const countdownDisplay = document.getElementById('countdown-display');
            const countdownNumber = document.getElementById('countdown-number');
            const progressBar = document.getElementById('progress-bar');
            const progressBarContainer = document.getElementById('progress-bar-container');

            const setTimeBtn = document.getElementById('set-time-btn');
            const quickSetBtn = document.getElementById('quick-settime-btn');
            const pauseBtn = document.getElementById('pause-btn');
            const resumeBtn = document.getElementById('resume-btn');
            const repeatBtn = document.getElementById('repeat-btn');
            const endBtn = document.getElementById('end-btn');

            // Timer popup elements
            const timerPopupOverlay = document.getElementById('timer-popup-overlay');
            const timerPopup = document.getElementById('timer-popup');
            const popupTimerModeSelect = document.getElementById('popup-timer-mode-select');
            const popupDurationSettings = document.getElementById('popup-duration-settings');
            const popupDurationHoursInput = document.getElementById('popup-duration-hours');
            const popupDurationMinutesInput = document.getElementById('popup-duration-minutes');
            const popupDurationSecondsInput = document.getElementById('popup-duration-seconds');
            const popupStartDelaySelect = document.getElementById('popup-start-delay');
            const popupEndtimeSettings = document.getElementById('popup-endtime-settings');
            const popupEndTimeHourInput = document.getElementById('popup-end-time-hour');
            const popupEndTimeMinuteInput = document.getElementById('popup-end-time-minute');
            const popupEndTimeAmPmInput = document.getElementById('popup-end-time-ampm');
            const popupStartBtn = document.getElementById('popup-start-btn');
            const popupCancelBtn = document.getElementById('popup-cancel-btn');
            // --- Auto-size popup selects (Mode and Countdown) to their text ---
            const autosizePopupSelects = () => {
                const selects = [document.getElementById('popup-timer-mode-select'), document.getElementById('popup-start-delay')].filter(Boolean);
                const measure = (el) => {
                    const dummy = document.createElement('span');
                    dummy.style.visibility = 'hidden';
                    dummy.style.position = 'absolute';
                    dummy.style.whiteSpace = 'nowrap';
                    dummy.style.font = getComputedStyle(el).font;
                    dummy.textContent = el.options[el.selectedIndex]?.text || el.value || '';
                    document.body.appendChild(dummy);
                    const width = dummy.getBoundingClientRect().width;
                    dummy.remove();
                    return width;
                };
                selects.forEach((sel) => {
                    const basePadding = 24; // account for select inner padding
                    const arrowAllowance = 16; // dropdown chevron
                    const target = Math.ceil(measure(sel) + basePadding + arrowAllowance);
                    const max = Math.max(120, Math.min(target, Math.floor(window.innerWidth - 96)));
                    sel.style.width = `${max}px`;
                });
            };

            const optionsBtn = document.getElementById('options-btn');
            const iconAnimator = document.getElementById('icon-animator');
            const optionsPanelOverlay = document.getElementById('options-panel-overlay');
            const closePanelBtn = document.getElementById('close-panel-btn');
            const saveConfirm = document.getElementById('save-confirm');
            const confirmModalOverlay = document.getElementById('confirm-modal-overlay');
            const confirmYesBtn = document.getElementById('confirm-yes');
            const confirmNoBtn = document.getElementById('confirm-no');
            // Options Panel Inputs
            const allInputs = document.querySelectorAll('#options-panel input, #options-panel select');
            const timerModeSelect = document.getElementById('timer-mode-select');
            const durationSettings = document.getElementById('duration-settings');
            const durationHoursInput = document.getElementById('duration-hours');
            const durationMinutesInput = document.getElementById('duration-minutes');
            const durationSecondsInput = document.getElementById('duration-seconds');
            const endtimeSettings = document.getElementById('endtime-settings');
            const endTimeHourInput = document.getElementById('end-time-hour');
            const endTimeMinuteInput = document.getElementById('end-time-minute');
            const endTimeAmPmInput = document.getElementById('end-time-ampm');
            const messageToggle = document.getElementById('message-toggle');
            const messageOptions = document.getElementById('message-options');
            const messageInput = document.getElementById('message-input');
            const messageColorInput = document.getElementById('message-color-input');
            const messageFontSizeInput = document.getElementById('message-font-size-input');
            const messageOutlineToggle = document.getElementById('message-outline-toggle');
            const messageOutlineOptions = document.getElementById('message-outline-options');
            const messageOutlineColorInput = document.getElementById('message-outline-color-input');
            const messageNeonToggle = document.getElementById('message-glow-neon-toggle');
            const messageNeonOptions = document.getElementById('message-glow-neon-options');
            const messageNeonSpreadInput = document.getElementById('message-neon-spread-input');
            const messageNeonMatchColorToggle = document.getElementById('message-neon-match-color-toggle');
            const messageNeonColorInput = document.getElementById('message-neon-color-input');
            const ellipsisAnimationSelect = document.getElementById('ellipsis-animation-select');
            const ellipsisIntensityInput = document.getElementById('ellipsis-intensity-input');
            const alarmSoundSelect = document.getElementById('alarm-sound-select');
            const countdownSoundSelect = document.getElementById('countdown-sound-select');
            const uiSoundSelect = document.getElementById('ui-sound-select');
            const barColorInput = document.getElementById('bar-color-input');
            const barGradientToggle = document.getElementById('bar-gradient-toggle');
            const barGradientOptions = document.getElementById('bar-gradient-options');
            const barGradientStartInput = document.getElementById('bar-gradient-start-input');
            const barGradientEndInput = document.getElementById('bar-gradient-end-input');
            const barLengthInput = document.getElementById('bar-length-input');
            const barWidthInput = document.getElementById('bar-width-input');
            const barCornerInput = document.getElementById('bar-corner-input');
            const barPaddingInput = document.getElementById('bar-padding-input');
            const barNeonIntensityInput = document.getElementById('bar-neon-intensity-input');
            const barGlowNeonToggle = document.getElementById('bar-glow-neon-toggle');
            const barGlowNeonOptions = document.getElementById('bar-glow-neon-options');
            const borderColorInput = document.getElementById('border-color-input');
            const borderSizeInput = document.getElementById('border-size-input');
            const borderNeonToggle = document.getElementById('border-neon-toggle');
            const borderNeonOptions = document.getElementById('border-neon-options');
            const borderNeonIntensityInput = document.getElementById('border-neon-intensity-input');
            const borderNeonMatchColorToggle = document.getElementById('border-neon-match-color-toggle');
            const borderNeonColorInput = document.getElementById('border-neon-color-input');
            const fontSelect = document.getElementById('font-select');
            const fontSizeInput = document.getElementById('font-size-input');
            const fontColorInput = document.getElementById('font-color-input');
            const fontOutlineColorInput = document.getElementById('font-outline-color-input');
            const fontOutlineToggle = document.getElementById('font-outline-toggle');
            const fontOutlineOptions = document.getElementById('font-outline-options');
            const textNeonSpreadInput = document.getElementById('text-neon-spread-input');
            const textNeonMatchColorToggle = document.getElementById('text-neon-match-color-toggle');
            const textNeonColorInput = document.getElementById('text-neon-color-input');
            const textGlowNeonToggle = document.getElementById('text-glow-neon-toggle');
            const textGlowNeonOptions = document.getElementById('text-glow-neon-options');
            const iconPresetSelect = document.getElementById('icon-preset-select');
            const iconAnimationToggle = document.getElementById('icon-animation-toggle');
            const iconAnimationStyleSelect = document.getElementById('icon-animation-style-select');
            const iconAnimationSpeedInput = document.getElementById('icon-animation-speed-input');
            const iconSizeInput = document.getElementById('icon-size-input');
            const iconColorInput = document.getElementById('icon-color-input');
            const iconColorStyleSelect = document.getElementById('icon-color-style-select');
            const iconOpacityInput = document.getElementById('icon-opacity-input');
            const iconNeonToggle = document.getElementById('icon-neon-toggle');
            const iconNeonOptions = document.getElementById('icon-neon-options');
            const iconNeonIntensityInput = document.getElementById('icon-neon-intensity-input');
            const iconNeonMatchColorToggle = document.getElementById('icon-neon-match-color-toggle');
            const iconNeonColorInput = document.getElementById('icon-neon-color-input');
            const iconOutlineToggle = document.getElementById('icon-outline-toggle');
            const iconOutlineOptions = document.getElementById('icon-outline-options');
            const iconOutlineColorInput = document.getElementById('icon-outline-color-input');
            const iconUploadInput = document.getElementById('icon-upload-input');
            const clearIconBtn = document.getElementById('clear-icon-btn');
            const bgColorInput = document.getElementById('bg-color-input');
            const bgImageUploadInput = document.getElementById('bg-image-upload-hidden');
            const bgImageUploadBtn = document.getElementById('bg-image-upload');
            const clearBgBtn = document.getElementById('clear-bg-btn');
            const particlesToggle = document.getElementById('particles-toggle');
            const particlesOptions = document.getElementById('particles-options');
            const particleDensityInput = document.getElementById('particle-density-input');
            const particleSpeedInput = document.getElementById('particle-speed-input');
            const particleSizeInput = document.getElementById('particle-size-input');
            const particleTwinkleInput = document.getElementById('particle-twinkle-input');
            const particleColorInput = document.getElementById('particle-color-input');
            const particleMultiColor1Input = document.getElementById('particle-multi-color-1-input');
            const particleMultiColor2Input = document.getElementById('particle-multi-color-2-input');
            const particleMultiColor3Input = document.getElementById('particle-multi-color-3-input');
            const particleMultiColor4Input = document.getElementById('particle-multi-color-4-input');
            const particleColorStyleSelect = document.getElementById('particle-color-style-select');
            const particleShapeSelect = document.getElementById('particle-shape-select');
            const particleDirectionSelect = document.getElementById('particle-direction-select');
            const particleEffectsSelect = document.getElementById('particle-effects-select');
            const auroraToggle = document.getElementById('aurora-toggle');
            const auroraOptions = document.getElementById('aurora-options');
            const auroraIntensityInput = document.getElementById('aurora-intensity-input');
            const auroraSpeedInput = document.getElementById('aurora-speed-input');
            const auroraColor1Input = document.getElementById('aurora-color1-input');
            const auroraColor2Input = document.getElementById('aurora-color2-input');
            const auroraColor3Input = document.getElementById('aurora-color3-input');
            const auroraColorStyleSelect = document.getElementById('aurora-color-style-select');
            
            const startBtnColorInput = document.getElementById('start-btn-color');
            const repeatBtnColorInput = document.getElementById('repeat-btn-color');
            const endBtnColorInput = document.getElementById('end-btn-color');
            const btnPaddingYInput = document.getElementById('btn-padding-y-input');
            const btnPaddingXInput = document.getElementById('btn-padding-x-input');
            const btnFontSizeInput = document.getElementById('btn-font-size-input');
            const btnBorderSizeInput = document.getElementById('btn-border-size-input');
            const btnBorderColorInput = document.getElementById('btn-border-color-input');
            const btnOutlineToggle = document.getElementById('btn-outline-toggle');
            const btnGlowNeonToggle = document.getElementById('btn-glow-neon-toggle');
            const btnGlowNeonOptions = document.getElementById('btn-glow-neon-options');
            const btnNeonIntensityInput = document.getElementById('btn-neon-intensity-input');
            const btnNeonMatchColorToggle = document.getElementById('btn-neon-match-color-toggle');
            const btnNeonColorInput = document.getElementById('btn-neon-color-input');
            const uiOpacityInput = document.getElementById('ui-opacity-input');
            const saveSettingsBtn = document.getElementById('save-settings-btn');
            const resetSettingsBtn = document.getElementById('reset-settings-btn');
            
            // --- STATE & PRESET DATA ---
            let totalDuration, timeRemaining, startTime, targetEndTime;
            let isRunning = false, isPaused = false;
            let audioContext;
            let timerLoopId; // To hold the requestAnimationFrame ID

            const presetIcons = {
                default: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M495.9 166.6c3.2 8.7 .5 18.4-6.4 24.6l-43.3 39.4c1.1 8.3 1.7 16.8 1.7 25.4s-.6 17.1-1.7 25.4l43.3 39.4c6.9 6.2 9.6 15.9 6.4 24.6c-4.4 11.9-15.7 20-28.1 20h-86.9c-3.5-10.1-8-19.6-13.3-28.5l-26.4 45.8c-6.2 10.7-18.2 17.2-30.8 17.2s-24.6-6.5-30.8-17.2l-26.4-45.8c-5.3 8.9-10.8 18.4-13.3 28.5H32.4c-12.4 0-23.7-8.1-28.1-20c-3.2-8.7-.5-18.4 6.4-24.6l43.3-39.4C52.6 273.1 52 264.6 52 256s.6-17.1 1.7-25.4L10.4 191.2c-6.9-6.2-9.6-15.9-6.4-24.6C8.4 154.7 19.7 146.6 32.1 146.6h86.9c3.5 10.1 8 19.6 13.3 28.5l26.4-45.8c6.2-10.7 18.2-17.2 30.8-17.2s-24.6 6.5 30.8 17.2l26.4 45.8c5.3-8.9 10.8-18.4 13.3-28.5h86.9c12.4 0 23.7 8.1 28.1 20zM256 336a80 80 0 1 0 0-160 80 80 0 1 0 0 160z"/></svg>',
                star: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><path fill="currentColor" d="M316.9 18C311.6 7 300.4 0 288.1 0s-23.4 7-28.8 18L195 150.3 51.4 171.5c-12 1.8-22 10.2-25.7 21.7s-.7 24.2 7.9 32.7L137.8 329 113.2 474.7c-2 12 3 24.2 12.9 31.3s23 8 33.8 2.3l128.3-68.5 128.3 68.5c10.8 5.7 23.9 4.9 33.8-2.3s14.9-19.3 12.9-31.3L438.5 329 542.7 225.9c8.6-8.5 11.7-21.2 7.9-32.7s-13.7-19.9-25.7-21.7L381.2 150.3 316.9 18z"/></svg>',
                heart: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M47.6 300.4L228.3 469.1c7.5 7 17.4 10.9 27.7 10.9s20.2-3.9 27.7-10.9L464.4 300.4c30.4-28.3 47.6-68 47.6-109.5v-5.8c0-69.9-50.5-129.5-119.4-141C347 36.5 300.6 51.4 268 84L256 96 244 84c-32.6-32.6-79-47.5-124.6-39.9C50.5 55.6 0 115.2 0 185.1v5.8c0 41.5 17.2 81.2 47.6 109.5z"/></svg>',
                wrench: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M148.4 69.3c-10.2-10.2-23.8-15.6-38.2-15.6s-28 5.4-38.2 15.6L15.6 125.7c-10.2 10.2-15.6 23.8-15.6 38.2s5.4 28 15.6 38.2l99.3 99.3-39.5 39.5-32-32c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l64 64c12.5 12.5 32.8 12.5 45.3 0l32-32 39.5-39.5 99.3 99.3c10.2 10.2 23.8 15.6 38.2 15.6s28-5.4 38.2-15.6l56.4-56.4c-10.2-10.2-15.6-23.8-15.6-38.2s-5.4-28-15.6-38.2L329.8 247.4l68-68c10.2-10.2 15.6-23.8 15.6-38.2s-5.4-28-15.6-38.2l-56.4-56.4c-10.2-10.2-23.8-15.6-38.2-15.6s-28 5.4-38.2 15.6l-68 68L148.4 69.3z"/></svg>',
                sliders: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M368 128h-8v-24c0-13.3-10.7-24-24-24s-24 10.7-24 24v24h-8c-13.3 0-24 10.7-24 24s10.7 24 24 24h8v264c0 13.3 10.7 24 24 24s24-10.7 24-24V176h8c13.3 0 24-10.7 24-24s-10.7-24-24-24zm-96 232h-8V24c0-13.3-10.7-24-24-24S216 10.7 216 24v336h-8c-13.3 0-24 10.7-24 24s10.7 24 24 24h64c13.3 0 24-10.7 24-24s-10.7-24-24-24zm-96-64h-8V152c0-13.3-10.7-24-24-24s-24 10.7-24 24v144h-8c-13.3 0-24 10.7-24 24s10.7 24 24 24h64c13.3 0 24-10.7 24-24s-10.7-24-24-24z"/></svg>',
                ellipsis: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M328 256c0 39.8-32.2 72-72 72s-72-32.2-72-72 32.2-72 72-72 72 32.2 72 72zm104-72c-39.8 0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72zm-352 0c-39.8 0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72z"/></svg>',
                info: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M256 512A256 256 0 1 0 256 0a256 256 0 1 0 0 512zM216 336h24V272H216c-13.3 0-24-10.7-24-24s10.7-24 24-24h48c13.3 0 24 10.7 24 24v88h8c13.3 0 24 10.7 24 24s-10.7 24-24 24H216c-13.3 0-24-10.7-24-24s10.7-24 24-24zm40-144a32 32 0 1 1 0-64 32 32 0 1 1 0 64z"/></svg>',
                menu: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M0 96C0 78.3 14.3 64 32 64H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32C14.3 128 0 113.7 0 96zM0 256c0-17.7 14.3-32 32-32H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32c-17.7 0-32-14.3-32-32zM448 416c0 17.7-14.3 32-32 32H32c-17.7 0-32-14.3-32-32s14.3-32 32-32H416c17.7 0 32 14.3 32 32z"/></svg>'
            };

            // --- HELPER FUNCTIONS ---
            const vibrateDevice = () => {
                if ('vibrate' in navigator) {
                    // Strong but brief vibration pattern: short-strong-short
                    navigator.vibrate([200, 50, 300]);
                }
            };
            
            const toggleButtons = (showSetTime, showPause, showResume, showRepeat, showEnd) => {
                // Batch DOM updates for better performance
                requestAnimationFrame(() => {
                    setTimeBtn.classList.toggle('hidden', !showSetTime);
                    pauseBtn.classList.toggle('hidden', !showPause);
                    resumeBtn.classList.toggle('hidden', !showResume);
                    repeatBtn.classList.toggle('hidden', !showRepeat);
                    endBtn.classList.toggle('hidden', !showEnd);
                    
                    // Add class when only repeat button is visible
                    const onlyRepeatVisible = !showSetTime && !showPause && !showResume && showRepeat && !showEnd;
                    timerWrapper.classList.toggle('only-repeat-visible', onlyRepeatVisible);
                });
            };

            // --- TIMER LOGIC ---
            let lastTextUpdate = 0;
            const TEXT_UPDATE_INTERVAL = 100; // Update text every 100ms (10fps) instead of 60fps
            
            const updateDisplay = (percentage) => {
                if (percentage < 0) percentage = 0;
                if (percentage > 100) percentage = 100;

                // Throttle text updates to prevent flickering during fast movement
                const now = performance.now();
                if (now - lastTextUpdate >= TEXT_UPDATE_INTERVAL) {
                mainNumbers.textContent = `${percentage.toFixed(2)}%`;
                    lastTextUpdate = now;
                }
                
                // Always update progress bar width for smooth animation
                // Only disable transitions if they're currently enabled
                const currentTransition = progressBar.style.transition;
                if (currentTransition && currentTransition !== 'none') {
                progressBar.style.transition = 'none';
                }
                
                progressBar.style.width = `${percentage}%`;
            };
            
            let lastTick = performance.now();
            const durationLoop = (now) => {
                if (!isRunning || isPaused) return;

                const delta = now - lastTick;
                lastTick = now;
                timeRemaining -= delta;

                if (timeRemaining <= 0) {
                    timeRemaining = 0;
                    isRunning = false;
                    timerWrapper.classList.add('timer-paused');
                    playAlarm();
                    vibrateDevice();
                    toggleButtons(false, false, false, true, false); // show repeat
                    // Force final text update when timer completes
                    lastTextUpdate = 0;
                }
                
                const elapsedTime = totalDuration - timeRemaining;
                const percentage = totalDuration > 0 ? (elapsedTime / totalDuration) * 100 : 0;
                updateDisplay(percentage);

                if (isRunning) {
                   timerLoopId = requestAnimationFrame(durationLoop);
                }
            };

            const endTimeLoop = () => {
                if (!isRunning) return;

                const now = Date.now();
                const elapsedTime = now - startTime;
                let percentage = totalDuration > 0 ? (elapsedTime / totalDuration) * 100 : 0;

                if (now >= targetEndTime) {
                    percentage = 100;
                    isRunning = false;
                    timerWrapper.classList.add('timer-paused');
                    playAlarm();
                    vibrateDevice();
                    toggleButtons(false, false, false, true, false);
                    // Force final text update when timer completes
                    lastTextUpdate = 0;
                }
                
                updateDisplay(percentage);

                if (isRunning) {
                    timerLoopId = requestAnimationFrame(endTimeLoop);
                }
            };

            const startTimer = () => {
                if (isRunning) return;
                
                // Prevent starting if countdown is active
                if (document.body.classList.contains('countdown-active')) {
                    return;
                }
                
                // Check if duration is 0 and prevent starting
                const mode = timerModeSelect.value;
                if (mode === 'duration') {
                    const hours = parseInt(durationHoursInput.value) || 0;
                    const minutes = parseInt(durationMinutesInput.value) || 0;
                    const seconds = parseInt(durationSecondsInput.value) || 0;
                    const totalSeconds = hours * 3600 + minutes * 60 + seconds;
                    
                    if (totalSeconds === 0) {
                        // Don't start timer if duration is 0
                        return;
                    }
                }
                
                
                // Reset timer to initialize variables
                resetTimer();
                
                timerWrapper.classList.remove('timer-paused', 'timer-running');
                if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                isRunning = true;
                isPaused = false;

                if (mode === 'duration') {
                    lastTick = performance.now();
                    timerLoopId = requestAnimationFrame(durationLoop);
                    toggleButtons(false, false, false, false, false); 
                } else { // endTime
                    startTime = Date.now();
                    // totalDuration and targetEndTime are set in resetTimer
                    timerLoopId = requestAnimationFrame(endTimeLoop);
                    toggleButtons(false, false, false, false, false); // No pause in endTime mode
                }
            };

            const stopTimer = () => {
                isRunning = false;
                if (timerLoopId) {
                    cancelAnimationFrame(timerLoopId);
                }
                // Force final text update when timer stops
                lastTextUpdate = 0; // Reset throttling to ensure immediate update
                // Re-enable transitions when timer stops
                progressBar.style.transition = 'width 0.3s cubic-bezier(0.4, 0, 0.2, 1), background 0.3s ease, box-shadow 0.3s ease';
            }

            const pauseTimer = () => {
                if (!isRunning || isPaused) return;
                isPaused = true;
                timerWrapper.classList.remove('timer-running');
                timerWrapper.classList.add('timer-paused');
                toggleButtons(false, false, true, true, true); 
                setTimeout(updateUIPositions, 0);
            };

            const resumeTimer = () => {
                if (!isPaused) return;
                isPaused = false;
                timerWrapper.classList.remove('timer-paused');
                timerWrapper.classList.add('timer-running');
                lastTick = performance.now();
                timerLoopId = requestAnimationFrame(durationLoop);
                toggleButtons(false, false, false, false, false);
                setTimeout(updateUIPositions, 0);
            };

            const resetTimer = () => {
                stopTimer();
                timerWrapper.classList.remove('timer-paused', 'timer-running');
                
                const mode = timerModeSelect.value;
                if (mode === 'duration') {
                    const hours = parseInt(durationHoursInput.value) || 0;
                    const minutes = parseInt(durationMinutesInput.value) || 0;
                    const seconds = parseInt(durationSecondsInput.value) || 0;
                    totalDuration = (hours * 3600 + minutes * 60 + seconds) * 1000;
                    timeRemaining = totalDuration;
                } else { // endTime
                    const hour12 = parseInt(endTimeHourInput.value);
                    const minute = parseInt(endTimeMinuteInput.value);
                    const isPM = endTimeAmPmInput.value === 'PM';

                    let hour24 = hour12;
                    if (isPM && hour12 < 12) {
                        hour24 += 12; // 1pm becomes 13, etc.
                    } else if (!isPM && hour12 === 12) {
                        hour24 = 0; // 12am becomes 0
                    }
                    
                    const now = new Date();
                    const targetDate = new Date();
                    targetDate.setHours(hour24, minute, 0, 0);

                    if (targetDate < now) { // If time has passed for today, set for tomorrow
                        targetDate.setDate(targetDate.getDate() + 1);
                    }
                    
                    targetEndTime = targetDate.getTime();
                    const currentTime = Date.now();
                    totalDuration = targetEndTime - currentTime;
                    timeRemaining = totalDuration;
                }
                
                updateDisplay(0);
                toggleButtons(true, false, false, false, false); 
            };

            // --- ALARM SOUND ---
            // playAlarm function already declared above with alarm selection system
            // --- TIMER POPUP FUNCTIONS ---
            const fitTimerPopupToViewport = () => {
                if (!timerPopup) return;
                // Reset scale to measure natural size
                document.documentElement.style.setProperty('--popup-scale', '1');
                // Measure available viewport area with safe padding
                const vh = window.innerHeight;
                const vw = window.innerWidth;
                const safePadding = 24; // space around popup
                const availableH = Math.max(200, vh - safePadding * 2);
                const availableW = Math.max(240, vw - safePadding * 2);
                // Measure natural popup size
                const rect = timerPopup.getBoundingClientRect();
                const content = document.getElementById('timer-popup-content');
                const contentRect = content ? content.getBoundingClientRect() : rect;
                const naturalH = Math.max(rect.height, contentRect.height + 0);
                const naturalW = Math.max(rect.width, contentRect.width + 0);
                // Compute scale so it fits both width and height
                let scale = Math.min(1, availableW / naturalW, availableH / naturalH);
                // Clamp to avoid too tiny UI
                scale = Math.max(0.6, scale);
                document.documentElement.style.setProperty('--popup-scale', String(scale));
            };

            const openTimerPopup = () => {
                // Sync popup values with main timer settings
                popupTimerModeSelect.value = timerModeSelect.value;
                popupDurationHoursInput.value = durationHoursInput.value;
                popupDurationMinutesInput.value = durationMinutesInput.value;
                
                // Update popup mode display
                updatePopupMode();
                
                // Auto-detect current time for end time option (after updatePopupMode)
                const now = new Date();
                const currentHour = now.getHours();
                const currentMinute = now.getMinutes();
                
                // Convert to 12-hour format
                let displayHour = currentHour;
                let amPm = 'AM';
                
                if (currentHour === 0) {
                    displayHour = 12;
                } else if (currentHour < 12) {
                    displayHour = currentHour;
                    amPm = 'AM';
                } else if (currentHour === 12) {
                    displayHour = 12;
                    amPm = 'PM';
                } else {
                    displayHour = currentHour - 12;
                    amPm = 'PM';
                }
                
                // Set current time in popup end time fields (override populateEndTimeOptions)
                // Use setTimeout to ensure DOM is ready
                setTimeout(() => {
                    popupEndTimeHourInput.value = displayHour;
                    popupEndTimeMinuteInput.value = currentMinute.toString().padStart(2, '0');
                    popupEndTimeAmPmInput.value = amPm;
                }, 10);
                
                // Update start button state
                updateStartButtonState();
                
                // Show popup
                timerPopupOverlay.classList.add('visible');
                document.body.classList.add('popup-open');
                document.body.classList.add('timer-popup-open');
                // Fit to viewport on open
                fitTimerPopupToViewport();
                // Refine after next frame when layout settles
                requestAnimationFrame(fitTimerPopupToViewport);
                // Auto-size selects
                autosizePopupSelects();
                requestAnimationFrame(autosizePopupSelects);
            };

            const closeTimerPopup = (e) => {
                if (e) e.stopPropagation(); // Prevent event bubbling if called from button
                timerPopupOverlay.classList.remove('visible');
                document.body.classList.remove('popup-open');
                document.body.classList.remove('timer-popup-open');
            };

            // Re-fit on resize/orientation changes
            window.addEventListener('resize', fitTimerPopupToViewport, { passive: true });
            window.addEventListener('orientationchange', () => setTimeout(fitTimerPopupToViewport, 50));
            window.addEventListener('resize', autosizePopupSelects, { passive: true });
            window.addEventListener('orientationchange', () => setTimeout(autosizePopupSelects, 50));

            // Re-size when value changes
            popupTimerModeSelect?.addEventListener('change', autosizePopupSelects);
            popupStartDelaySelect?.addEventListener('change', autosizePopupSelects);

            const updatePopupMode = () => {
                const isDurationMode = popupTimerModeSelect.value === 'duration';
                popupDurationSettings.classList.toggle('hidden', !isDurationMode);
                popupEndtimeSettings.classList.toggle('hidden', isDurationMode);
                
                if (!isDurationMode) {
                    populateEndTimeOptions();
                }
                
                // Update start button state
                updateStartButtonState();
            };

            const updateStartButtonState = () => {
                if (popupTimerModeSelect.value === 'duration') {
                    const hours = parseInt(popupDurationHoursInput.value) || 0;
                    const minutes = parseInt(popupDurationMinutesInput.value) || 0;
                    const seconds = parseInt(popupDurationSecondsInput.value) || 0;
                    const totalSeconds = hours * 3600 + minutes * 60 + seconds;
                    
                    popupStartBtn.disabled = totalSeconds === 0;
                } else {
                    // End time mode - always enabled
                    popupStartBtn.disabled = false;
                }
            };

            const populateEndTimeOptions = () => {
                // Populate hour options (1-12)
                popupEndTimeHourInput.innerHTML = '';
                for (let i = 1; i <= 12; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = i;
                    popupEndTimeHourInput.appendChild(option);
                }

                // Populate minute options (00-59)
                popupEndTimeMinuteInput.innerHTML = '';
                for (let i = 0; i < 60; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = i.toString().padStart(2, '0');
                    popupEndTimeMinuteInput.appendChild(option);
                }

                // Set current time as default
                const now = new Date();
                const currentHour = now.getHours();
                const currentMinute = now.getMinutes();
                
                if (currentHour === 0) {
                    popupEndTimeHourInput.value = 12;
                    popupEndTimeAmPmInput.value = 'AM';
                } else if (currentHour < 12) {
                    popupEndTimeHourInput.value = currentHour;
                    popupEndTimeAmPmInput.value = 'AM';
                } else if (currentHour === 12) {
                    popupEndTimeHourInput.value = 12;
                    popupEndTimeAmPmInput.value = 'PM';
                } else {
                    popupEndTimeHourInput.value = currentHour - 12;
                    popupEndTimeAmPmInput.value = 'PM';
                }
                
                popupEndTimeMinuteInput.value = currentMinute.toString().padStart(2, '0');
            };

            // Multiple alarm sound functions with reduced volume
            const createAlarmBeep1 = () => {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.08, audioContext.currentTime); // Reduced volume
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.3);
            };
            const createAlarmBeep2 = () => {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                // Two-tone alarm
                oscillator.frequency.setValueAtTime(600, audioContext.currentTime);
                oscillator.frequency.setValueAtTime(800, audioContext.currentTime + 0.15);
                oscillator.type = 'square';
                
                gainNode.gain.setValueAtTime(0.08, audioContext.currentTime); // Reduced volume
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.3);
            };

            const createAlarmBeep3 = () => {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                // Rising tone alarm
                oscillator.frequency.setValueAtTime(400, audioContext.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(1000, audioContext.currentTime + 0.4);
                oscillator.type = 'triangle';
                
                gainNode.gain.setValueAtTime(0.08, audioContext.currentTime); // Reduced volume
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.4);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.4);
            };

            const createAlarmBeep4 = () => {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                // Chime-like alarm
                oscillator.frequency.setValueAtTime(523, audioContext.currentTime); // C5
                oscillator.frequency.setValueAtTime(659, audioContext.currentTime + 0.1); // E5
                oscillator.frequency.setValueAtTime(784, audioContext.currentTime + 0.2); // G5
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.08, audioContext.currentTime); // Reduced volume
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.3);
            };
            const createAlarmBeep5 = () => {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                // Electronic beep pattern
                oscillator.frequency.setValueAtTime(1000, audioContext.currentTime);
                oscillator.frequency.setValueAtTime(500, audioContext.currentTime + 0.1);
                oscillator.frequency.setValueAtTime(1000, audioContext.currentTime + 0.2);
                oscillator.type = 'sawtooth';
                
                gainNode.gain.setValueAtTime(0.08, audioContext.currentTime); // Reduced volume
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.3);
            };

            // Alarm selection array
            const alarmSounds = [
                createAlarmBeep1,
                createAlarmBeep2,
                createAlarmBeep3,
                createAlarmBeep4,
                createAlarmBeep5
            ];

            // Current alarm selection (default to first alarm)
            let currentAlarmIndex = 0;

            // Countdown beep function
            const createCountdownBeep = (frequency = 1000, duration = 150) => {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                // Clean, crisp beep sound
                oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
                oscillator.type = 'triangle'; // Clean, soft sound
                
                gainNode.gain.setValueAtTime(0.08, audioContext.currentTime); // Reduced volume
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration / 1000);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + duration / 1000);
            };

            // Function to play the selected alarm
            const playAlarm = () => {
                if (currentAlarmIndex >= 0) {
                alarmSounds[currentAlarmIndex]();
                }
            };

            // Alarm selection event listener
            alarmSoundSelect.addEventListener('change', (e) => {
                if (e.target.value === 'none') {
                    currentAlarmIndex = -1; // Special value for no alarm
                } else {
                currentAlarmIndex = parseInt(e.target.value);
                }
            });

            // Sound system variables
            let currentCountdownSound = 'beep';
            let currentUISound = 'none';

            // Sound creation functions
            const createSound = (type, frequency = 800, duration = 100, volume = 0.1) => {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
                oscillator.type = 'triangle';
                
                gainNode.gain.setValueAtTime(volume, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration / 1000);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + duration / 1000);
            };

            const playCountdownSound = () => {
                if (currentCountdownSound === 'none') return;
                
                switch (currentCountdownSound) {
                    case 'beep': createSound('beep', 600, 150, 0.08); break;
                    case 'tick': createSound('tick', 1000, 50, 0.05); break;
                    case 'chime': createSound('chime', 800, 200, 0.06); break;
                    case 'digital': createSound('digital', 1200, 100, 0.07); break;
                }
            };

            const playUISound = () => {
                if (currentUISound === 'none') return;
                
                switch (currentUISound) {
                    case 'click': createSound('click', 800, 50, 0.06); break;
                    case 'tap': createSound('tap', 1000, 30, 0.05); break;
                    case 'beep': createSound('beep', 600, 80, 0.07); break;
                    case 'chime': createSound('chime', 900, 100, 0.06); break;
                }
            };

            // Event listeners for sound controls
            countdownSoundSelect.addEventListener('change', (e) => {
                currentCountdownSound = e.target.value;
            });

            uiSoundSelect.addEventListener('change', (e) => {
                currentUISound = e.target.value;
            });

            const startCountdown = (seconds, callback) => {
                if (seconds <= 0) {
                    countdownDisplay.classList.add('hidden');
                    document.body.classList.remove('countdown-active'); // Re-enable interactions
                    callback();
                    return;
                }
                
                // Disable interactions during countdown
                document.body.classList.add('countdown-active');
                
                countdownDisplay.classList.remove('hidden');
                countdownNumber.textContent = seconds;
                
                // Play countdown sound
                playCountdownSound();
                
                // Use requestAnimationFrame for smoother timing
                const countdownTimer = () => {
                    setTimeout(() => {
                        startCountdown(seconds - 1, callback);
                    }, 1000);
                };
                
                requestAnimationFrame(countdownTimer);
            };
            const startTimerFromPopup = (e) => {
                // Prevent event bubbling to avoid overlay click
                e.stopPropagation();
                
                // Prevent starting if countdown is active
                if (document.body.classList.contains('countdown-active')) {
                    return;
                }
                
                // Validate duration before starting
                if (popupTimerModeSelect.value === 'duration') {
                    const hours = parseInt(popupDurationHoursInput.value) || 0;
                    const minutes = parseInt(popupDurationMinutesInput.value) || 0;
                    const seconds = parseInt(popupDurationSecondsInput.value) || 0;
                    const totalSeconds = hours * 3600 + minutes * 60 + seconds;
                    
                    if (totalSeconds === 0) {
                        // Don't start timer if duration is 0
                        alert('Please set a duration greater than 0 seconds.');
                        return;
                    }
                }
                
                
                // Sync popup values back to main timer settings
                timerModeSelect.value = popupTimerModeSelect.value;
                durationHoursInput.value = popupDurationHoursInput.value;
                durationMinutesInput.value = popupDurationMinutesInput.value;
                durationSecondsInput.value = popupDurationSecondsInput.value;
                
                if (popupTimerModeSelect.value === 'endTime') {
                    endTimeHourInput.value = popupEndTimeHourInput.value;
                    endTimeMinuteInput.value = popupEndTimeMinuteInput.value;
                    endTimeAmPmInput.value = popupEndTimeAmPmInput.value;
                }
                
                // Close popup
                closeTimerPopup();
                
                // Add small delay to ensure popup is fully closed before starting timer
                setTimeout(() => {
                    // Always hard reset before starting to guarantee restart
                    resetTimer();
                    // Check if duration mode and delay is set
                    if (popupTimerModeSelect.value === 'duration') {
                        const delaySeconds = parseInt(popupStartDelaySelect.value) || 0;
                        if (delaySeconds > 0) {
                            startCountdown(delaySeconds, startTimer);
                        } else {
                    startTimer();
                        }
                    } else {
                        // End time mode - no delay
                        startTimer();
                    }
                }, 100);
            };

            // --- EVENT LISTENERS ---
            setTimeBtn.addEventListener('click', () => {
                playUISound();
                openTimerPopup();
            });
            quickSetBtn.addEventListener('click', () => {
                playUISound();
                openTimerPopup();
            });
            pauseBtn.addEventListener('click', () => {
                playUISound();
                pauseTimer();
            });
            resumeBtn.addEventListener('click', () => {
                playUISound();
                resumeTimer();
            });
            repeatBtn.addEventListener('click', () => { 
                playUISound();
                // Disable transition temporarily for instant reset
                progressBar.style.transition = 'none';
                timerWrapper.classList.add('no-transition');
                resetTimer(); 
                
                // Re-enable transition after a brief delay
                setTimeout(() => {
                    progressBar.style.transition = 'width 0.3s cubic-bezier(0.4, 0, 0.2, 1), background 0.3s ease, box-shadow 0.3s ease';
                    timerWrapper.classList.remove('no-transition');
                }, 50);
                
                startTimer(); 
            });
            
            const endTimer = () => {
                stopTimer();
                timerWrapper.classList.remove('timer-running');
                timerWrapper.classList.add('timer-paused'); // Show alarm_add icon when ended
                
                // Disable transition temporarily for instant fill
                progressBar.style.transition = 'none';
                updateDisplay(100); // Instantly fill the bar
                
                // Re-enable transition after a brief delay
                setTimeout(() => {
                    progressBar.style.transition = 'width 0.3s cubic-bezier(0.4, 0, 0.2, 1), background 0.3s ease, box-shadow 0.3s ease';
                }, 50);
                
                playAlarm();
                vibrateDevice();
                toggleButtons(false, false, false, true, false); // Show only repeat button
            };
            
            endBtn.addEventListener('click', () => {
                playUISound();
                endTimer();
            });
            
            // --- KEYBOARD NAVIGATION & ACCESSIBILITY ---
            document.addEventListener('keydown', (e) => {
                // Ignore if typing in inputs or UI overlays are open
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') return;
                if (document.body.classList.contains('timer-popup-open') || document.body.classList.contains('settings-open')) return;
                if (e.repeat) return; // avoid auto-repeat
                
                switch(e.key) {
                    case 'Escape':
                        e.preventDefault();
                        if (isRunning) {
                            endTimer();
                        }
                        break;
                    case 'r':
                    case 'R':
                        e.preventDefault();
                        if (isRunning) {
                            repeatBtn.click();
                        }
                        break;
                    case 'Tab':
                        // Ensure proper tab order for accessibility
                        const focusableElements = document.querySelectorAll('button, input, select, textarea, [tabindex]:not([tabindex="-1"])');
                        const firstElement = focusableElements[0];
                        const lastElement = focusableElements[focusableElements.length - 1];
                        
                        if (e.shiftKey && document.activeElement === firstElement) {
                            e.preventDefault();
                            lastElement.focus();
                        } else if (!e.shiftKey && document.activeElement === lastElement) {
                            e.preventDefault();
                            firstElement.focus();
                        }
                        break;
                }
            });
            
            // Add ARIA labels and roles for screen readers
            const addAccessibilityAttributes = () => {
                // Main timer display
                const mainNumbers = document.querySelector('.main-numbers');
                if (mainNumbers) {
                    mainNumbers.setAttribute('role', 'status');
                    mainNumbers.setAttribute('aria-live', 'polite');
                    mainNumbers.setAttribute('aria-label', 'Timer progress percentage');
                }
                
                // Progress bar
                const progressBar = document.querySelector('.progress-bar');
                if (progressBar) {
                    progressBar.setAttribute('role', 'progressbar');
                    progressBar.setAttribute('aria-valuemin', '0');
                    progressBar.setAttribute('aria-valuemax', '100');
                    progressBar.setAttribute('aria-label', 'Timer progress');
                }
                
                // Buttons
                setTimeBtn.setAttribute('aria-label', 'Set timer duration');
                pauseBtn.setAttribute('aria-label', 'Pause timer');
                resumeBtn.setAttribute('aria-label', 'Resume timer');
                repeatBtn.setAttribute('aria-label', 'Repeat timer');
                endBtn.setAttribute('aria-label', 'End timer');
                
                // Particle canvas
                const particlesCanvas = document.getElementById('particles-canvas');
                if (particlesCanvas) {
                    particlesCanvas.setAttribute('aria-hidden', 'true');
                    particlesCanvas.setAttribute('role', 'presentation');
                }
            };
            
            // Initialize accessibility attributes
            addAccessibilityAttributes();
            
            // Timer popup event listeners
            popupTimerModeSelect.addEventListener('change', updatePopupMode);
            popupStartBtn.addEventListener('click', (e) => {
                playUISound();
                startTimerFromPopup(e);
            });
            popupCancelBtn.addEventListener('click', (e) => {
                playUISound();
                closeTimerPopup(e);
            });
            
            // Close popup when clicking overlay
            timerPopupOverlay.addEventListener('click', (e) => {
                if (e.target === timerPopupOverlay) {
                    closeTimerPopup(e);
                }
            });
            
            // Input validation for popup duration inputs
            popupDurationHoursInput.addEventListener('input', (e) => { 
                e.target.value = e.target.value.replace(/[^0-9]/g, ''); 
                updateStartButtonState();
            });
            popupDurationMinutesInput.addEventListener('input', (e) => { 
                e.target.value = e.target.value.replace(/[^0-9]/g, ''); 
                updateStartButtonState();
            });
            popupDurationSecondsInput.addEventListener('input', (e) => { 
                e.target.value = e.target.value.replace(/[^0-9]/g, ''); 
                updateStartButtonState();
            });
            
            const enforceMinMaxPopup = (e) => {
                const min = parseInt(e.target.min);
                const max = parseInt(e.target.max);
                let value = parseInt(e.target.value);
                if (isNaN(value)) value = min;
                if (value < min) value = min;
                if (value > max) value = max;
                e.target.value = value;
            };
            
            popupDurationHoursInput.addEventListener('blur', enforceMinMaxPopup);
            popupDurationMinutesInput.addEventListener('blur', enforceMinMaxPopup);
            popupDurationSecondsInput.addEventListener('blur', enforceMinMaxPopup);
            
            timerModeSelect.addEventListener('change', () => {
                const isDurationMode = timerModeSelect.value === 'duration';
                durationSettings.classList.toggle('hidden', !isDurationMode);
                endtimeSettings.classList.toggle('hidden', isDurationMode);
                resetTimer();
            });

            const enforceMinMax = (e) => {
                const min = parseInt(e.target.min);
                const max = parseInt(e.target.max);
                let value = parseInt(e.target.value);
                if (isNaN(value)) value = min;
                if (value < min) e.target.value = min;
                if (value > max) e.target.value = max;
            };

            // Custom start button functionality
            const customStartBtn = document.getElementById('custom-start-btn');
            const updateCustomStartButtonState = () => {
                const hours = parseInt(durationHoursInput.value) || 0;
                const minutes = parseInt(durationMinutesInput.value) || 0;
                const seconds = parseInt(durationSecondsInput.value) || 0;
                const totalSeconds = hours * 3600 + minutes * 60 + seconds;
                
                customStartBtn.disabled = totalSeconds === 0;
                
                // Add/remove has-time class for green background
                if (totalSeconds > 0) {
                    customStartBtn.classList.add('has-time');
                } else {
                    customStartBtn.classList.remove('has-time');
                }
            };

            durationHoursInput.addEventListener('input', (e) => { e.target.value = e.target.value.replace(/[^0-9]/g, ''); });
            durationHoursInput.addEventListener('change', updateCustomStartButtonState); // No reset, just update button state
            durationHoursInput.addEventListener('blur', enforceMinMax); // Correct value when user leaves the box
            durationMinutesInput.addEventListener('input', (e) => { e.target.value = e.target.value.replace(/[^0-9]/g, ''); });
            durationMinutesInput.addEventListener('change', updateCustomStartButtonState); // No reset, just update button state
            durationMinutesInput.addEventListener('blur', enforceMinMax); // Correct value when user leaves the box
            durationSecondsInput.addEventListener('input', (e) => { e.target.value = e.target.value.replace(/[^0-9]/g, ''); });
            durationSecondsInput.addEventListener('change', updateCustomStartButtonState); // No reset, just update button state
            durationSecondsInput.addEventListener('blur', enforceMinMax); // Correct value when user leaves the box

            const startTimerFromCustom = () => {
                // Prevent starting if countdown is active
                if (document.body.classList.contains('countdown-active')) {
                    return;
                }
                
                const hours = parseInt(durationHoursInput.value) || 0;
                const minutes = parseInt(durationMinutesInput.value) || 0;
                const seconds = parseInt(durationSecondsInput.value) || 0;
                const totalSeconds = hours * 3600 + minutes * 60 + seconds;
                
                if (totalSeconds === 0) return;
                
                // Get delay from dropdown
                const delaySeconds = parseInt(document.getElementById('custom-start-delay').value) || 0;
                
                // Reset timer and set new duration
                resetTimer();
                totalDuration = totalSeconds;
                timeRemaining = totalSeconds;
                
                // Start with delay if specified
                if (delaySeconds > 0) {
                    startCountdown(delaySeconds, startTimer);
                } else {
                    startTimer();
                }
            };

            // Update button state when duration inputs change
            durationHoursInput.addEventListener('input', updateCustomStartButtonState);
            durationMinutesInput.addEventListener('input', updateCustomStartButtonState);
            durationSecondsInput.addEventListener('input', updateCustomStartButtonState);
            
            // Add click event listener
            customStartBtn.addEventListener('click', startTimerFromCustom);
            
            // Initial button state
            updateCustomStartButtonState();
            // Wheel picker functionality
            class WheelPicker {
                constructor(element, targetInput) {
                    this.element = element;
                    this.targetInput = targetInput;
                    this.container = element.querySelector('.wheel-container');
                    this.items = element.querySelectorAll('.wheel-item');
                    this.currentIndex = 0;
                    this.isDragging = false;
                    this.startY = 0;
                    this.currentY = 0;
                    this.velocity = 0;
                    this.lastY = 0;
                    this.lastTime = 0;
                    this.lastWheelTime = 0; // For wheel throttling
                    this.wheelAccumulator = 0; // Accumulate wheel delta for smooth scrolling
                    this.wheelThreshold = 60; // Threshold for wheel action (lower = more sensitive)
                    
                    this.init();
                }
                
                init() {
                    // Set initial value
                    this.setValue(parseInt(this.targetInput.value) || 0);
                    
                    // Add event listeners
                    this.element.addEventListener('mousedown', this.handleStart.bind(this));
                    this.element.addEventListener('touchstart', this.handleStart.bind(this));
                    this.element.addEventListener('wheel', this.handleWheel.bind(this));
                    document.addEventListener('mousemove', this.handleMove.bind(this));
                    document.addEventListener('touchmove', this.handleMove.bind(this));
                    document.addEventListener('mouseup', this.handleEnd.bind(this));
                    document.addEventListener('touchend', this.handleEnd.bind(this));
                    
                    // Click to select
                    this.items.forEach((item, index) => {
                        item.addEventListener('click', () => {
                            // Add haptic feedback
                            if (navigator.vibrate) {
                                navigator.vibrate(5);
                            }
                            this.setValue(parseInt(item.dataset.value));
                        });
                    });
                }
                handleWheel(e) {
                    e.preventDefault();
                    
                    // Accumulate wheel delta for smooth scrolling wheels
                    this.wheelAccumulator += e.deltaY;
                    
                    // Check if we've reached the threshold
                    if (Math.abs(this.wheelAccumulator) >= this.wheelThreshold) {
                        // Determine direction
                        const direction = this.wheelAccumulator > 0 ? 1 : -1;
                        
                        // Get current value and calculate new value
                        const currentValue = parseInt(this.targetInput.value) || 0;
                        const newValue = Math.max(0, Math.min(currentValue + direction, this.items.length - 1));
                        
                        // Only update if value actually changed
                        if (newValue !== currentValue) {
                            this.setValue(newValue);
                            
                            // Add haptic feedback for wheel
                            if (navigator.vibrate) {
                                navigator.vibrate(3);
                            }
                        }
                        
                        // Reset accumulator
                        this.wheelAccumulator = 0;
                    }
                }
                
                handleStart(e) {
                    this.isDragging = true;
                    this.startY = e.type === 'mousedown' ? e.clientY : e.touches[0].clientY;
                    this.currentY = this.startY;
                    this.lastY = this.startY;
                    this.lastTime = Date.now();
                    this.velocity = 0;
                    e.preventDefault();
                }
                
                handleMove(e) {
                    if (!this.isDragging) return;
                    
                    const currentY = e.type === 'mousemove' ? e.clientY : e.touches[0].clientY;
                    const deltaY = (currentY - this.currentY) * 1.5; // Increased sensitivity multiplier
                    const currentTime = Date.now();
                    const deltaTime = currentTime - this.lastTime;
                    
                    if (deltaTime > 0) {
                        this.velocity = (currentY - this.lastY) / deltaTime * 2; // Increased velocity sensitivity
                    }
                    
                    this.currentY = currentY;
                    this.lastY = currentY;
                    this.lastTime = currentTime;
                    
                    // Move wheel with increased sensitivity
                    const currentTransform = this.getCurrentTransform();
                    const newTransform = currentTransform + deltaY;
                    this.container.style.transform = `translateY(${newTransform}px)`;
                    
                    e.preventDefault();
                }
                
                handleEnd(e) {
                    if (!this.isDragging) return;
                    
                    this.isDragging = false;
                    
                    // Apply momentum with better physics and higher sensitivity
                    const momentum = this.velocity * 500; // Increased from 300 to 500
                    const currentTransform = this.getCurrentTransform();
                    const targetTransform = currentTransform + momentum;
                    
                    // Snap to nearest item with easing
                    const itemHeight = 40;
                    const targetIndex = Math.round(-targetTransform / itemHeight);
                    const clampedIndex = Math.max(0, Math.min(targetIndex, this.items.length - 1));
                    
                    // Add haptic feedback
                    if (navigator.vibrate) {
                        navigator.vibrate(10);
                    }
                    
                    this.setValue(parseInt(this.items[clampedIndex].dataset.value));
                }
                
                getCurrentTransform() {
                    const transform = this.container.style.transform;
                    const match = transform.match(/translateY\(([^)]+)px\)/);
                    return match ? parseFloat(match[1]) : 0;
                }
                
                setValue(value) {
                    const itemHeight = 40;
                    const index = Math.max(0, Math.min(value, this.items.length - 1));
                    const transform = -index * itemHeight;
                    
                    this.container.style.transform = `translateY(${transform}px)`;
                    this.currentIndex = index;
                    
                    // Update selected item
                    this.items.forEach(item => item.classList.remove('selected'));
                    this.items[index].classList.add('selected');
                    
                    // Update visual fade effect for all items
                    this.updateFadeEffect();
                    
                    // Update target input
                    this.targetInput.value = value;
                    this.targetInput.dispatchEvent(new Event('input', { bubbles: true }));
                    this.targetInput.dispatchEvent(new Event('change', { bubbles: true }));
                }
                
                updateFadeEffect() {
                    const centerIndex = this.currentIndex;
                    
                    this.items.forEach((item, index) => {
                        const distance = Math.abs(index - centerIndex);
                        
                        // Medium fade: 0 distance = full size/opacity, 3+ distance = smallest/darkest
                        let scale = 1;
                        let opacity = 1;
                        
                        if (distance === 1) {
                            scale = 0.75;
                            opacity = 0.4;
                        } else if (distance === 2) {
                            scale = 0.6;
                            opacity = 0.25;
                        } else if (distance >= 3) {
                            scale = 0.5;
                            opacity = 0.15;
                        }
                        
                        item.style.transform = `scale(${scale})`;
                        item.style.opacity = opacity;
                    });
                }
            }
            
            // Initialize wheel pickers
            let hoursWheel, minutesWheel, secondsWheel, popupHoursWheel, popupMinutesWheel, popupSecondsWheel;
            
            try {
                hoursWheel = new WheelPicker(document.getElementById('hours-wheel'), durationHoursInput);
                minutesWheel = new WheelPicker(document.getElementById('minutes-wheel'), durationMinutesInput);
                secondsWheel = new WheelPicker(document.getElementById('seconds-wheel'), durationSecondsInput);
                
                popupHoursWheel = new WheelPicker(document.getElementById('popup-hours-wheel'), popupDurationHoursInput);
                popupMinutesWheel = new WheelPicker(document.getElementById('popup-minutes-wheel'), popupDurationMinutesInput);
                popupSecondsWheel = new WheelPicker(document.getElementById('popup-seconds-wheel'), popupDurationSecondsInput);
            } catch (error) {
                console.error('Wheel picker initialization error:', error);
            }

            // Reset buttons for wheel pickers
            const durationResetBtn = document.getElementById('duration-reset-btn');
            const popupDurationResetBtn = document.getElementById('popup-duration-reset-btn');

            // Reset button functionality for customization tab
            durationResetBtn?.addEventListener('click', () => {
                playUISound();
                if (hoursWheel) hoursWheel.setValue(0);
                if (minutesWheel) minutesWheel.setValue(0);
                if (secondsWheel) secondsWheel.setValue(0);
                durationHoursInput.value = 0;
                durationMinutesInput.value = 0;
                durationSecondsInput.value = 0;
            });

            // Reset button functionality for popup
            popupDurationResetBtn?.addEventListener('click', () => {
                playUISound();
                if (popupHoursWheel) popupHoursWheel.setValue(0);
                if (popupMinutesWheel) popupMinutesWheel.setValue(0);
                if (popupSecondsWheel) popupSecondsWheel.setValue(0);
                popupDurationHoursInput.value = 0;
                popupDurationMinutesInput.value = 0;
                popupDurationSecondsInput.value = 0;
            });

            // Custom spinner functionality
            function handleSpinnerClick(targetId, direction) {
                const input = document.getElementById(targetId);
                if (!input) return;
                
                const currentValue = parseInt(input.value) || 0;
                const min = parseInt(input.min) || 0;
                const max = parseInt(input.max) || 99;
                
                let newValue = currentValue + direction;
                newValue = Math.max(min, Math.min(max, newValue));
                
                input.value = newValue;
                input.dispatchEvent(new Event('input', { bubbles: true }));
                input.dispatchEvent(new Event('change', { bubbles: true }));
            }

            // Add event listeners to all spinner buttons
            document.querySelectorAll('.spinner-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    const targetId = btn.getAttribute('data-target');
                    const direction = btn.classList.contains('spinner-up') ? 1 : -1;
                    handleSpinnerClick(targetId, direction);
                });
            });
            endTimeHourInput.addEventListener('change', resetTimer);
            endTimeMinuteInput.addEventListener('change', resetTimer);
            endTimeAmPmInput.addEventListener('change', resetTimer);
            // Unified Space handler: works regardless of keyboard layout
            document.addEventListener('keydown', (e) => {
                const inForm = e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT' || e.target.tagName === 'TEXTAREA';
                if (inForm) return;
                if (e.repeat) return;
                if (document.body.classList.contains('timer-popup-open') || document.body.classList.contains('settings-open')) return;
                const isSpace = e.code === 'Space' || e.key === ' ' || e.key === 'Spacebar';
                if (!isSpace) return;
                    e.preventDefault();
                    if (!repeatBtn.classList.contains('hidden') && endBtn.classList.contains('hidden')) {
                        repeatBtn.click();
                } else if (!isRunning && !isPaused) startTimer();
                    else if (isPaused) resumeTimer();
                    else if (isRunning) pauseTimer();
            });

            document.body.addEventListener('click', (e) => {
                const isClickOnInteractiveUI = e.target.closest('#options-btn') || e.target.closest('#options-panel') || e.target.closest('#options-panel-overlay') || e.target.closest('#settings-management-external') || (e.target.tagName === 'BUTTON' && e.target.closest('#controls'));
                if (isClickOnInteractiveUI) return;

                // Don't start timer if popup is open
                if (document.body.classList.contains('timer-popup-open')) return;

                // When only Repeat button is visible, trigger it
                if (!repeatBtn.classList.contains('hidden') && endBtn.classList.contains('hidden')) {
                    repeatBtn.click();
                }
                // Normal timer controls
                else if (isRunning && !isPaused) pauseTimer();
                else if (isPaused) resumeTimer();
                else if (!isRunning && !isPaused) startTimer(); // Click anywhere to start
            });

            const openOptionsPanel = () => {
                optionsPanelOverlay.classList.add('visible');
                document.body.classList.add('settings-open');
            };

            const closeOptionsPanel = () => {
                optionsPanelOverlay.classList.remove('visible');
                document.body.classList.remove('settings-open');
                
                // Collapse all sections except Timer when closing panel
                const allSections = document.querySelectorAll('.options-section');
                allSections.forEach(section => {
                    // Keep Timer section open (it has "Timer" in the h3)
                    const sectionTitle = section.querySelector('h3');
                    if (sectionTitle && sectionTitle.textContent.includes('Timer')) {
                        section.classList.add('is-open');
                    } else {
                        section.classList.remove('is-open');
                    }
                });
            };
            optionsBtn.addEventListener('click', () => {
                playUISound();
                openOptionsPanel();
            });
            closePanelBtn.addEventListener('click', closeOptionsPanel);

            optionsPanelOverlay.addEventListener('click', (e) => {
                if (e.target === optionsPanelOverlay) {
                    closeOptionsPanel();
                }
            });

            // Collapsible sections
            document.querySelectorAll('.options-section.collapsible h3').forEach(header => {
                header.addEventListener('click', () => {
                    const section = header.parentElement;
                    const wasOpen = section.classList.contains('is-open');
                    
                    // Toggle the section
                    section.classList.toggle('is-open');
                    
                    // If section is now open (was closed), scroll to center the section
                    if (!wasOpen && section.classList.contains('is-open')) {
                        setTimeout(() => {
                            const panel = document.getElementById('options-panel');
                            
                            // Method 1: Scroll to center the entire section (including content)
                            const sectionTop = section.offsetTop;
                            const sectionHeight = section.offsetHeight;
                            const panelHeight = panel.clientHeight;
                            
                            // Calculate scroll position to center the section
                            const targetScrollTop = sectionTop - (panelHeight / 2) + (sectionHeight / 2);
                            
                            panel.scrollTo({
                                top: Math.max(0, targetScrollTop),
                                behavior: 'smooth'
                            });
                        }, 150); // Delay to allow expansion animation to complete
                    }
                });
            });
            
            // --- SETTINGS MANAGEMENT ---
            saveSettingsBtn.addEventListener('click', () => {
                playUISound();
                const settings = {};
                allInputs.forEach(input => {
                    // We don't save file inputs
                    if (input.type === 'file') return;
                    
                    if (input.type === 'checkbox') {
                        settings[input.id] = input.checked;
                    } else {
                        settings[input.id] = input.value;
                    }
                });
                localStorage.setItem('progressBarTimerSettings', JSON.stringify(settings));
                
                // Show save confirmation
                saveConfirm.classList.add('visible');
                setTimeout(() => {
                    saveConfirm.classList.remove('visible');
                }, 1500);
            });

            resetSettingsBtn.addEventListener('click', () => {
                playUISound();
                confirmModalOverlay.classList.remove('hidden');
            });

            confirmYesBtn.addEventListener('click', () => {
                localStorage.removeItem('progressBarTimerSettings');
                location.reload();
            });
            
            confirmNoBtn.addEventListener('click', () => {
                confirmModalOverlay.classList.add('hidden');
            });


            function loadAndApplySettings() {
                const savedSettings = localStorage.getItem('progressBarTimerSettings');
                if (!savedSettings) return;

                const settings = JSON.parse(savedSettings);

                allInputs.forEach(input => {
                    if (settings[input.id] !== undefined) {
                        if (input.type === 'checkbox') {
                            input.checked = settings[input.id];
                        } else {
                            input.value = settings[input.id];
                        }
                        // Dispatch events to trigger the live update listeners
                        input.dispatchEvent(new Event('input', { bubbles: true }));
                        input.dispatchEvent(new Event('change', { bubbles: true }));
                    }
                });

                // Ensure interface opacity CSS var is applied if saved (in case no listener fired yet)
                if (settings['ui-opacity-input'] !== undefined) {
                    const value = Math.max(20, Math.min(100, parseInt(settings['ui-opacity-input'], 10)));
                    setCssVar('--ui-opacity', value / 100);
                }
                // Ensure icon opacity is applied if saved (in case no listener fired yet)
                if (settings['icon-opacity-input'] !== undefined) {
                    const opacityValue = Math.max(20, Math.min(100, parseInt(settings['icon-opacity-input'], 10))) / 100;
                    optionsBtn.style.opacity = opacityValue;
                }
                // Ensure icon color style is applied if saved
                if (settings['icon-color-style-select'] !== undefined) {
                    iconAnimator.classList.remove('multicolor', 'rainbow');
                    if (settings['icon-color-style-select'] === 'multicolor') {
                        iconAnimator.classList.add('multicolor');
                    } else if (settings['icon-color-style-select'] === 'rainbow') {
                        iconAnimator.classList.add('rainbow');
                    }
                }
                // Ensure icon neon effect is applied if saved
                if (settings['icon-neon-toggle'] !== undefined && settings['icon-neon-toggle']) {
                    iconAnimator.classList.add('neon');
                    if (settings['icon-neon-intensity-input'] !== undefined) {
                        const intensity = parseInt(settings['icon-neon-intensity-input'], 10);
                        iconAnimator.style.filter = `drop-shadow(0 0 ${intensity/2}px currentColor) drop-shadow(0 0 ${intensity}px currentColor) drop-shadow(0 0 ${intensity*1.5}px currentColor)`;
                    }
                }
            }


            // --- LIVE CUSTOMIZATION ---
            const setCssVar = (name, value, unit = '') => root.style.setProperty(name, value + unit);
            
            messageInput.addEventListener('input', (e) => updateTimerMessage(e.target.value));
            ellipsisAnimationSelect.addEventListener('change', () => updateTimerMessage(messageInput.value));
            ellipsisIntensityInput.addEventListener('input', (e) => {
                const intensityValue = parseFloat(e.target.value); // 0-10
                const pulseScale = 1 + (intensityValue / 10) * 0.5; // maps to 1.0 - 1.5
                const waveOpacity = 0.5 - (intensityValue / 10) * 0.4; // maps to 0.5 - 0.1
                setCssVar('--ellipsis-pulse-scale', pulseScale);
                setCssVar('--ellipsis-wave-opacity', waveOpacity);
            });


            messageFontSizeInput.addEventListener('input', (e) => setCssVar('--message-font-size', e.target.value, 'rem'));
            messageColorInput.addEventListener('input', e => {
                setCssVar('--message-color', e.target.value);
                if (messageNeonMatchColorToggle.checked) {
                    setCssVar('--message-neon-color', e.target.value);
                }
            });
            messageOutlineColorInput.addEventListener('input', e => setCssVar('--message-outline-color', e.target.value));

            // Neon color controls
            textNeonColorInput.addEventListener('input', e => setCssVar('--text-neon-color', e.target.value));
            messageNeonColorInput.addEventListener('input', e => setCssVar('--message-neon-color', e.target.value));
            borderNeonColorInput.addEventListener('input', e => setCssVar('--border-neon-color', e.target.value));
            btnNeonColorInput.addEventListener('input', e => setCssVar('--btn-neon-color', e.target.value));
            iconNeonColorInput.addEventListener('input', e => setCssVar('--icon-neon-color', e.target.value));

            // Match color toggles
            textNeonMatchColorToggle.addEventListener('change', (e) => {
                textNeonColorInput.classList.toggle('unclickable', e.target.checked);
                if (e.target.checked) {
                    setCssVar('--text-neon-color', getComputedStyle(document.documentElement).getPropertyValue('--font-color').trim());
                }
            });
            messageNeonMatchColorToggle.addEventListener('change', (e) => {
                messageNeonColorInput.classList.toggle('unclickable', e.target.checked);
                if (e.target.checked) {
                    setCssVar('--message-neon-color', getComputedStyle(document.documentElement).getPropertyValue('--message-color').trim());
                }
            });
            
            borderNeonMatchColorToggle.addEventListener('change', (e) => {
                borderNeonColorInput.classList.toggle('unclickable', e.target.checked);
                if (e.target.checked) {
                    setCssVar('--border-neon-color', getComputedStyle(document.documentElement).getPropertyValue('--border-color').trim());
                }
            });
            
            btnNeonMatchColorToggle.addEventListener('change', (e) => {
                btnNeonColorInput.classList.toggle('unclickable', e.target.checked);
                if (e.target.checked) {
                    // For buttons, we'll use the current button colors dynamically
                    // This will be handled by the individual button color change listeners
                    updateButtonNeonColors();
                }
            });
            
            iconNeonMatchColorToggle.addEventListener('change', (e) => {
                iconNeonColorInput.classList.toggle('unclickable', e.target.checked);
                if (e.target.checked) {
                    setCssVar('--icon-neon-color', getComputedStyle(document.documentElement).getPropertyValue('--font-color').trim());
                }
            });

            // Initialize neon color inputs state (unclickable by default since match color is checked)
            textNeonColorInput.classList.toggle('unclickable', textNeonMatchColorToggle.checked);
            messageNeonColorInput.classList.toggle('unclickable', messageNeonMatchColorToggle.checked);
            borderNeonColorInput.classList.toggle('unclickable', borderNeonMatchColorToggle.checked);
            btnNeonColorInput.classList.toggle('unclickable', btnNeonMatchColorToggle.checked);
            iconNeonColorInput.classList.toggle('unclickable', iconNeonMatchColorToggle.checked);

            // Initialize match color checkboxes as disabled (since neon options start unchecked)
            textNeonMatchColorToggle.classList.toggle('disabled', !textGlowNeonToggle.checked);
            messageNeonMatchColorToggle.classList.toggle('disabled', !messageNeonToggle.checked);
            borderNeonMatchColorToggle.classList.toggle('disabled', !borderNeonToggle.checked);
            btnNeonMatchColorToggle.classList.toggle('disabled', !btnGlowNeonToggle.checked);
            iconNeonMatchColorToggle.classList.toggle('disabled', !iconNeonToggle.checked);
            iconOutlineOptions.classList.toggle('disabled', !iconOutlineToggle.checked);

            // Initialize button neon color to match start button color
            updateButtonNeonColors();

            // Prevent color picker from opening when unclickable
            [textNeonColorInput, messageNeonColorInput, borderNeonColorInput, btnNeonColorInput, iconNeonColorInput, iconOutlineColorInput].forEach(input => {
                input.addEventListener('click', (e) => {
                    if (input.classList.contains('unclickable')) {
                        e.preventDefault();
                        e.stopPropagation();
                    }
                });
            });

            // Function to update button neon colors when match color is enabled
            function updateButtonNeonColors() {
                if (btnNeonMatchColorToggle.checked) {
                    // Use the start button color as the default neon color
                    // Since all buttons share the same neon color variable, we'll use the start button color
                    const startBtnColor = getComputedStyle(document.documentElement).getPropertyValue('--start-btn-color').trim();
                    setCssVar('--btn-neon-color', startBtnColor);
                }
            }

            // Font outline toggle with fixed size
            fontOutlineToggle.addEventListener('change', (e) => {
                const isEnabled = e.target.checked;
                fontOutlineOptions.classList.toggle('disabled', !isEnabled);
                if (isEnabled) {
                    setCssVar('--font-outline-size', '1px');
                } else {
                    setCssVar('--font-outline-size', '0px');
                }
            });
            
            // Message outline toggle with fixed size
            messageOutlineToggle.addEventListener('change', (e) => {
                const isEnabled = e.target.checked;
                messageOutlineOptions.classList.toggle('disabled', !isEnabled);
                if (isEnabled) {
                    setCssVar('--message-outline-size', '1px');
                } else {
                    setCssVar('--message-outline-size', '0px');
                }
            });

            barLengthInput.addEventListener('input', (e) => setCssVar('--bar-length', e.target.value, 'vw'));
            barWidthInput.addEventListener('input', (e) => setCssVar('--bar-width', e.target.value, 'px'));
            barCornerInput.addEventListener('input', (e) => setCssVar('--bar-corner-radius', e.target.value, 'px'));
            barPaddingInput.addEventListener('input', (e) => setCssVar('--bar-padding', e.target.value, 'px'));
            
            borderColorInput.addEventListener('input', e => {
                setCssVar('--border-color', e.target.value);
                if (borderNeonMatchColorToggle.checked) {
                    setCssVar('--border-neon-color', e.target.value);
                }
            });
            borderSizeInput.addEventListener('input', e => setCssVar('--border-size', e.target.value, 'px'));
            
            fontSelect.addEventListener('change', (e) => {
                // Add smooth fade effect during font change
                const timerDisplay = document.getElementById('timer-display');
                const timerMessage = document.getElementById('timer-message');
                
                // Fade out slightly
                timerDisplay.style.opacity = '0.7';
                timerMessage.style.opacity = '0.7';
                
                // Change font after brief delay
                setTimeout(() => {
                    setCssVar('--font-family', e.target.value);
                    
                    // Fade back in
                    setTimeout(() => {
                        timerDisplay.style.opacity = '1';
                        timerMessage.style.opacity = '1';
                    }, 50);
                }, 100);
            });
            fontSizeInput.addEventListener('input', (e) => {
                setCssVar('--font-size', e.target.value, 'px');
                if (textNeonMatchColorToggle.checked) {
                    setCssVar('--text-neon-color', getComputedStyle(document.documentElement).getPropertyValue('--font-color').trim());
                }
                if (iconNeonMatchColorToggle.checked) {
                    setCssVar('--icon-neon-color', getComputedStyle(document.documentElement).getPropertyValue('--font-color').trim());
                }
            });
            fontColorInput.addEventListener('input', (e) => {
                setCssVar('--font-color', e.target.value);
                if (textNeonMatchColorToggle.checked) {
                    setCssVar('--text-neon-color', e.target.value);
                }
                if (iconNeonMatchColorToggle.checked) {
                    setCssVar('--icon-neon-color', e.target.value);
                }
            });
            fontOutlineColorInput.addEventListener('input', (e) => setCssVar('--font-outline-color', e.target.value));
            
            iconPresetSelect.addEventListener('change', e => {
                const iconKey = e.target.value;
                if(presetIcons[iconKey]) {
                    iconAnimator.innerHTML = presetIcons[iconKey];
                    iconAnimator.style.backgroundImage = 'none';
                    iconAnimator.classList.remove('custom-icon');
                    iconUploadInput.value = '';
                    // Apply the selected color to preset icons
                    iconAnimator.style.color = iconColorInput.value;
                }
            });

            function applyIconAnimation() {
                iconAnimator.classList.remove('animated-spin', 'animated-pulse', 'animated-float', 'animated-wobble');
                if (iconAnimationToggle.checked) {
                    const style = iconAnimationStyleSelect.value;
                    iconAnimator.classList.add(`animated-${style}`);
                }
            }

            iconAnimationToggle.addEventListener('change', applyIconAnimation);
            iconAnimationStyleSelect.addEventListener('change', applyIconAnimation);

            iconAnimationSpeedInput.addEventListener('input', (e) => {
                // Invert the value: slider 1-5 maps to duration 5-1s (left=slower, right=faster)
                const invertedValue = 6 - parseFloat(e.target.value);
                setCssVar('--options-btn-animation-speed', invertedValue, 's');
            });
            iconSizeInput.addEventListener('input', (e) => setCssVar('--options-btn-size', e.target.value, 'px'));
            iconOpacityInput.addEventListener('input', (e) => {
                const opacityValue = Math.max(20, Math.min(100, parseInt(e.target.value, 10))) / 100;
                optionsBtn.style.opacity = opacityValue;
            });
            iconColorInput.addEventListener('input', (e) => {
                if (!iconAnimator.classList.contains('custom-icon')) {
                    iconAnimator.style.color = e.target.value;
                }
            });
            
            // Icon Color Style
            iconColorStyleSelect.addEventListener('change', (e) => {
                iconAnimator.classList.remove('multicolor', 'rainbow');
                if (e.target.value === 'multicolor') {
                    iconAnimator.classList.add('multicolor');
                } else if (e.target.value === 'rainbow') {
                    iconAnimator.classList.add('rainbow');
                }
            });

            // Icon Neon Effect
            iconNeonToggle.addEventListener('change', (e) => {
                const neonEnabled = e.target.checked;
                if (neonEnabled) {
                    iconAnimator.classList.add('neon');
                } else {
                    iconAnimator.classList.remove('neon');
                }
                
                // Disable/enable match color checkbox based on neon state
                iconNeonMatchColorToggle.classList.toggle('disabled', !neonEnabled);
            });

            iconNeonIntensityInput.addEventListener('input', (e) => {
                const intensity = parseInt(e.target.value, 10);
                setCssVar('--icon-neon-intensity', intensity, 'px');
            });

            // Icon Outline Effect
            iconOutlineToggle.addEventListener('change', (e) => {
                const outlineEnabled = e.target.checked;
                if (outlineEnabled) {
                    iconAnimator.classList.add('outline');
                } else {
                    iconAnimator.classList.remove('outline');
                }
                
                // Enable/disable outline options based on toggle state
                iconOutlineOptions.classList.toggle('disabled', !outlineEnabled);
            });

            iconOutlineColorInput.addEventListener('input', (e) => {
                setCssVar('--icon-outline-color', e.target.value);
            });
            
            iconUploadInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        iconAnimator.style.backgroundImage = `url(${event.target.result})`;
                        iconAnimator.innerHTML = '';
                        iconAnimator.classList.add('custom-icon');

                        let customOption = iconPresetSelect.querySelector('option[value="custom"]');
                        if (!customOption) {
                            customOption = document.createElement('option');
                            customOption.value = 'custom';
                            customOption.textContent = 'Custom (Uploaded)';
                            iconPresetSelect.appendChild(customOption);
                        }
                        iconPresetSelect.value = 'custom';
                    };
                    reader.readAsDataURL(file);
                }
            });
            clearIconBtn.addEventListener('click', () => {
                iconAnimator.innerHTML = presetIcons.menu;
                iconAnimator.style.backgroundImage = 'none';
                iconAnimator.classList.remove('custom-icon');
                iconUploadInput.value = '';
                iconPresetSelect.value = 'menu';
                // Reset to default color
                iconAnimator.style.color = iconColorInput.value;
                const customOption = iconPresetSelect.querySelector('option[value="custom"]');
                if (customOption) {
                    customOption.remove();
                }
            });
            const updateUIPositions = () => {
                // All elements now have proper CSS transitions matching the bar's 0.3s ease
                // No JavaScript manipulation needed - CSS handles the smooth animations
            };

            [fontSizeInput, barWidthInput, fontSelect, messageFontSizeInput, iconSizeInput, barLengthInput].forEach(el => {
                el.addEventListener('input', () => {
                    // Add a small delay to ensure CSS variables are updated
                    setTimeout(updateUIPositions, 10);
                });
            });
            
            bgColorInput.addEventListener('input', (e) => {
                 document.body.style.backgroundImage = 'none'; 
                 setCssVar('--bg-color', e.target.value);
            });
            bgImageUploadBtn.addEventListener('click', () => {
                bgImageUploadInput.click();
            });
            
            bgImageUploadInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => document.body.style.backgroundImage = `url(${event.target.result})`;
                    reader.readAsDataURL(file);
                }
            });
            clearBgBtn.addEventListener('click', () => {
                document.body.style.backgroundImage = 'none';
                bgImageUploadInput.value = '';
            });
            
            // --- PARTICLE SYSTEM ---
            const canvas = document.getElementById('particles-canvas');
            const ctx = canvas.getContext('2d');
            let particles = [];
            let animationId;
            
            // Advanced effects variables
            let mouseX = 0;
            let mouseY = 0;
            let particleConnections = [];
            
            // Object pooling for better performance
            const particlePool = [];
            const maxPoolSize = 100;
            
            const getPooledParticle = () => {
                if (particlePool.length > 0) {
                    return particlePool.pop();
                }
                return null;
            };
            
            const returnParticleToPool = (particle) => {
                if (particlePool.length < maxPoolSize) {
                    particlePool.push(particle);
                }
            };
            
            const resizeCanvas = () => {
                // Get exact visible viewport dimensions - no overflow
                const vw = window.innerWidth;
                const vh = window.innerHeight;
                const dpr = window.devicePixelRatio || 1;
                
                // Set canvas size to exact viewport dimensions
                canvas.width = Math.round(vw * dpr);
                canvas.height = Math.round(vh * dpr);
                
                // Scale context to match device pixel ratio
                ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
                
                // Set canvas CSS size to exact viewport
                canvas.style.width = vw + 'px';
                canvas.style.height = vh + 'px';
                
                // Ensure no overflow
                canvas.style.maxWidth = vw + 'px';
                canvas.style.maxHeight = vh + 'px';
                canvas.style.overflow = 'hidden';
                canvas.style.margin = '0';
                canvas.style.padding = '0';
                
                // Store exact dimensions for particle system
                window.canvasWidth = vw;
                window.canvasHeight = vh;
            };
            // Initialize canvas size
            resizeCanvas();
            
            const createParticle = () => {
                // Try to get a pooled particle first
                let particle = getPooledParticle();
                
                if (!particle) {
                    // Create new particle if pool is empty
                    particle = {};
                }
                
                const speed = parseFloat(particleSpeedInput.value);
                const size = parseFloat(particleSizeInput.value);
                const direction = particleDirectionSelect.value;
                const colorStyle = particleColorStyleSelect.value;
                const shape = particleShapeSelect.value;
                const baseColor = particleColorInput.value;
                const multiColor1 = particleMultiColor1Input.value;
                const multiColor2 = particleMultiColor2Input.value;
                const multiColor3 = particleMultiColor3Input.value;
                const multiColor4 = particleMultiColor4Input.value;
                
                // Generate color based on style using cached random
                let color = baseColor;
                if (colorStyle === 'rainbow') {
                    const hue = getCachedRandom() * 360;
                    color = `hsl(${hue}, 100%, 70%)`;
                } else if (colorStyle === 'random') {
                    color = `hsl(${getCachedRandom() * 360}, ${50 + getCachedRandom() * 50}%, ${50 + getCachedRandom() * 30}%)`;
                } else if (colorStyle === 'multiple') {
                    const colors = [multiColor1, multiColor2, multiColor3, multiColor4];
                    color = colors[Math.floor(getCachedRandom() * colors.length)];
                }
                
                // Use exact viewport dimensions - no overflow
                const vw = window.canvasWidth || window.innerWidth;
                const vh = window.canvasHeight || window.innerHeight;
                
                // Set initial position and velocity based on direction
                let x, y, vx, vy;
                let angle, velocity; // Declare for space particles
                
                switch (direction) {
                    case 'up':
                        x = getCachedRandom() * vw;
                        y = vh + 2; // Minimal margin for instant appearance
                        vx = (getCachedRandom() - 0.5) * speed * 0.2;
                        vy = -speed * (2.5 + getCachedRandom() * 0.5); // Faster movement
                        break;
                    case 'down':
                        x = getCachedRandom() * vw;
                        y = -2; // Minimal margin for instant appearance
                        vx = (getCachedRandom() - 0.5) * speed * 0.2;
                        vy = speed * (2.5 + getCachedRandom() * 0.5); // Faster movement
                        break;
                    case 'left':
                        x = vw + 2; // Minimal margin for instant appearance
                        y = getCachedRandom() * vh;
                        vx = -speed * (2.5 + getCachedRandom() * 0.5); // Faster movement
                        vy = (getCachedRandom() - 0.5) * speed * 0.2;
                        break;
                    case 'right':
                        x = -2; // Minimal margin for instant appearance
                        y = getCachedRandom() * vh;
                        vx = speed * (2.5 + getCachedRandom() * 0.5); // Faster movement
                        vy = (getCachedRandom() - 0.5) * speed * 0.2;
                        break;
                    case 'bounce':
                        x = getCachedRandom() * vw;
                        y = getCachedRandom() * vh;
                        vx = (getCachedRandom() - 0.5) * speed * 2;
                        vy = (getCachedRandom() - 0.5) * speed * 2;
                        break;
                    case 'random':
                        x = getCachedRandom() * vw;
                        y = getCachedRandom() * vh;
                        vx = (getCachedRandom() - 0.5) * speed * 2;
                        vy = (getCachedRandom() - 0.5) * speed * 2;
                        break;
                    case 'static':
                        // For static pattern, use random positioning to allow freezing particles
                        // in their current positions when switching from other patterns
                        x = getCachedRandom() * vw;
                        y = getCachedRandom() * vh;
                        vx = 0;
                        vy = 0;
                        break;
                    case 'space':
                        // Space traveling: particles start at center and move outward in straight lines
                        x = vw / 2 + (getCachedRandom() - 0.5) * 20; // Small random offset from center
                        y = vh / 2 + (getCachedRandom() - 0.5) * 20;
                        
                        // Fixed outward movement - each particle gets its own straight direction
                        angle = getCachedRandom() * Math.PI * 2;
                        velocity = speed * 0.6; // Much slower speed for outward particles
                        vx = Math.cos(angle) * velocity;
                        vy = Math.sin(angle) * velocity;
                        break;
                }
                
                return {
                    x: x,
                    y: y,
                    vx: vx,
                    vy: vy,
                    size: size,
                    color: color,
                    baseColor: baseColor,
                    multiColor1: multiColor1,
                    multiColor2: multiColor2,
                    multiColor3: multiColor3,
                    multiColor4: multiColor4,
                    colorStyle: colorStyle,
                    shape: shape,
                    opacity: direction === 'static' ? 0.95 + getCachedRandom() * 0.05 : 
                             direction === 'space' ? 0.1 + getCachedRandom() * 0.1 : 
                             0.8 + getCachedRandom() * 0.2,
                    rotation: getCachedRandom() * Math.PI * 2,
                    rotationSpeed: (getCachedRandom() - 0.5) * 0.1,
                    twinklePhase: getCachedRandom() * Math.PI * 2,
                    twinkleSpeed: parseFloat(particleTwinkleInput.value) > 0 ? (0.1 + (parseFloat(particleTwinkleInput.value) / 100) * 0.2) : 0, // Custom twinkle speed
                    direction: direction,
                    index: particles.length + Math.floor(Math.random() * 1000), // Add unique index for movement patterns
                    isConnectionStarter: Math.random() < 0.3, // 30% of particles are connection starters
                    maxConnections: 3, // Maximum connections per starter
                    currentConnections: 0, // Track current connections
                    maxReceivers: 2, // Maximum receivers per starter
                    connectedReceivers: [], // Track connected receiver indices
                    originalAngle: direction === 'space' ? angle : undefined, // Store original angle for space particles
                    originalVelocity: direction === 'space' ? velocity : undefined // Store original velocity for space particles
                };
            };
            // Cache expensive calculations
            let twinkleIntensity = 0;
            let twinkleIntensityUpdated = false;
            let twinkleSpeedBase = 0;
            
            // Math operation caching for better performance
            const mathCache = {
                sinCache: new Map(),
                cosCache: new Map(),
                randomCache: [],
                randomIndex: 0,
                cacheSize: 1000
            };
            
            // Pre-generate random numbers for better performance
            for (let i = 0; i < mathCache.cacheSize; i++) {
                mathCache.randomCache.push(Math.random());
            }
            
            const getCachedRandom = () => {
                const value = mathCache.randomCache[mathCache.randomIndex];
                mathCache.randomIndex = (mathCache.randomIndex + 1) % mathCache.cacheSize;
                return value;
            };
            
            const getCachedSin = (angle) => {
                const key = Math.round(angle * 1000) / 1000; // Round to 3 decimal places
                if (!mathCache.sinCache.has(key)) {
                    mathCache.sinCache.set(key, Math.sin(angle));
                }
                return mathCache.sinCache.get(key);
            };
            
            const getCachedCos = (angle) => {
                const key = Math.round(angle * 1000) / 1000; // Round to 3 decimal places
                if (!mathCache.cosCache.has(key)) {
                    mathCache.cosCache.set(key, Math.cos(angle));
                }
                return mathCache.cosCache.get(key);
            };
            const drawParticle = (particle) => {
                // Cache twinkle intensity calculation (only update when input changes)
                if (!twinkleIntensityUpdated) {
                    twinkleIntensity = parseFloat(particleTwinkleInput.value) / 100; // 0..1
                    // Non-linear mapping: very slow at low values, much faster at high values
                    // Map to per-frame phase increment (used below)
                    twinkleSpeedBase = twinkleIntensity === 0 ? 0 : (0.001 + Math.pow(twinkleIntensity, 2.2) * 0.05);
                    twinkleIntensityUpdated = true;
                }
                
                // Optimized twinkling effect using cached sin
                const twinkleEffect = twinkleIntensity > 0 ? getCachedSin(particle.twinklePhase) : 1;
                const currentOpacity = particle.opacity * (twinkleIntensity > 0 ? (0.3 + 0.7 * twinkleEffect) : 1);
                
                ctx.globalAlpha = currentOpacity;
                
                // Optimized shadow settings - reduced for better performance
                ctx.shadowColor = particle.color;
                ctx.shadowBlur = twinkleIntensity > 0 ? (3 + twinkleEffect * 2) : 3; // Reduced shadow blur
                ctx.shadowOffsetX = 0;
                ctx.shadowOffsetY = 0;
                
                // Set fill style
                ctx.fillStyle = particle.color;
                
                const halfSize = particle.size * 0.5;
                
                // Simplified particle shapes for better performance - no ctx.save/restore needed
                switch (particle.shape) {
                    case 'square':
                        // Draw actual square
                        ctx.fillRect(particle.x - halfSize, particle.y - halfSize, particle.size, particle.size);
                        break;
                    case 'circle':
                        // Use simple circle
                        ctx.beginPath();
                        ctx.arc(particle.x, particle.y, halfSize, 0, Math.PI * 2);
                        ctx.fill();
                        break;
                    case 'single-pixel':
                        // Single pixel - most efficient
                        ctx.fillRect(particle.x, particle.y, 1, 1);
                        break;
                    case 'horizontal-line':
                        ctx.fillRect(particle.x - halfSize, particle.y - 1, particle.size, 2);
                        break;
                    case 'vertical-line':
                        ctx.fillRect(particle.x - 1, particle.y - halfSize, 2, particle.size);
                        break;
                    case 'diagonal-line':
                        ctx.beginPath();
                        ctx.moveTo(particle.x - halfSize, particle.y - halfSize);
                        ctx.lineTo(particle.x + halfSize, particle.y + halfSize);
                        ctx.strokeStyle = particle.color; // Set stroke color explicitly
                        ctx.lineWidth = 2;
                        ctx.stroke();
                        break;
                    case 'ring':
                        ctx.beginPath();
                        ctx.arc(particle.x, particle.y, halfSize, 0, Math.PI * 2);
                        ctx.strokeStyle = particle.color;
                        ctx.lineWidth = Math.max(1, particle.size * 0.2);
                        ctx.stroke();
                        break;
                    case 'triangle':
                    case 'triangle-outline':
                        // Simplified triangle - no rotation for better performance
                        ctx.beginPath();
                        ctx.moveTo(particle.x, particle.y - halfSize);
                        ctx.lineTo(particle.x - halfSize, particle.y + halfSize);
                        ctx.lineTo(particle.x + halfSize, particle.y + halfSize);
                        ctx.closePath();
                        if (particle.shape === 'triangle-outline') {
                            ctx.strokeStyle = particle.color;
                            ctx.lineWidth = 1;
                            ctx.stroke();
                        } else {
                            ctx.fill();
                        }
                        break;
                    
                    // 🔷 ADVANCED SHAPES 🔷
                    case 'star':
                        // 5-pointed star
                        const starSize = halfSize;
                        ctx.beginPath();
                        for (let i = 0; i < 5; i++) {
                            const angle = (i * 4 * Math.PI) / 5 - Math.PI / 2;
                            const x = particle.x + Math.cos(angle) * starSize;
                            const y = particle.y + Math.sin(angle) * starSize;
                            if (i === 0) ctx.moveTo(x, y);
                            else ctx.lineTo(x, y);
                            
                            const innerAngle = ((i * 4 + 2) * Math.PI) / 5 - Math.PI / 2;
                            const innerX = particle.x + Math.cos(innerAngle) * starSize * 0.4;
                            const innerY = particle.y + Math.sin(innerAngle) * starSize * 0.4;
                            ctx.lineTo(innerX, innerY);
                        }
                        ctx.closePath();
                        ctx.fill();
                        break;
                    
                    case 'heart':
                        // Heart shape - made much larger for better visibility
                        const heartSize = halfSize * 2.5; // Increased size by 150% (was 80%)
                        ctx.beginPath();
                        ctx.moveTo(particle.x, particle.y + heartSize * 0.3);
                        ctx.bezierCurveTo(
                            particle.x - heartSize, particle.y - heartSize * 0.3,
                            particle.x - heartSize * 0.5, particle.y - heartSize,
                            particle.x, particle.y - heartSize * 0.5
                        );
                        ctx.bezierCurveTo(
                            particle.x + heartSize * 0.5, particle.y - heartSize,
                            particle.x + heartSize, particle.y - heartSize * 0.3,
                            particle.x, particle.y + heartSize * 0.3
                        );
                        ctx.fill();
                        break;
                    
                    case 'diamond':
                        // Diamond shape
                        const diamondSize = halfSize;
                        ctx.beginPath();
                        ctx.moveTo(particle.x, particle.y - diamondSize);
                        ctx.lineTo(particle.x + diamondSize, particle.y);
                        ctx.lineTo(particle.x, particle.y + diamondSize);
                        ctx.lineTo(particle.x - diamondSize, particle.y);
                        ctx.closePath();
                        ctx.fill();
                        break;
                    
                    case 'cross':
                        // Plus/cross shape
                        const crossSize = halfSize;
                        ctx.fillRect(particle.x - crossSize, particle.y - crossSize * 0.2, crossSize * 2, crossSize * 0.4);
                        ctx.fillRect(particle.x - crossSize * 0.2, particle.y - crossSize, crossSize * 0.4, crossSize * 2);
                        break;
                    
                    case 'hexagon':
                        // 6-sided hexagon
                        const hexSize = halfSize;
                        ctx.beginPath();
                        for (let i = 0; i < 6; i++) {
                            const angle = (i * Math.PI) / 3;
                            const x = particle.x + Math.cos(angle) * hexSize;
                            const y = particle.y + Math.sin(angle) * hexSize;
                            if (i === 0) ctx.moveTo(x, y);
                            else ctx.lineTo(x, y);
                        }
                        ctx.closePath();
                        ctx.fill();
                        break;
                    
                    case 'pentagon':
                        // 5-sided pentagon
                        const pentSize = halfSize;
                        ctx.beginPath();
                        for (let i = 0; i < 5; i++) {
                            const angle = (i * 2 * Math.PI) / 5 - Math.PI / 2;
                            const x = particle.x + Math.cos(angle) * pentSize;
                            const y = particle.y + Math.sin(angle) * pentSize;
                            if (i === 0) ctx.moveTo(x, y);
                            else ctx.lineTo(x, y);
                        }
                        ctx.closePath();
                        ctx.fill();
                        break;
                    
                    // ✨ SPECIAL EFFECTS ✨
                    case 'sparkle':
                        // Twinkling star burst effect
                        const sparkleSize = halfSize * (0.5 + getCachedSin(particle.twinklePhase * 2) * 0.5);
                        ctx.beginPath();
                        // Draw 4-pointed star
                        for (let i = 0; i < 4; i++) {
                            const angle = (i * Math.PI) / 2;
                            const x1 = particle.x + Math.cos(angle) * sparkleSize;
                            const y1 = particle.y + Math.sin(angle) * sparkleSize;
                            const x2 = particle.x + Math.cos(angle + Math.PI / 4) * sparkleSize * 0.5;
                            const y2 = particle.y + Math.sin(angle + Math.PI / 4) * sparkleSize * 0.5;
                            if (i === 0) ctx.moveTo(x1, y1);
                            else ctx.lineTo(x1, y1);
                            ctx.lineTo(x2, y2);
                        }
                        ctx.closePath();
                        ctx.fill();
                        break;
                    case 'smoke':
                        // Wispy smoke trail effect
                        const smokeOpacity = currentOpacity * 0.6;
                        ctx.globalAlpha = smokeOpacity;
                        ctx.beginPath();
                        ctx.arc(particle.x, particle.y, halfSize * (0.8 + getCachedSin(particle.twinklePhase * 1.5) * 0.4), 0, Math.PI * 2);
                        ctx.fill();
                        // Add smaller trailing circle
                        ctx.beginPath();
                        ctx.arc(particle.x - halfSize * 0.5, particle.y + halfSize * 0.3, halfSize * 0.6, 0, Math.PI * 2);
                        ctx.fill();
                        ctx.globalAlpha = currentOpacity; // Reset alpha
                        break;
                    
                    case 'lightning':
                        // Electric bolt effect
                        const lightningSize = halfSize * (1 + getCachedSin(particle.twinklePhase * 4) * 0.5);
                        ctx.beginPath();
                        ctx.moveTo(particle.x, particle.y - lightningSize);
                        ctx.lineTo(particle.x - halfSize * 0.3, particle.y - lightningSize * 0.5);
                        ctx.lineTo(particle.x + halfSize * 0.2, particle.y - lightningSize * 0.2);
                        ctx.lineTo(particle.x - halfSize * 0.1, particle.y + lightningSize * 0.2);
                        ctx.lineTo(particle.x + halfSize * 0.3, particle.y + lightningSize * 0.5);
                        ctx.lineTo(particle.x, particle.y + lightningSize);
                        ctx.strokeStyle = particle.color;
                        ctx.lineWidth = 2;
                        ctx.stroke();
                        break;
                    
                    case 'pulse':
                        // Expanding/contracting circle
                        const pulseSize = halfSize * (0.7 + getCachedSin(particle.twinklePhase * 2) * 0.6);
                        ctx.beginPath();
                        ctx.arc(particle.x, particle.y, pulseSize, 0, Math.PI * 2);
                        ctx.fill();
                        // Add outer ring
                        ctx.beginPath();
                        ctx.arc(particle.x, particle.y, pulseSize * 1.5, 0, Math.PI * 2);
                        ctx.strokeStyle = particle.color;
                        ctx.lineWidth = 1;
                        ctx.stroke();
                        break;
                    
                    default:
                        // Default to circle for unknown shapes
                        ctx.beginPath();
                        ctx.arc(particle.x, particle.y, halfSize, 0, Math.PI * 2);
                        ctx.fill();
                        break;
                };
            };
            
            // Advanced effects function
            const applyAdvancedEffects = (effect) => {
                switch (effect) {
                    case 'connections':
                        // Optimized connection system with starters and receivers
                        const connectionDistance = 70; // Slightly reduced detection radius for better performance
                        const connectionDistanceSquared = connectionDistance * connectionDistance;
                        
                        // Reset connection counts and clear receiver tracking
                        particles.forEach(particle => {
                            particle.currentConnections = 0;
                            particle.connectedReceivers = [];
                        });
                        
                        // Track receivers that have been connected to prevent over-connection
                        const receiverConnectionCount = new Map();
                        
                        // Draw connections only from starters to receivers
                        const step = Math.max(1, Math.floor(particles.length / 40));
                        for (let si = 0; si < particles.length; si += step) {
                            const starter = particles[si];
                            if (!starter.isConnectionStarter || starter.currentConnections >= starter.maxConnections) {
                                continue; // Skip if not a starter or at max connections
                            }
                            
                            for (let ri = 0; ri < particles.length; ri++) {
                                const receiver = particles[ri];
                                // Skip if receiver is also a starter or same particle
                                if (receiver.isConnectionStarter || receiver === starter) {
                                    continue;
                                }
                                
                                // Check if starter can still make connections
                                if (starter.currentConnections >= starter.maxConnections) {
                                    break;
                                }
                                
                                // Check if receiver is already connected to max starters
                                const receiverConnections = receiverConnectionCount.get(receiver.index) || 0;
                                if (receiverConnections >= starter.maxReceivers) {
                                    continue;
                                }
                                
                                const dx = starter.x - receiver.x;
                                const dy = starter.y - receiver.y;
                                const distanceSquared = dx * dx + dy * dy;
                                
                                if (distanceSquared < connectionDistanceSquared) {
                                    // Draw elegant connection line with enhanced visibility
                                    ctx.globalAlpha = 0.35; // Increased from 0.15 for better visibility
                                    ctx.lineWidth = 1.2; // Slightly increased for better visibility
                                    ctx.lineCap = 'round';
                                    ctx.lineJoin = 'round'; // Smooth line joins
                                    
                                    // Add enhanced gradient effect with better brightness
                                    const gradient = ctx.createLinearGradient(starter.x, starter.y, receiver.x, receiver.y);
                                    gradient.addColorStop(0, starter.color);
                                    gradient.addColorStop(0.5, '#ffffff'); // Add white center for luminosity
                                    gradient.addColorStop(1, receiver.color);
                                    ctx.strokeStyle = gradient;
                                    
                                    // Add subtle glow effect
                                    ctx.shadowColor = starter.color;
                                    ctx.shadowBlur = 3;
                                    
                                    ctx.beginPath();
                                    ctx.moveTo(starter.x, starter.y);
                                    ctx.lineTo(receiver.x, receiver.y);
                                    ctx.stroke();
                                    
                                    // Reset shadow
                                    ctx.shadowBlur = 0;
                                    
                                    // Increment connection count
                                    starter.currentConnections++;
                                    starter.connectedReceivers.push(receiver.index);
                                    
                                    // Track receiver connection
                                    receiverConnectionCount.set(receiver.index, receiverConnections + 1);
                                }
                            }
                        }
                        
                        ctx.globalAlpha = 1;
                        break;
                }
            };
            const animate = () => {
                try {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    
                    // Use exact viewport dimensions - no overflow
                    const canvasWidth = window.canvasWidth || window.innerWidth;
                    const canvasHeight = window.canvasHeight || window.innerHeight;
                    const canvasCenterX = canvasWidth * 0.5;
                    const canvasCenterY = canvasHeight * 0.5;
                    
                    // Viewport culling bounds
                    const cullMargin = 50;
                    const viewportLeft = -cullMargin;
                    const viewportRight = canvasWidth + cullMargin;
                    const viewportTop = -cullMargin;
                    const viewportBottom = canvasHeight + cullMargin;
                    
                    particles.forEach(particle => {
                        // Update particle position (skip for static particles)
                        if (particle.direction !== 'static') {
                        particle.x += particle.vx;
                        particle.y += particle.vy;
                        }
                        
                        particle.rotation += particle.rotationSpeed;
                    // Advance twinkle phase using non-linear base speed plus small per-particle variance
                    particle.twinklePhase += (twinkleSpeedBase + particle.twinkleSpeed * 0.01);
                    
                    // Optimized color updates (reduce Math.random calls)
                    if (particle.colorStyle === 'rainbow') {
                        const hue = (particle.twinklePhase * 50) % 360;
                        particle.color = `hsl(${hue}, 100%, 70%)`;
                    } else if (particle.colorStyle === 'random' && Math.random() < 0.005) { // Reduced frequency
                        particle.color = `hsl(${Math.random() * 360}, ${50 + Math.random() * 50}%, ${50 + Math.random() * 30}%)`;
                    }
                    
                    // Space traveling fade-in effect
                    if (particle.direction === 'space') {
                        // Gradually increase opacity as particles move outward
                        const distanceFromCenter = Math.sqrt(Math.pow(particle.x - canvasWidth/2, 2) + Math.pow(particle.y - canvasHeight/2, 2));
                        const maxDistance = Math.sqrt(Math.pow(canvasWidth/2, 2) + Math.pow(canvasHeight/2, 2));
                        const fadeProgress = Math.min(distanceFromCenter / (maxDistance * 0.3), 1); // Fade in over first 30% of distance
                        particle.opacity = Math.max(0.1, 0.1 + fadeProgress * 0.7); // Fade from 0.1 to 0.8
                    }
                    
                    // Optimized screen wrapping using cached dimensions
                    const direction = particle.direction;
                    const margin = 2; // Minimal margin for faster appearance
                    
                    switch (direction) {
                        case 'up':
                            if (particle.x < -margin) particle.x = canvasWidth + margin;
                            if (particle.x > canvasWidth + margin) particle.x = -margin;
                            if (particle.y < -margin) {
                                particle.y = canvasHeight + margin;
                                particle.x = Math.random() * canvasWidth;
                            }
                            break;
                        case 'down':
                            if (particle.x < -margin) particle.x = canvasWidth + margin;
                            if (particle.x > canvasWidth + margin) particle.x = -margin;
                            if (particle.y > canvasHeight + margin) {
                                particle.y = -margin;
                                particle.x = Math.random() * canvasWidth;
                            }
                            break;
                        case 'left':
                            if (particle.y < -margin) particle.y = canvasHeight + margin;
                            if (particle.y > canvasHeight + margin) particle.y = -margin;
                            if (particle.x < -margin) {
                                particle.x = canvasWidth + margin;
                                particle.y = Math.random() * canvasHeight;
                            }
                            break;
                        case 'right':
                            if (particle.y < -margin) particle.y = canvasHeight + margin;
                            if (particle.y > canvasHeight + margin) particle.y = -margin;
                            if (particle.x > canvasWidth + margin) {
                                particle.x = -margin;
                                particle.y = Math.random() * canvasHeight;
                            }
                            break;
                        case 'bounce':
                            // Optimized bounce with cached dimensions
                            if (particle.x < 0 || particle.x > canvasWidth) {
                                particle.vx = -particle.vx;
                                particle.x = Math.max(0, Math.min(canvasWidth, particle.x));
                            }
                            if (particle.y < 0 || particle.y > canvasHeight) {
                                particle.vy = -particle.vy;
                                particle.y = Math.max(0, Math.min(canvasHeight, particle.y));
                            }
                            break;
                        case 'random':
                            if (particle.x < -margin) particle.x = canvasWidth + margin;
                            if (particle.x > canvasWidth + margin) particle.x = -margin;
                            if (particle.y < -margin) particle.y = canvasHeight + margin;
                            if (particle.y > canvasHeight + margin) particle.y = -margin;
                            break;
                        case 'static':
                            // Static particles don't move, so no boundary checking needed
                            break;
                        case 'space':
                            // Space traveling particles disappear when they reach screen edges
                            if (particle.x < -margin || particle.x > canvasWidth + margin || 
                                particle.y < -margin || particle.y > canvasHeight + margin) {
                                // Mark particle for removal by setting a flag
                                particle.shouldRemove = true;
                            }
                            break;
                    }
                    
                    // Viewport culling - only draw if particle is visible or near viewport
                    if (particle.x >= viewportLeft && particle.x <= viewportRight && 
                        particle.y >= viewportTop && particle.y <= viewportBottom) {
                        drawParticle(particle);
                    }
                });
                
                // Remove particles marked for removal (space particles that reached edges)
                particles = particles.filter(particle => !particle.shouldRemove);
                
                // Continuously generate space particles to maintain target count
                if (particleDirectionSelect.value === 'space') {
                    const density = parseInt(particleDensityInput.value);
                    const targetCount = Math.min(density * 6, 45);
                    
                    if (particles.length < targetCount) {
                        const needed = targetCount - particles.length;
                        const newParticles = new Array(needed).fill(0).map(() => createParticle());
                        particles.push(...newParticles);
                    }
                }
                
                // Apply advanced effects
                const currentEffect = particleEffectsSelect.value;
                applyAdvancedEffects(currentEffect);
                
                animationId = requestAnimationFrame(animate);
                } catch (error) {
                    // Canvas animation failed, stop animation
                    cancelAnimationFrame(animationId);
                }
            };
            const updateParticles = (skipVelocityUpdate = false) => {
                const density = parseInt(particleDensityInput.value);
                const direction = particleDirectionSelect.value;
                
                // Higher density for static particles
                const densityMultiplier = direction === 'static' ? 10 : 6; // Static gets 67% more particles
                const maxCount = direction === 'static' ? 75 : 45; // Static can have more particles
                const targetCount = Math.min(density * densityMultiplier, maxCount);
                
                // Clear existing particles if density is 0
                if (targetCount === 0) {
                    particles = [];
                    return;
                }
                
                // Adjust particle count more efficiently
                if (particles.length < targetCount) {
                    // Spawn all remaining particles immediately for simultaneous appearance
                    const needed = targetCount - particles.length;
                    const newParticles = new Array(needed).fill(0).map(() => createParticle());
                    particles.push(...newParticles);
                } else if (particles.length > targetCount) {
                    // Remove excess particles and return them to pool
                    const excessParticles = particles.splice(targetCount);
                    excessParticles.forEach(particle => returnParticleToPool(particle));
                }
                
                // Update existing particles
                particles.forEach(particle => {
                    const speed = parseFloat(particleSpeedInput.value);
                    const size = parseFloat(particleSizeInput.value);
                    const direction = particleDirectionSelect.value;
                    const colorStyle = particleColorStyleSelect.value;
                    const shape = particleShapeSelect.value;
                    const baseColor = particleColorInput.value;
                    const multiColor1 = particleMultiColor1Input.value;
                    const multiColor2 = particleMultiColor2Input.value;
                    const multiColor3 = particleMultiColor3Input.value;
                    const multiColor4 = particleMultiColor4Input.value;
                    
                    // Update properties
                    particle.size = size;
                    particle.direction = direction;
                    particle.colorStyle = colorStyle;
                    particle.shape = shape;
                    particle.baseColor = baseColor;
                    particle.multiColor1 = multiColor1;
                    particle.multiColor2 = multiColor2;
                    particle.multiColor3 = multiColor3;
                    particle.multiColor4 = multiColor4;
                    particle.twinkleSpeed = parseFloat(particleTwinkleInput.value) > 0 ? (0.1 + (parseFloat(particleTwinkleInput.value) / 100) * 0.2) : 0;
                    
                    // Reset intensity based on movement pattern
                    if (direction === 'static') {
                        // Increase intensity for static particles
                        particle.opacity = Math.max(particle.opacity, 0.95 + Math.random() * 0.05);
                    } else if (direction === 'space') {
                        // Space traveling particles start with low opacity (will fade in during animation)
                        particle.opacity = 0.1 + Math.random() * 0.1;
                    } else {
                        // Reset to normal intensity when switching from static to other patterns
                        particle.opacity = 0.8 + Math.random() * 0.2;
                    }
                    
                    // Maintain connection properties for existing particles
                    if (particle.isConnectionStarter === undefined) {
                        particle.isConnectionStarter = Math.random() < 0.3; // 30% chance for existing particles
                        particle.maxConnections = 3;
                        particle.currentConnections = 0;
                        particle.maxReceivers = 2;
                        particle.connectedReceivers = [];
                    }
                    
                    // Update color based on style
                    if (colorStyle === 'rainbow') {
                        const hue = Math.random() * 360;
                        particle.color = `hsl(${hue}, 100%, 70%)`;
                    } else if (colorStyle === 'random') {
                        particle.color = `hsl(${Math.random() * 360}, ${50 + Math.random() * 50}%, ${50 + Math.random() * 30}%)`;
                    } else if (colorStyle === 'multiple') {
                        const colors = [multiColor1, multiColor2, multiColor3, multiColor4];
                        particle.color = colors[Math.floor(Math.random() * colors.length)];
                    } else {
                        particle.color = baseColor;
                    }
                    // Only update velocity if not skipping (i.e., not during resize)
                    if (!skipVelocityUpdate) {
                        // Update velocity based on direction
                        switch (direction) {
                            case 'up':
                                particle.vx = (Math.random() - 0.5) * speed * 0.2;
                                particle.vy = -speed * (1.5 + Math.random() * 0.5);
                                break;
                            case 'down':
                                particle.vx = (Math.random() - 0.5) * speed * 0.2;
                                particle.vy = speed * (1.5 + Math.random() * 0.5);
                                break;
                            case 'left':
                                particle.vx = -speed * (1.5 + Math.random() * 0.5);
                                particle.vy = (Math.random() - 0.5) * speed * 0.2;
                                break;
                            case 'right':
                                particle.vx = speed * (1.5 + Math.random() * 0.5);
                                particle.vy = (Math.random() - 0.5) * speed * 0.2;
                                break;
                            case 'bounce':
                                particle.vx = (Math.random() - 0.5) * speed * 2;
                                particle.vy = (Math.random() - 0.5) * speed * 2;
                                break;
                            case 'orbit':
                                particle.vx = Math.cos(particle.orbitAngle) * speed * 0.5;
                                particle.vy = Math.sin(particle.orbitAngle) * speed * 0.5;
                                break;
                            case 'random':
                                particle.vx = (Math.random() - 0.5) * speed * 2;
                                particle.vy = (Math.random() - 0.5) * speed * 2;
                                break;
                            case 'static':
                                // Freeze particles in their current positions
                                particle.vx = 0;
                                particle.vy = 0;
                                break;
                            case 'space':
                                // Space traveling: restore original straight line movement only if needed
                                if (particle.originalAngle !== undefined && particle.originalVelocity !== undefined) {
                                    // Only restore if velocity has been changed (not already correct)
                                    const expectedVx = Math.cos(particle.originalAngle) * particle.originalVelocity;
                                    const expectedVy = Math.sin(particle.originalAngle) * particle.originalVelocity;
                                    
                                    if (Math.abs(particle.vx - expectedVx) > 0.01 || Math.abs(particle.vy - expectedVy) > 0.01) {
                                        particle.vx = expectedVx;
                                        particle.vy = expectedVy;
                                    }
                                }
                                break;
                        }
                    }
                });
            };
            
            // Event listeners for particles
            // Event listeners for particles - Use the new animation system
            setupToggleWithAnimation(particlesToggle, particlesOptions, (isEnabled) => {
                canvas.classList.toggle('active', isEnabled);
                
                if (isEnabled) {
                    resizeCanvas();
                    updateParticles();
                    animate();
                } else {
                    cancelAnimationFrame(animationId);
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    particles = []; // Clear particles array when disabled
                }
            });
            
            [particleDensityInput, particleSpeedInput, particleSizeInput, particleTwinkleInput, particleColorInput, particleMultiColor1Input, particleMultiColor2Input, particleMultiColor3Input, particleMultiColor4Input, particleColorStyleSelect, particleShapeSelect, particleDirectionSelect, particleEffectsSelect].forEach(input => {
                input.addEventListener('input', () => {
                    // Reset twinkle intensity cache when twinkle input changes
                    if (input === particleTwinkleInput) {
                        twinkleIntensityUpdated = false;
                    }
                    
                    // Clear particles when movement pattern changes
                    if (input === particleDirectionSelect) {
                        particles = [];
                    }
                    
                    // Clear particles when speed changes
                    if (input === particleSpeedInput) {
                        particles = [];
                    }
                    
                    updateParticles();
                });
                input.addEventListener('change', () => {
                    // Reset twinkle intensity cache when twinkle input changes
                    if (input === particleTwinkleInput) {
                        twinkleIntensityUpdated = false;
                    }
                    
                    // Clear particles when movement pattern changes
                    if (input === particleDirectionSelect) {
                        particles = [];
                    }
                    
                    // Clear particles when speed changes
                    if (input === particleSpeedInput) {
                        particles = [];
                    }
                    
                    updateParticles();
                });
            });
            // Show/hide color inputs based on color style selection
            particleColorStyleSelect.addEventListener('change', () => {
                const colorItem = particleColorInput.closest('.option-item');
                const multiColor1Item = particleMultiColor1Input.closest('.option-item');
                const multiColor2Item = particleMultiColor2Input.closest('.option-item');
                const multiColor3Item = particleMultiColor3Input.closest('.option-item');
                const multiColor4Item = particleMultiColor4Input.closest('.option-item');
                
                if (particleColorStyleSelect.value === 'multiple') {
                    colorItem.style.display = 'none';
                    multiColor1Item.style.display = 'flex';
                    multiColor2Item.style.display = 'flex';
                    multiColor3Item.style.display = 'flex';
                    multiColor4Item.style.display = 'flex';
                } else {
                    colorItem.style.display = 'flex';
                    multiColor1Item.style.display = 'none';
                    multiColor2Item.style.display = 'none';
                    multiColor3Item.style.display = 'none';
                    multiColor4Item.style.display = 'none';
                }
                updateParticles();
            });
            
            // Initialize color input visibility
            const colorItem = particleColorInput.closest('.option-item');
            const multiColor1Item = particleMultiColor1Input.closest('.option-item');
            const multiColor2Item = particleMultiColor2Input.closest('.option-item');
            const multiColor3Item = particleMultiColor3Input.closest('.option-item');
            const multiColor4Item = particleMultiColor4Input.closest('.option-item');
            
            if (particleColorStyleSelect.value === 'multiple') {
                colorItem.style.display = 'none';
                multiColor1Item.style.display = 'flex';
                multiColor2Item.style.display = 'flex';
                multiColor3Item.style.display = 'flex';
                multiColor4Item.style.display = 'flex';
            } else {
                colorItem.style.display = 'flex';
                multiColor1Item.style.display = 'none';
                multiColor2Item.style.display = 'none';
                multiColor3Item.style.display = 'none';
                multiColor4Item.style.display = 'none';
            }
            // Handle window resize with debouncing for better performance
            let resizeTimeout;
            let isResizing = false; // Flag to prevent multiple resize operations
            const handleResize = () => {
                if (isResizing) return; // Prevent overlapping resize operations
                
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(() => {
                    if (particlesToggle.checked) {
                        isResizing = true; // Set flag to prevent overlapping
                        
                        // Store current animation state
                        const wasAnimating = animationId !== null;
                        
                        // Stop current animation to prevent acceleration
                        if (animationId) {
                            cancelAnimationFrame(animationId);
                            animationId = null;
                        }
                        
                        // Resize canvas
                        resizeCanvas();
                        
                        // Update particles without restarting animation
                        updateParticles(true); // Skip velocity update during resize
                        
                        // Resume animation only if it was running before
                        if (wasAnimating) {
                            animate();
                        }
                        
                        isResizing = false; // Clear flag
                    }
                }, 150); // Increased debounce time for stability
            };
            
            window.addEventListener('resize', handleResize);
            window.addEventListener('orientationchange', handleResize);
            
            // Handle viewport changes (mobile browsers)
            if ('visualViewport' in window) {
                window.visualViewport.addEventListener('resize', handleResize);
            }
            
            // Mouse tracking for magnetic effects
            canvas.addEventListener('mousemove', (e) => {
                const rect = canvas.getBoundingClientRect();
                mouseX = e.clientX - rect.left;
                mouseY = e.clientY - rect.top;
            });
            
            startBtnColorInput.addEventListener('input', (e) => {
                setCssVar('--start-btn-color', e.target.value);
                updateButtonNeonColors();
            });
            repeatBtnColorInput.addEventListener('input', (e) => {
                setCssVar('--repeat-btn-color', e.target.value);
                updateButtonNeonColors();
            });
            endBtnColorInput.addEventListener('input', (e) => {
                setCssVar('--end-btn-color', e.target.value);
                updateButtonNeonColors();
            });
            
            btnPaddingYInput.addEventListener('input', e => setCssVar('--btn-padding-y', e.target.value, 'px'));
            btnPaddingXInput.addEventListener('input', e => setCssVar('--btn-padding-x', e.target.value, 'px'));
            btnFontSizeInput.addEventListener('input', e => setCssVar('--btn-font-size', e.target.value, 'rem'));
            btnBorderSizeInput.addEventListener('input', e => setCssVar('--btn-border-size', e.target.value, 'px'));
            btnBorderColorInput.addEventListener('input', e => setCssVar('--btn-border-color', e.target.value));
            
            // Button outline toggle
            btnOutlineToggle.addEventListener('change', (e) => {
                const buttons = document.querySelectorAll('#controls button');
                buttons.forEach(button => {
                    if (e.target.checked) {
                        button.classList.add('outline-enabled');
                    } else {
                        button.classList.remove('outline-enabled');
                    }
                });
            });
            
            uiOpacityInput.addEventListener('input', (e) => {
                // Map 20..100 to 0.2..1.0
                const value = Math.max(20, Math.min(100, parseInt(e.target.value, 10)));
                setCssVar('--ui-opacity', value / 100);
            });
            
             // --- GLOW TOGGLE LOGIC ---
            function setupGlowToggle(toggle, group, intensityInput, cssVar) {
                if(!toggle || !group || !intensityInput) return; // Prevent error if element is missing
                function updateState() {
                    const isEnabled = toggle.checked;
                    group.classList.toggle('disabled', !isEnabled);
                    if (!isEnabled) {
                        setCssVar(cssVar, '0px'); // Turn off glow
                    } else {
                        setCssVar(cssVar, `${intensityInput.value}px`); // Restore glow from slider
                    }
                }

                toggle.addEventListener('change', updateState);
                intensityInput.addEventListener('input', (e) => {
                    if (toggle.checked) {
                        setCssVar(cssVar, `${e.target.value}px`);
                    }
                });

                // Initial state on load
                updateState();
            }
            
            function setupMutuallyExclusiveGlows(normalToggle, normalGroup, normalIntensity, normalVar, neonToggle, neonGroup, neonIntensity, neonVar) {
                if(!normalToggle || !neonToggle) return; // Prevent errors
                function updateState(changedToggle) {
                    if (changedToggle === 'normal' && normalToggle.checked) {
                        neonToggle.checked = false;
                    } else if (changedToggle === 'neon' && neonToggle.checked) {
                        normalToggle.checked = false;
                    }
                    
                    const normalEnabled = normalToggle.checked;
                    const neonEnabled = neonToggle.checked;

                    normalGroup.classList.toggle('disabled', !normalEnabled);
                    neonGroup.classList.toggle('disabled', !neonEnabled);

                    setCssVar(normalVar, normalEnabled ? `${normalIntensity.value}px` : '0px');
                    setCssVar(neonVar, neonEnabled ? `${neonIntensity.value}px` : '0px');
                }

                normalToggle.addEventListener('change', () => updateState('normal'));
                neonToggle.addEventListener('change', () => updateState('neon'));
                
                normalIntensity.addEventListener('input', () => updateState());
                neonIntensity.addEventListener('input', () => updateState());
                
                updateState(); // Initial call
            }
            
            function setupNeonToggle(neonToggle, neonGroup, neonIntensity, neonVar, matchColorToggle = null) {
                if(!neonToggle) return; // Prevent errors
                function updateState() {
                    const neonEnabled = neonToggle.checked;
                    neonGroup.classList.toggle('disabled', !neonEnabled);
                    setCssVar(neonVar, neonEnabled ? `${neonIntensity.value}px` : '0px');
                    
                    // Disable/enable match color checkbox based on neon state
                    if (matchColorToggle) {
                        matchColorToggle.classList.toggle('disabled', !neonEnabled);
                    }
                }

                neonToggle.addEventListener('change', updateState);
                neonIntensity.addEventListener('input', updateState);

                // Initial state on load
                updateState();
            }
            
             function setupGradientToggle(toggle, colorInput, gradientGroup, startInput, endInput, cssVar) {
                if(!toggle) return;
                const colorOption = document.getElementById('bar-color-option');
                function updateState() {
                    const isGradient = toggle.checked;
                    gradientGroup.classList.toggle('disabled', !isGradient);
                    if(colorOption) colorOption.classList.toggle('disabled', isGradient);

                    if (isGradient) {
                        setCssVar(cssVar, `linear-gradient(90deg, ${startInput.value}, ${endInput.value})`);
                        setCssVar('--bar-color', endInput.value); // Match glow to end color
                    } else {
                        setCssVar(cssVar, colorInput.value);
                        setCssVar('--bar-color', colorInput.value); // Match glow to solid color
                    }
                }
                toggle.addEventListener('change', updateState);
                colorInput.addEventListener('input', updateState);
                startInput.addEventListener('input', updateState);
                endInput.addEventListener('input', updateState);
                updateState();
            }

            setupGradientToggle(barGradientToggle, barColorInput, barGradientOptions, barGradientStartInput, barGradientEndInput, '--bar-background');
            setupNeonToggle(barGlowNeonToggle, barGlowNeonOptions, barNeonIntensityInput, '--bar-neon-intensity');
            setupNeonToggle(textGlowNeonToggle, textGlowNeonOptions, textNeonSpreadInput, '--text-neon-spread', textNeonMatchColorToggle);
            setupNeonToggle(messageNeonToggle, messageNeonOptions, messageNeonSpreadInput, '--message-neon-spread', messageNeonMatchColorToggle);
            setupNeonToggle(borderNeonToggle, borderNeonOptions, borderNeonIntensityInput, '--border-neon-intensity', borderNeonMatchColorToggle);
            setupNeonToggle(btnGlowNeonToggle, btnGlowNeonOptions, btnNeonIntensityInput, '--btn-neon-intensity', btnNeonMatchColorToggle);

            // Enhanced toggle functionality with smooth animations
            function setupToggleWithAnimation(toggle, optionsGroup, callback = null) {
                if (!toggle || !optionsGroup) return;
                
                function updateState() {
                    const isEnabled = toggle.checked;
                    const optionItems = optionsGroup.querySelectorAll('.option-item');
                    
                    if (isEnabled) {
                        // Enable the group
                        optionsGroup.classList.remove('disabled');
                        
                        // Animate each option item with a slight delay
                        optionItems.forEach((item, index) => {
                            setTimeout(() => {
                                item.style.transform = 'translateY(0)';
                                item.style.opacity = '1';
                            }, index * 50); // 50ms delay between each item
                        });
                        
                        // Call callback if provided
                        if (callback) callback(true);
                    } else {
                        // Disable the group
                        optionsGroup.classList.add('disabled');
                        
                        // Hide all option items immediately
                        optionItems.forEach(item => {
                            item.style.transform = 'translateY(-10px)';
                            item.style.opacity = '0';
                        });
                        
                        // Call callback if provided
                        if (callback) callback(false);
                    }
                }
                
                toggle.addEventListener('change', updateState);
                
                // Initialize state
                updateState();
            }
            // Message toggle functionality
            function setupMessageToggle(toggle, optionsGroup) {
                if(!toggle || !optionsGroup) return;
                function updateState() {
                    const isEnabled = toggle.checked;
                    optionsGroup.classList.toggle('disabled', !isEnabled);
                    timerMessage.style.display = isEnabled ? 'block' : 'none';
                }
                toggle.addEventListener('change', updateState);
                updateState(); // Initial call
            }
            setupMessageToggle(messageToggle, messageOptions);

            // Update timer message function
            const updateTimerMessage = (text) => {
                let displayText = text.trim();
                if (!displayText) {
                    displayText = "Your custom message here";
                }

                if (displayText.endsWith('...')) {
                    const mainText = displayText.slice(0, -3);
                    const animationType = ellipsisAnimationSelect.value;
                    timerMessage.innerHTML = `<span>${mainText}</span><span class="ellipsis ${animationType}"><span class="ellipsis-dot">.</span><span class="ellipsis-dot">.</span><span class="ellipsis-dot">.</span></span>`;
                } else {
                    timerMessage.innerHTML = ''; // Clear previous content
                    timerMessage.textContent = displayText;
                }
                
            };
            

            window.addEventListener('resize', () => {
                let percentage = 0;
                if (totalDuration > 0) {
                    const mode = timerModeSelect.value;
                    if (mode === 'duration') {
                        const elapsedTime = totalDuration - timeRemaining;
                        percentage = totalDuration > 0 ? (elapsedTime / totalDuration) * 100 : 0;
                    } else { // endTime
                        const now = Date.now();
                        if (now >= targetEndTime) {
                            percentage = 100;
                        } else if (!startTime || now < startTime) {
                            percentage = 0;
                        } else {
                            const elapsedTime = now - startTime;
                            percentage = totalDuration > 0 ? (elapsedTime / totalDuration) * 100 : 0;
                        }
                    }
                }
                updateDisplay(percentage);
                updateUIPositions();
            });

            // --- INITIALIZATION ---
            // Populate End Time dropdowns
            for (let i = 1; i <= 12; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i;
                endTimeHourInput.appendChild(option);
            }
            for (let i = 0; i <= 59; i++) {
                const option = document.createElement('option');
                const value = i.toString().padStart(2, '0');
                option.value = value;
                option.textContent = value;
                endTimeMinuteInput.appendChild(option);
            }

            iconAnimator.innerHTML = presetIcons.menu; // Load default icon into the correct container
            iconAnimator.style.color = iconColorInput.value; // Apply initial color
            resetTimer(); 
            updateTimerMessage(messageInput.value);
            loadAndApplySettings();
            // Final UI position update after loading settings
            updateUIPositions();
            
            // Cleanup functions for proper memory management
            const cleanup = () => {
                // Stop all animations
                if (timerLoopId) {
                    cancelAnimationFrame(timerLoopId);
                    timerLoopId = null;
                }
                if (animationId) {
                    cancelAnimationFrame(animationId);
                    animationId = null;
                }
                
                // Clear particles and return to pool
                particles.forEach(particle => returnParticleToPool(particle));
                particles = [];
                
                // Close audio context
                if (audioContext && audioContext.state !== 'closed') {
                    audioContext.close();
                }
                
                // Clear canvas
                if (ctx) {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                }
            };
            
            // Add cleanup on page unload
            window.addEventListener('beforeunload', cleanup);
            
            // Add cleanup on visibility change (when tab becomes hidden)
            document.addEventListener('visibilitychange', () => {
                if (document.hidden) {
                    // Reduce performance when tab is hidden
                    if (animationId) {
                        cancelAnimationFrame(animationId);
                        animationId = null;
                    }
                } else if (particlesToggle.checked) {
                    // Resume animation when tab becomes visible
                    animate();
                }
            });
        });
    </script>
    <!-- PWA Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then((registration) => {
                        console.log('SW registered: ', registration);
                    })
                    .catch((registrationError) => {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }
    </script>
    <!-- Timer Settings Popup -->
    <div id="timer-popup-overlay" class="popup-overlay">
        <div id="timer-popup" class="timer-popup">
            <div id="timer-popup-content">
                <h2>Set Timer</h2>
                
                <div class="timer-popup-section">
                    <div class="option-item">
                        <label for="popup-timer-mode-select">Mode</label>
                        <select id="popup-timer-mode-select">
                            <option value="duration" selected>Duration</option>
                            <option value="endTime">End Time</option>
                        </select>
                    </div>
                    
                    <div id="popup-duration-settings">
                        <div class="option-item full-width">
                            <label>Duration</label>
                            <div class="reset-section">
                                <button class="zero-btn" id="popup-duration-reset-btn">Reset</button>
                            </div>
                            <div class="duration-control">
                                    <div class="input-group">
                                        <label for="popup-duration-hours">Hrs</label>
                                        <div class="wheel-picker" id="popup-hours-wheel">
                                            <div class="wheel-label">HRS</div>
                                            <div class="selection-highlight"></div>
                                            <div class="wheel-container">
                                                <div class="wheel-item" data-value="0">00</div>
                                                <div class="wheel-item" data-value="1">01</div>
                                                <div class="wheel-item" data-value="2">02</div>
                                                <div class="wheel-item" data-value="3">03</div>
                                                <div class="wheel-item" data-value="4">04</div>
                                                <div class="wheel-item" data-value="5">05</div>
                                                <div class="wheel-item" data-value="6">06</div>
                                                <div class="wheel-item" data-value="7">07</div>
                                                <div class="wheel-item" data-value="8">08</div>
                                                <div class="wheel-item" data-value="9">09</div>
                                                <div class="wheel-item" data-value="10">10</div>
                                                <div class="wheel-item" data-value="11">11</div>
                                                <div class="wheel-item" data-value="12">12</div>
                                                <div class="wheel-item" data-value="13">13</div>
                                                <div class="wheel-item" data-value="14">14</div>
                                                <div class="wheel-item" data-value="15">15</div>
                                                <div class="wheel-item" data-value="16">16</div>
                                                <div class="wheel-item" data-value="17">17</div>
                                                <div class="wheel-item" data-value="18">18</div>
                                                <div class="wheel-item" data-value="19">19</div>
                                                <div class="wheel-item" data-value="20">20</div>
                                                <div class="wheel-item" data-value="21">21</div>
                                                <div class="wheel-item" data-value="22">22</div>
                                                <div class="wheel-item" data-value="23">23</div>
                                                <div class="wheel-item" data-value="24">24</div>
                            </div>
                                        </div>
                                        <input type="hidden" id="popup-duration-hours" value="0">
                                    </div>
                                    <span class="time-separator">:</span>
                                    <div class="input-group">
                                        <label for="popup-duration-minutes">Min</label>
                                        <div class="wheel-picker" id="popup-minutes-wheel">
                                            <div class="wheel-label">MIN</div>
                                            <div class="selection-highlight"></div>
                                            <div class="wheel-container">
                                                <div class="wheel-item" data-value="0">00</div>
                                                <div class="wheel-item" data-value="1">01</div>
                                                <div class="wheel-item" data-value="2">02</div>
                                                <div class="wheel-item" data-value="3">03</div>
                                                <div class="wheel-item" data-value="4">04</div>
                                                <div class="wheel-item" data-value="5">05</div>
                                                <div class="wheel-item" data-value="6">06</div>
                                                <div class="wheel-item" data-value="7">07</div>
                                                <div class="wheel-item" data-value="8">08</div>
                                                <div class="wheel-item" data-value="9">09</div>
                                                <div class="wheel-item" data-value="10">10</div>
                                                <div class="wheel-item" data-value="11">11</div>
                                                <div class="wheel-item" data-value="12">12</div>
                                                <div class="wheel-item" data-value="13">13</div>
                                                <div class="wheel-item" data-value="14">14</div>
                                                <div class="wheel-item" data-value="15">15</div>
                                                <div class="wheel-item" data-value="16">16</div>
                                                <div class="wheel-item" data-value="17">17</div>
                                                <div class="wheel-item" data-value="18">18</div>
                                                <div class="wheel-item" data-value="19">19</div>
                                                <div class="wheel-item" data-value="20">20</div>
                                                <div class="wheel-item" data-value="21">21</div>
                                                <div class="wheel-item" data-value="22">22</div>
                                                <div class="wheel-item" data-value="23">23</div>
                                                <div class="wheel-item" data-value="24">24</div>
                                                <div class="wheel-item" data-value="25">25</div>
                                                <div class="wheel-item" data-value="26">26</div>
                                                <div class="wheel-item" data-value="27">27</div>
                                                <div class="wheel-item" data-value="28">28</div>
                                                <div class="wheel-item" data-value="29">29</div>
                                                <div class="wheel-item" data-value="30">30</div>
                                                <div class="wheel-item" data-value="31">31</div>
                                                <div class="wheel-item" data-value="32">32</div>
                                                <div class="wheel-item" data-value="33">33</div>
                                                <div class="wheel-item" data-value="34">34</div>
                                                <div class="wheel-item" data-value="35">35</div>
                                                <div class="wheel-item" data-value="36">36</div>
                                                <div class="wheel-item" data-value="37">37</div>
                                                <div class="wheel-item" data-value="38">38</div>
                                                <div class="wheel-item" data-value="39">39</div>
                                                <div class="wheel-item" data-value="40">40</div>
                                                <div class="wheel-item" data-value="41">41</div>
                                                <div class="wheel-item" data-value="42">42</div>
                                                <div class="wheel-item" data-value="43">43</div>
                                                <div class="wheel-item" data-value="44">44</div>
                                                <div class="wheel-item" data-value="45">45</div>
                                                <div class="wheel-item" data-value="46">46</div>
                                                <div class="wheel-item" data-value="47">47</div>
                                                <div class="wheel-item" data-value="48">48</div>
                                                <div class="wheel-item" data-value="49">49</div>
                                                <div class="wheel-item" data-value="50">50</div>
                                                <div class="wheel-item" data-value="51">51</div>
                                                <div class="wheel-item" data-value="52">52</div>
                                                <div class="wheel-item" data-value="53">53</div>
                                                <div class="wheel-item" data-value="54">54</div>
                                                <div class="wheel-item" data-value="55">55</div>
                                                <div class="wheel-item" data-value="56">56</div>
                                                <div class="wheel-item" data-value="57">57</div>
                                                <div class="wheel-item" data-value="58">58</div>
                                                <div class="wheel-item" data-value="59">59</div>
                                            </div>
                                        </div>
                                        <input type="hidden" id="popup-duration-minutes" value="0">
                                    </div>
                                    <span class="time-separator">:</span>
                                    <div class="input-group">
                                        <label for="popup-duration-seconds">Sec</label>
                                        <div class="wheel-picker" id="popup-seconds-wheel">
                                            <div class="wheel-label">SEC</div>
                                            <div class="selection-highlight"></div>
                                            <div class="wheel-container">
                                                <div class="wheel-item" data-value="0">00</div>
                                                <div class="wheel-item" data-value="1">01</div>
                                                <div class="wheel-item" data-value="2">02</div>
                                                <div class="wheel-item" data-value="3">03</div>
                                                <div class="wheel-item" data-value="4">04</div>
                                                <div class="wheel-item" data-value="5">05</div>
                                                <div class="wheel-item" data-value="6">06</div>
                                                <div class="wheel-item" data-value="7">07</div>
                                                <div class="wheel-item" data-value="8">08</div>
                                                <div class="wheel-item" data-value="9">09</div>
                                                <div class="wheel-item" data-value="10">10</div>
                                                <div class="wheel-item" data-value="11">11</div>
                                                <div class="wheel-item" data-value="12">12</div>
                                                <div class="wheel-item" data-value="13">13</div>
                                                <div class="wheel-item" data-value="14">14</div>
                                                <div class="wheel-item" data-value="15">15</div>
                                                <div class="wheel-item" data-value="16">16</div>
                                                <div class="wheel-item" data-value="17">17</div>
                                                <div class="wheel-item" data-value="18">18</div>
                                                <div class="wheel-item" data-value="19">19</div>
                                                <div class="wheel-item" data-value="20">20</div>
                                                <div class="wheel-item" data-value="21">21</div>
                                                <div class="wheel-item" data-value="22">22</div>
                                                <div class="wheel-item" data-value="23">23</div>
                                                <div class="wheel-item" data-value="24">24</div>
                                                <div class="wheel-item" data-value="25">25</div>
                                                <div class="wheel-item" data-value="26">26</div>
                                                <div class="wheel-item" data-value="27">27</div>
                                                <div class="wheel-item" data-value="28">28</div>
                                                <div class="wheel-item" data-value="29">29</div>
                                                <div class="wheel-item" data-value="30">30</div>
                                                <div class="wheel-item" data-value="31">31</div>
                                                <div class="wheel-item" data-value="32">32</div>
                                                <div class="wheel-item" data-value="33">33</div>
                                                <div class="wheel-item" data-value="34">34</div>
                                                <div class="wheel-item" data-value="35">35</div>
                                                <div class="wheel-item" data-value="36">36</div>
                                                <div class="wheel-item" data-value="37">37</div>
                                                <div class="wheel-item" data-value="38">38</div>
                                                <div class="wheel-item" data-value="39">39</div>
                                                <div class="wheel-item" data-value="40">40</div>
                                                <div class="wheel-item" data-value="41">41</div>
                                                <div class="wheel-item" data-value="42">42</div>
                                                <div class="wheel-item" data-value="43">43</div>
                                                <div class="wheel-item" data-value="44">44</div>
                                                <div class="wheel-item" data-value="45">45</div>
                                                <div class="wheel-item" data-value="46">46</div>
                                                <div class="wheel-item" data-value="47">47</div>
                                                <div class="wheel-item" data-value="48">48</div>
                                                <div class="wheel-item" data-value="49">49</div>
                                                <div class="wheel-item" data-value="50">50</div>
                                                <div class="wheel-item" data-value="51">51</div>
                                                <div class="wheel-item" data-value="52">52</div>
                                                <div class="wheel-item" data-value="53">53</div>
                                                <div class="wheel-item" data-value="54">54</div>
                                                <div class="wheel-item" data-value="55">55</div>
                                                <div class="wheel-item" data-value="56">56</div>
                                                <div class="wheel-item" data-value="57">57</div>
                                                <div class="wheel-item" data-value="58">58</div>
                                                <div class="wheel-item" data-value="59">59</div>
                                            </div>
                                        </div>
                                        <input type="hidden" id="popup-duration-seconds" value="0">
                                    </div>
                                </div>
                        </div>
                        
                        <div class="option-item">
                            <label for="popup-start-delay">Countdown</label>
                            <select id="popup-start-delay">
                                <option value="0">0 seconds</option>
                                <option value="3">3 seconds</option>
                                <option value="5">5 seconds</option>
                                <option value="10">10 seconds</option>
                                <option value="15">15 seconds</option>
                            </select>
                        </div>
                    </div>
                    <div id="popup-endtime-settings" class="hidden">
                        <div class="option-item full-width">
                            <label>End Time</label>
                            <div class="endtime-control">
                                <select id="popup-end-time-hour"></select>
                                <span>:</span>
                                <select id="popup-end-time-minute"></select>
                                <select id="popup-end-time-ampm">
                                    <option>AM</option>
                                    <option>PM</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                </div>
                
                <div class="timer-popup-buttons">
                    <button id="popup-start-btn">Start</button>
                    <button id="popup-cancel-btn">Cancel</button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>